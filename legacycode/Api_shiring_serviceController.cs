using IndusWebApi.Models;
using IndusWebApi.ValidateRequest;
using Microsoft.Graph.Models;
using Microsoft.Kiota.Abstractions;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.ComponentModel.Design;
using System.Data;
using System.Data.Entity.Core.Metadata.Edm;
using System.Data.SqlClient;
using System.Data.SqlTypes;
using System.Diagnostics;
using System.Drawing;
using System.Drawing.Imaging;
using System.Drawing.Printing;
using System.Globalization;
using System.IdentityModel.Tokens;
using System.Linq;
using System.Linq.Dynamic.Core;
using System.Net;
using System.Net.Http;
using System.Reflection;
using System.Runtime.InteropServices.ComTypes;
using System.Security.Claims;
using System.Security.Cryptography;
using System.Security.Policy;
using System.Text;
using System.Text.Json.Nodes;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Compilation;
using System.Web.DynamicData;
using System.Web.Http;
using System.Web.Script.Serialization;
using System.Web.Script.Services;
using System.Web.UI.WebControls;
using System.Windows.Forms;
using static System.Net.Mime.MediaTypeNames;

namespace IndusWebApi.Controllers.Planning
{
    [Validate]
    public class Api_shiring_serviceController : ApiController
    {
        public string str, AppName = "", JobName = "", ClientName = "", JobPrePlan = "";
        public string planErrors = "";
        public double Gbl_Job_Overlap_Flap = 0, Gbl_Job_Open_Flap = 0, Gbl_Job_Pasting_Flap = 0, Gbl_Job_Center_Seal = 0, Gbl_Job_Side_Seal = 0, Gbl_Job_Bottom_Gusset = 0, Gbl_Job_Top_Seal = 0, Gbl_Job_Zipper_Length = 0, Gbl_Job_Zipper_Weight_Per_Meter = 0;
        public double Gbl_Die_Size_L, Gbl_Die_Size_H;
        public double Gbl_Job_Tongue_Height, Gbl_Job_Bottom_Flap, Gbl_Job_Bottom_Flap_Per;

        private readonly SqlDataAdapter DA;
        public bool Gbl_Half_Ups_Logic, Check_Plan_In_Special_Size, Check_Plan_In_Standard_Size, CheckPaperByClient, ChkPlanInAvailableStock, ChkBackToBackPastingRequired;
        public string k, Gbl_Machine_Name;
        public double Gbl_lower_Width, Gbl_upper_Width;
        public long CompanyID, Gbl_Job_Leaves, Gbl_Job_Flap_Width;
        public double Gbl_Machine_Gripper, Gbl_Gripper;
        public string Gbl_Printing_Style, Gbl_Required_Printing_Style, Gbl_Flat_Wastage_Type, Gbl_Plate_Type, Gbl_Grain_Direction, Gbl_Plan_Grain_Direction;

        public double Gbl_UPS_L, Gbl_UPS_H, Gbl_Job_Ups, Gbl_Job_Across_Ups, Gbl_Job_Around_Ups;
        public long Gbl_Job_Pages;
        public double Gbl_Flat_Wastage_Value, Gbl_Job_Trimming_TB, Gbl_Job_Trimming_LR;
        public double Gbl_Striping_LR, Gbl_Striping_TB, Gbl_ColorStrip;
        public DataTable Gbl_DT_plan = new DataTable(), DT_Printing_Slabs = new DataTable(), DT_Client_Printing_Slabs = new DataTable(), Gbl_DT_Search_In_Machine = new DataTable();
        public DataTable Gbl_DT_Paper = new DataTable(), Gbl_DT_Machine = new DataTable(), Gbl_DT_Operation = new DataTable(), Gbl_DT_Operation_Machine_Allocation = new DataTable();
        public DataTable Gbl_DT_Category_Wastage = new DataTable();
        public double Gbl_Paper_Rate, Gbl_Paper_H, Gbl_Paper_L, Gbl_Paper_TrimmingLR, Gbl_Paper_TrimmingTB;
        public double Gbl_Paper_GSM = 0, Gbl_Paper_Thickness = 0;
        public byte Gbl_Front_Color, Gbl_Back_Color;
        public double Gbl_Sheet_L, Gbl_Sheet_W;
        public float Gbl_Order_Quantity;
        public long Gbl_Category_ID;

        public string Gbl_GripperSide, Gbl_Orientation, PlanContName, Gbl_Estimation_Unit;
        public int Gbl_Paper_ID, Gbl_Machine_ID;
        public double Gbl_Job_H, Gbl_Job_L, Gbl_Job_W, Gbl_Machine_Colors;
        public string Gbl_Paper_Detail;
        public string Gbl_Bal_Side, Bal_Piece;
        public string Gbl_Paper_Rate_Type = "";
        public string Gbl_Paper_Quality, Gbl_Paper_Mill, Gbl_Paper_Finish;
        double Gbl_Make_Ready_Rate, Gbl_Coating_Rate; // Added by Vivek on 04-June-25

        public string Gbl_Machine_Type, Gbl_Plan_Type;
        public int Gbl_InterLock_Style;
        public string Gbl_Unit_Per_Packing, Gbl_Packing;
        public double Coating_Charges = 0;
        public double Special_Color_Back_Charges = 0;
        public double Special_Color_Front_Charges = 0;
        public int Gbl_Special_Front_Color, Gbl_Special_Back_Color;
        public double Special_Color_Front_Amount, Special_Color_Back_Amount;
        public DataTable Rf_Dt_Opr = new DataTable();

        public DataTable GblDTReel = new DataTable();
        public DataTable GblDTRoll = new DataTable();
        public DataTable GblDTFlexRoll = new DataTable();
        public int Gbl_LedgerID = 0;

        public long Gbl_M_Min_H, GblMachineMaxW, GblMachineMaxL;
        public DataTable GblDTSlittingMachine = new DataTable();
        public DataTable GblDTCorrugationMachine = new DataTable();
        public DataTable GblDTCorrugationPlan = new DataTable();

        public DataTable GblDTMachineCoatingRates = new DataTable();
        public DataTable GblDTBook, GblDTOprFactors, GblDTOprSlabs = new DataTable();
        public string MachineIDFilter = "";
        public string GblMainPaperGroup = "";
        public string GblOperId = "";
        public string GblOnlineCoating = "";
        public double SlabPrintingChargeN = 0;
        public string GblPaperPurchaseRateType;
        public string Gbl_Content_Domain_Type;
        public double Gbl_Plate_Bearer, Gbl_Standard_AC_Gap, Gbl_Standard_AR_Gap, Gbl_Around_Waste_Strip, Gbl_Actual_Around_Gap, Gbl_Side_Wastage_Strip;
        public double Gbl_Label_L_With_Around, Gbl_Label_H_With_Across;
        public bool GblShadeCardCreationRequired;
        public int Gbl_Big_H, Gbl_Big_Ups_H;
        public int Gbl_Cylinder_Tool_ID;

        // Added By Vivek On 06_Dec_2022
        string Gbl_labeltype;
        int Gbl_windingdirection;
        string Gbl_finishedformat;
        string Gbl_dietype;
        int Gbl_LabelPerRoll;
        float Gbl_CoreInnerDia;
        float Gbl_CoreOuterDia;
        string DBType = "";

        float Gbl_Width_Minus_Factor = 0;
        int Forms_Wastage;
        bool Gbl_Is_Wastage_Add_In_Printing_Rates = false; // By Vivek ON 05-Nov-2024
        bool Gbl_Is_Book_Half_Form_Wastage = false;        // By Vivek ON 05-Nov-2024
        DataTable Gbl_DT_CompanyMaster_Flags = new DataTable(); // By Vivek ON 05-Nov-2024
        DataTable Gbl_DT_DieMaster = new DataTable(); // By Abhinav ON 02-Feb-2026
        float Gbl_Corrugation_Allowance = 0;
        bool Gbl_Variable_CutOff = false;
        double Gbl_Process_Size_L, Gbl_Process_Size_H;
        double Gbl_Plan_Make_Ready_Wastage;
        double Gbl_Other_Material_GSM = 0;
        string PlanOtherMaterialGSMSettingJSON = "";
        string ContentSizeInputUnit = "";
        string GblCostEstimationMethodType = "MATERIAL+PROCESS";
        float GblRoundOffImpressionValue = 0.25f;
        float GblShowPlanUptoWastagePerc = 0f;
        string GblPlateChargesType = "Rate/Plate";
        double MachinePerHourCost = 0;

        DataTable Gbl_DT_Formula = new DataTable();
        float L_firstupsize_WG;  // Added By Vivek On 05_Nov_2024
        float L_evenupsize_WG;
        float L_oddupsize_WG;
        float L_lastupsize_WG;
        float W_firstupsize_WG;
        float W_evenupsize_WG;
        float W_oddupsize_WG;
        float W_lastupsize_WG;

        float L_firstupsize_AG;  // Added By Vivek On 05_Nov_2024
        float L_evenupsize_AG;
        float L_oddupsize_AG;
        float L_lastupsize_AG;
        float W_firstupsize_AG;
        float W_evenupsize_AG;
        float W_oddupsize_AG;
        float W_lastupsize_AG;
        private const double TOL_PERCENT = 0.03;  // 3%
        private const double TOL_ABS_MM = 20.0;   // 20 mm
        private string ProductionUnitID;
        private float GblUnitPrice_GridCosting;
        double Gbl_Book_Spine;
        int GblPreviousPlateQty;

        // added by abhinav on 27-12-2025 for the parksons requirement
        double AnnualQuantity;
        string Com_MachieId = "";
        string Com_ProcessIDStr = "";
        string Com_MateialIDStr = "";
        double ProcessWiseWastagePer = 0.0;
        string ProcessWiseWastageType = "";
        double DefaultProfit = 0;


        public DataTable GetDataTable()
        {
            DataTable dataTable = new DataTable();
            string str;
            string wherecondition = "";
            string strfilter = "";
            try
            {
                CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
                str = DBConnection.Version;

                if (str == "New")
                {
                    if (k == "Paper_Planning")
                        str = "SELECT IM.ItemID as PaperID, Quality, GSM, Manufecturer, PackingType, UnitPerPacking, WtPerPacking, IMS.EstimationRate, Finish, NULL as PaperTrimming, SizeW, SizeL, Caliper, IsStandardItem, ItemCode as PaperCode, 0 as IsBalancePiece, EstimationUnit, ItemName as PaperName, PaperGroup, ItemGroupName, PurchaseUnit FROM ItemMaster IM INNER JOIN ItemGroupMaster IGM ON IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID WHERE Isnull(IM.IsDeletedTransaction,0)=0 AND Isnull(IGM.IsDeletedTransaction,0)=0 AND IMS.ProductionUnitID = " + ProductionUnitID + " AND Quality='" + Gbl_Paper_Quality + "' AND GSM=" + Gbl_Paper_GSM + (string.IsNullOrEmpty(Gbl_Paper_Mill) ? "" : " AND Manufecturer='" + Gbl_Paper_Mill + "'") + (string.IsNullOrEmpty(Gbl_Paper_Finish) ? "" : " AND Finish='" + Gbl_Paper_Finish + "'");
                    else if (k == "Flexo_Roll_Planning")
                        str = "Select Distinct IM.ItemID as PaperID,Quality,FaceGSM,ReleaseGSM,AdhesiveGSM,Thickness,Density,Manufecturer,IMS.EstimationRate,Finish,SizeW,IsStandardItem,IM.ItemCode as PaperCode,EstimationUnit,IM.ItemName as PaperName,PaperGroup,ItemGroupName,PurchaseUnit,AvgRollLength FROM ItemMaster IM INNER JOIN ItemGroupMaster IGM ON IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID WHERE Isnull(IM.IsDeletedTransaction,0)=0 AND Isnull(IGM.IsDeletedTransaction,0)=0 AND IMS.ProductionUnitID = " + ProductionUnitID + "  AND Quality='" + Gbl_Paper_Quality + "' AND GSM=" + Gbl_Paper_GSM + (string.IsNullOrEmpty(Gbl_Paper_Mill) ? "" : " AND Manufecturer='" + Gbl_Paper_Mill + "'") + (string.IsNullOrEmpty(Gbl_Paper_Finish) ? "" : " AND Finish='" + Gbl_Paper_Finish + "'");
                    else if (k == "Roto_Gravure_Planning")
                    {
                        if (Convert.ToDecimal(Gbl_Paper_Thickness) > 0)
                            str = "SELECT IM.ItemID as PaperID, Quality, GSM AS FaceGSM,0 AS ReleaseGSM,0 AS AdhesiveGSM,Thickness,Density, Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem,ItemCode As PaperCode,  IsNull(EstimationUnit,'') As EstimationUnit,ItemName As PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit,AvgRollLength FROM ItemMaster IM INNER JOIN ItemGroupMaster IGM ON IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID WHERE Isnull(IM.IsDeletedTransaction,0)=0 AND Isnull(IGM.IsDeletedTransaction,0)=0 AND IMS.ProductionUnitID = " + ProductionUnitID + "  AND Quality = '" + Gbl_Paper_Quality + "' AND GSM = " + Gbl_Paper_GSM + " And Thickness = " + Gbl_Paper_Thickness + (string.IsNullOrEmpty(Gbl_Paper_Mill) ? "" : " AND Manufecturer='" + Gbl_Paper_Mill + "'") + (string.IsNullOrEmpty(Gbl_Paper_Finish) ? "" : " AND Finish='" + Gbl_Paper_Finish + "'");
                        else if (Convert.ToDecimal(Gbl_Paper_GSM) > 0)
                            str = "SELECT IM.ItemID as PaperID,Quality,IM.FaceGSM,ReleaseGSM,AdhesiveGSM,Thickness,Density,Manufecturer,IMS.EstimationRate,Finish,SizeW,IsStandardItem, ItemCode as PaperCode,EstimationUnit,ItemName as PaperName,ItemType as PaperGroup,ItemGroupName,PurchaseUnit,AvgRollLength FROM ItemMaster IM INNER JOIN ItemGroupMaster IGM ON IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID WHERE Isnull(IM.IsDeletedTransaction,0)=0 AND Isnull(IGM.IsDeletedTransaction,0)=0 AND IMS.ProductionUnitID = " + ProductionUnitID + "  AND Quality='" + Gbl_Paper_Quality + "' AND GSM = " + Gbl_Paper_GSM + (string.IsNullOrEmpty(Gbl_Paper_Mill) ? "" : " AND Manufecturer='" + Gbl_Paper_Mill + "'") + (string.IsNullOrEmpty(Gbl_Paper_Finish) ? "" : " AND Finish='" + Gbl_Paper_Finish + "'");
                    }
                    else if (k == "Large_Format_Planning")
                    {
                        if (Convert.ToDecimal(Gbl_Paper_Thickness) > 0)
                            str = "SELECT IM.ItemID as PaperID, Quality, GSM AS FaceGSM,0 AS ReleaseGSM,0 AS AdhesiveGSM,Thickness,Density, Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode As PaperCode,  IsNull(EstimationUnit,'') As EstimationUnit,ItemName As PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit FROM ItemMaster IM INNER JOIN ItemGroupMaster IGM ON IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID WHERE Isnull(IM.IsDeletedTransaction,0)=0 AND Isnull(IGM.IsDeletedTransaction,0)=0 AND IMS.ProductionUnitID = " + ProductionUnitID + "  AND Quality='" + Gbl_Paper_Quality + "' AND GSM = " + Gbl_Paper_GSM + " And Thickness = " + Gbl_Paper_Thickness + (string.IsNullOrEmpty(Gbl_Paper_Mill) ? "" : " AND Manufecturer='" + Gbl_Paper_Mill + "'") + (string.IsNullOrEmpty(Gbl_Paper_Finish) ? "" : " AND Finish='" + Gbl_Paper_Finish + "'");
                        else if (Convert.ToDecimal(Gbl_Paper_GSM) > 0)
                            str = "SELECT Distinct IM.ItemID as PaperID, Quality, GSM AS FaceGSM,0 AS ReleaseGSM,0 AS AdhesiveGSM,Thickness,Density, Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode As PaperCode,  IsNull(EstimationUnit,'') As EstimationUnit,ItemName As PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit FROM ItemMaster IM INNER JOIN ItemGroupMaster IGM ON IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID WHERE Isnull(IM.IsDeletedTransaction,0)=0 AND Isnull(IGM.IsDeletedTransaction,0)=0 AND IMS.ProductionUnitID = " + ProductionUnitID + "  AND Quality='" + Gbl_Paper_Quality + "' AND GSM = " + Gbl_Paper_GSM + (string.IsNullOrEmpty(Gbl_Paper_Mill) ? "" : " AND Manufecturer='" + Gbl_Paper_Mill + "'") + (string.IsNullOrEmpty(Gbl_Paper_Finish) ? "" : " AND Finish='" + Gbl_Paper_Finish + "'");
                    }
                    else if (k == "Search_In_Machine_Selection")
                        str = "SELECT MachineId, MachineName, MinimumSheet, Colors, MakeReadyCharges, MakeReadyWastageSheet, MachineType, MakeReadyTime, ElectricConsumption, PrintingMargin, MachineSpeed, LabourCharges, ChargesType, RoundofImpressionsWith, IsPerfectaMachine, BasicPrintingCharges , JobChangeOverTime, OtherCharges, WastageType, WastageCalculationOn,IsSpecialMachine,Isnull(PerHourCost,0) AS PerHourCost,Isnull(PlateChargesType,'') AS PlateChargesType From MachineMaster  Where CompanyId = " + CompanyID + " " + (string.IsNullOrEmpty(MachineIDFilter) ? "" : MachineIDFilter) + " Order By MachineID";
                    else if (k == "Online_Coated_Rates")
                        str = "SELECT MachineID, SheetRangeFrom, SheetRangeTo, CoatingName, Rate From MachineOnlineCoatingRates Where CompanyId = " + CompanyID + "  Order By MachineID, SheetRangeFrom, SheetRangeTo";
                    else if (k == "Client_Printing_Slabs")
                        str = "SELECT MachineID, SheetRangeFrom, SheetRangeTo, Wastage, Rate, PlateCharges, PSPlateCharges, CTCPPlateCharges, FlatRate, FlatWastageSheets, ApplyAsFixedCharge, MinimumSheet, ChargesType, RoundofImpressionsWith, BasicPrintingCharges From ClientMachineCostSettings Where /*LedgerID = 0  And*/ CompanyId = " + CompanyID + " " + (string.IsNullOrEmpty(MachineIDFilter) ? "" : MachineIDFilter) + "  Order By MachineID, SheetRangeFrom, SheetRangeTo ";   // '" & Gbl_Ledger_ID & " Order By Machine_ID, SheetRangeFrom, SheetRangeTo"           
                    else if (k == "Printing_Slabs")
                        str = "Select MachineID, SheetRangeFrom, SheetRangeTo, Wastage, Rate, PlateCharges, PSPlateCharges, CTCPPlateCharges,CoatingCharges, SpecialColorFrontCharges, SpecialColorBackCharges, FlatRate, FlatWastageSheets, ApplyAsFixedCharge,Isnull(NULLIF(PaperGroup,''),'-') AS PaperGroup,MaxPlanL,MaxPlanW,MinCharges,RunningMeterRangeFrom,RunningMeterRangeTo,Wastage AS ProcessWastagePercentage,MachineSpeed From MachineSlabMaster  Where CompanyId = " + CompanyID + "  " + (string.IsNullOrEmpty(MachineIDFilter) ? "" : MachineIDFilter) + "  Order By (MaxPlanL * MaxPlanW) ASC ";
                    else if (k == "Category_Wise_Wastage")
                        str = "Select CategoryID, PrintingStyle, NoOfColor, Unit, FlatWastage, WastagePercentage, CalculationOn From CategoryWiseWastageSetting Where CategoryID=" + Gbl_Category_ID + " AND Isnull(IsDeletedTransaction,0)=0  Order By PrintingStyle,NoOfColor";
                    else if (k == "Planning_Machines")
                    {

                        //str = "SELECT Top(5) MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW,  Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) AS IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime, JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine ,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff " + " FROM MachineMaster Where /*DepartmentID=0 AND*/ Isnull(IsDeletedTransaction,0)=0 And (MachineType In ('Sheetfed Offset', 'Digital') Or Isnull(IsPlanningMachine,0)=1 ) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  And CompanyId = " + CompanyID + " " + MachineIDFilter + " Union SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW, Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime , JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff " + " FROM MachineMaster Where Isnull(IsDeletedTransaction,0)=0 And DepartmentID=100 And (MachineType ='Web Offset') /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  And CompanyId = " + CompanyID + "  " + MachineIDFilter + "";
                        if (Gbl_Content_Domain_Type.ToString().ToUpper() == "OFFSET")
                        {
                            double totalColors = Convert.ToDouble(Gbl_Front_Color) + Convert.ToDouble(Gbl_Back_Color) + Convert.ToDouble(Gbl_Special_Front_Color) + Convert.ToDouble(Gbl_Special_Back_Color);

                            if (totalColors > 0)
                            {
                                strfilter = " AND ISNULL(IsPlanningMachine,0) = 1 AND ISNULL(Colors,0) >= " + ((Convert.ToDouble(Gbl_Front_Color) + Convert.ToDouble(Gbl_Special_Front_Color)) > (Convert.ToDouble(Gbl_Back_Color) + Convert.ToDouble(Gbl_Special_Back_Color)) ? (Convert.ToDouble(Gbl_Front_Color) + Convert.ToDouble(Gbl_Special_Front_Color)) : (Convert.ToDouble(Gbl_Back_Color) + Convert.ToDouble(Gbl_Special_Back_Color)));
                            }
                            else
                            {
                                strfilter = " AND ISNULL(Colors,0) <= 0 AND ISNULL(IsPlanningMachine,0) = 1";
                            }

                            bool noCoating = (GblOnlineCoating == "None" || GblOnlineCoating == "No" || GblOnlineCoating == "null");

                            if (noCoating)
                            {
                                str = "SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW,  Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) AS IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime, JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine ,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                      " FROM MachineMaster Where /*DepartmentID=0 AND*/ Isnull(IsDeletedTransaction,0)=0 And (MachineType In ('Sheetfed Offset', 'Digital') Or Isnull(IsPlanningMachine,0)=1 ) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  " + strfilter + " And CompanyId = " + CompanyID + " " + MachineIDFilter + " Union SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW, Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime , JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                      " FROM MachineMaster Where Isnull(IsDeletedTransaction,0)=0 And DepartmentID=100 And (MachineType ='Web Offset') " + strfilter + " /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  And CompanyId = " + CompanyID + "  " + MachineIDFilter + "";
                            }
                            else
                            {
                                str = "SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW,  Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) AS IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime, JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine ,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                  " FROM MachineMaster Where /*DepartmentID=0 AND*/ Isnull(IsDeletedTransaction,0)=0 And (MachineType In ('Sheetfed Offset', 'Digital') Or Isnull(IsPlanningMachine,0)=1 ) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  " + strfilter + " And CompanyId = " + CompanyID + " AND MachineID IN (Select MachineID From MachineOnlineCoatingRates Where CoatingName =  '" + GblOnlineCoating + "')  " + MachineIDFilter + " Union SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW, Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime , JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                  " FROM MachineMaster Where Isnull(IsDeletedTransaction,0)=0 And DepartmentID=100 And (MachineType ='Web Offset') /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  " + strfilter + " And CompanyId = " + CompanyID + " AND MachineID IN (Select MachineID From MachineOnlineCoatingRates Where CoatingName =  '" + GblOnlineCoating + "')   " + MachineIDFilter + "";
                            }
                            DBConnection.FillDataTable(ref dataTable, str);
                            if (dataTable.Rows.Count == 0 && totalColors > 0)
                            {
                                strfilter = " AND ISNULL(Colors,0) > 0 AND ISNULL(IsPlanningMachine,0) = 1";

                                if (noCoating)
                                {
                                    str = "SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW,  Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) AS IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime, JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine ,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                      " FROM MachineMaster Where /*DepartmentID=0 AND*/ Isnull(IsDeletedTransaction,0)=0 And (MachineType In ('Sheetfed Offset', 'Digital') Or Isnull(IsPlanningMachine,0)=1 ) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  " + strfilter + " And CompanyId = " + CompanyID + " " + MachineIDFilter + " Union SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW, Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime , JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                      " FROM MachineMaster Where Isnull(IsDeletedTransaction,0)=0 And DepartmentID=100 And (MachineType ='Web Offset') " + strfilter + " /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  And CompanyId = " + CompanyID + "  " + MachineIDFilter + "";
                                }
                                else
                                {
                                    str = "SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW,  Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) AS IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime, JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine ,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                      " FROM MachineMaster Where /*DepartmentID=0 AND*/ Isnull(IsDeletedTransaction,0)=0 And (MachineType In ('Sheetfed Offset', 'Digital') Or Isnull(IsPlanningMachine,0)=1 ) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  " + strfilter + " And CompanyId = " + CompanyID + " AND MachineID IN (Select MachineID From MachineOnlineCoatingRates Where CoatingName =  '" + GblOnlineCoating + "')  " + MachineIDFilter + " Union SELECT MachineId, MachineName, Isnull(MaxLength,0) as MaxLength, Isnull(MaxWidth,0) as MaxWidth, Isnull(MinLength,0) As MinLength, Isnull(MinWidth,0) As MinWidth, Isnull(MaxPrintL,0) As MaxPrintL, Isnull(MaxPrintW,0) As MaxPrintW, Isnull(MinPrintL,0) As MinPrintL, Isnull(MinPrintW,0) As MinPrintW, Isnull(Colors,0) As Colors,Isnull(MachineType,'') As MachineType,Isnull(ChargesType,'') As ChargesType, Isnull(Gripper,0) As Gripper, Isnull(IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(RoundofImpressionsWith,0) As RoundofImpressionsWith, MachineType, Isnull(BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MachineSpeed,0) As MachineSpeed, Isnull(MakeReadyTime,0) As MakeReadyTime , JobChangeOverTime, WastageType, WastageCalculationOn,Isnull(IsSpecialMachine,0) As IsSpecialMachine,Isnull(MachineSpeed,0) AS SpeedRunningMeters,Isnull(PerHourCost,0) AS PerHourCost,Isnull(MinRollWidth,0) AS MinRollWidth,Isnull(MaxRollWidth,0) AS MaxRollWidth,Isnull(MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MachineWidth,0) AS MachineWidth,Isnull(AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(AverageRollLength,0) AS AverageRollLength,Isnull(RollChangeTime,0) AS RollChangeTime,0 AS ToolID,Null AS ToolCode,Null AS Manufecturer,0 AS CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,0 AS WebCutOffSizeMin,0 AS WebCutOffSize,Isnull(IsVariableCutOff,0) AS IsVariableCutOff,Isnull(PlateCharges,0) AS PlateCharges,Isnull(PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                      " FROM MachineMaster Where Isnull(IsDeletedTransaction,0)=0 And DepartmentID=100 And (MachineType ='Web Offset') /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  " + strfilter + " And CompanyId = " + CompanyID + " AND MachineID IN (Select MachineID From MachineOnlineCoatingRates Where CoatingName =  '" + GblOnlineCoating + "')   " + MachineIDFilter + "";
                                }
                            }
                        }
                        else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "FLEXO")
                            str = "SELECT MM.MachineId, MM.MachineName, Isnull(MM.MaxLength,0) as MaxLength, Isnull(MM.MaxWidth,0) as MaxWidth, Isnull(MM.MinLength,0) As MinLength, Isnull(MM.MinWidth,0) As MinWidth, Isnull(MM.MaxPrintL,0) As MaxPrintL, Isnull(MM.MaxPrintW,0) As MaxPrintW, Isnull(MM.MinPrintL,0) As MinPrintL, Isnull(MM.MinPrintW,0) As MinPrintW, Isnull(MM.Colors,0) As Colors,Isnull(MM.MachineType,'') As MachineType,Isnull(MM.ChargesType,'') As ChargesType, Isnull(MM.Gripper,0) As Gripper, Isnull(MM.IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(MM.RoundofImpressionsWith,0) As RoundofImpressionsWith, MM.MachineType, Isnull(MM.BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MM.MachineSpeed,0) As MachineSpeed, Isnull(MM.MakeReadyTime,0) As MakeReadyTime , MM.JobChangeOverTime, MM.WastageType, MM.WastageCalculationOn,Isnull(MM.IsSpecialMachine,0) As IsSpecialMachine,Isnull(MM.MachineSpeed,0) AS SpeedRunningMeters,Isnull(MM.PerHourCost,0) AS PerHourCost,Isnull(MM.MinRollWidth,0) AS MinRollWidth,Isnull(MM.MaxRollWidth,0) AS MaxRollWidth,Isnull(MM.MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(MM.AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MM.MachineWidth,0) AS MachineWidth,Isnull(MM.AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(MM.AverageRollLength,0) AS AverageRollLength,Isnull(MM.RollChangeTime,0) AS RollChangeTime,TM.ToolID,TM.ToolCode,TM.Manufecturer,Isnull(TM.SizeW,0) AS CylinderWidth,Isnull(TM.NoOfTeeth,0) as NoOfTeeth,Isnull(TM.CircumferenceMM,0) as CircumferenceMM,Isnull(TM.CircumferenceInch,0) as CircumferenceInch,Isnull(MM.WebCutOffSizeMin,0) as WebCutOffSizeMin,Isnull(MM.WebCutOffSize,0) as WebCutOffSize,Isnull(MM.PlateCharges,0) AS PlateCharges,Isnull(MM.PlateChargesType,'') AS PlateChargesType,PerHourCostingParameter " +
                                  " FROM MachineMaster AS MM LEFT JOIN MachineToolAllocationMaster AS MTM ON MTM.MachineID=MM.MachineID AND MTM.CompanyID=MM.CompanyID AND MTM.ToolGroupID IN(Select ToolGroupID From ToolGroupMaster Where ToolGroupNameID=-5 AND CompanyID=" + CompanyID + ") LEFT JOIN ToolMaster AS TM ON TM.ToolID=MTM.ToolID AND TM.CompanyID=MTM.CompanyID Where Isnull(MM.IsDeletedTransaction,0)=0 And MM.DepartmentID=100 And (MM.MachineType  IN('Flexo','Dry Web Offset')) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  And MM.CompanyId = " + CompanyID + "  " + MachineIDFilter.Replace("MachineID", "MM.MachineID") + "" + (Gbl_Cylinder_Tool_ID != 0 ? " AND MTM.ToolID=" + Gbl_Cylinder_Tool_ID : "") + "";
                        else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "ROTOGRAVURE")
                            str = "SELECT MM.MachineId, MM.MachineName, Isnull(MM.MaxLength,0) as MaxLength, Isnull(MM.MaxWidth,0) as MaxWidth, Isnull(MM.MinLength,0) As MinLength, Isnull(MM.MinWidth,0) As MinWidth, Isnull(MM.MaxPrintL,0) As MaxPrintL, Isnull(MM.MaxPrintW,0) As MaxPrintW, Isnull(MM.MinPrintL,0) As MinPrintL, Isnull(MM.MinPrintW,0) As MinPrintW, Isnull(MM.Colors,0) As Colors,Isnull(MM.MachineType,'') As MachineType,Isnull(MM.ChargesType,'') As ChargesType, Isnull(MM.Gripper,0) As Gripper, Isnull(MM.IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(MM.RoundofImpressionsWith,0) As RoundofImpressionsWith, MM.MachineType, Isnull(MM.BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MM.MachineSpeed,0) As MachineSpeed, Isnull(MM.MakeReadyTime,0) As MakeReadyTime , MM.JobChangeOverTime, MM.WastageType, MM.WastageCalculationOn,Isnull(MM.IsSpecialMachine,0) As IsSpecialMachine,Isnull(MM.MachineSpeed,0) AS SpeedRunningMeters,Isnull(MM.PerHourCost,0) AS PerHourCost,Isnull(MM.MinRollWidth,0) AS MinRollWidth,Isnull(MM.MaxRollWidth,0) AS MaxRollWidth,Isnull(MM.MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(MM.AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MM.MachineWidth,0) AS MachineWidth,Isnull(MM.AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(MM.AverageRollLength,0) AS AverageRollLength,Isnull(MM.RollChangeTime,0) AS RollChangeTime,0 AS ToolID,NULL AS ToolCode,NULL AS Manufecturer,0 AS  CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,MM.WebCutOffSizeMin,MM.WebCutOffSize  " + " FROM MachineMaster AS MM  Where Isnull(MM.IsDeletedTransaction,0)=0 And MM.DepartmentID=100 And (MM.MachineType  IN('Roto Gravure')) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  And MM.CompanyId = " + CompanyID + "  " + MachineIDFilter.Replace("MachineID", "MM.MachineID");
                        else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "LARGEFORMAT")
                            str = "SELECT MM.MachineId, MM.MachineName, Isnull(MM.MaxLength,0) as MaxLength, Isnull(MM.MaxWidth,0) as MaxWidth, Isnull(MM.MinLength,0) As MinLength, Isnull(MM.MinWidth,0) As MinWidth, Isnull(MM.MaxPrintL,0) As MaxPrintL, Isnull(MM.MaxPrintW,0) As MaxPrintW, Isnull(MM.MinPrintL,0) As MinPrintL, Isnull(MM.MinPrintW,0) As MinPrintW, Isnull(MM.Colors,0) As Colors,Isnull(MM.MachineType,'') As MachineType,Isnull(MM.ChargesType,'') As ChargesType, Isnull(MM.Gripper,0) As Gripper, Isnull(MM.IsPerfectaMachine,0) As IsPerfectaMachine, Isnull(MM.RoundofImpressionsWith,0) As RoundofImpressionsWith, MM.MachineType, Isnull(MM.BasicPrintingCharges,0) As BasicPrintingCharges, Isnull(MM.MachineSpeed,0) As MachineSpeed, Isnull(MM.MakeReadyTime,0) As MakeReadyTime , MM.JobChangeOverTime, MM.WastageType, MM.WastageCalculationOn,Isnull(MM.IsSpecialMachine,0) As IsSpecialMachine,Isnull(MM.MachineSpeed,0) AS SpeedRunningMeters,Isnull(MM.PerHourCost,0) AS PerHourCost,Isnull(MM.MinRollWidth,0) AS MinRollWidth,Isnull(MM.MaxRollWidth,0) AS MaxRollWidth,Isnull(MM.MinCircumference,0) AS MinCircumference,Isnull(MaxCircumference,0) AS MaxCircumference,Isnull(MakeReadyWastageRunningMeter,0) AS MakeReadyWastageRunningMeter,Isnull(AvgBreakDownTime,0) AS AvgBreakDownTime,Isnull(MM.AvgBreakDownRunningMeters,0) AS AvgBreakDownRunningMeters,Isnull(MM.MachineWidth,0) AS MachineWidth,Isnull(MM.AverageRollChangeWastage,0) AS AverageRollChangeWastage,Isnull(MM.AverageRollLength,0) AS AverageRollLength,Isnull(MM.RollChangeTime,0) AS RollChangeTime,0 AS ToolID,NULL AS ToolCode,NULL AS Manufecturer,0 AS  CylinderWidth,0 AS NoOfTeeth,0 AS CircumferenceMM,0 AS CircumferenceInch,MM.WebCutOffSizeMin,MM.WebCutOffSize  " + " FROM MachineMaster AS MM  Where Isnull(MM.IsDeletedTransaction,0)=0 And MM.DepartmentID=100 And (MM.MachineType  IN('Large Format')) /*AND (Isnull(Colors,0) >= " + Gbl_Front_Color + ")*/  And MM.CompanyId = " + CompanyID + "  " + MachineIDFilter.Replace("MachineID", "MM.MachineID");
                    }
                    else if (k == "Slitting_Machine")
                        str = "Select MachineID, MachineName, Gripper, MaxReelSize, WebCutOffSize, MinReelSize, WebCutOffSizeMin, MachineType From MachineMaster Where CompanyId = " + CompanyID + " /*" + (string.IsNullOrEmpty(MachineIDFilter) ? "" : MachineIDFilter + "  And DepartmentID = 0") + "*/ AND (MachineType In ('Reel to Sheet Cutting')) ";
                    else if (k == "Machine_Online_Coating_Rates")
                        str = "SELECT MachineID, SheetRangeFrom, SheetRangeTo, CoatingName, Rate, RateType, BasicCoatingCharges FROM MachineOnlineCoatingRates WHERE CompanyId = " + CompanyID + " AND CoatingName='" + GblOnlineCoating + "' " + (string.IsNullOrEmpty(MachineIDFilter) ? "" : MachineIDFilter) + " ORDER BY MachineID, SheetRangeFrom, SheetRangeTo";
                    else if (k == "Operation_Slabs")
                        str = "SELECT DISTINCT PM.TypeofCharges, Case When ISNULL(PMS.Rate, 0)=0 Then Round(ISNULL(PM.Rate, 0),4) Else Round(ISNULL(PMS.Rate, 0),4) End AS Rate, Case When PMS.MinimumCharges=0 Then PM.MinimumCharges Else PMS.MinimumCharges End As MinimumCharges, PM.SetupCharges, PM.SizeToBeConsidered, PM.ChargeApplyOnSheets, PM.PrePress, PM.ProcessID, PM.ProcessName,Isnull(PMS.FromQty,0) AS FromQty,IsNull(PMS.ToQty,0) As ToQty,Isnull(PMS.RateFactor,'') As RateFactor FROM ProcessMaster AS PM Left JOIN ProcessMasterSlabs AS PMS ON PMS.ProcessID = PM.ProcessID And PMS.IsLocked=0 And PM.CompanyID=PMS.CompanyID Where PM.ProcessId In (" + GblOperId + ") And PM.CompanyId = " + CompanyID + " And Isnull(PM.IsDeletedTransaction,0)<>1 ";
                    else if (k == "Corrugation_Machine")
                        str = "Select MachineID, MachineName, Gripper, MaxReelSize, WebCutOffSize, MinReelSize, WebCutOffSizeMin, MachineType From MachineMaster Where CompanyId = " + CompanyID + " AND (MachineType In ('Corrugation'))  ";
                    else if (k == "CompanyMaster")
                        str = "Select * From CompanyMaster Where CompanyId = " + CompanyID + "";
                    else if (k == "DieMaster")
                    {
                        str = " Select TM.ToolID,Nullif(TM.ToolCode,'') as ToolCode,Nullif(TM.ToolName,'') as ToolName,Nullif(TM.ToolDescription,'') as ToolDescription,Isnull(TM.LedgerName,'-') As LedgerName,TM.SizeL,TM.SizeW,TM.SizeH,ISNULL(TM.UpsL,0) as UpsL,ISNULL(TM.UpsW,0) as UpsW,ISNULL(TM.TotalUps,0) as TotalUps,TM.Manufecturer From ToolMaster AS TM INNER JOIN ToolGroupMaster AS TG ON TM.ToolGroupID =TG.ToolGroupID Where TG.ToolGroupNameID IN(-3,-8) " +
                              " and (TM.SizeL >= (" + Gbl_Job_L + ") and TM.SizeL <= (" + Gbl_Job_L + "))  " +
                              " and (TM.SizeW >= (" + Gbl_Job_W + ") and TM.SizeW <= (" + Gbl_Job_W + "))  " +
                              " and (TM.SizeH >= (" + Gbl_Job_H + ") and TM.SizeH <= (" + Gbl_Job_H + ")) Order BY TM.ToolCode ";
                    }
                }

                DBConnection.FillDataTable(ref dataTable, str);
                return dataTable;
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return dataTable;
            }
        }

        static DataTable ConvertJsonToDataTable(JObject jsonObject)
        {
            DataTable table = new DataTable();
            foreach (var property in jsonObject.Properties())
            {
                table.Columns.Add(property.Name, typeof(string));
            }
            DataRow row = table.NewRow();
            foreach (var property in jsonObject.Properties())
            {
                row[property.Name] = property.Value.ToString();
            }
            table.Rows.Add(row);
            return table;
        }
        public static string ConvertToSqlList(string input)
        {
            if (string.IsNullOrWhiteSpace(input))
                return string.Empty;

            var items = input.Split(',')
                             .Select(x => $"'{x.Trim()}'");

            return string.Join(",", items);
        }
        public static string FormatCommaSeparatedString(string input)
        {
            if (string.IsNullOrWhiteSpace(input))
                return string.Empty;

            return string.Join(",", input
                .Split(',')
                .Select(s => s.Trim())
                .Where(s => !string.IsNullOrEmpty(s))
                .Select(s => $"'{s}'"));
        }
        public string Shirin_Job(string jsonData, string type)
        {
            JavaScriptSerializer js = new JavaScriptSerializer();
            js.MaxJsonLength = 2147483647;
            DataSet Dataset = new DataSet();
            try
            {
                CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
                AppName = DBConnection.AppName.ToUpper();
                DataTable dt = new DataTable();
                double Job_Pasting_Flap;
                string errStr = "";
                GblDTOprFactors = new DataTable();
                if (type == "directcosting")
                {
                    dt = DBConnection.ConvertJsonStringToDataTable(jsonData);
                }
                else
                {
                    JObject jsonObject = JObject.Parse(jsonData);
                    dt = ConvertJsonToDataTable(jsonObject);
                }

                // Dimensions
                Gbl_Job_H = dt.Rows[0]["SizeHeight"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeHeight"]);
                Gbl_Job_L = dt.Rows[0]["SizeLength"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeLength"]);
                Gbl_Job_W = dt.Rows[0]["SizeWidth"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeWidth"]);
                Gbl_Job_Open_Flap = dt.Rows[0]["SizeOpenflap"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeOpenflap"]);
                Job_Pasting_Flap = dt.Rows[0]["SizePastingflap"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizePastingflap"]);
                Gbl_Job_Pasting_Flap = dt.Rows[0]["SizePastingflap"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizePastingflap"]);
                Gbl_Job_Pasting_Flap = dt.Rows[0]["SizePastingflap"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizePastingflap"]);
                Gbl_Job_Bottom_Flap = dt.Rows[0]["SizeBottomflap"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeBottomflap"]);

                // Job Info
                Gbl_Job_Pages = dt.Rows[0]["JobNoOfPages"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["JobNoOfPages"]);
                Gbl_Job_Ups = dt.Rows[0]["JobUps"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["JobUps"]);
                Gbl_Job_Tongue_Height = dt.Rows[0]["JobTongHeight"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["JobTongHeight"]);

                // Plan Details
                Gbl_Orientation = dt.Rows[0]["PlanContentType"] == DBNull.Value ? "" : dt.Rows[0]["PlanContentType"].ToString().Trim();
                Gbl_Front_Color = dt.Rows[0]["PlanFColor"] == DBNull.Value ? (byte)0 : Convert.ToByte(dt.Rows[0]["PlanFColor"]);
                Gbl_Back_Color = dt.Rows[0]["PlanBColor"] == DBNull.Value ? (byte)0 : Convert.ToByte(dt.Rows[0]["PlanBColor"]);
                Gbl_ColorStrip = dt.Rows[0]["PlanColorStrip"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PlanColorStrip"]);
                Gbl_Gripper = dt.Rows[0]["PlanGripper"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PlanGripper"]);
                Gbl_Printing_Style = dt.Rows[0]["PlanPrintingStyle"] == DBNull.Value ? "" : dt.Rows[0]["PlanPrintingStyle"].ToString().Trim();
                Gbl_Required_Printing_Style = Gbl_Printing_Style;
                Gbl_Flat_Wastage_Value = dt.Rows[0]["PlanWastageValue"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PlanWastageValue"]);

                Gbl_Plan_Grain_Direction = dt.Rows[0]["PlanPrintingGrain"] == DBNull.Value ? "" : dt.Rows[0]["PlanPrintingGrain"].ToString().Trim();

                // Paper & Material
                Gbl_Paper_Quality = dt.Rows[0]["ItemPlanQuality"] == DBNull.Value ? "" : dt.Rows[0]["ItemPlanQuality"].ToString();
                Gbl_Paper_GSM = dt.Rows[0]["ItemPlanGsm"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["ItemPlanGsm"]);
                Gbl_Paper_Thickness = dt.Rows[0]["ItemPlanThickness"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["ItemPlanThickness"]);
                Gbl_Estimation_Unit = dt.Rows[0]["EstimationQuantityUnit"] == DBNull.Value ? "" : dt.Rows[0]["EstimationQuantityUnit"].ToString();

                Gbl_Job_Center_Seal = dt.Rows[0]["SizeCenterSeal"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeCenterSeal"]);
                Gbl_Job_Side_Seal = dt.Rows[0]["SizeSideSeal"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeSideSeal"]);
                Gbl_Job_Top_Seal = dt.Rows[0]["SizeTopSeal"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeTopSeal"]);
                Gbl_Job_Bottom_Gusset = dt.Rows[0]["SizeBottomGusset"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["SizeBottomGusset"]);

                Gbl_Plan_Make_Ready_Wastage = dt.Rows[0]["PlanMakeReadyWastage"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PlanMakeReadyWastage"]);
                Gbl_Other_Material_GSM = dt.Rows[0]["PlanOtherMaterialGSM"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PlanOtherMaterialGSM"]);
                PlanOtherMaterialGSMSettingJSON = dt.Rows[0]["PlanOtherMaterialGSMSettingJSON"] == DBNull.Value ? "" : dt.Rows[0]["PlanOtherMaterialGSMSettingJSON"].ToString();
                ContentSizeInputUnit = dt.Rows[0]["JobSizeInputUnit"] == DBNull.Value ? "" : dt.Rows[0]["JobSizeInputUnit"].ToString();
                GblShowPlanUptoWastagePerc = Convert.ToSingle(dt.Rows[0]["ShowPlanUptoWastePercent"] == DBNull.Value ? 0 : dt.Rows[0]["ShowPlanUptoWastePercent"]);

                // Paper Mill & Finish
                Gbl_Paper_Mill = dt.Rows[0]["ItemPlanMill"] == DBNull.Value ? "" : dt.Rows[0]["ItemPlanMill"].ToString();
                Gbl_Paper_Finish = dt.Rows[0]["ItemPlanFinish"] == DBNull.Value ? "" : dt.Rows[0]["ItemPlanFinish"].ToString();

                // Plate, Wastage Type, Quantity
                Gbl_Plate_Type = dt.Rows[0]["PlanPlateType"] == DBNull.Value ? "" : dt.Rows[0]["PlanPlateType"].ToString().Trim();
                Gbl_Flat_Wastage_Type = dt.Rows[0]["PlanWastageType"] == DBNull.Value ? "" : dt.Rows[0]["PlanWastageType"].ToString().Trim();
                Gbl_Order_Quantity = dt.Rows[0]["PlanContQty"] == DBNull.Value ? 0 : Convert.ToSingle(dt.Rows[0]["PlanContQty"]);
                Gbl_Special_Front_Color = dt.Rows[0]["PlanSpeFColor"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["PlanSpeFColor"]);
                Gbl_Special_Back_Color = dt.Rows[0]["PlanSpeBColor"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["PlanSpeBColor"]);
                PlanContName = dt.Rows[0]["PlanContName"] == DBNull.Value ? "" : dt.Rows[0]["PlanContName"].ToString().Trim();

                GblOperId = dt.Rows[0]["OperId"] == DBNull.Value ? "" : dt.Rows[0]["OperId"].ToString().Trim();

                // Paper Detail Filter
                Gbl_Paper_Detail = $" Quality='{Gbl_Paper_Quality.Trim()}' and GSM={Gbl_Paper_GSM.ToString().Trim()} and (Manufecturer='{Gbl_Paper_Mill.Trim()}' Or Finish='{Gbl_Paper_Finish.Trim()}')";

                // Plan Checks
                Check_Plan_In_Special_Size = dt.Rows[0]["ChkPlanInSpecialSizePaper"] == DBNull.Value ? false : Convert.ToBoolean(dt.Rows[0]["ChkPlanInSpecialSizePaper"]);
                Check_Plan_In_Standard_Size = dt.Rows[0]["ChkPlanInStandardSizePaper"] == DBNull.Value ? false : Convert.ToBoolean(dt.Rows[0]["ChkPlanInStandardSizePaper"]);

                if (dt.Rows[0]["MachineId"] != DBNull.Value && dt.Rows[0]["MachineId"].ToString().Trim() != "")
                {
                    MachineIDFilter = " And MachineID In (" + dt.Rows[0]["MachineId"].ToString().Trim() + ")";
                }

                GblOnlineCoating = dt.Rows[0]["PlanOnlineCoating"] == DBNull.Value || dt.Rows[0]["PlanOnlineCoating"].ToString().Trim() == "" ? "None" : dt.Rows[0]["PlanOnlineCoating"].ToString().Trim();

                // Paper Trimming
                Gbl_Paper_TrimmingLR = (dt.Rows[0]["PaperTrimleft"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PaperTrimleft"])) + (dt.Rows[0]["PaperTrimright"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PaperTrimright"]));
                Gbl_Paper_TrimmingTB = (dt.Rows[0]["PaperTrimtop"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PaperTrimtop"])) + (dt.Rows[0]["PaperTrimbottom"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["PaperTrimbottom"]));

                // Trimming and Striping
                Gbl_Job_Trimming_LR = (dt.Rows[0]["Trimmingleft"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Trimmingleft"])) + (dt.Rows[0]["Trimmingright"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Trimmingright"]));
                Gbl_Job_Trimming_TB = (dt.Rows[0]["Trimmingtop"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Trimmingtop"])) + (dt.Rows[0]["Trimmingbottom"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Trimmingbottom"]));
                Gbl_Striping_LR = (dt.Rows[0]["Stripingleft"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Stripingleft"])) + (dt.Rows[0]["Stripingright"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Stripingright"]));
                Gbl_Striping_TB = (dt.Rows[0]["Stripingtop"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Stripingtop"])) + (dt.Rows[0]["Stripingbottom"] == DBNull.Value ? 0 : Convert.ToDouble(dt.Rows[0]["Stripingbottom"]));

                // Client/Paper Checks
                CheckPaperByClient = dt.Rows[0]["ChkPaperByClient"] == DBNull.Value ? false : Convert.ToBoolean(dt.Rows[0]["ChkPaperByClient"]);
                ChkPlanInAvailableStock = dt.Rows[0]["ChkPlanInAvailableStock"] == DBNull.Value ? false : Convert.ToBoolean(dt.Rows[0]["ChkPlanInAvailableStock"]);
                ChkBackToBackPastingRequired = dt.Rows[0]["ChkBackToBackPastingRequired"] == DBNull.Value ? false : Convert.ToBoolean(dt.Rows[0]["ChkBackToBackPastingRequired"]);

                // Job Ups in Layout
                Gbl_Job_Across_Ups = dt.Rows[0]["JobAcrossUps"] == DBNull.Value ? 1 : Convert.ToInt32(dt.Rows[0]["JobAcrossUps"]);
                Gbl_Job_Around_Ups = dt.Rows[0]["JobAroundUps"] == DBNull.Value ? 1 : Convert.ToInt32(dt.Rows[0]["JobAroundUps"]);

                // Plate, Wastage Type, Quantity
                Gbl_Plate_Bearer = dt.Rows[0]["PlanPlateBearer"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["PlanPlateBearer"]);
                Gbl_Standard_AR_Gap = dt.Rows[0]["PlanStandardARGap"] == DBNull.Value ? 1.25 : Convert.ToDouble(dt.Rows[0]["PlanStandardARGap"]);
                Gbl_Standard_AC_Gap = dt.Rows[0]["PlanStandardACGap"] == DBNull.Value ? 3 : Convert.ToDouble(dt.Rows[0]["PlanStandardACGap"]);
                Gbl_Content_Domain_Type = dt.Rows[0]["PlanContDomainType"] == DBNull.Value ? "Offset" : dt.Rows[0]["PlanContDomainType"].ToString();

                // Label Type and Winding Direction
                Gbl_labeltype = dt.Rows[0]["Planlabeltype"] == DBNull.Value ? "" : dt.Rows[0]["Planlabeltype"].ToString();
                Gbl_windingdirection = dt.Rows[0]["Planwindingdirection"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["Planwindingdirection"]);
                Gbl_finishedformat = dt.Rows[0]["Planfinishedformat"] == DBNull.Value ? "" : dt.Rows[0]["Planfinishedformat"].ToString();
                Gbl_dietype = dt.Rows[0]["Plandietype"] == DBNull.Value ? "" : dt.Rows[0]["Plandietype"].ToString();

                // Core Details
                Gbl_LabelPerRoll = dt.Rows[0]["PlanPcsPerRoll"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["PlanPcsPerRoll"]);
                Gbl_CoreInnerDia = dt.Rows[0]["PlanCoreInnerDia"] == DBNull.Value ? 0f : Convert.ToSingle(dt.Rows[0]["PlanCoreInnerDia"]);
                Gbl_CoreOuterDia = dt.Rows[0]["PlanCoreOuterDia"] == DBNull.Value ? 0f : Convert.ToSingle(dt.Rows[0]["PlanCoreOuterDia"]);


                Gbl_Category_ID = dt.Rows[0]["CategoryID"] == DBNull.Value ? 0 : Convert.ToInt32(dt.Rows[0]["CategoryID"]);
                Gbl_Job_Bottom_Flap_Per = Convert.ToDouble(dt.Rows[0]["SizeBottomflapPer"] == DBNull.Value ? 0 : Convert.ToDecimal(dt.Rows[0]["SizeBottomflapPer"]));
                Gbl_LedgerID = dt.Rows[0].IsNull("LedgerID") ? 0 : Convert.ToInt32(dt.Rows[0]["LedgerID"]);
                ProductionUnitID = dt.Rows[0]["ProductionUnitID"] == DBNull.Value ? "" : dt.Rows[0]["ProductionUnitID"].ToString().Trim();
                //ProductionUnitID = (1).ToString();
                //JobName = dt.Rows[0]["JobName"].ToString();
                //ClientName = dt.Rows[0]["ClientName"].ToString();
                //JobPrePlan = dt.Rows[0]["JobPrePlan"].ToString();
                string ConversationID = "0";

                if (type.ToLower() == "costingbot" || type.ToLower() == "directcosting")
                {
                    AnnualQuantity = dt.Rows[0]["AnnualQuantity"] == DBNull.Value ? 0 : Convert.ToSingle(dt.Rows[0]["AnnualQuantity"]);
                    JobName = dt.Rows[0]["JobName"].ToString();
                    ClientName = dt.Rows[0]["ClientName"].ToString();
                    DataTable Com_Table = new DataTable();
                    Com_MachieId = "";
                    Com_ProcessIDStr = "";
                    Com_MateialIDStr = "";
                    Check_Plan_In_Special_Size = true;
                    dt.Rows[0]["ChkPlanInSpecialSizePaper"] = true;
                    if (Gbl_Category_ID == 0)
                    {
                        return "Category selection is required to proceed.";
                    }
                    str = "Select CM.CategoryID,CM.CategoryName,PM.DepartmentID,CM.DefaultJobTrimmingTop,CM.DefaultJobTrimmingBottom,CM.DefaultJobTrimmingLeft,CM.DefaultJobTrimmingRight,CM.DefaultPrintingMarginTop,CM.DefaultPrintingMarginBottom,CM.DefaultPrintingMarginLeft,CM.DefaultPrintingMarginRight,CM.DefaultStrippingMarginTop,CM.DefaultStrippingMarginBottom,CM.DefaultStrippingMarginLeft,CM.DefaultStrippingMarginRight,COM.* from CategoryMaster As CM Inner JOIN CombinationMaster as COM ON COM.CombinationCode = CM.CombinationCode INNER JOIN ProcessMaster as PM On PM.ProcessID =  COM.ProcessID Where ISNULL(CM.IsDeletedTransaction,0) = 0 And CategoryID = " + Gbl_Category_ID;
                    DBConnection.FillDataTable(ref Com_Table, str);
                    string proStr = "";
                    if (Com_Table.Rows.Count > 0)
                    {

                        // Paper Trimming default accotording to category
                        Gbl_Paper_TrimmingLR = (Com_Table.Rows[0]["DefaultPrintingMarginLeft"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultPrintingMarginLeft"])) + (Com_Table.Rows[0]["DefaultPrintingMarginRight"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultPrintingMarginRight"]));
                        Gbl_Paper_TrimmingTB = (Com_Table.Rows[0]["DefaultPrintingMarginTop"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultPrintingMarginTop"])) + (Com_Table.Rows[0]["DefaultPrintingMarginBottom"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultPrintingMarginBottom"]));

                        // Trimming default accotording to category
                        Gbl_Job_Trimming_LR = (Com_Table.Rows[0]["DefaultJobTrimmingLeft"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultJobTrimmingLeft"])) + (Com_Table.Rows[0]["DefaultJobTrimmingRight"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultJobTrimmingRight"]));
                        Gbl_Job_Trimming_TB = (Com_Table.Rows[0]["DefaultJobTrimmingTop"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultJobTrimmingTop"])) + (Com_Table.Rows[0]["DefaultJobTrimmingBottom"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultJobTrimmingBottom"]));

                        //Striping default accotording to category
                        Gbl_Striping_LR = (Com_Table.Rows[0]["DefaultStrippingMarginLeft"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultStrippingMarginLeft"])) + (Com_Table.Rows[0]["DefaultStrippingMarginRight"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultStrippingMarginRight"]));
                        Gbl_Striping_TB = (Com_Table.Rows[0]["DefaultStrippingMarginTop"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultStrippingMarginTop"])) + (Com_Table.Rows[0]["DefaultStrippingMarginBottom"] == DBNull.Value ? 0 : Convert.ToDouble(Com_Table.Rows[0]["DefaultStrippingMarginBottom"]));


                        Com_MachieId = Com_Table.Rows[0]["MachineID"].ToString();
                        Com_ProcessIDStr = Com_Table.Rows[0]["ProcessID"].ToString();
                        Com_MateialIDStr = Com_Table.Rows[0]["ItemSubGroupID"].ToString();

                        List<string> processIds = new List<string>();
                        foreach (DataRow row in Com_Table.Rows)
                        {
                            processIds.Add(row["ProcessID"].ToString());
                            if (row["DepartmentID"].ToString() == "100")
                            {
                                MachineIDFilter = " And MachineID In (" + Com_MachieId + ")";
                            }
                        }
                        proStr = string.Join(",", processIds);
                    }
                    str = "Select ProcessID, Rate, '' as RateFactor, ProcessName, 0 as MachineID, 0 as MachineSpeed, MakeReadyTime, 0 as JobChangeOverTime, 0 as MakeReadyPerHourCost, 0 as MachinePerHourCost, '' as Remarks, 0 as PaperConsumptionRequired, DM.SequenceNo as DepartmentSequenceNo, ProcessFlatWastageValue, ProcessWastagePercentage, ProcessProductionType, PerHourCostingParameter, 0 as PerHourCalculationQuantity,0 as SetupCost,0 as SetupTime From ProcessMaster AS PM INNER JOIN DepartmentMaster AS DM ON DM.DepartmentID = PM.DepartmentID WHERE PM.CompanyID = " + CompanyID + " And PM.ProcessId IN(" + proStr + ")";
                    DBConnection.FillDataTable(ref GblDTOprFactors, str);

                    if (type.ToLower() == "costingbot")
                    {
                        ConversationID = HttpContext.Current.Session["ConversationID"].ToString();
                    }
                    if (GblDTOprFactors.Rows.Count > 0)
                    {
                        dt.Rows[0]["OperId"] = proStr;
                        GblOperId = proStr;
                        DBConnection.ExecuteNonSQLQuery("Insert OpenAiInputParameters(ConversationID, InputJSON, CompanyID, UserID) Values(" + ConversationID + ",'" + DBConnection.ConvertDataTableToJsonString(dt) + "'," + Convert.ToInt64(HttpContext.Current.Session["CompanyID"]) + "," + Convert.ToInt64(HttpContext.Current.Session["UserID"]) + ")");
                    }
                }
                else
                {
                    str = "Select ProcessID,Rate,'' as RateFactor,ProcessName,0 as MachineID,0 as MachineSpeed,MakeReadyTime,0 as JobChangeOverTime,0 as MakeReadyPerHourCost,0 as MachinePerHourCost,'' as Remarks,0 as PaperConsumptionRequired,DM.SequenceNo as DepartmentSequenceNo,ProcessFlatWastageValue,ProcessWastagePercentage,ProcessProductionType,PerHourCostingParameter,0 as PerHourCalculationQuantity " +
                     " From ProcessMaster AS PM INNER JOIN DepartmentMaster AS DM ON DM.DepartmentID = PM.DepartmentID WHERE PM.CompanyID = " + CompanyID + " And PM.ProcessID IN(" + GblOperId + ")";
                    DBConnection.FillDataTable(ref GblDTOprFactors, str);
                }

                dt = null/* TODO Change to default(_) if this is not a reference type */;

                if (Gbl_Job_W == 0)
                    Gbl_Job_W = Gbl_Job_H;
                else if (Gbl_Job_H == 0)
                    Gbl_Job_H = Gbl_Job_W;
                if (Gbl_Job_Leaves == 0)
                    Gbl_Job_Leaves = Gbl_Job_Pages;
                if (Gbl_Job_Overlap_Flap == 0)
                    Gbl_Job_Overlap_Flap = Job_Pasting_Flap;

                if (Gbl_Content_Domain_Type.ToString().ToUpper() == "OFFSET")
                {
                    k = "Paper_Planning";
                    Gbl_DT_Paper = GetDataTable();
                    DataView dataViewItems = Gbl_DT_Paper.DefaultView;
                    dataViewItems.RowFilter = "ItemGroupName = 'Reel'";
                    GblDTReel = Gbl_DT_Paper.Clone();
                    GblDTReel.Clear();
                    foreach (DataRowView rowView in dataViewItems)
                    {
                        GblDTReel.ImportRow(rowView.Row);
                    }

                    if (Gbl_DT_Paper.Rows.Count > 0)
                    {
                        if (Check_Plan_In_Special_Size)
                        {
                            DataRow R = Gbl_DT_Paper.NewRow();
                            foreach (DataColumn column in Gbl_DT_Paper.Columns)//|| column.ColumnName == "SizeL"  //Removed by Abhinav & Vivek on 11-11-2025 
                            {
                                if (column.ColumnName == "SizeW" || column.ColumnName == "PaperID" || column.ColumnName == "WtPerPacking" || column.ColumnName == "PaperTrimming")
                                {
                                    R[column.ColumnName] = 0;
                                }
                                else
                                {
                                    R[column.ColumnName] = Gbl_DT_Paper.Rows[0][column.ColumnName];
                                }
                            }
                            Gbl_DT_Paper.Rows.Add(R);

                        }
                        Gbl_Packing = DBNull.Value.Equals(Gbl_DT_Paper.Rows[0][4]) ? "" : Gbl_DT_Paper.Rows[0][4].ToString();
                        Gbl_Unit_Per_Packing = DBNull.Value.Equals(Gbl_DT_Paper.Rows[0][5]) ? "0" : Gbl_DT_Paper.Rows[0][5].ToString();
                        GblMainPaperGroup = DBNull.Value.Equals(Gbl_DT_Paper.Rows[0]["PaperGroup"]) ? "" : Gbl_DT_Paper.Rows[0]["PaperGroup"].ToString();
                    }
                    else
                    {
                        planErrors = "Selected Paper detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another Paper size or deselect Standard size check";
                        return planErrors;
                    }
                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "FLEXO")
                {
                    k = "Flexo_Roll_Planning";
                    GblDTRoll = GetDataTable();
                    if (GblDTRoll.Rows.Count > 0)
                    {
                        if (Check_Plan_In_Special_Size)
                        {
                            DataRow R = GblDTRoll.NewRow();
                            foreach (DataColumn column in GblDTRoll.Columns)
                            {
                                if (column.ColumnName == "SizeW" || column.ColumnName == "PaperID")
                                {
                                    R[column.ColumnName] = 0;
                                }
                                else
                                {
                                    R[column.ColumnName] = GblDTRoll.Rows[0][column.ColumnName];
                                }
                            }
                            GblDTRoll.Rows.Add(R);
                        }
                        Gbl_Packing = "";
                        Gbl_Unit_Per_Packing = "1";
                        GblMainPaperGroup = DBNull.Value.Equals(GblDTRoll.Rows[0]["PaperGroup"]) ? "" : GblDTRoll.Rows[0]["PaperGroup"].ToString(); // Fixed DBNull check
                    }
                    else
                    {
                        planErrors = "Selected Roll detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another roll size or deselect Standard size check";
                        return planErrors;
                    }
                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "ROTOGRAVURE")
                {
                    k = "Roto_Gravure_Planning";
                    GblDTRoll = GetDataTable();

                    if (GblDTRoll.Rows.Count > 0)
                    {
                        if (Check_Plan_In_Special_Size)
                        {
                            DataRow R = GblDTRoll.NewRow();
                            foreach (DataColumn column in GblDTRoll.Columns)
                            {
                                if (column.ColumnName == "SizeW" || column.ColumnName == "PaperID")
                                {
                                    R[column.ColumnName] = 0;
                                }
                                else
                                {
                                    R[column.ColumnName] = GblDTRoll.Rows[0][column.ColumnName];
                                }
                            }
                            GblDTRoll.Rows.Add(R);
                        }
                        Gbl_Packing = "";
                        Gbl_Unit_Per_Packing = "1";
                        GblMainPaperGroup = DBNull.Value.Equals(GblDTRoll.Rows[0]["PaperGroup"]) ? "" : GblDTRoll.Rows[0]["PaperGroup"].ToString(); // Fixed DBNull check
                    }

                    else
                    {
                        planErrors = "Selected Roll detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another roll size or deselect Standard size check";
                        return (planErrors);
                    }
                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "LARGEFORMAT")
                {
                    k = "Large_Format_Planning";
                    GblDTRoll = GetDataTable();

                    if (GblDTRoll.Rows.Count > 0)
                    {
                        if (Check_Plan_In_Special_Size)
                        {
                            DataRow R = GblDTRoll.NewRow();

                            foreach (DataColumn column in GblDTRoll.Columns)
                            {
                                if (column.ColumnName == "SizeW" || column.ColumnName == "PaperID")
                                {
                                    R[column.ColumnName] = 0;
                                }
                                else
                                {
                                    R[column.ColumnName] = GblDTRoll.Rows[0][column.ColumnName];
                                }
                            }
                            GblDTRoll.Rows.Add(R);
                        }
                        Gbl_Packing = "";
                        Gbl_Unit_Per_Packing = "1";
                        GblMainPaperGroup = DBNull.Value.Equals(GblDTRoll.Rows[0]["PaperGroup"]) ? "" : GblDTRoll.Rows[0]["PaperGroup"].ToString();
                    }
                    else
                    {
                        planErrors = "Selected Roll detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another roll size or deselect Standard size check";
                        return (planErrors);
                    }
                }
                LoadAllGrids();

                if (Gbl_DT_Machine.Rows.Count <= 0)
                {
                    planErrors = "Machine not found in the database, Plan in total colors is " + Convert.ToInt16(Gbl_Front_Color) + Convert.ToInt16(Gbl_Back_Color) + "..! Please check total colors of machine";
                    return (planErrors);
                }

                if (Gbl_Content_Domain_Type.ToString().ToUpper() == "OFFSET")
                {
                    if (Gbl_Printing_Style == "Choose Best")
                    {
                        Gbl_Printing_Style = "Work & Turn";
                        Plan_Job_Pre();
                        Gbl_Printing_Style = "Work & Tumble";
                        Plan_Job_Pre();
                        Gbl_Printing_Style = "Front & Back";
                        Plan_Job_Pre();
                        Gbl_Printing_Style = "FB-Perfection";
                        Plan_Job_Pre();
                    }
                    else
                        Plan_Job_Pre();
                }
                else
                    Plan_Job_Pre();

                if (Gbl_DT_plan.Rows.Count < 1)
                {
                    if (planErrors == "")
                        planErrors = "Check Job Size: Job size may be larger than available Paper size or Machine Size. " + " Check Paper Size: Suitable paper size may not be available in selected Paper Group.  " + " Check Grain Direction: Grain Direction may not be correct. " + " Check Printing Style: Printing Style may not be correct. " + " Check Color Strip, Gripper,  Plate Type, Job Trimming, Stripping Margin, Printing Margin";
                    return (planErrors);
                }

                Gbl_DT_plan.TableName = "TblPlanning";
                Rf_Dt_Opr.TableName = "TblOperations";
                GblDTBook.TableName = "TblBookForms";

                Dataset.Merge(Gbl_DT_plan);
                Dataset.Merge(Rf_Dt_Opr);
                Dataset.Merge(GblDTBook);
                var sortedRows = Gbl_DT_plan.AsEnumerable()
            .OrderBy(row => SafeDecimal(row["TotalAmount"]))
            .ThenBy(row => SafeDecimal(row["WastageKg"]));
                decimal SafeDecimal(object value)
                {
                    if (value == null || value == DBNull.Value)
                        return 0;

                    decimal result;
                    return decimal.TryParse(value.ToString(), out result) ? result : 0;
                }

                DataTable Costingdetails = new DataTable();

                Costingdetails.Columns.Add("PlanID", typeof(int));
                Costingdetails.Columns.Add("PaperID", typeof(int));
                Costingdetails.Columns.Add("PaperRate", typeof(double));
                Costingdetails.Columns.Add("PaperAmount", typeof(double));
                Costingdetails.Columns.Add("PrintingRate", typeof(double));
                Costingdetails.Columns.Add("FinalQuantity", typeof(int));
                Costingdetails.Columns.Add("TotalAmount", typeof(double));
                Costingdetails.Columns.Add("UnitPrice", typeof(double));
                Costingdetails.Columns.Add("PlateAmount", typeof(double));
                Costingdetails.Columns.Add("ActualSheets", typeof(int));
                Costingdetails.Columns.Add("WastageSheets", typeof(int));
                Costingdetails.Columns.Add("WastePerc", typeof(double));
                Costingdetails.Columns.Add("WastageKg", typeof(double));
                Costingdetails.Columns.Add("TotalPaperWeightInKg", typeof(double));
                Costingdetails.Columns.Add("FullSheets", typeof(int));

                Costingdetails.Columns.Add("TotalMaterialCost", typeof(double));
                Costingdetails.Columns.Add("MaterialCost1000", typeof(double));
                Costingdetails.Columns.Add("TotalMachieRunCost", typeof(double));
                Costingdetails.Columns.Add("MachieRunCost1000", typeof(double));
                Costingdetails.Columns.Add("TotalMachieSetupCost", typeof(double));
                Costingdetails.Columns.Add("MachieSetupCost1000", typeof(double));
                Costingdetails.Columns.Add("CreditDays", typeof(double));
                Costingdetails.Columns.Add("ProfitPercentage", typeof(double));
                Costingdetails.Columns.Add("ProfitCost", typeof(double));
                Costingdetails.Columns.Add("UnitCost1000", typeof(double));
                Costingdetails.Columns.Add("FinalCost", typeof(double));
                Costingdetails.Columns.Add("QuotedCost", typeof(double));
                Costingdetails.Columns.Add("TotalCost", typeof(double));
                Costingdetails.Columns.Add("AnnualQuantity", typeof(double));
                Costingdetails.Columns.Add("TotalLabourCost", typeof(double));
                Costingdetails.Columns.Add("LabourCost1000", typeof(double));
                Costingdetails.Columns.Add("ProcessWiseWastagePer", typeof(double));
                Costingdetails.Columns.Add("ProcessWiseWastageType", typeof(string));
                Costingdetails.Columns.Add("CreditCost", typeof(double));
                Costingdetails.Columns.Add("CreditCost1000", typeof(double));
                Costingdetails.Columns.Add("FreightRate", typeof(double));
                Costingdetails.Columns.Add("FreightCost", typeof(double));
                Costingdetails.Columns.Add("FreightCost1000", typeof(double));
                Costingdetails.Columns.Add("TotalWeightOfJob", typeof(double));
                Costingdetails.Columns.Add("BoardCost1000", typeof(double));
                Costingdetails.Columns.Add("OtherMaterialCost", typeof(double));
                Costingdetails.Columns.Add("ConversionCost", typeof(double));

                if (type.ToLower() == "costingbot" || type.ToLower() == "directcosting")
                {
                    DataTable sortedTable = sortedRows.Take(1).CopyToDataTable();
                    DataTable AllocatedMaterials = new DataTable();
                    DataTable AllocatedMaterialParams = new DataTable();
                    DataTable TablePrcoess = FilterRowsByPlanID(Rf_Dt_Opr, sortedTable.Rows[0]["PlanID"].ToString());
                    DataTable dataTable = new DataTable();

                    double CreditDays = 0;
                    double FreightRate = 0;
                    str = "Select Distinct S.WastagePer,S.WastageType,DefaultProfit,FreightRate,ISNULL((Select Distinct CreditDays from LedgerMaster Where ISNULL(IsDeletedTransaction,0) = 0 And LedgerID = '" + Gbl_LedgerID + "'),0) as CreditDays from CategoryMaster as CM INNER JOIN ProcessWiseWastageSetting as S ON S.WastageType = CM.ProcessWiseWastageType Where CategoryID = " + Gbl_Category_ID + " And SheetFrom < " + sortedTable.Rows[0]["ActualSheets"] + " And SheetTo >= " + sortedTable.Rows[0]["ActualSheets"] + " ";
                    DBConnection.FillDataTable(ref dataTable, str);
                    if (dataTable.Rows.Count > 0)
                    {
                        ProcessWiseWastagePer = dataTable.Rows.Count > 0 && dataTable.Rows[0]["WastagePer"] != DBNull.Value ? Convert.ToDouble(dataTable.Rows[0]["WastagePer"]) : 0.0;
                        ProcessWiseWastageType = dataTable.Rows.Count > 0 && dataTable.Rows[0]["WastageType"] != DBNull.Value && !string.IsNullOrWhiteSpace(dataTable.Rows[0]["WastageType"].ToString()) ? dataTable.Rows[0]["WastageType"].ToString() : string.Empty;
                        DefaultProfit = dataTable.Rows.Count > 0 && dataTable.Rows[0]["DefaultProfit"] != DBNull.Value ? Convert.ToDouble(dataTable.Rows[0]["DefaultProfit"]) : 0.0;
                        CreditDays = dataTable.Rows.Count > 0 && dataTable.Rows[0]["CreditDays"] != DBNull.Value ? Convert.ToDouble(dataTable.Rows[0]["CreditDays"]) : 0.0;
                        FreightRate = dataTable.Rows.Count > 0 && dataTable.Rows[0]["FreightRate"] != DBNull.Value ? Convert.ToDouble(dataTable.Rows[0]["FreightRate"]) : 0.0;
                    }

                    ApplyCostingCalculations(ref sortedTable, ref TablePrcoess, Gbl_Category_ID, ProductionUnitID, ref AllocatedMaterials, ref AllocatedMaterialParams);
                    double TotalMaterialCost = 0.00;
                    double TotalLabourCost = 0.00;
                    double TotalMachieRunCost = 0.00;
                    double TotalMachieSetupCost = 0.00;
                    double TotalFreightWeight = 0.00;

                    var materialLookup = AllocatedMaterials.AsEnumerable().GroupBy(r => Convert.ToInt32(r["ItemSubGroupID"])).ToDictionary(g => g.Key, g => g.ToList());
                    if (TablePrcoess.Rows.Count > 0)
                    {
                        foreach (DataRow Row in TablePrcoess.Rows)
                        {
                            TotalMachieRunCost += Convert.ToDouble(Row["ExecutionCost"]);
                            TotalMachieSetupCost += Convert.ToDouble(Row["SetupCost"]);
                        }
                    }

                    if (AllocatedMaterialParams.Rows.Count > 0)
                    {
                        foreach (DataRow paramRow in AllocatedMaterialParams.Rows)
                        {
                            string fieldName = paramRow["FieldName"]?.ToString();
                            if (string.IsNullOrEmpty(fieldName))
                                continue;

                            if (!double.TryParse(paramRow["FieldValue"]?.ToString(), out double value))
                                continue;

                            int itemSubGroupID = Convert.ToInt32(paramRow["ItemSubGroupID"]);

                            if (!materialLookup.TryGetValue(itemSubGroupID, out var materialRows))
                                continue;

                            switch (fieldName.ToUpperInvariant())
                            {
                                case "ESTIMATEDAMOUNT":
                                    TotalMaterialCost += value;
                                    foreach (var row in materialRows)
                                    {
                                        row["EstimatedAmount"] = value;
                                    }
                                    break;

                                case "REQUIREDQUANTITYINSTOCKUNIT":
                                    foreach (var row in materialRows)
                                    {
                                        row["RequiredQuantityInStockUnit"] = value;
                                        row["EstimatedQuantity"] = value;
                                    }
                                    break;

                                case "PURCHASEUNIT":
                                    foreach (var row in materialRows)
                                    {
                                        row["PurchaseUnit"] = value;
                                        row["EstimationRate"] = value;
                                        row["RequiredQtyUnit"] = value;
                                    }
                                    break;

                                case "RATE":
                                    foreach (var row in materialRows)
                                    {
                                        row["EstimationRate"] = value;
                                    }
                                    break;

                                case "LABOURCOST":
                                    foreach (var row in materialRows)
                                    {
                                        TotalLabourCost += value;
                                    }
                                    break;

                                case "FREIGHTWEIGHTKG":
                                    foreach (var row in materialRows)
                                    {
                                        TotalFreightWeight += value;
                                    }
                                    break;
                            }
                        }
                    }

                    double totalWeightOfJob = TotalFreightWeight + (double)(sortedTable.Rows[0]["TotalPaperWeightInKg"]);

                    double totalAmt = Math.Round((double)sortedTable.Rows[0]["TotalAmount"], 2, MidpointRounding.AwayFromZero);
                    double qty = (double)Gbl_Order_Quantity;
                    TotalMaterialCost = Math.Round(TotalMaterialCost - TotalLabourCost, 2, MidpointRounding.AwayFromZero);
                    double platecostPer1000 = Math.Round(Convert.ToDouble(sortedTable.Rows[0]["PlateAmount"]) / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double MachinecostPer1000 = Math.Round(TotalMachieRunCost / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double setupcostPer1000 = Math.Round(TotalMachieSetupCost / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double papercostPer1000 = Math.Round((double)sortedTable.Rows[0]["PaperAmount"] / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double wastagecost = Math.Round((double)sortedTable.Rows[0]["PaperAmount"] * ProcessWiseWastagePer / 100, 2, MidpointRounding.AwayFromZero);
                    double wastagecostPer1000 = Math.Round(wastagecost / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double materialcostPer1000 = Math.Round(TotalMaterialCost / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double creditper = Math.Round((double)((CreditDays / 365) * 12), 2, MidpointRounding.AwayFromZero);
                    double creditcost = Math.Round((((totalAmt + TotalMaterialCost + TotalMachieRunCost + TotalMachieSetupCost + wastagecost + TotalLabourCost) * creditper) / 100), 2, MidpointRounding.AwayFromZero);
                    double creditcostPer1000 = Math.Round(creditcost / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double profit = Math.Round(((totalAmt + TotalMaterialCost + TotalMachieRunCost + TotalMachieSetupCost + wastagecost + creditcost + TotalLabourCost) * DefaultProfit) / 100, 2, MidpointRounding.AwayFromZero);
                    double profit1000 = Math.Round(profit / qty * 1000, 2, MidpointRounding.AwayFromZero);
                    double LabourCost1000 = Math.Round(TotalLabourCost / qty * 1000, 2, MidpointRounding.AwayFromZero);

                    double freightcost = totalWeightOfJob * FreightRate;
                    double freightcost1000 = Math.Round(freightcost / qty * 1000, 2, MidpointRounding.AwayFromZero);

                    double UnitPrice1000 = Math.Round((((totalAmt + TotalMaterialCost + TotalMachieRunCost + TotalMachieSetupCost + wastagecost + TotalLabourCost + creditcost + profit + freightcost) / qty) * 1000), 2, MidpointRounding.AwayFromZero);
                    double UnitPrice = Math.Round(((totalAmt + TotalMaterialCost + TotalMachieRunCost + TotalMachieSetupCost + wastagecost + TotalLabourCost + creditcost + profit + freightcost) / qty), 2, MidpointRounding.AwayFromZero);
                    double Totalcost = Math.Round((totalAmt + TotalMaterialCost + TotalMachieRunCost + TotalMachieSetupCost + wastagecost + TotalLabourCost + creditcost + profit + freightcost), 2, MidpointRounding.AwayFromZero);

                    double BoardCost = Math.Round(papercostPer1000, 2);
                    double OtherMaterialCost = Math.Round(materialcostPer1000 + wastagecostPer1000 + platecostPer1000, 2);
                    double ConversionCost = Math.Round(setupcostPer1000 + MachinecostPer1000 + creditcostPer1000 + LabourCost1000, 2);

                    for (int i = 0; i < sortedTable.Rows.Count; i++)
                    {
                        Costingdetails.Rows.Add(sortedTable.Rows[i]["PlanID"],
                            sortedTable.Rows[i]["PaperID"], Math.Round(Convert.ToDouble(sortedTable.Rows[i]["PaperRate"]), 2, MidpointRounding.AwayFromZero), Math.Round(Convert.ToDouble(sortedTable.Rows[i]["PaperAmount"]), 2, MidpointRounding.AwayFromZero), Math.Round(Convert.ToDouble(sortedTable.Rows[i]["PrintingRate"]), 2, MidpointRounding.AwayFromZero),
                            sortedTable.Rows[i]["FinalQuantity"], Math.Round(Convert.ToDouble(sortedTable.Rows[i]["TotalAmount"]), 2, MidpointRounding.AwayFromZero), Math.Round(UnitPrice, 2, MidpointRounding.AwayFromZero), Math.Round(Convert.ToDouble(sortedTable.Rows[i]["PlateAmount"]), 2, MidpointRounding.AwayFromZero),
                            sortedTable.Rows[i]["ActualSheets"], sortedTable.Rows[i]["WastageSheets"], Math.Round(Convert.ToDouble(sortedTable.Rows[i]["WastePerc"]), 2, MidpointRounding.AwayFromZero), Math.Round(Convert.ToDouble(sortedTable.Rows[i]["WastageKg"]), 2, MidpointRounding.AwayFromZero),
                            Math.Round(Convert.ToDouble(sortedTable.Rows[i]["TotalPaperWeightInKg"]), 2, MidpointRounding.AwayFromZero), sortedTable.Rows[i]["FullSheets"], Math.Round(TotalMaterialCost, 2, MidpointRounding.AwayFromZero), Math.Round(materialcostPer1000, 2, MidpointRounding.AwayFromZero), Math.Round(TotalMachieRunCost, 2, MidpointRounding.AwayFromZero),
                            Math.Round(MachinecostPer1000, 2, MidpointRounding.AwayFromZero), Math.Round(TotalMachieSetupCost, 2, MidpointRounding.AwayFromZero), Math.Round(setupcostPer1000, 2, MidpointRounding.AwayFromZero), CreditDays, DefaultProfit, Math.Round(profit, 2, MidpointRounding.AwayFromZero), Math.Round(UnitPrice1000, 2, MidpointRounding.AwayFromZero), Math.Round(UnitPrice1000, 2, MidpointRounding.AwayFromZero),
                            Math.Round(UnitPrice1000, 2, MidpointRounding.AwayFromZero), Math.Round(Totalcost, 2, MidpointRounding.AwayFromZero), AnnualQuantity, Math.Round(TotalLabourCost, 2, MidpointRounding.AwayFromZero), Math.Round(LabourCost1000, 2, MidpointRounding.AwayFromZero),
                            ProcessWiseWastagePer, ProcessWiseWastageType, creditcost, creditcostPer1000, FreightRate, freightcost, freightcost1000, totalWeightOfJob, BoardCost, OtherMaterialCost, ConversionCost);
                    }

                    string jsonStringDetailCost = JsonConvert.SerializeObject(Costingdetails);
                    string jsonString = JsonConvert.SerializeObject(sortedTable);
                    string jsonStringProcess = JsonConvert.SerializeObject(TablePrcoess);
                    string jsonStringMaterials = JsonConvert.SerializeObject(AllocatedMaterials);
                    string jsonStringMaterialsParams = JsonConvert.SerializeObject(AllocatedMaterialParams);

                    str = "Insert into OpenAiEstimationPlans(ChatID,ContentType,Top5Plans,CreatedAt,DetailCostParameters,CompanyID,UserID,ProcessJSON,ConversationID,AllocatedMaterialJSON,AllocatedMaterialParamsJSON,TotalMaterialCost,AnnualQuantity) Values(0,'Top Plans','" + jsonString + "',GETDATE(),'" + jsonStringDetailCost + "','" + Convert.ToInt64(HttpContext.Current.Session["CompanyID"]) + "','" + Convert.ToInt64(HttpContext.Current.Session["UserID"]) + "','" + jsonStringProcess + "','" + Convert.ToInt64(HttpContext.Current.Session["ConversationID"]) + "','" + jsonStringMaterials + "','" + jsonStringMaterialsParams + "'," + TotalMaterialCost + "," + AnnualQuantity + ")";
                    DBConnection.ExecuteNonSQLQuery(str);
                    if (type.ToLower() == "costingbot")
                    {
                        string json =
                        "COSTING SUMMARY – BEST PRODUCTION PLAN\n" +
                        "\n" +
                        "{\n" +
                        "  \"Type\": \"CostingBot\",\n" +
                        "  \"Title\": \"COSTING SUMMARY – BEST PRODUCTION PLAN\",\n" +
                        "  \"CustomerDetails\": {\n" +
                        "    \"CustomerName\": \"" + ClientName + "\",\n" +
                        "    \"JobName\": \"" + JobName + "\",\n" +
                        "    \"SheetSize\": \"" + sortedTable.Rows[0]["PaperSize"] + "\",\n" +
                        "    \"OrderQuantity\": " + Gbl_Order_Quantity + ",\n" +
                        "    \"Ups\": " + sortedTable.Rows[0]["TotalUps"] + ",\n" +
                        "    \"RequiredSheets\": " + sortedTable.Rows[0]["FullSheets"] + "\n" +
                        "  },\n" +
                        "  \"CostStructurePer1000\": {\n" +
                        "    \"BoardCost\": " + BoardCost + ",\n" +
                        "    \"OtherMaterialCost\": " + OtherMaterialCost + ",\n" +
                        "    \"ConversionCost\": " + ConversionCost + ",\n" +
                        "    \"Profit\": " + Math.Round(profit1000, 2) + ",\n" +
                        "    \"FreightCost\": " + Math.Round(freightcost1000, 2) + ",\n" +
                        "    \"TotalCostPer1000\": " + Math.Round(UnitPrice1000, 2) + "\n" +
                        "  }\n" +
                        "}";
                        return json;
                    }
                    else
                    {
                        DataSet Dset = new DataSet();
                        sortedTable.TableName = "TblPlanning";
                        TablePrcoess.TableName = "TblOperations";
                        Dset.Merge(sortedTable);
                        Dset.Merge(TablePrcoess);
                        return DBConnection.ConvertDataSetsToJsonString(Dset);
                    }
                }

                DataTable Table = sortedRows.CopyToDataTable();
                return DBConnection.ConvertDataTableToJsonString(Table);
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return (planErrors);
            }
        }
        public class ShirinJobMasterRequest
        {
            public object ObjJobSize { get; set; }
            public object ObjOpr { get; set; }
            public double PlateRate { get; set; }
            public double PaperRate { get; set; }
            public double MakeReadyRate { get; set; }
            public double CoatingRate { get; set; }
        }


        public string ShirinJobMaster(ShirinJobMasterRequest request)
        {
            JavaScriptSerializer js = new JavaScriptSerializer();
            js.MaxJsonLength = 2147483647;
            DataSet Dataset = new DataSet();
            double Gbl_Rect_L = 0, Gbl_Rect_H = 0, Job_H = 0, Job_W = 0, Job_L;
            double Tool_Cylinder_Circumference_MM;
            try
            {
                CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
                DataTable dt = new DataTable();
                Gbl_Make_Ready_Rate = request.MakeReadyRate; // ' Added by Vivek on 04-June-25
                Gbl_Coating_Rate = request.CoatingRate; // ' Added by Vivek on 04-June-25
                DBConnection.ConvertObjectToDatatable(request.ObjOpr, ref GblDTOprFactors, ref str);
                DBConnection.ConvertObjectToDatatable(request.ObjJobSize, ref dt, ref str);
                // Gbl_Sheet_W = Val(dt.Rows(0)(0))
                // Gbl_Sheet_L = Val(dt.Rows(0)(1))
                DataRow row = dt.Rows[0];

                string SafeString(object v) => v == DBNull.Value ? "" : v.ToString().Trim();
                double SafeDouble(object v) => v == DBNull.Value ? 0 : Convert.ToDouble(v);
                int SafeInt(object v) => v == DBNull.Value ? 0 : Convert.ToInt32(v);
                decimal SafeDecimal(object v) => v == DBNull.Value ? 0 : Convert.ToDecimal(v);

                if (SafeString(row["CutSize"]) != "")
                    Seperate_Paper_Size(row["CutSize"].ToString(), ref Gbl_Sheet_L, ref Gbl_Sheet_W);
                else
                {
                    Gbl_Sheet_L = 0;
                    Gbl_Sheet_W = 0;
                }

                Gbl_Orientation = SafeString(row["PlanContentType"]);
                Gbl_UPS_L = SafeInt(row["UpsL"]);
                Gbl_UPS_H = SafeInt(row["UpsH"]);
                Gbl_Machine_ID = SafeInt(row["MachineId"]);
                Gbl_Order_Quantity = SafeInt(row["PlanContQty"]);
                Gbl_Job_Pages = SafeInt(row["JobNoOfPages"]);
                Gbl_Printing_Style = SafeString(row["PlanPrintingStyle"]);

                Gbl_Front_Color = (row["PlanFColor"]) == DBNull.Value ? (byte)0 : Convert.ToByte(row["PlanFColor"]);
                Gbl_Back_Color = (row["PlanBColor"]) == DBNull.Value ? (byte)0 : Convert.ToByte(row["PlanBColor"]);
                Gbl_Special_Front_Color = SafeInt(row["PlanSpeFColor"]);
                Gbl_Special_Back_Color = SafeInt(row["PlanSpeBColor"]);

                Gbl_Flat_Wastage_Type = SafeString(row["PlanWastageType"]) == "" ? "Machine Default" : SafeString(row["PlanWastageType"]);
                Gbl_Flat_Wastage_Value = SafeDouble(row["PlanWastageValue"]);
                Gbl_Grain_Direction = SafeString(row["PlanPrintingGrain"]) == "" ? "With Grain" : SafeString(row["PlanPrintingGrain"]);

                Gbl_Paper_Quality = SafeString(row["ItemPlanQuality"]);
                Gbl_Paper_GSM = SafeInt(row["ItemPlanGsm"]);
                Gbl_Paper_Mill = SafeString(row["ItemPlanMill"]);
                Gbl_Paper_Finish = SafeString(row["ItemPlanFinish"]);

                Gbl_Paper_Thickness = SafeDouble(row["ItemPlanThickness"]);
                Gbl_Estimation_Unit = SafeString(row["EstimationQuantityUnit"]);

                Gbl_Plate_Type = SafeString(row["PlanPlateType"]);
                Gbl_Plan_Type = SafeString(row["PlanType"]);
                Gbl_Paper_ID = SafeInt(row["PaperID"]);

                GblOnlineCoating = SafeString(row["PlanOnlineCoating"]);
                if (string.IsNullOrWhiteSpace(GblOnlineCoating)) GblOnlineCoating = "None";

                GblMainPaperGroup = SafeString(row["PaperGroup"]);
                Gbl_GripperSide = SafeString(row["GripperSide"]) == "" ? "L" : SafeString(row["GripperSide"]);
                Gbl_Machine_Gripper = SafeInt(row["PlanGripper"]);
                GblOperId = SafeString(row["OperId"]);
                Gbl_Content_Domain_Type = SafeString(row["PlanContDomainType"]) == "" ? "Offset" : SafeString(row["PlanContDomainType"]);
                Gbl_Plate_Bearer = SafeDouble(row["PlanPlateBearer"]);
                Gbl_Standard_AR_Gap = row["PlanStandardARGap"] == DBNull.Value ? 1.25 : Convert.ToDouble(row["PlanStandardARGap"]);
                Gbl_Standard_AC_Gap = row["PlanStandardACGap"] == DBNull.Value ? 3 : Convert.ToDouble(row["PlanStandardACGap"]);
                Job_H = SafeDouble(row["SizeHeight"]);
                Job_W = SafeDouble(row["SizeWidth"]);
                Job_L = SafeDouble(row["SizeLength"]);
                Gbl_Cylinder_Tool_ID = SafeInt(row["CylinderToolID"]);

                Gbl_labeltype = row["Planlabeltype"] == DBNull.Value ? "" : row["Planlabeltype"].ToString();
                Gbl_windingdirection = row["Planwindingdirection"] == DBNull.Value ? 0 : Convert.ToInt32(row["Planwindingdirection"]);
                Gbl_finishedformat = row["Planfinishedformat"] == DBNull.Value ? "" : row["Planfinishedformat"].ToString();
                Gbl_dietype = row["Plandietype"] == DBNull.Value ? "" : row["Plandietype"].ToString();

                Gbl_LabelPerRoll = row["PlanPcsPerRoll"] == DBNull.Value ? 0 : Convert.ToInt32(row["PlanPcsPerRoll"]);
                Gbl_CoreInnerDia = row["PlanCoreInnerDia"] == DBNull.Value ? 0f : Convert.ToSingle(row["PlanCoreInnerDia"]);
                Gbl_CoreOuterDia = row["PlanCoreOuterDia"] == DBNull.Value ? 0f : Convert.ToSingle(row["PlanCoreOuterDia"]);

                Gbl_Job_L = SafeDouble(row["SizeLength"]);
                Gbl_Job_W = SafeDouble(row["SizeWidth"]);
                Gbl_Job_H = SafeDouble(row["SizeHeight"]);
                Gbl_Job_Open_Flap = SafeDouble(row["SizeOpenflap"]);

                Gbl_Job_Pasting_Flap = SafeDouble(row["SizePastingflap"]);
                Gbl_Job_Bottom_Flap = SafeDouble(row["SizeBottomflap"]);
                Gbl_Job_Center_Seal = SafeDouble(row["SizeCenterSeal"]);
                Gbl_Job_Side_Seal = SafeDouble(row["SizeSideSeal"]);
                Gbl_Job_Top_Seal = SafeDouble(row["SizeTopSeal"]);
                Gbl_Job_Bottom_Gusset = SafeDouble(row["SizeBottomGusset"]);
                Gbl_Job_Zipper_Length = SafeDouble(row["SizeZipperLength"]);
                Gbl_Job_Zipper_Weight_Per_Meter = SafeDouble(row["ZipperWeightPerMeter"]);

                Gbl_Plan_Make_Ready_Wastage = SafeDouble(row["PlanMakeReadyWastage"]);
                Gbl_Other_Material_GSM = SafeDouble(row["PlanOtherMaterialGSM"]);
                PlanOtherMaterialGSMSettingJSON = SafeString(row["PlanOtherMaterialGSMSettingJSON"]);

                Gbl_Plan_Grain_Direction = SafeString(row["PlanPrintingGrain"]) == "" ? "Both" : SafeString(row["PlanPrintingGrain"]);

                Gbl_Category_ID = SafeInt(row["CategoryID"]);
                Gbl_Book_Spine = SafeDouble(row["BookSpine"]);
                ChkBackToBackPastingRequired = (bool)(row["ChkBackToBackPastingRequired"]);
                ContentSizeInputUnit = SafeString(row["JobSizeInputUnit"]);
                ProductionUnitID = row["ProductionUnitID"] == DBNull.Value ? "" : row["ProductionUnitID"].ToString().Trim();

                Gbl_Job_Across_Ups = SafeInt(row["JobAcrossUps"]);
                Gbl_Job_Around_Ups = SafeInt(row["JobAroundUps"]);
                //GblPreviousPlateQty = SafeInt(row["PlateQty"]);
                if (Gbl_Machine_ID != 0)
                {
                    MachineIDFilter = " AND MachineID IN (" + Gbl_Machine_ID.ToString() + ")";
                }
                else
                {
                    MachineIDFilter = "";
                }

                Gbl_Job_Ups = Gbl_UPS_L * Gbl_UPS_H;

                int paperId = Gbl_Paper_ID;
                string domain = Gbl_Content_Domain_Type?.ToString().ToUpper() ?? "";
                if (paperId == 0)
                {
                    if (domain == "ROTOGRAVURE" || domain == "FLEXO" || domain == "LARGEFORMAT")
                    {
                        Gbl_Sheet_W = SafeInt(dt.Rows[0]["PaperSize"]);
                    }
                }
                dt = null/* TODO Change to default(_) if this is not a reference type */;

                if (Gbl_Job_Leaves == 0 & (Gbl_Orientation == "WiroLeaves" | Gbl_Orientation == "MultipleLeaves" | Gbl_Orientation == "MultipleLeaves"))
                    Gbl_Job_Leaves = Gbl_Job_Pages;


                if (Gbl_Content_Domain_Type.ToString().ToUpper() == "OFFSET")
                {
                    Gbl_Paper_Detail = $" Quality='{Gbl_Paper_Quality.Trim()}'" + $" AND GSM={Gbl_Paper_GSM}" + $" AND (Manufecturer='{Gbl_Paper_Mill.Trim()}' OR Finish='{Gbl_Paper_Finish.Trim()}')";
                    LoadPaperGrid(Gbl_Content_Domain_Type, ref Gbl_DT_Paper);
                    if (Gbl_DT_Paper.Rows.Count == 0)
                    {
                        planErrors = "Selected Paper detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another Paper size or deselect Standard size check";
                        return planErrors;
                    }
                    Gbl_DT_Paper.Rows[0]["EstimationRate"] = request.PaperRate;

                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "ROTOGRAVURE")
                {
                    //if (Gbl_Grain_Direction == "With Grain")
                    //{
                    //    string orientation = Gbl_Orientation.ToUpper();

                    //    if (orientation == "CENTERSEALPOUCH")
                    //    {
                    //        Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Top_Seal * 2);
                    //        Gbl_Rect_L = (Gbl_Job_W * 2) + (Gbl_Job_Center_Seal * 2);
                    //    }
                    //    else if (orientation == "STANDUPPOUCH")
                    //    {
                    //        Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Bottom_Gusset * 2);
                    //        Gbl_Rect_L = (Gbl_Job_W * 2);
                    //    }
                    //    else if (orientation == "FLATBOTTOMPOUCH")
                    //    {
                    //        Gbl_Rect_H = Gbl_Job_L;
                    //        Gbl_Rect_L = (Gbl_Job_W * 2) + (Gbl_Job_Pasting_Flap * 2);
                    //    }
                    //    else if (orientation == "FOURSIDESEALPOUCH")
                    //    {
                    //        Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Side_Seal * 2);
                    //        Gbl_Rect_L = (Gbl_Job_W + (Gbl_Job_Side_Seal * 2)) * 2;
                    //    }
                    //    else if (orientation == "THREESIDESEALPOUCH")
                    //    {
                    //        // No calculation provided originally
                    //    }
                    //    else if (orientation == "PILLOWPOUCH")
                    //    {
                    //        Gbl_Rect_H = Gbl_Job_L;
                    //        Gbl_Rect_L = (Gbl_Job_W * 2) + (Gbl_Job_Pasting_Flap * 2);
                    //    }
                    //    else if (orientation == "SPOUTPOUCH")
                    //    {
                    //        Gbl_Rect_H = Gbl_Job_L;
                    //        Gbl_Rect_L = Gbl_Job_W;
                    //    }
                    //    else if (orientation == "ROTOLABEL" || orientation == "OPENSIZEPOUCHWITHZIPPER")
                    //    {
                    //        Gbl_Rect_H = Gbl_Job_L;
                    //        Gbl_Rect_L = Gbl_Job_W;
                    //    }
                    //}

                    //else if (Gbl_Orientation.ToUpper() == "CENTERSEALPOUCH")
                    //{
                    //    Gbl_Rect_H = (Gbl_Job_W * 2) + (Val(Gbl_Job_Center_Seal) * 2);
                    //    Gbl_Rect_L = Gbl_Job_H + (Val(Gbl_Job_Top_Seal) * 2);
                    //}
                    //else if (Gbl_Orientation.ToUpper() == "STANDUPPOUCH")
                    //{
                    //    Gbl_Rect_H = (Gbl_Job_W * 2);
                    //    Gbl_Rect_L = Gbl_Job_L + (Val(Gbl_Job_Bottom_Gusset) * 2);
                    //}
                    //else if (Gbl_Orientation.ToUpper() == "FLATBOTTOMPOUCH")
                    //{
                    //    Gbl_Rect_H = (Gbl_Job_W * 2) + (Val(Gbl_Job_Pasting_Flap) * 2);
                    //    Gbl_Rect_L = Gbl_Job_L;
                    //}
                    //else if (Gbl_Orientation.ToUpper() == "FOURSIDESEALPOUCH")
                    //{
                    //    Gbl_Rect_H = ((Gbl_Job_W + Val(Gbl_Job_Side_Seal) * 2) * 2);
                    //    Gbl_Rect_L = (Gbl_Job_H + Val(Gbl_Job_Side_Seal) * 2);
                    //}
                    //else if (Gbl_Orientation.ToUpper() == "THREESIDESEALPOUCH")
                    //{
                    //}
                    //else if (Gbl_Orientation.ToUpper() == "PILLOWPOUCH")
                    //{
                    //    Gbl_Rect_H = (Gbl_Job_W * 2) + (Val(Gbl_Job_Pasting_Flap) * 2);
                    //    Gbl_Rect_L = Gbl_Job_L;
                    //}
                    //else if (Gbl_Orientation.ToUpper() == "SPOUTPOUCH")
                    //{
                    //    Gbl_Rect_H = Gbl_Job_W;
                    //    Gbl_Rect_L = Gbl_Job_L;
                    //}
                    //else if (Gbl_Orientation.ToUpper() == "ROTOLABEL" | Gbl_Orientation.ToUpper() == "OPENSIZEPOUCHWITHZIPPER")
                    //{
                    //    Gbl_Rect_H = Gbl_Job_W;
                    //    Gbl_Rect_L = Gbl_Job_L;
                    //}

                    //// ''' Gbl_Rect_L = IIf(IsDBNull(dt.Rows(0)("FeedValue")), 0, dt.Rows(0)("FeedValue"))   '' Added By Minesh Jain On 03-Aug-2022


                    //Gbl_Paper_Detail = "Quality=" + Trim(Gbl_Paper_Quality) + " and Thickness=" + Trim(Gbl_Paper_Thickness) + " and GSM=" + Trim(Gbl_Paper_GSM) + " and Manufecturer=" + Trim(Gbl_Paper_Mill) + "";

                    //Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L + Gbl_Standard_AR_Gap);
                    //Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H + Gbl_Standard_AC_Gap);

                    //LoadPaperGrid(Gbl_Content_Domain_Type, GblDTRoll);

                    //if (GblDTRoll.Rows.Count == 0)
                    //{
                    //    planErrors = "Selected Roll detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another Paper size or deselect Standard size check";
                    //    return planErrors;
                    //}
                    //GblDTRoll.Rows(0)("EstimationRate") = PaperRate;
                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "LARGEFORMAT")
                {
                    //if (Gbl_Grain_Direction == "With Grain")
                    //{
                    //    Gbl_Rect_H = Gbl_Job_H;
                    //    Gbl_Rect_L = Gbl_Job_L;
                    //}
                    //else
                    //{
                    //    Gbl_Rect_H = Gbl_Job_L;
                    //    Gbl_Rect_L = Gbl_Job_H;
                    //}

                    //Gbl_Paper_Detail = "Quality=" + Trim(Gbl_Paper_Quality) + " and Thickness=" + Trim(Gbl_Paper_Thickness) + " and Manufecturer=" + Trim(Gbl_Paper_Mill) + "";

                    //if (IIf(ContentSizeInputUnit.Trim() == "", "MM", ContentSizeInputUnit.Trim().ToUpper()) == "INCH")
                    //{
                    //    Gbl_Rect_L = Math.Round((Gbl_Rect_L * 2.54), 2);
                    //    Gbl_Rect_H = Math.Round((Gbl_Rect_H * 2.54), 2);
                    //}
                    //else if (IIf(ContentSizeInputUnit.Trim() == "", "MM", ContentSizeInputUnit.Trim().ToUpper()) == "MM")
                    //{
                    //    Gbl_Rect_L = Math.Round((Gbl_Rect_L / 10), 2);
                    //    Gbl_Rect_H = Math.Round((Gbl_Rect_H / 10), 2);
                    //}
                    //else if (IIf(ContentSizeInputUnit.Trim() == "", "MM", ContentSizeInputUnit.Trim()) == "MTR")
                    //{
                    //    Gbl_Rect_L = Math.Round((Gbl_Rect_L * 100), 2);
                    //    Gbl_Rect_H = Math.Round((Gbl_Rect_H * 100), 2);
                    //}

                    //Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L);
                    //Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H);

                    //LoadPaperGrid(Gbl_Content_Domain_Type, GblDTRoll);

                    //if (GblDTRoll.Rows.Count == 0)
                    //{
                    //    planErrors = "Selected Roll detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another Paper size or deselect Standard size check";
                    //    return planErrors;
                    //}
                    //GblDTRoll.Rows(0)("EstimationRate") = PaperRate;
                }
                else
                {
                    if (Gbl_Orientation == "PrePlannedSheetLabel")
                    {
                        if (Gbl_Grain_Direction == "With Grain")
                        {
                            Gbl_Rect_H = Job_H;   // Gbl_Job_H
                            Gbl_Rect_L = Job_L;   // Gbl_Job_W
                        }
                        else
                        {
                            Gbl_Rect_H = Job_L;    // Gbl_Job_W
                            Gbl_Rect_L = Job_H;   // Gbl_Job_H
                        }
                    }
                    else if (Gbl_Grain_Direction == "With Grain")
                    {
                        Gbl_Rect_H = Job_H;   // Gbl_Job_H
                        Gbl_Rect_L = Job_W;   // Gbl_Job_W
                    }
                    else
                    {
                        Gbl_Rect_H = Job_W;    // Gbl_Job_W
                        Gbl_Rect_L = Job_H;   // Gbl_Job_H
                    }


                    Gbl_Job_W = Job_W;
                    Gbl_Job_H = Job_H;

                    Gbl_Paper_Detail = " Quality='" + Gbl_Paper_Quality.Trim() + "' and Face GSM=" + Gbl_Paper_GSM + " and Manufecturer='" + Gbl_Paper_Mill.Trim() + "'";
                    if (Gbl_Orientation == "PrePlannedSheetLabel")
                    {
                        Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L);
                        Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H);
                    }
                    else
                    {
                        Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L + Gbl_Standard_AR_Gap);
                        Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H + Gbl_Standard_AC_Gap);
                    }


                    // LoadFlexoRollGrid()
                    LoadPaperGrid(Gbl_Content_Domain_Type, ref GblDTRoll);

                    if (GblDTRoll.Rows.Count == 0)
                    {
                        planErrors = "Selected Paper detail not found in the database, Plan In Standard Size is " + Check_Plan_In_Standard_Size + "..! Please select another Paper size or deselect Standard size check";
                        return planErrors;
                    }
                    GblDTRoll.Rows[0]["EstimationRate"] = request.PaperRate;
                }

                LoadAllGrids();
                for (var i = 0; i <= DT_Printing_Slabs.Rows.Count - 1; i++)
                {
                    DT_Printing_Slabs.Rows[i][5] = request.PlateRate;
                    DT_Printing_Slabs.Rows[i][6] = request.PlateRate;
                    DT_Printing_Slabs.Rows[i][7] = request.PlateRate;
                }

                Gbl_Machine_Name = Gbl_DT_Machine.Rows[0][1].ToString();
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[0][3]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[0][2]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[0][5]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[0][11].ToString();
                if (Gbl_Content_Domain_Type.ToString().ToUpper() == "OFFSET")
                    Paper_Planning();
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "FLEXO" | Gbl_Content_Domain_Type.ToString().ToUpper() == "ROTOGRAVURE" | Gbl_Content_Domain_Type.ToString().ToUpper() == "LARGEFORMAT")
                {
                    if (Gbl_Machine_Type.ToString().ToUpper() == "FLEXO")
                    {
                        Tool_Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[0][42]), 2);
                        if (Gbl_Orientation == "PrePlannedSheetLabel")
                        {
                            Gbl_Around_Waste_Strip = Math.Round((Tool_Cylinder_Circumference_MM - Gbl_Rect_L), 2);
                            Plan_On_RollPreplanned(0, Gbl_Rect_H, Gbl_Rect_L);
                        }
                        else
                        {
                            if (Gbl_Standard_AR_Gap == 0)
                                Gbl_Around_Waste_Strip = Math.Round((Tool_Cylinder_Circumference_MM - (Gbl_UPS_L * Gbl_Rect_L)), 2);
                            else
                                Gbl_Actual_Around_Gap = Math.Round((Tool_Cylinder_Circumference_MM - (Gbl_UPS_L * Gbl_Rect_L)) / (double)Gbl_UPS_L, 2);
                            Plan_On_Roll(0, Gbl_Rect_H, Gbl_Rect_L);
                        }
                    }
                    else if (Gbl_Machine_Type.ToString().ToUpper() == "DRY WEB OFFSET")
                    {
                        Tool_Cylinder_Circumference_MM = 0;
                        Gbl_Actual_Around_Gap = Gbl_Standard_AR_Gap;
                        if (Gbl_Orientation == "PrePlannedSheetLabel")
                            Plan_On_RollPreplanned(0, Gbl_Rect_H, Gbl_Rect_L);
                        else
                            Plan_On_Roll(0, Gbl_Rect_H, Gbl_Rect_L);
                    }
                    else if (Gbl_Machine_Type.ToString().ToUpper() == "ROTO GRAVURE")
                    {
                        Tool_Cylinder_Circumference_MM = 0;
                        Gbl_Actual_Around_Gap = Gbl_Standard_AR_Gap;
                        // If GblDTRoll.Rows.Count > 0 Then
                        // Gbl_Rect_H = Val(IIf(IsDBNull(GblDTRoll.Rows(0)(10)), 0, GblDTRoll.Rows(0)(10)))
                        // End If
                        Plan_On_Roto_Roll(0, Gbl_Rect_H, Gbl_Rect_L);
                    }
                    else if (Gbl_Machine_Type.ToString().ToUpper() == "LARGE FORMAT")
                    {
                        Tool_Cylinder_Circumference_MM = 0;
                        Gbl_Actual_Around_Gap = 0;
                        Plan_On_Large_Format_Roll(0, Gbl_Rect_H, Gbl_Rect_L);
                    }
                }

                if (Gbl_DT_plan.Rows.Count < 1)
                {
                    if (planErrors == "")
                        planErrors = "Check Job Size: Job size may be larger than available Paper size or Machine Size. " + " Check Paper Size: Suitable paper size may not be available in selected Paper Group.  " + " Check Grain Direction: Grain Direction may not be correct. " + " Check Printing Style: Printing Style may not be correct. " + " Check Color Strip, Gripper,  Plate Type, Job Trimming, Stripping Margin, Printing Margin";
                    return planErrors;
                }

                Gbl_DT_plan.TableName = "TblPlanning";
                Rf_Dt_Opr.TableName = "TblOperations";
                GblDTBook.TableName = "TblBookForms";

                Gbl_DT_plan.DefaultView.Sort = "WastageKg ASC,TotalAmount ASC";
                Gbl_DT_plan = Gbl_DT_plan.DefaultView.ToTable();

                Dataset.Merge(Gbl_DT_plan);
                Dataset.Merge(Rf_Dt_Opr);
                Dataset.Merge(GblDTBook);

                HelloWorldData data = new HelloWorldData();
                data.Message = DBConnection.ConvertDataSetsToJsonString(Dataset);

                return js.Serialize(data.Message);
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return planErrors;
            }
        }


        public static DataTable FilterRowsByPlanID(DataTable sourceTable, string planID)
        {
            if (sourceTable == null || string.IsNullOrEmpty(planID))
                return null;

            DataTable resultTable = sourceTable.Clone();

            foreach (DataRow row in sourceTable.Rows)
            {
                string currentPlanId = Convert.ToString(row["PlanID"]);
                if (currentPlanId == planID)
                {
                    resultTable.ImportRow(row);
                }
            }

            return resultTable;
        }


        private void LoadPaperGrid(string Gbl_Content_Domain_Type, ref DataTable dt)
        {
            try
            {
                CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
                string FilterStr = "";
                if (Gbl_Content_Domain_Type.ToString().ToUpper() == "OFFSET")
                {
                    if (Gbl_Paper_ID > 0)
                        str = "SELECT Distinct IM.ItemID as PaperID, Quality, GSM, Manufecturer, PackingType, UnitPerPacking, WtPerPacking,IMS.EstimationRate,Finish,0 as PaperTrimming, SizeW, SizeL, Caliper, Isnull(IsStandardItem,0) As IsStandardItem,ItemCode as PaperCode, Isnull(IsBalancePiece,0) As IsBalancePiece, IsNull(EstimationUnit,'') As EstimationUnit,ItemName as PaperName,PaperGroup,ItemGroupName,PurchaseUnit From ItemMASter As IM INNER JOIN ItemGroupMaster as IGM on IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID Where ISNULL(IM.IsDeletedTransaction,0) = 0 AND IMS.ProductionUnitID = " + ProductionUnitID + "  And IM.ItemID =" + Gbl_Paper_ID + "";
                    else
                    {
                        if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) && Convert.ToDouble(Gbl_Paper_GSM) > 0 && !string.IsNullOrWhiteSpace(Gbl_Paper_Mill) && !string.IsNullOrWhiteSpace(Gbl_Paper_Finish))
                            FilterStr = " Where Quality='" + Gbl_Paper_Quality + "' AND GSM='" + Gbl_Paper_GSM + "' AND Manufecturer='" + Gbl_Paper_Mill + "' AND Finish='" + Gbl_Paper_Finish + "' AND IMS.ProductionUnitID = " + ProductionUnitID + "";
                        else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) && Convert.ToDouble(Gbl_Paper_GSM) > 0 && !string.IsNullOrWhiteSpace(Gbl_Paper_Mill))
                            FilterStr = " Where Quality ='" + Gbl_Paper_Quality + "' AND GSM ='" + Gbl_Paper_GSM + "' AND Manufecturer ='" + Gbl_Paper_Mill + "' AND IMS.ProductionUnitID = " + ProductionUnitID + " ";
                        else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) && Convert.ToDouble(Gbl_Paper_GSM) > 0)
                            FilterStr = " Where Quality='" + Gbl_Paper_Quality + "' AND GSM='" + Gbl_Paper_GSM + "' AND IMS.ProductionUnitID = " + ProductionUnitID + "";
                        else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality))
                            FilterStr = " Where Quality='" + Gbl_Paper_Quality + "' AND IMS.ProductionUnitID = " + ProductionUnitID + " ";

                        str = "SELECT Distinct Top 1 0 AS PaperID, Quality, GSM, Manufecturer, PackingType, UnitPerPacking, WtPerPacking,IMS.EstimationRate,Finish,'' as PaperTrimming, " + Gbl_Sheet_W + " AS SizeW, " + Gbl_Sheet_L + " AS SizeL, Caliper,Isnull(IsStandardItem,0) As IsStandardItem, '' AS PaperCode, Isnull(IsBalancePiece,0) As IsBalancePiece, IsNull(EstimationUnit,'') As EstimationUnit,ItemName as PaperName,PaperGroup,ItemGroupName,PurchaseUnit From ItemMaster as IM INNER JOIN ItemGroupMaster as IGM ON IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID " + FilterStr;
                    }
                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "FLEXO")
                {
                    if (Gbl_Paper_ID > 0)
                        str = "SELECT Distinct IM.ItemID As PaperID, Quality, GSM AS FaceGSM,ReleaseGSM,AdhesiveGSM,Thickness,Density,Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode AS PaperCode, IsNull(EstimationUnit,'') As EstimationUnit, ItemName AS PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit,AvgRollLength From ItemMaster as IM INNER JOIN ItemGroupMaster as IGM On IGM.ItemGroupID = IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID Where Isnull(IM.IsDeletedTransaction,0) <> 1 AND IMS.ProductionUnitID = " + ProductionUnitID + " And IM.ItemId = " + Gbl_Paper_ID;
                    else
                    {
                        if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0 & !string.IsNullOrWhiteSpace(Gbl_Paper_Mill) & !string.IsNullOrWhiteSpace(Gbl_Paper_Finish))
                            FilterStr = " AND Quality ='" + Gbl_Paper_Quality + "' AND GSM ='" + Gbl_Paper_GSM + "' AND Manufecturer ='" + Gbl_Paper_Mill + "' AND Finish ='" + Gbl_Paper_Finish + "' AND IMS.ProductionUnitID = " + ProductionUnitID + " ";
                        else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0 & !string.IsNullOrWhiteSpace(Gbl_Paper_Mill))
                            FilterStr = " AND Quality ='" + Gbl_Paper_Quality + "' AND GSM ='" + Gbl_Paper_GSM + "' AND Manufecturer ='" + Gbl_Paper_Mill + "' AND IMS.ProductionUnitID = " + ProductionUnitID + " ";
                        else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0)
                            FilterStr = " AND Quality = '" + Gbl_Paper_Quality + "' AND GSM = '" + Gbl_Paper_GSM + "' AND IMS.ProductionUnitID = " + ProductionUnitID + " ";
                        else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality))
                            FilterStr = " AND Quality = '" + Gbl_Paper_Quality + "' AND IMS.ProductionUnitID = " + ProductionUnitID + " ";
                        str = "SELECT Distinct IM.ItemID as  PaperID, Quality, GSM AS FaceGSM,ReleaseGSM,AdhesiveGSM,Thickness,Density,Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode AS PaperCode, IsNull(EstimationUnit,'') As EstimationUnit,ItemName AS PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit,AvgRollLength  From ItemMaster AS IM INNER JOIN ItemGroupMaster AS IG On IG.ItemGroupID=IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID  Where IM.ItemID = " + Gbl_Paper_ID + " " + FilterStr + " And Isnull(IG.IsDeletedTransaction,0)<>1  ";
                    }
                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "ROTOGRAVURE")
                {
                    if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0 & !string.IsNullOrWhiteSpace(Gbl_Paper_Mill) & !string.IsNullOrWhiteSpace(Gbl_Paper_Finish))
                        FilterStr = " AND Quality ='" + Gbl_Paper_Quality + "' AND GSM ='" + Gbl_Paper_GSM + "' AND Manufecturer ='" + Gbl_Paper_Mill + "' AND Finish ='" + Gbl_Paper_Finish + "'";
                    else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0 & !string.IsNullOrWhiteSpace(Gbl_Paper_Mill))
                        FilterStr = " AND Quality ='" + Gbl_Paper_Quality + "' AND GSM ='" + Gbl_Paper_GSM + "' AND Manufecturer ='" + Gbl_Paper_Mill + "'";
                    else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0)
                        FilterStr = " AND Quality = '" + Gbl_Paper_Quality + "' AND GSM = '" + Gbl_Paper_GSM + "'";
                    else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality))
                        FilterStr = " AND Quality = '" + Gbl_Paper_Quality + "'";

                    str = "SELECT Distinct IM.ItemID as PaperID, Quality, GSM AS FaceGSM,0 AS ReleaseGSM,0 AS AdhesiveGSM,Thickness,Density,Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode AS PaperCode, IsNull(EstimationUnit,'') As EstimationUnit,ItemName AS PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit,AvgRollLength From ItemMaster AS IM INNER JOIN ItemGroupMaster AS IG On IG.ItemGroupID=IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID  Where IMD.ItemID =" + Gbl_Paper_ID + " " + FilterStr + " And Isnull(IG.IsDeletedTransaction,0)<>1 AND IMS.ProductionUnitID = " + ProductionUnitID + " ";
                }
                else if (Gbl_Content_Domain_Type.ToString().ToUpper() == "LARGEFORMAT")
                {
                    if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0 & !string.IsNullOrWhiteSpace(Gbl_Paper_Mill) & !string.IsNullOrWhiteSpace(Gbl_Paper_Finish))
                        FilterStr = " AND Quality ='" + Gbl_Paper_Quality + "' AND GSM ='" + Gbl_Paper_GSM + "' AND Manufecturer ='" + Gbl_Paper_Mill + "' AND Finish ='" + Gbl_Paper_Finish + "'";
                    else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0 & !string.IsNullOrWhiteSpace(Gbl_Paper_Mill))
                        FilterStr = " AND Quality ='" + Gbl_Paper_Quality + "' AND GSM ='" + Gbl_Paper_GSM + "' AND Manufecturer ='" + Gbl_Paper_Mill + "'";
                    else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality) & Convert.ToDouble(Gbl_Paper_GSM) > 0)
                        FilterStr = " AND Quality = '" + Gbl_Paper_Quality + "' AND GSM = '" + Gbl_Paper_GSM + "'";
                    else if (!string.IsNullOrWhiteSpace(Gbl_Paper_Quality))
                        FilterStr = " AND Quality = '" + Gbl_Paper_Quality + "'";

                    str = "SELECT Distinct IM.ItemID as PaperID, Quality, GSM AS FaceGSM,0 AS ReleaseGSM,0 AS AdhesiveGSM,Thickness,Density,Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode AS PaperCode, IsNull(EstimationUnit,'') As EstimationUnit,ItemName AS PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit From ItemMaster AS IM INNER JOIN ItemGroupMaster AS IG On IG.ItemGroupID=IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID  Where IMD.ItemID =" + Gbl_Paper_ID + " " + FilterStr + " And Isnull(IG.IsDeletedTransaction,0)<>1 AND IMS.ProductionUnitID = " + ProductionUnitID + " ";
                }
                DBConnection.FillDataTable(ref dt, str);

                if (Gbl_Content_Domain_Type.ToString().ToUpper() == "OFFSET")
                {
                    DataView dataViewItems = Gbl_DT_Paper.DefaultView;
                    dataViewItems.RowFilter = "ItemGroupName = 'Reel'";

                    GblDTReel = Gbl_DT_Paper.Copy();
                    GblDTReel.Clear();

                    for (int i = 0; i < dataViewItems.Count; i++)
                    {
                        GblDTReel.ImportRow(dataViewItems[i].Row);
                    }

                }
            }
            catch (Exception ex)
            {
            }
        }
        private void LoadFlexoRollGrid()
        {
            try
            {
                CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
                DBType = DBConnection.DBType;
                str = "SELECT Distinct IM.ItemID as  PaperID, Quality, GSM AS FaceGSM,ReleaseGSM,AdhesiveGSM,Thickness,Density,Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode AS PaperCode, IsNull(EstimationUnit,'') As EstimationUnit,ItemName AS PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit  From ItemMaster AS IM INNER JOIN ItemGroupMaster AS IG On IG.ItemGroupID=IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID  Where IM.ItemID =" + Gbl_Paper_ID + "  And Isnull(IG.IsDeletedTransaction,0)<>1 AND IMS.ProductionUnitID = " + ProductionUnitID + "  ";

                DBConnection.FillDataTable(ref GblDTRoll, str);
            }
            catch (Exception ex)
            {
            }
        }
        private void LoadRotoRollGrid()
        {
            try
            {
                CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
                DBType = DBConnection.DBType;
                str = "SELECT Distinct IM.ItemID as  PaperID, Quality, GSM AS FaceGSM,ReleaseGSM,AdhesiveGSM,Thickness,Density,Manufecturer, IMS.EstimationRate,Null AS Finish, SizeW, Isnull(IsStandardItem,0) As IsStandardItem, ItemCode AS PaperCode,IsNull(EstimationUnit,'') As EstimationUnit,ItemName AS PaperName,ItemType AS PaperGroup,ItemGroupName,PurchaseUnit  From ItemMaster AS IM INNER JOIN ItemGroupMaster AS IG On IG.ItemGroupID=IM.ItemGroupID INNER JOIN ItemMasterStock IMS ON IMS.ItemID = IM.ItemID  Where IM.ItemID =" + Gbl_Paper_ID + " And IM.CompanyID=" + CompanyID + " And Isnull(IG.IsDeletedTransaction,0)<>1 AND IMS.ProductionUnitID = " + ProductionUnitID + "  ";
                DBConnection.FillDataTable(ref GblDTRoll, str);
            }
            catch (Exception ex)
            {
            }
        }
        public string callloadgrids()
        {
            LoadAllGrids();
            return "All data grids loaded";
        }
        private void LoadAllGrids()
        {
            k = "Planning_Machines";
            Gbl_DT_Machine = GetDataTable();

            k = "Client_Printing_Slabs";
            DT_Client_Printing_Slabs = GetDataTable();

            k = "Printing_Slabs";
            DT_Printing_Slabs = GetDataTable();

            k = "Search_In_Machine_Selection";
            Gbl_DT_Search_In_Machine = GetDataTable();

            k = "Slitting_Machine";
            GblDTSlittingMachine = GetDataTable();

            k = "Corrugation_Machine";
            GblDTCorrugationMachine = GetDataTable();

            k = "Machine_Online_Coating_Rates";
            GblDTMachineCoatingRates = GetDataTable();

            k = "Category_Wise_Wastage";
            Gbl_DT_Category_Wastage = GetDataTable();

            k = "CompanyMaster";
            Gbl_DT_CompanyMaster_Flags = GetDataTable();

            k = "DieMaster";
            Gbl_DT_DieMaster = GetDataTable();

            if (Gbl_DT_CompanyMaster_Flags.Rows.Count > 0)
            {
                Gbl_Is_Wastage_Add_In_Printing_Rates = Gbl_DT_CompanyMaster_Flags.Rows[0]["IsWastageAddInPrintingRate"] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_CompanyMaster_Flags.Rows[0]["IsWastageAddInPrintingRate"]);
                Gbl_Is_Book_Half_Form_Wastage = Gbl_DT_CompanyMaster_Flags.Rows[0]["Is_Book_Half_Form_Wastage"] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_CompanyMaster_Flags.Rows[0]["Is_Book_Half_Form_Wastage"]);
                GblCostEstimationMethodType = Gbl_DT_CompanyMaster_Flags.Rows[0]["CostEstimationMethodType"] == DBNull.Value ? "MATERIAL+PROCESS" : Gbl_DT_CompanyMaster_Flags.Rows[0]["CostEstimationMethodType"].ToString();

                GblCostEstimationMethodType = GblCostEstimationMethodType.ToUpper();
            }
            LoadOperations();
            {
                Gbl_DT_plan.Columns.Add("MachineID", typeof(long));
                Gbl_DT_plan.Columns.Add("MachineName", typeof(string));
                Gbl_DT_plan.Columns.Add("Gripper", typeof(long));
                Gbl_DT_plan.Columns.Add("GripperSide", typeof(string));
                Gbl_DT_plan.Columns.Add("MachineColors", typeof(long));
                Gbl_DT_plan.Columns.Add("PaperID", typeof(long));
                Gbl_DT_plan.Columns.Add("PaperSize", typeof(string));
                Gbl_DT_plan.Columns.Add("CutSize", typeof(string));
                Gbl_DT_plan.Columns.Add("CutL", typeof(long));
                Gbl_DT_plan.Columns.Add("CutW", typeof(long));

                // Across Ups, Around Ups, TotalUps
                Gbl_DT_plan.Columns.Add("UpsL", typeof(double));
                Gbl_DT_plan.Columns.Add("UpsW", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalUps", typeof(double));

                Gbl_DT_plan.Columns.Add("BalPiece", typeof(string));
                Gbl_DT_plan.Columns.Add("BalSide", typeof(string));
                Gbl_DT_plan.Columns.Add("WasteArea", typeof(long));
                Gbl_DT_plan.Columns.Add("WastePerc", typeof(double));
                Gbl_DT_plan.Columns.Add("WastageKg", typeof(double));
                Gbl_DT_plan.Columns.Add("GrainDirection", typeof(string));
                Gbl_DT_plan.Columns.Add("PlateQty", typeof(int));
                Gbl_DT_plan.Columns.Add("PlateRate", typeof(double));
                Gbl_DT_plan.Columns.Add("PlateAmount", typeof(double));
                Gbl_DT_plan.Columns.Add("MakeReadyWastageSheet", typeof(long));
                Gbl_DT_plan.Columns.Add("ActualSheets", typeof(long));
                Gbl_DT_plan.Columns.Add("WastageSheets", typeof(int));
                Gbl_DT_plan.Columns.Add("ProcessWastageSheets", typeof(int));
                Gbl_DT_plan.Columns.Add("TotalPaperWeightInKg", typeof(double));
                Gbl_DT_plan.Columns.Add("FullSheets", typeof(long));
                Gbl_DT_plan.Columns.Add("PaperRate", typeof(double));
                Gbl_DT_plan.Columns.Add("PaperAmount", typeof(double));
                Gbl_DT_plan.Columns.Add("PrintingImpressions", typeof(long));
                Gbl_DT_plan.Columns.Add("ImpressionsToBeCharged", typeof(long));
                Gbl_DT_plan.Columns.Add("PrintingRate", typeof(double));
                Gbl_DT_plan.Columns.Add("PrintingAmount", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalMakeReadies", typeof(long));
                Gbl_DT_plan.Columns.Add("MakeReadyRate", typeof(double));
                Gbl_DT_plan.Columns.Add("MakeReadyAmount", typeof(double));
                Gbl_DT_plan.Columns.Add("FinalQuantity", typeof(double));
                Gbl_DT_plan.Columns.Add("OrderQuantity", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalColors", typeof(long));
                Gbl_DT_plan.Columns.Add("TotalAmount", typeof(double));
                Gbl_DT_plan.Columns.Add("CutLH", typeof(long));
                Gbl_DT_plan.Columns.Add("CutHL", typeof(long));
                Gbl_DT_plan.Columns.Add("PrintingStyle", typeof(string));
                Gbl_DT_plan.Columns.Add("PrintingChargesType", typeof(string));
                Gbl_DT_plan.Columns.Add("ExpectedExecutionTime", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalExecutionTime", typeof(double));
                Gbl_DT_plan.Columns.Add("MainPaperName", typeof(string));
                Gbl_DT_plan.Columns.Add("PlanType", typeof(string));
                Gbl_DT_plan.Columns.Add("PaperRateType", typeof(string));
                Gbl_DT_plan.Columns.Add("DieCutSize", typeof(string));
                Gbl_DT_plan.Columns.Add("InterlockStyle", typeof(int));
                Gbl_DT_plan.Columns.Add("NoOfSets", typeof(int));
                Gbl_DT_plan.Columns.Add("GrantAmount", typeof(double));
                Gbl_DT_plan.Columns.Add("UnitPrice", typeof(double));
                Gbl_DT_plan.Columns.Add("Packing", typeof(string));
                Gbl_DT_plan.Columns.Add("UnitPerPacking", typeof(double));
                Gbl_DT_plan.Columns.Add("RoundofImpressionsWith", typeof(double));
                Gbl_DT_plan.Columns.Add("SpeColorFCharges", typeof(double));
                Gbl_DT_plan.Columns.Add("SpeColorBCharges", typeof(double));
                Gbl_DT_plan.Columns.Add("SpeColorFAmt", typeof(double));
                Gbl_DT_plan.Columns.Add("SpeColorBAmt", typeof(double));
                Gbl_DT_plan.Columns.Add("OpAmt", typeof(double));
                Gbl_DT_plan.Columns.Add("PlanID", typeof(int));
                Gbl_DT_plan.Columns.Add("CoatingCharges", typeof(double));
                Gbl_DT_plan.Columns.Add("CoatingAmount", typeof(double));
                Gbl_DT_plan.Columns.Add("PaperGroup", typeof(string));
                Gbl_DT_plan.Columns.Add("MachineType", typeof(string));
                Gbl_DT_plan.Columns.Add("CylinderToolID", typeof(int));
                Gbl_DT_plan.Columns.Add("CylinderToolCode", typeof(string));
                Gbl_DT_plan.Columns.Add("CylinderCircumferenceInch", typeof(double));
                Gbl_DT_plan.Columns.Add("CylinderCircumferenceMM", typeof(double));
                Gbl_DT_plan.Columns.Add("CylinderWidth", typeof(double));
                Gbl_DT_plan.Columns.Add("CylinderNoOfTeeth", typeof(double));
                Gbl_DT_plan.Columns.Add("FeedValue", typeof(double));
                Gbl_DT_plan.Columns.Add("AcrossGap", typeof(double));
                Gbl_DT_plan.Columns.Add("AroundGap", typeof(double));
                Gbl_DT_plan.Columns.Add("WastageStrip", typeof(double));
                Gbl_DT_plan.Columns.Add("RequiredRunningMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("MakeReadyWastageRunningMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("AvgBreakDownRunningMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("WastageRunningMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("ProcessWastageRunningMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalRequiredRunningMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("RequiredSquareMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalRequiredSquareMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("WastageSquareMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("ScrapSquareMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("MachineSpeed", typeof(double));
                Gbl_DT_plan.Columns.Add("MachinePerHourRate", typeof(double));
                Gbl_DT_plan.Columns.Add("PaperTotalGSM", typeof(double));
                Gbl_DT_plan.Columns.Add("RequiredPaperWeightKg", typeof(double));
                Gbl_DT_plan.Columns.Add("RollChangeWastageMeter", typeof(double));
                Gbl_DT_plan.Columns.Add("AverageRollLength", typeof(double));
                Gbl_DT_plan.Columns.Add("PaperFaceGSM", typeof(double));
                Gbl_DT_plan.Columns.Add("PaperReleaseGSM", typeof(double));
                Gbl_DT_plan.Columns.Add("PaperAdhesiveGSM", typeof(double));
                Gbl_DT_plan.Columns.Add("PaperMill", typeof(string));
                Gbl_DT_plan.Columns.Add("RollType", typeof(string));
                Gbl_DT_plan.Columns.Add("TotalProcessCost", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalMaterialCost", typeof(double));
                Gbl_DT_plan.Columns.Add("TotalMachineCost", typeof(double));
                // Added by Vivek on 06_Dec_2022
                Gbl_DT_plan.Columns.Add("WindingDirectionID", typeof(string));
                Gbl_DT_plan.Columns.Add("LabelType", typeof(string));
                Gbl_DT_plan.Columns.Add("OutputType", typeof(string));
                Gbl_DT_plan.Columns.Add("PcsPerRoll", typeof(string));
                Gbl_DT_plan.Columns.Add("DieType", typeof(string));
                Gbl_DT_plan.Columns.Add("CoreInnerDia", typeof(string));
                Gbl_DT_plan.Columns.Add("CoreOuterDia", typeof(string));
                Gbl_DT_plan.Columns.Add("FinalQuantityInPcs", typeof(long));
                Gbl_DT_plan.Columns.Add("EstimationQuantityUnit", typeof(string));
                Gbl_DT_plan.Columns.Add("PlanOtherMaterialGSM", typeof(double));
                Gbl_DT_plan.Columns.Add("PlanOtherMaterialGSMSettingJSON", typeof(string));
                Gbl_DT_plan.Columns.Add("TotalContentActualWeight", typeof(double));
                Gbl_DT_plan.Columns.Add("PlanContentType", typeof(string));
                Gbl_DT_plan.Columns.Add("PlanContName", typeof(string));
                Gbl_DT_plan.Columns.Add("IsDieAvailable", typeof(bool));
            }
            if (GblDTBook == null)
            {
                GblDTBook = new DataTable();
            }

            GblDTBook.Columns.Add("Forms", typeof(double));
            GblDTBook.Columns.Add("Sets", typeof(double));
            GblDTBook.Columns.Add("Pages", typeof(double));
            GblDTBook.Columns.Add("Sheets", typeof(double));
            GblDTBook.Columns.Add("ImpressionsPerSet", typeof(double));
            GblDTBook.Columns.Add("FormsInPoint", typeof(double));
            GblDTBook.Columns.Add("ImprsToChargedPerSet", typeof(double));
            GblDTBook.Columns.Add("BasicRate", typeof(double));
            GblDTBook.Columns.Add("SlabRate", typeof(double));
            GblDTBook.Columns.Add("RateType", typeof(string));
            GblDTBook.Columns.Add("Amount", typeof(long));
            GblDTBook.Columns.Add("WastagePercentSheet", typeof(double));
            GblDTBook.Columns.Add("PlateRate", typeof(double));
            GblDTBook.Columns.Add("PlanID", typeof(long));
            GblDTBook.Columns.Add("FormPlanType", typeof(string));
            GblDTBook.Columns.Add("WastageSheets", typeof(double));

        }

        private void LoadOperations()
        {
            CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
            DBType = DBConnection.DBType;
            string str1 = "";
            Gbl_DT_Operation.Clear();
            Gbl_DT_Operation_Machine_Allocation.Clear();
            if (GblOperId != "")
            {
                k = "Operation_Slabs";
                GblDTOprSlabs = GetDataTable();
                str = "Select A.TypeofCharges,	A.Rate,	A.MinimumCharges,	A.SetupCharges,	A.SizeToBeConsidered,	A.ChargeApplyOnSheets,	A.PrePress,	A.SizeL,	A.SizeW,	A.MaximumL,	A.MaximumW,	A.Amount,	A.PlanID,	A.ProcessID,	A.ProcessName,	A.Quantity,	A.Ups,	A.NoOfPass,	A.Remarks,	A.RateFactor,	A.Pieces,	A.NoOfStitch,	A.NoOfLoops,	A.NoOfColors, A.IsDisplay,A.IsOnlineProcess,	A.MachineID,Case When Isnull(A.MachineSpeed,0)>0 THEN Isnull(A.MachineSpeed,0) ELSE Isnull(MM.MachineSpeed,0) END AS MachineSpeed,Case When Isnull(A.MakeReadyTime,0)>0 THEN Isnull(A.MakeReadyTime,0) ELSE Isnull(MM.MakeReadyTime,0) END AS MakeReadyTime,Case When Isnull(A.JobChangeOverTime,0)>0 THEN Isnull(A.JobChangeOverTime,0) ELSE Isnull(MM.JobChangeOverTime,0) END AS JobChangeOverTime,Isnull(MM.MakeReadyPerHourCost,0) AS MakeReadyPerHourCost,Isnull(MM.PerHourCost,0) AS MachinePerHourCost,0 AS ExecutionTime,0 AS TotalExecutionTime,0 As MakeReadyMachineCost,0 As ExecutionCost,0 AS MachineCost,0 AS MaterialCost,A.ToolRequired,A.ProcessProductionType,0 AS PaperConsumptionRequired,MM.MachineName,0 AS ConvertToSemiFinishGood,A.DepartmentID,A.DepartmentSequenceNo,Isnull(A.ProcessFlatWastageValue,0) AS ProcessFlatWastageValue,Isnull(A.ProcessWastagePercentage,0) AS ProcessWastagePercentage,A.ProcessModuleType,A.PagesPerSection,A.NoOfForms,A.PlateRequired,A.NoOfFolds,Case When Isnull(MM.MachineId,0)>0 THEN MM.PerHourCostingParameter ELSE A.PerHourCostingParameter END AS PerHourCostingParameter,A.MinimumQuantityToBeCharged,A.PerHourCalculationQuantity,Isnull(NULLIF(MM.MakeReadyTimeMode,''),'Flat') AS MakeReadyTimeMode,0 as SetupTime,0 as SetupCost " +
                              " From (SELECT DISTINCT P.TypeofCharges,  ISNULL(P.Rate, 0) AS Rate, P.MinimumCharges, P.SetupCharges, P.SizeToBeConsidered, P.ChargeApplyOnSheets, P.PrePress, P.MinimumL AS SizeL, P.MinimumW AS SizeW, P.MaximumL, P.MaximumW, '0.00' AS Amount, 0 AS PlanID, P.ProcessID, P.ProcessName, '0.00' AS Quantity,'0.00' AS PerHourCalculationQuantity, 0 AS Ups, 1.0 AS NoOfPass, '' AS Remarks,'' As RateFactor,1 As Pieces ,1 As NoOfStitch,1 As NoOfLoops,1 As NoOfColors,1 As NoOfFolds,ISNULL(P.IsDisplay,0) As IsDisplay,ISNULL(P.IsOnlineProcess,0) As IsOnlineProcess,Isnull(PSA.MachineID,0) AS MachineID,Isnull(PSA.MachineSpeed,0) AS MachineSpeed,Case When Isnull(PSA.MachineID,0)>0 THEN (Select Top 1 Isnull(MakeReadyTime,0) From ProcessAllocatedMachineMaster Where ProcessID=P.ProcessID AND MachineID=PSA.MachineID AND isnull(IsDeletedTransaction,0)=0) ELSE 0 END AS MakeReadyTime,Case When Isnull(PSA.MachineID,0)>0 THEN (Select Top 1 Isnull(JobChangeOverTime,0) From ProcessAllocatedMachineMaster Where ProcessID=P.ProcessID AND MachineID=PSA.MachineID AND isnull(IsDeletedTransaction,0)=0) ELSE 0 END AS JobChangeOverTime,Isnull(P.ToolRequired,0) AS ToolRequired,Isnull(P.ProcessProductionType,'None') AS ProcessProductionType,Isnull(DP.DepartmentID,0) AS DepartmentID,Isnull(DP.SequenceNo,0) AS DepartmentSequenceNo,Isnull(P.ProcessFlatWastageValue,0) AS ProcessFlatWastageValue,Isnull(P.ProcessWastagePercentage,0) AS ProcessWastagePercentage,Isnull(NullIf(P.ProcessModuleType,''),'Universal') AS ProcessModuleType,1 AS PagesPerSection,0 As NoOfForms,Case When Isnull(PTG.ToolGroupID,0)>0 THEN 1 ELSE 0 END AS PlateRequired,Isnull(P.PerHourCostingParameter,'') AS PerHourCostingParameter,Isnull(P.MinimumQuantityToBeCharged,0) AS MinimumQuantityToBeCharged,0 as SetupTime,0 as SetupCost " +
                              " FROM ProcessMaster AS P INNER JOIN DepartmentMaster AS DP ON DP.DepartmentID=P.DepartmentID LEFT JOIN (Select A.ProcessID,Max(A.MachineSpeed) AS MachineSpeed,(Select Top 1 MachineID From ProcessAllocatedMachineMaster Where ProcessID=A.ProcessID AND Isnull(IsDefaultMachine,0)=1  AND isnull(IsDeletedTransaction,0)=0 Group By MachineID,MachineSpeed  Having MachineSpeed=Max(A.MachineSpeed))  AS MachineID From ProcessAllocatedMachineMaster AS A Where A.ProcessId In (" + GblOperId + ") AND Isnull(A.IsDefaultMachine,0)=1  AND isnull(IsDeletedTransaction,0)=0 Group BY A.ProcessID) AS PSA ON PSA.ProcessID=P.ProcessID LEFT JOIN (Select PTG.ProcessID,PTG.ToolGroupID From ProcessToolGroupAllocationMaster AS PTG INNER JOIN ToolGroupMaster AS TGM ON TGM.ToolGroupID=PTG.ToolGroupID Where TGM.ToolGroupNameID=-9 and ISNULL(PTG.IsDeletedTransaction,0)=0 and ISNULL(TGM.IsDeletedTransaction,0)=0) AS PTG ON PTG.ProcessID=P.ProcessID " +
                              " Where P.ProcessId In (" + GblOperId + ") And P.CompanyId = " + CompanyID + " And ISNULL(P.IsDeletedTransaction,0)<>1) AS A LEFT JOIN MachineMaster AS MM ON MM.MachineID=Isnull(A.MachineID,0) Order by A.DepartmentSequenceNo; ";
                str1 = "Select PAM.ProcessID,PAM.MachineID,PAM.MachineSpeed,PAM.MakeReadyTime,PAM.JobChangeOverTime,Isnull(PAM.IsDefaultMachine,0) AS IsDefaultMachine,MM.DepartmentID,Isnull(MM.PerHourCostingParameter,'') AS PerHourCostingParameter,Isnull(MM.MakeReadyPerHourCost,0) AS MakeReadyPerHourCost,Isnull(MM.PerHourCost,0) AS MachinePerHourCost,Isnull(NULLIF(MM.MakeReadyTimeMode,''),'Flat') AS MakeReadyTimeMode " +
                               " From ProcessAllocatedMachineMaster AS PAM INNER JOIN MachineMaster AS MM ON MM.MachineID=PAM.MachineID Where PAM.ProcessID In (" + GblOperId + ") And PAM.CompanyId = " + CompanyID + " AND Isnull(PAM.IsDeletedTransaction,0)=0 AND Isnull(MM.IsDeletedTransaction,0)=0 AND Isnull(MM.IsBlocked,0)=0";
                DBConnection.FillDataTable(ref Gbl_DT_Operation, str);
                if (str1 != "")
                    DBConnection.FillDataTable(ref Gbl_DT_Operation_Machine_Allocation, str1);
            }
        }

        public float Formula_eval(string expression)
        {
            expression = expression
                .Replace("OF", Gbl_Job_Open_Flap.ToString())
                .Replace("PF", Gbl_Job_Overlap_Flap.ToString())
                .Replace("TH", Gbl_Job_Tongue_Height.ToString())
                .Replace("FH", Gbl_Job_Flap_Width.ToString())
                .Replace("L", Gbl_Job_L.ToString())
                .Replace("W", Gbl_Job_W.ToString())
                .Replace("H", Gbl_Job_H.ToString())
                .Replace("BF", Gbl_Job_Bottom_Flap.ToString());

            object result = new DataTable().Compute(expression, null);
            return Convert.ToSingle(result);
        }

        private bool All_Content_In_One_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToInt32(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt32(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToInt32(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToInt32(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();


                if (Gbl_Machine_Gripper == 0)
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);

                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = L_firstupsize_WG;
                    Gbl_Rect_H = W_firstupsize_WG;

                    Gbl_Die_Size_L = L_firstupsize_WG;
                    Gbl_Die_Size_H = W_firstupsize_WG;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = W_firstupsize_WG;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;

                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H = Convert.ToDouble(Size_H) + W_evenupsize_WG + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + W_evenupsize_WG + Gbl_Job_Trimming_TB;
                            }
                            else
                            {
                                Size_H = Convert.ToDouble(Size_H) + W_oddupsize_WG + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + W_oddupsize_WG + Gbl_Job_Trimming_TB;
                            }
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + L_firstupsize_WG + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = L_firstupsize_AG;
                    Gbl_Rect_H = W_firstupsize_AG;
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = L_firstupsize_AG;
                    Gbl_Die_Size_H = W_firstupsize_AG;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = W_firstupsize_AG;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToDouble(Size_H) + Convert.ToDouble(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Convert.ToDouble(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;

                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + L_evenupsize_AG + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + L_evenupsize_AG + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + L_oddupsize_AG + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + L_oddupsize_AG + Gbl_Job_Trimming_TB;
                        }
                    }
                }
            NextMachine:
                ;
            }
            return true;
        }

        private void Plan_Job_Pre()
        {
            CallPlanningFormula(Gbl_Orientation);

            for (int i = 0; i < Gbl_DT_Formula.Rows.Count; i++)
            {
                if (Gbl_DT_Formula.Rows[i]["Grain"].ToString() == "With Grain")
                {
                    if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "First Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_firstupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Even Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_evenupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Odd Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_oddupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Last Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_lastupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());

                    if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "First Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_firstupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Even Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_evenupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Odd Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_oddupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Last Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_lastupsize_WG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                }
                else if (Gbl_DT_Formula.Rows[i]["Grain"].ToString() == "Across Grain")
                {
                    if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "First Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_firstupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Even Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_evenupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Odd Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_oddupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Last Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Length")
                        L_lastupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());

                    if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "First Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_firstupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Even Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_evenupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Odd Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_oddupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                    else if (Gbl_DT_Formula.Rows[i]["UpsType"].ToString() == "Last Up" && Gbl_DT_Formula.Rows[i]["SheetSize"].ToString() == "Width")
                        W_lastupsize_AG = Formula_eval(Gbl_DT_Formula.Rows[i]["Formula"].ToString());
                }
            }
            switch (Gbl_Orientation)
            {
                case "Rectangular":
                case "BookCover":
                case "MultipleLeaves":
                case "WrintingPad":
                case "Brochure" // , "AccordionFold", "DoubleGateFold", "DoubleParallelFold", "GateFold", "FrenchFold", "HalfFold", "HalfThenTriFold", "RollFold", "TriFold", "ZFold", "RightAngleFirstFoldShort"
               :
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Rectangular_Planning("With Grain");
                            Rectangular_Planning("Across Grain");
                        }
                        else
                            Rectangular_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "BookPages":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Book_Pages_Planning("With Grain");
                            Book_Pages_Planning("Across Grain");
                        }
                        else
                            Book_Pages_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "WiroBookPages":
                case "WiroLeaves":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Wiro_Book_Pages_Planning("With Grain");
                            Wiro_Book_Pages_Planning("Across Grain");
                        }
                        else
                            Wiro_Book_Pages_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "Calendar":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Calendar_Planning("With Grain");
                            Calendar_Planning("Across Grain");
                        }
                        else
                            Calendar_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "FourCornerBox":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Four_Corner_Box_Planning("With Grain");
                            Four_Corner_Box_Planning("Across Grain");
                        }
                        else
                            Four_Corner_Box_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }
                case "ReverseTuckIn":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            All_Content_In_One_Planning("With Grain");
                            All_Content_In_One_Planning("Across Grain");
                        }
                        else
                            All_Content_In_One_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }
                case "ReverseTuckAndTongue":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Reverse_Tuck_And_Tongue_Planning("With Grain");
                            Reverse_Tuck_And_Tongue_Planning("Across Grain");
                        }
                        else
                            Reverse_Tuck_And_Tongue_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }
                case "UniversalCarton":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Universal_Planning("With Grain");
                            Universal_Planning("Across Grain");
                        }
                        else
                            Universal_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }
                case "StandardStraightTuckIn":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            All_Content_In_One_Planning("With Grain");
                            All_Content_In_One_Planning("Across Grain");
                        }
                        else
                            All_Content_In_One_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }
                case "StandardStraightTuckInHang2":
                case "INDUS-100":
                case "INDUS-101":
                case "INDUS-102":
                case "INDUS-103":
                case "INDUS-104":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            All_Content_In_One_Planning("With Grain");
                            All_Content_In_One_Planning("Across Grain");
                        }
                        else
                        {
                            All_Content_In_One_Planning(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "StandardStraightTuckInNested":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            All_Content_In_One_Planning("With Grain");
                            All_Content_In_One_Planning("Across Grain");
                        }
                        else
                            All_Content_In_One_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }
                case "CrashLockWithPasting":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Crash_Lock_With_Pasting_Planning("With Grain");
                            Crash_Lock_With_Pasting_Planning("Across Grain");
                        }
                        else
                        {
                            Crash_Lock_With_Pasting_Planning(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "CrashLockWithPasting2":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Crash_Lock_With_Pasting_Planning2("With Grain");
                            Crash_Lock_With_Pasting_Planning2("Across Grain");
                        }
                        else
                        {
                            Crash_Lock_With_Pasting_Planning2(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "CrashLockWithPasting3":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Crash_Lock_With_Pasting_Planning3("With Grain");
                            Crash_Lock_With_Pasting_Planning3("Across Grain");
                        }
                        else
                        {
                            Crash_Lock_With_Pasting_Planning3(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "CrashLockWithPasting4":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Crash_Lock_With_Pasting_Planning4("With Grain");
                            Crash_Lock_With_Pasting_Planning4("Across Grain");
                        }
                        else
                        {
                            Crash_Lock_With_Pasting_Planning4(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "CrashLockWithoutPasting":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Crash_Lock_Without_Pasting_Planning("With Grain");
                            Crash_Lock_Without_Pasting_Planning("Across Grain");
                        }
                        else
                        {
                            Crash_Lock_Without_Pasting_Planning(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "PrePlannedSheet":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Preplanned_Sheet_Planning("With Grain");
                            Preplanned_Sheet_Planning("Across Grain");
                        }
                        else
                            Preplanned_Sheet_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "CarryBag":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Carry_Bag_Planning("With Grain");
                            Carry_Bag_Planning("Across Grain");
                        }
                        else
                            Carry_Bag_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "EnvCenterPasting":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Env_Center_Pasting("With Grain");
                            Env_Center_Pasting("Across Grain");
                        }
                        else
                            Env_Center_Pasting(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "EnvLPasting":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Env_L_Pasting("With Grain");
                            Env_L_Pasting("Across Grain");
                        }
                        else
                            Env_L_Pasting(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "EnvSidePasting":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Env_Side_Pasting("With Grain");
                            Env_Side_Pasting("Across Grain");
                        }
                        else
                            Env_Side_Pasting(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "CatchCover":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Catch_Cover_Planning("With Grain");
                            Catch_Cover_Planning("Across Grain");
                        }
                        else
                            Catch_Cover_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "TuckToFrontOpenTop":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Sleev_Box_Planning("With Grain");
                            Sleev_Box_Planning("Across Grain");
                        }
                        else
                            Sleev_Box_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "FourCornerHingedLid":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Four_Corner_Hinged_Lid_Planning("With Grain");
                            Four_Corner_Hinged_Lid_Planning("Across Grain");
                        }
                        else
                            Four_Corner_Hinged_Lid_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "TurnOverEndTray":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Turn_Over_End_Tray_Planning("With Grain");
                            Turn_Over_End_Tray_Planning("Across Grain");
                        }
                        else
                            Turn_Over_End_Tray_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "WebbedSelfLockingTray":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Webbed_Self_locking_Tray_Planning("With Grain");
                            Webbed_Self_locking_Tray_Planning("Across Grain");
                        }
                        else
                            Webbed_Self_locking_Tray_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "RingFlap":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Ring_Flap_Planning("With Grain");
                            Ring_Flap_Planning("Across Grain");
                        }
                        else
                            Ring_Flap_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "UniversalOpenCrashLockWithPasting":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Universal_Crash_Lock_With_Pasting_Planning("With Grain");
                            Universal_Crash_Lock_With_Pasting_Planning("Across Grain");
                        }
                        else
                            Universal_Crash_Lock_With_Pasting_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "6CornerBox":
                case "SixCornerBox":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            B_6_Corner_Box_Planning("With Grain");
                            B_6_Corner_Box_Planning("Across Grain");
                        }
                        else
                            B_6_Corner_Box_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "OvelShape":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Ovel_Shape_Planning("With Grain");
                            Ovel_Shape_Planning("Across Grain");
                        }
                        else
                            Ovel_Shape_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "PolygonShape":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Polygon_Shape_Planning("With Grain");
                            Polygon_Shape_Planning("Across Grain");
                        }
                        else
                            Polygon_Shape_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "StandardStraightTuckInHang":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Standard_Straight_Tuck_In_Hang("With Grain");
                            Standard_Straight_Tuck_In_Hang("Across Grain");
                        }
                        else
                            Standard_Straight_Tuck_In_Hang(Gbl_Grain_Direction);
                        break;
                    }

                case "WiroPrePlannedSheet":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Preplanned_Wiro_Sheet_Planning("With Grain");
                            Preplanned_Wiro_Sheet_Planning("Across Grain");
                        }
                        else
                            Preplanned_Wiro_Sheet_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "WeddingCardSets":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Wedding_Card_Sets_Planning("With Grain");
                            Wedding_Card_Sets_Planning("Across Grain");
                        }
                        else
                            Wedding_Card_Sets_Planning(Gbl_Plan_Grain_Direction);
                        break;
                    }

                case "Label":
                case "ShrinkSleeve":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Flexo_Label_Planning_Main("With Grain");
                            Flexo_Label_Planning_Main("Across Grain");
                        }
                        else
                        {
                            Flexo_Label_Planning_Main(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "PrePlannedSheetLabel":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            PrePlannedSheetFlexoLabelPlanning("With Grain");
                            PrePlannedSheetFlexoLabelPlanning("Across Grain");
                        }
                        else
                        {
                            PrePlannedSheetFlexoLabelPlanning(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "CenterSealPouch":
                case "RotoLabel":
                case "StandUpPouch":
                case "FlatBottomPouch":
                case "ThreeSideSealPouch":
                case "FourSideSealPouch":
                case "PillowPouch":
                case "SpoutPouch":
                case "OpenSizePouchWithZipper":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Roto_Label_Planning_Main("With Grain");
                            Roto_Label_Planning_Main("Across Grain");
                        }
                        else
                        {
                            Roto_Label_Planning_Main(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
                case "FlexBanner":
                    {
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            Large_Format_Planning_Main("With Grain");
                            Large_Format_Planning_Main("Across Grain");
                        }
                        else
                        {
                            Large_Format_Planning_Main(Gbl_Plan_Grain_Direction);
                        }
                        break;
                    }
            }
        }

        private void Paper_Planning()
        {
            try
            {
                if (Gbl_Machine_Type == "Sheetfed Offset" || Gbl_Machine_Type == "Digital" || Gbl_Machine_Type == "")
                {
                    Gbl_Plan_Type = "Sheet Planning";
                    Plan_On_Sheet();
                    if (Pass_in_Slitting_Machine() == true)
                    {
                        Gbl_Plan_Type = "Reel to Sheet Planning";
                        Plan_On_Reel_Slitting();
                    }
                }
                else if (Gbl_Machine_Type == "Web Offset")
                {
                    Gbl_Plan_Type = "Reel Planning";
                    Plan_On_Reel();
                }
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
            }
        }
        private bool Pass_in_Slitting_Machine()
        {
            try
            {
                double Min_Reel_Size, Max_Reel_Size, Web_CutOff_Size, Web_CutOff_Size_Min, Machine_Gripper;

                for (int mi = 0; mi < GblDTSlittingMachine.Rows.Count; mi++)
                {
                    Machine_Gripper = Convert.ToDouble(GblDTSlittingMachine.Rows[mi][2]);
                    Max_Reel_Size = Convert.ToDouble(GblDTSlittingMachine.Rows[mi][3]);
                    Web_CutOff_Size = Convert.ToDouble(GblDTSlittingMachine.Rows[mi][4]);
                    Min_Reel_Size = Convert.ToDouble(GblDTSlittingMachine.Rows[mi][5]);
                    Web_CutOff_Size_Min = Convert.ToDouble(GblDTSlittingMachine.Rows[mi][6]);

                    if ((Gbl_Sheet_W <= Max_Reel_Size && Gbl_Sheet_L <= Web_CutOff_Size) || (Gbl_Sheet_L <= Max_Reel_Size && Gbl_Sheet_W <= Web_CutOff_Size))
                    {
                        if ((Gbl_Sheet_W >= Min_Reel_Size && Gbl_Sheet_L >= Web_CutOff_Size_Min) || (Gbl_Sheet_L >= Min_Reel_Size && Gbl_Sheet_W >= Web_CutOff_Size_Min))
                        {
                            return true;
                        }
                    }
                }
                return false;
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return false;
            }
        }
        private bool Wedding_Card_Sets_Planning(string Grain_Direction)
        {
            double Size_W, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Trimming_LR);
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                        goto NextMachine;
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                GblMachineMaxL = Gbl_DT_Machine.Rows[i][2] != DBNull.Value ? Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]) : 0;
                GblMachineMaxW = Gbl_DT_Machine.Rows[i][3] != DBNull.Value ? Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]) : 0;
                Gbl_M_Min_H = Gbl_DT_Machine.Rows[i][5] != DBNull.Value ? Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]) : 0;


                if (Gbl_Machine_Gripper == 0)
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt64(Gbl_DT_Machine.Rows[i][13]);

                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Size_L = Gbl_Rect_L;
                Gbl_UPS_L = Gbl_Job_Ups;
                Gbl_UPS_H = 1;
                Size_W = Gbl_Rect_H;

                if (Size_W >= Size_L)
                {
                    Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                    Gbl_Sheet_W = Size_W + Gbl_Striping_LR;

                    if (Gbl_Machine_Type == "Web Offset")
                    {
                        Gbl_M_Min_H = (long)Gbl_Sheet_W;
                        Max_Print_H = Gbl_Sheet_W;
                    }

                    Gbl_GripperSide = "L";

                    if ((Gbl_Sheet_W <= M_Max_L && Gbl_Sheet_L <= GblMachineMaxW) || (Gbl_Sheet_L <= M_Max_L && Gbl_Sheet_W <= GblMachineMaxW))
                    {
                        if ((Gbl_Sheet_W >= M_Min_L && Gbl_Sheet_L >= Gbl_M_Min_H) || (Gbl_Sheet_L >= M_Min_L && Gbl_Sheet_W >= Gbl_M_Min_H))
                        {
                            if ((Size_W <= Max_Print_L && Size_L <= Max_Print_H) || (Size_L <= Max_Print_L && Size_W <= Max_Print_H))
                            {
                                Paper_Planning();
                            }
                        }
                    }
                }
                else
                {
                    Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                    Gbl_Sheet_W = Size_W + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                    Gbl_GripperSide = "H";

                    if (Gbl_Machine_Type == "Web Offset")
                    {
                        Gbl_M_Min_H = (long)Gbl_Sheet_W;
                    }

                    if ((Gbl_Sheet_W <= M_Max_L && Gbl_Sheet_L <= GblMachineMaxW) || (Gbl_Sheet_L <= M_Max_L && Gbl_Sheet_W <= GblMachineMaxW))
                    {
                        if ((Gbl_Sheet_W >= M_Min_L && Gbl_Sheet_L >= Gbl_M_Min_H) || (Gbl_Sheet_L >= M_Min_L && Gbl_Sheet_W >= Gbl_M_Min_H))
                        {
                            if ((Size_W <= Max_Print_L && Size_L <= Max_Print_H) || (Size_L <= Max_Print_L && Size_W <= Max_Print_H))
                            {
                                Paper_Planning();
                            }
                        }
                    }
                }


            NextMachine:
                ;
            }
            return true;
        }
        private bool Preplanned_Wiro_Sheet_Planning(string Grain_Direction)
        {
            double Size_W, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Trimming_LR);
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt64(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Size_L = Gbl_Rect_L;
                Size_W = Gbl_Rect_H;
                Gbl_UPS_H = 1;
                Gbl_UPS_L = Gbl_Job_Ups;
                if (Size_W >= Size_L)
                {
                    Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                    Gbl_Sheet_W = Size_W + Gbl_Striping_LR;

                    Gbl_GripperSide = "L";
                    // '*****Check size in Machine Min and Max******''
                    if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                    {
                        if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                        {
                            if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                Paper_Planning();
                        }
                    }
                }
                else
                {
                    Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                    Gbl_Sheet_W = Size_W + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                    Gbl_GripperSide = "H";

                    if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                    {
                        if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                        {
                            if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                Paper_Planning();
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }
        private bool Rectangular_Planning(string Grain_Direction)
        {
            double Size_W, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Trimming_LR);
                Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Trimming_TB);
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Convert.ToDouble(Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[i][13]);
                }

                if (Gbl_Printing_Style == "Work & Tumble" || Gbl_Printing_Style == "FB-Perfection")
                {
                    Gbl_Machine_Gripper *= 2;
                }


                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Size_L = Gbl_Rect_L;
                Gbl_UPS_L = 1;
                while (Size_L <= M_Max_L)
                {
                    Gbl_UPS_H = 1;
                    Size_W = Gbl_Rect_H;
                    while (Size_W <= GblMachineMaxW | Size_W <= M_Max_L)
                    {
                        if (Size_W >= Size_L)
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_LR;

                            // If Gbl_Machine_Type = "Web Offset" Then
                            // Gbl_M_Min_H = Gbl_Sheet_W
                            // Max_Print_H = Gbl_Sheet_W
                            // End If
                            Gbl_GripperSide = "L";
                            // '*****Check size in Machine Min and Max******''
                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                    {
                                        if (Gbl_Printing_Style == "Work & Tumble")
                                        {
                                            if (Gbl_UPS_L % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else if (Gbl_Printing_Style == "Work & Turn")
                                        {
                                            if (Gbl_UPS_H % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else
                                            Paper_Planning();
                                    }
                                }
                            }
                        }
                        else
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                            Gbl_GripperSide = "H";

                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                    {
                                        if (Gbl_Printing_Style == "Work & Tumble")
                                        {
                                            if (Gbl_UPS_H % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else if (Gbl_Printing_Style == "Work & Turn")
                                        {
                                            if (Gbl_UPS_L % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else
                                            Paper_Planning();
                                    }
                                }
                            }
                        }
                        Size_W = Convert.ToDouble(Size_W) + Convert.ToDouble(Gbl_Rect_H);
                        Gbl_UPS_H = Gbl_UPS_H + 1;
                    }
                    Size_L = Size_L + Gbl_Rect_L;
                    Gbl_UPS_L = Gbl_UPS_L + 1;
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Preplanned_Sheet_Planning(string Grain_Direction)
        {
            // CompanyID = Convert.ToString(HttpContext.Current.Session("CompanyID"))
            double Size_W, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Trimming_LR);
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = !Convert.IsDBNull(Gbl_DT_Machine.Rows[i][14]) && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    bool isColorValid = Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) >= (Gbl_Front_Color + Gbl_Back_Color);
                    bool isFrontBackColorEqual = Gbl_Front_Color == Gbl_Back_Color;

                    if (!isMachineValid || !isColorValid || !isFrontBackColorEqual)
                        goto NextMachine;
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(M_Max_L);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToUInt16(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                // If Gbl_Machine_Gripper is 0, get the value from the machine data
                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Convert.IsDBNull(Gbl_DT_Machine.Rows[i][13]) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }

                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Size_L = Gbl_Rect_L;
                Size_W = Gbl_Rect_H;
                Gbl_UPS_H = 1;
                Gbl_UPS_L = Gbl_Job_Ups;
                if (Size_W >= Size_L)
                {
                    Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                    Gbl_Sheet_W = Size_W + Gbl_Striping_LR;

                    Gbl_GripperSide = "L";
                    // '*****Check size in Machine Min and Max******''
                    if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                    {
                        if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                        {
                            if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                Paper_Planning();
                        }
                    }
                }
                else
                {
                    Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                    Gbl_Sheet_W = Size_W + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                    Gbl_GripperSide = "H";

                    if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                    {
                        if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                        {
                            if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                Paper_Planning();
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Four_Corner_Box_Planning(string Grain_Direction)
        {
            // CompanyID = Convert.ToString(HttpContext.Current.Session("CompanyID"))
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = !(Gbl_DT_Machine.Rows[i][14] is DBNull) && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    bool isColorValid = Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) >= (Gbl_Front_Color + Gbl_Back_Color);
                    bool isFrontBackColorEqual = Gbl_Front_Color == Gbl_Back_Color;

                    if (!isMachineValid || !isColorValid || !isFrontBackColorEqual)
                        goto NextMachine;
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);



                // If Gbl_Machine_Gripper is 0, assign from DataTable
                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = (Gbl_DT_Machine.Rows[i][13] is DBNull) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_W + (Gbl_Job_H * 2);
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_H * 2);

                    Gbl_Die_Size_L = Gbl_Job_W + (Gbl_Job_H * 2); // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_L + (Gbl_Job_H * 2);
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + (Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_TB);
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_TB);
                        }
                        Size_L = Size_L + Gbl_Job_W + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_W + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_H * 2);
                    Gbl_Rect_H = Gbl_Job_W + (Gbl_Job_H * 2);
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = Gbl_Job_L + (Gbl_Job_H * 2);
                    Gbl_Die_Size_H = Gbl_Job_W + (Gbl_Job_H * 2);
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + (Gbl_Job_W + (Gbl_Job_H * 2) + Gbl_Job_Trimming_TB);
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_W + (Gbl_Job_H * 2) + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + (Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR);
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool A4_Corner_Tray_Planning(string Grain_Direction)
        {
            // CompanyID = Convert.ToString(HttpContext.Current.Session("CompanyID"))
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_W + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_TB;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    // Size_H = Gbl_Rect_H

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H);
                        }
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                    Gbl_Rect_H = Gbl_Job_W + (Gbl_Job_H * 2) + Gbl_Job_Trimming_TB;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H);
                        }
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool B_6_Corner_Box_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_H * 2);
                    Gbl_Rect_H = (Gbl_Job_W * 2) + (Gbl_Job_H * 3);

                    Gbl_Die_Size_L = Gbl_Job_L + (Gbl_Job_H * 2); // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = (Gbl_Job_W * 2) + (Gbl_Job_H * 3);
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_W * 2) + (Gbl_Job_H * 3);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = (Gbl_Job_W * 2) + (Gbl_Job_H * 3);
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_H * 2);
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = (Gbl_Job_W * 2) + (Gbl_Job_H * 3);
                    Gbl_Die_Size_H = Gbl_Job_L + (Gbl_Job_H * 2);
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H + Gbl_Job_Overlap_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + (Gbl_Rect_H + Gbl_Job_Trimming_LR);
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + (Gbl_Rect_L + Gbl_Job_Trimming_TB);
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Ovel_Shape_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_L + Gbl_Job_Trimming_LR;
                    Gbl_Rect_H = Gbl_Job_W + Gbl_Job_Trimming_TB;

                    Gbl_Die_Size_L = Gbl_Job_L + Gbl_Job_Trimming_LR;
                    Gbl_Die_Size_H = Gbl_Job_W + Gbl_Job_Trimming_TB;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + (Gbl_Job_L / (double)2) + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + (Gbl_Job_L / (double)2) + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Rect_H - (Gbl_Job_H * (13.5 / 100));
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H - (Gbl_Job_H * (13.5 / 100));
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Job_L + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_W + Gbl_Job_Trimming_TB;
                    Gbl_Rect_H = Gbl_Job_L + Gbl_Job_Trimming_LR;
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = Gbl_Job_W + Gbl_Job_Trimming_TB;
                    Gbl_Die_Size_H = Gbl_Job_L + Gbl_Job_Trimming_LR;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + (Gbl_Job_H / (double)2) + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + (Gbl_Job_H / (double)2) + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + (Gbl_Job_L + Gbl_Job_Trimming_LR) - (Gbl_Job_L * (13.5 / 100));
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_L + Gbl_Job_Trimming_LR - (Gbl_Job_L * (13.5 / 100));
                        }

                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + (Gbl_Job_H + Gbl_Job_Trimming_TB);
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Polygon_Shape_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_lower_Width + Gbl_Job_Trimming_LR;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Trimming_TB;

                    Gbl_Die_Size_L = Gbl_lower_Width + Gbl_Job_Trimming_LR;
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Trimming_TB;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L - ((Gbl_lower_Width - Gbl_upper_Width) / (double)2) + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Rect_H;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Trimming_TB;
                    Gbl_Rect_H = Gbl_lower_Width + Gbl_Job_Trimming_LR;
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Trimming_TB;
                    Gbl_Die_Size_H = Gbl_lower_Width + Gbl_Job_Trimming_LR;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        if (Gbl_upper_Width < Gbl_lower_Width)
                            Size_H = Gbl_lower_Width + Gbl_Job_Trimming_LR;
                        else
                            Size_H = Gbl_upper_Width + Gbl_Job_Trimming_LR;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L - ((Gbl_lower_Width - Gbl_upper_Width) / (double)2) + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L - ((Gbl_lower_Width - Gbl_upper_Width) / (double)2) + Gbl_Striping_LR + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Rect_H;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H;
                        }

                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Wiro_Book_Pages_Planning(string Grain_Direction)
        {
            double Size_W, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }
            else
            {
                Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }

            for (i = 0; i < Gbl_DT_Machine.Rows.Count; i++)
            {
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }
                Size_L = Gbl_Rect_L;
                Gbl_UPS_L = 1;
                while (Size_L <= M_Max_L)
                {
                    Gbl_UPS_H = 1;
                    Size_W = Gbl_Rect_H;
                    while (Size_W <= GblMachineMaxW | Size_W <= M_Max_L)
                    {
                        if (Size_W >= Size_L)
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_LR;

                            if (Gbl_Machine_Type == "Web Offset")
                                M_Min_L = Gbl_Sheet_W;
                            Gbl_GripperSide = "L";
                            // '*****Check size in Machine Min and Max******''
                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                    {
                                        if (Gbl_Printing_Style == "Work & Tumble")
                                        {
                                            if (Gbl_UPS_L % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else if (Gbl_Printing_Style == "Work & Turn")
                                        {
                                            if (Gbl_UPS_H % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else
                                            Paper_Planning();
                                    }
                                }
                            }
                        }
                        else
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                            Gbl_GripperSide = "H";

                            if (Gbl_Machine_Type == "Web Offset")
                                Gbl_M_Min_H = Convert.ToInt64(Gbl_Sheet_W);

                            // '*****Check size in Machine Min and Max******''
                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Size_W <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_W <= Max_Print_H))
                                    {
                                        if (Gbl_Printing_Style == "Work & Tumble")
                                        {
                                            if (Gbl_UPS_H % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else if (Gbl_Printing_Style == "Work & Turn")
                                        {
                                            if (Gbl_UPS_L % 2 == 0)
                                                Paper_Planning();
                                        }
                                        else
                                            Paper_Planning();
                                    }
                                }
                            }
                        }

                        Gbl_UPS_H = Gbl_UPS_H + 1;
                        Size_W = Convert.ToInt64(Size_W) + Convert.ToInt64(Gbl_Rect_H);
                    }

                    Gbl_UPS_L = Gbl_UPS_L + 1;
                    Size_L = Size_L + Gbl_Rect_L;
                }
            }
            return true;
        }

        private void CallPlanningFormula(string ContentName)
        {
            string str;
            str = "Select ContentType, Grain, UpsType, SheetSize, Formula From ContentWiseKeylineSheetPlanning where ContentType = '" + ContentName + "'";
            DBConnection.FillDataTable(ref Gbl_DT_Formula, str);
        }

        private bool Webbed_Self_locking_Tray_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2);
                    Gbl_Rect_H = (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2);

                    Gbl_Die_Size_L = (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2); // + Gbl_Job_Trimming_L + Gbl_Job_Trimming_R
                    Gbl_Die_Size_H = (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2); // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2); // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H) + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2) + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2) + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2);
                    Gbl_Rect_H = (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2);
                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2); // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B
                    Gbl_Die_Size_H = (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2); // + Gbl_Job_Trimming_L + Gbl_Job_Trimming_R
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2);
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2) + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2) + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Ring_Flap_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(M_Max_L);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_W + Gbl_Job_H + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_H * 2) + (Gbl_Job_Overlap_Flap) + Gbl_Job_Open_Flap;

                    Gbl_Die_Size_L = Gbl_Job_W + Gbl_Job_H + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_H * 2) + (Gbl_Job_Overlap_Flap) + Gbl_Job_Open_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_H * 4) + Gbl_Job_W + (Gbl_Job_Open_Flap * 2) + (Gbl_Job_Tongue_Height * 2); // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H) + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Job_W + Gbl_Job_H + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_W + Gbl_Job_H + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = (Gbl_Job_H * 2) + (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Open_Flap;
                    Gbl_Rect_H = Gbl_Job_W + Gbl_Job_H + (Gbl_Job_Overlap_Flap * 2);

                    Gbl_Die_Size_L = (Gbl_Job_H * 2) + (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Open_Flap;
                    Gbl_Die_Size_H = Gbl_Job_W + Gbl_Job_H + (Gbl_Job_Overlap_Flap * 2);

                    Gbl_UPS_L = 1;
                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_H * 4) + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + (Gbl_Job_Tongue_Height * 2);
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Reverse_Tuck_In_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;
            float ups1;
            float Ups;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isRow14DbNull = Convert.IsDBNull(Gbl_DT_Machine.Rows[i][14]);
                    bool row14Value = isRow14DbNull ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);

                    if (!row14Value ||
                        Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color) ||
                        Gbl_Front_Color != Gbl_Back_Color)
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    bool isRow13DbNull = Convert.IsDBNull(Gbl_DT_Machine.Rows[i][13]);
                    Gbl_Machine_Gripper = isRow13DbNull ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Ups = 1;
                ups1 = 1;

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4);
                    Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 4);

                    Gbl_Die_Size_L = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4); // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 4);
                    Gbl_UPS_L = Ups;

                    if (M_Max_L < Gbl_Rect_L)
                    {
                        Gbl_Rect_L = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 2);
                        ups1 = (float)Convert.ToDecimal(0.5);
                        Gbl_UPS_L = Ups;
                    }

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 4);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;

                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + (Gbl_Corrugation_Allowance * 2) + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + (Gbl_Corrugation_Allowance * 2) + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) - Gbl_Width_Minus_Factor + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 4) + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 4);
                    Gbl_Rect_H = ((Gbl_Job_W * 2) + (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4);
                    Gbl_UPS_L = Ups;

                    Gbl_Die_Size_L = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 4); // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B
                    Gbl_Die_Size_H = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4);
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = ups1;

                        Gbl_Die_Size_H = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4);

                        if (M_Max_L < Gbl_Rect_H)
                        {
                            Gbl_Rect_H = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 2);
                            ups1 = (float)Convert.ToDecimal(0.5);
                            Gbl_UPS_H = ups1;
                        }
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) - Gbl_Width_Minus_Factor + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 4) + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + (Gbl_Corrugation_Allowance * 2) + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + (Gbl_Corrugation_Allowance * 2) + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Reverse_Tuck_And_Tongue_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }
                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);

                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap; // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB + Gbl_Job_Tongue_Height;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Tongue_Height + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Convert.ToInt64(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Tongue_Height + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB + Gbl_Job_Tongue_Height;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }
        private bool Env_Center_Pasting(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap; // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }

                    // ''''''interlock style = 7
                    Gbl_InterLock_Style = 7;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap; // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;

                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Open_Flap; // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B
                            }
                            else
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Open_Flap; // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B                            
                            }

                            if (Gbl_UPS_H == 2)
                            {
                                Size_L = Size_L + Gbl_Job_L;
                                Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_L; // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B                            
                            }
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Job_L + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_L + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 5;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                    }

                    // ''''''interlock style = 9
                    Gbl_InterLock_Style = 9;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        if (Gbl_UPS_L >= 2)
                        {
                            Size_H = (Gbl_Job_L * 3) + Gbl_Job_Overlap_Flap;
                            Gbl_Die_Size_H = (Gbl_Job_L * 3) + Gbl_Job_Overlap_Flap;
                        }
                        else
                        {
                            Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                            Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                        }
                        Gbl_UPS_H = 1;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt64(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }

                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }
        private bool Env_L_Pasting(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true
                        || Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)
                        || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap; // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }

                    // ''''''interlock style = 7
                    Gbl_InterLock_Style = 7;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap; // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;

                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Open_Flap;
                            }
                            else
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Open_Flap;
                            }

                            if (Gbl_UPS_H == 2)
                            {
                                Size_L = Size_L + Gbl_Job_Overlap_Flap;
                                Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_Overlap_Flap; // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B                            
                            }
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + (Gbl_Job_L * 2) + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_L * 2) + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 5;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                    }

                    // ''''''interlock style = 9
                    Gbl_InterLock_Style = 9;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        if (Gbl_UPS_L >= 2)
                        {
                            Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Overlap_Flap;
                            Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Overlap_Flap;
                        }
                        else
                        {
                            Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                            Gbl_Die_Size_H = (Gbl_Job_L * 2) + Gbl_Job_Overlap_Flap;
                        }
                        Gbl_UPS_H = 1;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }

                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Sleev_Box_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i].IsNull(14) ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt64(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt64(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i].IsNull(13) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_W;

                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap; // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_W;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Trimming_TB;
                            }
                            else
                            {
                                Size_H = Size_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_H + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_H + Gbl_Job_Trimming_TB;
                            }
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_W;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_W;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Convert.ToInt32(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_H + Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Four_Corner_Hinged_Lid_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Gbl_DT_Machine.Rows[i][10] != DBNull.Value ? Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]) : 0;

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                        goto NextMachine;
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]) : 0;


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_W * 2) + (Gbl_Job_H * 3);
                    Gbl_Rect_H = (Gbl_Job_H * 2) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_L;

                    Gbl_Die_Size_L = (Gbl_Job_W * 2) + (Gbl_Job_H * 3);
                    Gbl_Die_Size_H = (Gbl_Job_H * 2) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_L;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                if (Gbl_UPS_H == 1)
                                    Gbl_Sheet_L = Size_L - Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Machine_Gripper + Gbl_ColorStrip + Gbl_Striping_TB;
                                else
                                    Gbl_Sheet_L = Size_L + Gbl_Machine_Gripper + Gbl_ColorStrip + Gbl_Striping_TB;

                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (Gbl_UPS_H == 1)
                                {
                                    if (Gbl_UPS_H % 2 == 0)
                                        Gbl_Sheet_L = Size_L - Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Striping_TB;
                                    else
                                        Gbl_Sheet_L = Size_L - Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Striping_TB;
                                }
                                else
                                    Gbl_Sheet_L = Size_L + Gbl_Striping_TB;

                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;

                            if (Gbl_UPS_H % 2 == 0)
                            {
                                if (Gbl_Job_Flap_Width > ((Gbl_Job_H + Gbl_Job_Overlap_Flap) / (double)2))
                                {
                                    Size_H = Size_H - Gbl_Job_H - Gbl_Job_Overlap_Flap + Gbl_Job_Flap_Width + Gbl_Job_L + Gbl_Job_Trimming_TB;
                                    Gbl_Die_Size_H = Gbl_Die_Size_H - Gbl_Job_H - Gbl_Job_Overlap_Flap + Gbl_Job_Flap_Width + Gbl_Job_L + Gbl_Job_Trimming_TB;
                                }
                                else
                                {
                                    Size_H = Size_H + Gbl_Job_L + Gbl_Job_Overlap_Flap + Gbl_Job_H + Gbl_Job_Trimming_TB;
                                    Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_L + Gbl_Job_Overlap_Flap + Gbl_Job_H + Gbl_Job_Trimming_TB;
                                }
                            }
                            else if (Gbl_Job_Flap_Width > ((Gbl_Job_H + Gbl_Job_Overlap_Flap) / (double)2))
                            {
                                Size_H = Size_H + Gbl_Job_L + (Gbl_Job_Flap_Width * 2) + Gbl_Job_L + Gbl_Job_Trimming_TB;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_L + (Gbl_Job_Flap_Width * 2) + Gbl_Job_L + Gbl_Job_Trimming_TB;
                            }
                            else
                            {
                                Size_H = Size_H + (Gbl_Job_L) + (Gbl_Job_H) + (Gbl_Job_Overlap_Flap * 2); // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B
                                Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L) + (Gbl_Job_H) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_TB;
                            }
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + (Gbl_Job_W * 2) + (Gbl_Job_H * 2) + Gbl_Job_Open_Flap + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_W * 2) + (Gbl_Job_H * 2) + Gbl_Job_Open_Flap + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = (Gbl_Job_H * 2) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_L;
                    Gbl_Rect_H = (Gbl_Job_W * 2) + (Gbl_Job_H * 2) + Gbl_Job_Open_Flap;
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = (Gbl_Job_H * 2) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_L;
                    Gbl_Die_Size_H = (Gbl_Job_W * 2) + (Gbl_Job_H * 2) + Gbl_Job_Open_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                if (Gbl_UPS_L == 1)
                                    Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                else
                                    Gbl_Sheet_W = Size_H + Gbl_Job_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                if (Gbl_UPS_L == 1)
                                    Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                else
                                    Gbl_Sheet_W = Size_H + Gbl_Job_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "H";
                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Convert.ToInt16(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Open_Flap + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;

                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + Gbl_Job_L + Gbl_Job_H + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_L + Gbl_Job_H + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + (Gbl_Job_H) + (Gbl_Job_Overlap_Flap) + Gbl_Job_L + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_H) + (Gbl_Job_Overlap_Flap) + Gbl_Job_L + Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Env_Side_Pasting(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {

                    // '/////// InterLock_Style 1
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_Die_Size_L = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }

                    // ''''''interlock style = 2
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_Die_Size_L = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;

                            Size_H = Size_H + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {

                    // '/////// InterLock_Style 3
                    Gbl_InterLock_Style = 3;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                    }

                    // ''''''interlock style = 4
                    Gbl_InterLock_Style = 4;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Size_H = Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_H = Gbl_Rect_H;
                        Gbl_UPS_H = 1;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }

                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Calendar_Planning(string Grain_Direction)
        {
            double Size_W, Size_H = 0, Size_L = 0, Gbl_Rect_H = 0, Gbl_Rect_L = 0;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Trimming_LR);
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt32(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Size_L = Gbl_Rect_L;
                Gbl_UPS_L = 1;

                while (Size_L <= M_Max_L)
                {
                    Gbl_UPS_H = 1;
                    Size_W = Gbl_Rect_H;
                    while (Size_W <= GblMachineMaxW | Size_W <= M_Max_L)
                    {
                        if (Size_W >= Size_L)
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_LR;

                            if (Gbl_Machine_Type == "Web Offset")
                            {
                                Gbl_M_Min_H = Convert.ToInt32(Gbl_Sheet_W);
                                Max_Print_H = Gbl_Sheet_W;
                            }
                            Gbl_GripperSide = "L";
                            // '*****Check size in Machine Min and Max******''
                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Convert.ToInt32(Size_H) <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        Paper_Planning();
                                }
                            }
                        }
                        else
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                            Gbl_GripperSide = "H";

                            if (Gbl_Machine_Type == "Web Offset")
                                Gbl_M_Min_H = Convert.ToInt32(Gbl_Sheet_W);

                            // '*****Check size in Machine Min and Max******''
                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        Paper_Planning();
                                }
                            }
                        }

                        Size_W = Convert.ToInt32(Size_W) + Convert.ToInt32(Gbl_Rect_H);
                        Gbl_UPS_H = Gbl_UPS_H + 1;
                    }
                    Size_L = Size_L + Gbl_Rect_L;
                    Gbl_UPS_L = Gbl_UPS_L + 1;
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Carry_Bag_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;
            float Ups;
            float ups1;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt16(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt32(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }



                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);
                Ups = 1;
                ups1 = 1;
                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;

                    // Gbl_UPS_L = 1

                    if (M_Max_L < Gbl_Rect_L)
                    {
                        Gbl_Rect_L = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap;
                        Ups = (float)Convert.ToDecimal(0.5);
                    }
                    Gbl_UPS_L = Ups;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H;
                        }
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        if (M_Max_L < Gbl_Rect_H)
                        {
                            Gbl_Rect_H = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap;
                            ups1 = (float)Convert.ToDecimal(0.5);
                        }
                        Gbl_UPS_H = ups1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Convert.ToInt16(Gbl_Rect_H);
                        }
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Catch_Cover_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true ||
                        (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) ||
                        (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt16(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt32(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_H + Gbl_Job_Bottom_Flap;

                    Gbl_UPS_L = 1;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }

                    // ////////////////////////////////////////////////// InterLock_Style = 2
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_H + Gbl_Job_Bottom_Flap;

                    Gbl_UPS_L = 1;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Job_L + (Gbl_Job_Overlap_Flap) + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {

                    // //////////////////////////////////////////////////////InterLock_Style = 3
                    Gbl_InterLock_Style = 3;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_H + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);

                    Gbl_UPS_L = 1;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }

                    // //////////////////////////////////InterLock_Style = 4
                    Gbl_InterLock_Style = 4;
                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_H + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Overlap_Flap * 2);

                    Gbl_UPS_L = 1;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Job_L + (Gbl_Job_Overlap_Flap) + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Universal_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;
            float Ups;
            float ups1;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);
                Ups = 1;
                ups1 = 1;
                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4);
                    Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 2);

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4); // + Gbl_Job_Trimming_L + Gbl_Job_Trimming_R
                    Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 2);
                    Size_L = Gbl_Rect_L;

                    Gbl_UPS_L = Ups;

                    if (M_Max_L < Gbl_Rect_L)
                    {
                        Gbl_Rect_L = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 2);
                        Ups = (float)Convert.ToDecimal(0.5);
                        Gbl_UPS_L = Ups;
                        Size_L = Gbl_Rect_L;
                    }

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;

                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17

                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 2);
                    Gbl_Rect_H = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4);

                    Gbl_Die_Size_L = Gbl_Job_H + (Gbl_Job_Open_Flap * 2) + (Gbl_Corrugation_Allowance * 2); // + Gbl_Job_Trimming_T + Gbl_Job_Trimming_B
                    Gbl_Die_Size_H = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor + (Gbl_Corrugation_Allowance * 4);
                    Size_L = Gbl_Rect_L;

                    // Gbl_UPS_L = 1
                    Gbl_UPS_L = Ups;
                    while (Size_L <= M_Max_L)
                    {
                        // Gbl_UPS_H = 1
                        Gbl_UPS_H = ups1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;

                        if (M_Max_L < Gbl_Rect_H)
                        {
                            Gbl_Rect_H = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 2);
                            ups1 = (float)Convert.ToDecimal(0.5);
                            Gbl_UPS_H = ups1;
                            Size_H = Gbl_Rect_H;
                        }

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;

                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17

                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;

                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17

                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Convert.ToInt16(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + (Gbl_Job_Open_Flap * 2) + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Universal_Crash_Lock_With_Pasting_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                        continue;
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]) : 0;
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Convert.ToInt16(Gbl_Rect_H);
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Standard_Straight_Tuck_In_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                        continue; // Skip to next iteration instead of using goto
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt16(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]) : 0;
                }

                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2) + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2);
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Convert.ToInt32(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_TB;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + (Gbl_Job_Open_Flap * 2) + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Crash_Lock_With_Pasting_Planning4(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                        continue;
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt16(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]) : 0;
                }
                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            }
                            else
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            }
                            if (Gbl_UPS_H == 2)
                                Size_L = Size_L + Gbl_Job_W - Gbl_Job_Overlap_Flap;
                        }

                        if (Gbl_UPS_H > 1)
                            Size_L = Size_L + (Gbl_Job_L * 2) + (Gbl_Job_W) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_LR;
                        else
                            Size_L = Size_L + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;

                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;

                            if (Gbl_UPS_H == 2)
                            {
                                Size_H = Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 3) + Gbl_Job_Trimming_LR;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 3) + Gbl_Job_Trimming_LR;
                            }
                            else
                            {
                                Size_H = Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                                Gbl_Die_Size_H = Gbl_Die_Size_H + (Gbl_Job_L * 2) + (Gbl_Job_W * 3) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_LR;
                            }
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;

                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Crash_Lock_With_Pasting_Planning3(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                        continue;
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt16(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]) : 0;
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H = Size_H + Gbl_Job_H + ((Gbl_Job_W + Gbl_Job_Open_Flap) / (double)2) + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + ((Gbl_Job_W + Gbl_Job_Open_Flap) / (double)2) + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            }
                            else
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;// + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;//+ Gbl_Job_Trimming_TB;
                            }
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Convert.ToInt32(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;

                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + Gbl_Job_H + ((Gbl_Job_W + Gbl_Job_Open_Flap) / (double)2) + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + ((Gbl_Job_W + Gbl_Job_Open_Flap) / (double)2) + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;//+ Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;//+ Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }
        private bool Crash_Lock_With_Pasting_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;
            float Ups;
            float ups1;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                        continue; // Skips to the next iteration instead of using 'goto'
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt16(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt16(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value
                        ? Convert.ToDouble(Gbl_DT_Machine.Rows[i][13])
                        : 0;
                }
                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Ups = 1;
                ups1 = 1;

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_Die_Size_L = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor;
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;


                    // Gbl_UPS_L = 1

                    if (M_Max_L < Gbl_Rect_L)
                    {
                        Gbl_Rect_L = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 2);
                        Ups = (float)Convert.ToDecimal(0.5);
                    }
                    Gbl_UPS_L = Ups;
                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            }
                            else
                            {
                                Size_H = Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;// + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;// + Gbl_Job_Trimming_TB;
                            }
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor;

                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor;

                    Gbl_UPS_L = Ups;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_Die_Size_H = ((Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap) - Gbl_Width_Minus_Factor;

                        if (M_Max_L < Gbl_Rect_H)
                        {
                            Gbl_Rect_H = Gbl_Job_L + Gbl_Job_W + Gbl_Job_Overlap_Flap + (Gbl_Corrugation_Allowance * 2);
                            ups1 = (float)Convert.ToDecimal(0.5);
                        }
                        Size_H = Gbl_Rect_H;
                        Gbl_UPS_H = ups1;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_Process_Size_L = Size_L;
                                Gbl_Process_Size_H = Size_H;
                                // '''BY MJ CALCULATE PROCESS SIZE 20-11-17
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Convert.ToInt16(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;

                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L = Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;// + Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;// + Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }
        private bool Crash_Lock_With_Pasting_Planning2(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || (Gbl_Front_Color != Gbl_Back_Color))
                        continue; // Skip to the next iteration instead of using 'goto'
                }

                // Assign Machine Details
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt16(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt16(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value ? Convert.ToInt32(Gbl_DT_Machine.Rows[i][13]) : 0;
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;

                            Size_H = Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size H
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Convert.ToInt16(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;

                        Size_L = Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        // ''''''' Die Cut Size L
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Crash_Lock_Without_Pasting_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i].IsNull(14) ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                if (Gbl_Machine_Gripper == 0)
                    Gbl_Machine_Gripper = Convert.ToDouble(Gbl_DT_Machine.Rows[i].IsNull(13) ? 0 : Gbl_DT_Machine.Rows[i][13]);

                if (Gbl_Printing_Style == "Work & Tumble" || Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper *= 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Rect_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                        while (Size_H <= GblMachineMaxW || Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L && Gbl_Sheet_L <= GblMachineMaxW) || (Gbl_Sheet_L <= M_Max_L && Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L && Gbl_Sheet_L >= Gbl_M_Min_H) || (Gbl_Sheet_L >= M_Min_L && Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L && Size_L <= Max_Print_H) || (Size_L <= Max_Print_L && Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L && Gbl_Sheet_L <= GblMachineMaxW) || (Gbl_Sheet_L <= M_Max_L && Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L && Gbl_Sheet_L >= Gbl_M_Min_H) || (Gbl_Sheet_L >= M_Min_L && Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L && Size_L <= Max_Print_H) || (Size_L <= Max_Print_L && Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H++;
                            if (Gbl_UPS_H % 2 == 0)
                            {
                                Size_H += Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H += Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            }
                            else
                            {
                                Size_H += Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;// + Gbl_Job_Trimming_TB;
                                // ''''''' Die Cut Size H
                                Gbl_Die_Size_H += Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;//+ Gbl_Job_Trimming_TB;
                            }
                        }
                        Size_L += Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L++;
                        Gbl_Die_Size_L += Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Rect_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;
                    Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = (Gbl_Job_L * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap;
                        while (Size_H <= GblMachineMaxW || Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L && Gbl_Sheet_L <= GblMachineMaxW) || (Gbl_Sheet_L <= M_Max_L && Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L && Gbl_Sheet_L >= Gbl_M_Min_H) || (Gbl_Sheet_L >= M_Min_L && Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L && Size_L <= Max_Print_H) || (Size_L <= Max_Print_L && Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L && Gbl_Sheet_L <= GblMachineMaxW) || (Gbl_Sheet_L <= M_Max_L && Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L && Gbl_Sheet_L >= Gbl_M_Min_H) || (Gbl_Sheet_L >= M_Min_L && Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L && Size_L <= Max_Print_H) || (Size_L <= Max_Print_L && Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H++;
                            Size_H = Convert.ToInt16(Size_H) + Convert.ToInt16(Gbl_Rect_H) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H += Gbl_Rect_H + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L++;

                        if (Gbl_UPS_L % 2 == 0)
                        {
                            Size_L += Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L += Gbl_Job_H + Gbl_Job_Bottom_Flap + Gbl_Job_Trimming_TB;
                        }
                        else
                        {
                            Size_L += Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;//+ Gbl_Job_Trimming_TB;
                            // ''''''' Die Cut Size L
                            Gbl_Die_Size_L += Gbl_Job_H + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Bottom_Flap;//+ Gbl_Job_Trimming_TB;
                        }
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Turn_Over_End_Tray_Planning(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = Gbl_DT_Machine.Rows[i][14] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14]);
                    int machineColorCapacity = Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || (Gbl_Front_Color != Gbl_Back_Color))
                        continue;
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt16(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt16(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();

                // Handle Gbl_Machine_Gripper Assignment
                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i][13] != DBNull.Value
                        ? Convert.ToInt32(Gbl_DT_Machine.Rows[i][13])
                        : 0;
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_H * 2);
                    Gbl_Rect_H = Gbl_Job_W + (((Gbl_Job_L) * 70 / (double)100) * 2) + (Gbl_Job_Overlap_Flap * 2);

                    Gbl_Die_Size_L = Gbl_Job_L + (Gbl_Job_H * 2); // + Gbl_Job_Trimming_LR
                    Gbl_Die_Size_H = Gbl_Job_W + (((Gbl_Job_L) * 70 / (double)100) * 2) + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_UPS_L = 1;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Job_W + (Gbl_Job_H * 4) + (Gbl_Job_Overlap_Flap * 2);
                        Gbl_Die_Size_H = Gbl_Job_W + (((Gbl_Job_L) * 70 / (double)100) * 2) + (Gbl_Job_Overlap_Flap * 2);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt32(Size_H) + Gbl_Job_W + (Gbl_Job_H * 4) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_W + (Gbl_Job_H * 4) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_TB;
                        }
                        Size_L = Size_L + Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;
                    Gbl_Rect_L = Gbl_Job_W + (Gbl_Job_H * 4) + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_H * 2);
                    Gbl_UPS_L = 1;

                    Gbl_Die_Size_L = Gbl_Job_W + (Gbl_Job_H * 4) + (Gbl_Job_Overlap_Flap * 2);
                    Gbl_Die_Size_H = Gbl_Job_L + (Gbl_Job_H * 2);
                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Job_L + (Gbl_Job_H * 2);
                        Gbl_Die_Size_H = Gbl_Job_L + (Gbl_Job_H * 2);

                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Size_H + Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_L + (Gbl_Job_H * 2) + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Job_W + (Gbl_Job_H * 4) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_TB;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Job_W + (Gbl_Job_H * 4) + (Gbl_Job_Overlap_Flap * 2) + Gbl_Job_Trimming_TB;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Standard_Straight_Tuck_In_Hang(string Grain_Direction)
        {
            double Size_H, Size_L, Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i].IsNull(14) ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        continue;
                    }
                }

                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i].IsNull(13) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }

                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                if (Grain_Direction == "With Grain")
                {
                    Gbl_InterLock_Style = 1;
                    Gbl_Rect_H = (Gbl_Job_H * 2) + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap) + (Gbl_Job_Tongue_Height * 2) + Gbl_Job_Trimming_LR;
                    Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_TB;

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_H = (Gbl_Job_H * 2) + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap) + (Gbl_Job_Tongue_Height * 2) + Gbl_Job_Trimming_LR;
                    Gbl_Die_Size_L = Gbl_Job_L + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + Gbl_Job_Trimming_TB;

                    Size_L = Gbl_Rect_L;
                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip; // + Gbl_Printing_Margin_TB
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Rect_H + Gbl_Job_Trimming_TB;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                        Gbl_Die_Size_L = Gbl_Die_Size_L + Gbl_Rect_L + Gbl_Job_Trimming_LR;
                    }
                }
                else if (Grain_Direction == "Across Grain")
                {
                    Gbl_InterLock_Style = 2;

                    Gbl_Rect_L = (Gbl_Job_H * 2) + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap) + (Gbl_Job_Tongue_Height * 2) + Gbl_Job_Trimming_TB;
                    Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2) + Gbl_Job_Trimming_LR;

                    Gbl_UPS_L = 1;
                    Gbl_Die_Size_L = Gbl_Rect_L;
                    Gbl_Die_Size_H = Gbl_Rect_H;

                    Size_L = Gbl_Rect_L;

                    while (Size_L <= M_Max_L)
                    {
                        Gbl_UPS_H = 1;
                        Size_H = Gbl_Rect_H;
                        Gbl_Die_Size_H = Gbl_Rect_H;
                        while (Size_H <= GblMachineMaxW | Size_H <= M_Max_L)
                        {
                            if (Size_H >= Size_L)
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_LR;
                                Gbl_GripperSide = "L";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                                Gbl_Sheet_W = Size_H + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                                Gbl_GripperSide = "H";

                                // '*****Check size in Machine Min and Max******''
                                if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                                {
                                    if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                    {
                                        if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        {
                                            if (Gbl_Printing_Style == "Work & Tumble")
                                            {
                                                if (Gbl_UPS_H % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else if (Gbl_Printing_Style == "Work & Turn")
                                            {
                                                if (Gbl_UPS_L % 2 == 0)
                                                    Paper_Planning();
                                            }
                                            else
                                                Paper_Planning();
                                        }
                                    }
                                }
                            }
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                            Size_H = Convert.ToInt16(Size_H) + Gbl_Job_L + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Trimming_LR;
                            Gbl_Die_Size_H = Gbl_Die_Size_H + Gbl_Job_L + Gbl_Job_W + Gbl_Job_Open_Flap + Gbl_Job_Trimming_LR;
                        }
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                        Size_L = Size_L + Gbl_Rect_L; // + Gbl_Job_Trimming_TB
                        Gbl_Die_Size_L = Gbl_Die_Size_L + (Gbl_Job_H * 2) + (Gbl_Job_W * 2) + Gbl_Job_Overlap_Flap + (Gbl_Job_Tongue_Height * 2); // + Gbl_Job_Trimming_TB
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }

        private bool Book_Pages_Planning(string Grain_Direction)
        {
            // CompanyID = Convert.ToString(HttpContext.Current.Session("CompanyID"))
            double Size_W = 0, Size_H = 0, Size_L = 0, Gbl_Rect_H = 0, Gbl_Rect_L = 0;
            double M_Max_L = 0;
            double M_Min_L = 0, Max_Print_L = 0, Max_Print_H = 0;
            int i;

            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_L = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }
            else
            {
                Gbl_Rect_L = Gbl_Job_H + (Gbl_Job_Trimming_TB);
                Gbl_Rect_H = Gbl_Job_L + (Gbl_Job_Trimming_LR);
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i].IsNull(14) ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToInt32(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        continue;
                    }
                }
                Gbl_Machine_Gripper = Gbl_Gripper;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Convert.ToString(Gbl_DT_Machine.Rows[i][1]);
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt16(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt16(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt64(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Convert.ToString(Gbl_DT_Machine.Rows[i][11]);

                // Handle Machine Gripper Assignment
                if (Gbl_Machine_Gripper == 0)
                {
                    Gbl_Machine_Gripper = Gbl_DT_Machine.Rows[i].IsNull(13) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][13]);
                }


                if (Gbl_Printing_Style == "Work & Tumble" | Gbl_Printing_Style == "FB-Perfection")
                    Gbl_Machine_Gripper = Gbl_Machine_Gripper * 2;

                Gbl_Machine_Gripper = Math.Round(Gbl_Machine_Gripper, 3);

                Size_L = Gbl_Rect_L;
                Size_W = Gbl_Rect_H;
                if (Grain_Direction == "Across Grain")
                {
                    Size_L = Gbl_Rect_L;
                    Gbl_UPS_L = 1;
                }
                else
                {
                    Size_L = Gbl_Rect_L * 2;
                    Gbl_UPS_L = 2;
                }

                while (Size_L <= M_Max_L)
                {
                    if (Grain_Direction == "Across Grain")
                    {
                        Size_W = Gbl_Rect_H * 2;
                        Gbl_UPS_H = 2;
                    }
                    else
                    {
                        Size_W = Gbl_Rect_H;
                        Gbl_UPS_H = 1;
                    }

                    while (Size_W <= GblMachineMaxW | Size_W <= M_Max_L)
                    {
                        if (Size_W >= Size_L)
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_LR;
                            Gbl_GripperSide = "L";

                            // If Gbl_Machine_Type = "Web Offset" Then
                            // Gbl_M_Min_H = Gbl_Sheet_W
                            // Max_Print_H = Gbl_Sheet_W
                            // End If

                            // '*****Check size in Machine Min and Max******''
                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        Paper_Planning();
                                }
                            }
                        }
                        else
                        {
                            Gbl_Sheet_L = Size_L + Gbl_Striping_LR;
                            Gbl_Sheet_W = Size_W + Gbl_Striping_TB + Gbl_Machine_Gripper + Gbl_ColorStrip;

                            // If Gbl_Machine_Type = "Web Offset" Then
                            // Gbl_M_Min_H = Gbl_Sheet_W
                            // End If

                            // '*****Check size in Machine Min and Max******''
                            if ((Gbl_Sheet_W <= M_Max_L & Gbl_Sheet_L <= GblMachineMaxW) | (Gbl_Sheet_L <= M_Max_L & Gbl_Sheet_W <= GblMachineMaxW))
                            {
                                if ((Gbl_Sheet_W >= M_Min_L & Gbl_Sheet_L >= Gbl_M_Min_H) | (Gbl_Sheet_L >= M_Min_L & Gbl_Sheet_W >= Gbl_M_Min_H))
                                {
                                    if ((Size_H <= Max_Print_L & Size_L <= Max_Print_H) | (Size_L <= Max_Print_L & Size_H <= Max_Print_H))
                                        Paper_Planning();
                                }
                            }
                        }
                        if (Grain_Direction == "Across Grain")
                        {
                            Gbl_UPS_H = Gbl_UPS_H + 2;
                            Size_W = Convert.ToInt16(Size_W) + Convert.ToInt16(Gbl_Rect_H) + Gbl_Rect_H;
                        }
                        else
                        {
                            Size_W = Convert.ToInt16(Size_W) + Convert.ToInt16(Gbl_Rect_H);
                            Gbl_UPS_H = Gbl_UPS_H + 1;
                        }
                    }

                    if (Grain_Direction == "Across Grain")
                    {
                        Size_L = Size_L + Gbl_Rect_L;
                        Gbl_UPS_L = Gbl_UPS_L + 1;
                    }
                    else
                    {
                        Gbl_UPS_L = Gbl_UPS_L + 2;
                        Size_L = Size_L + Gbl_Rect_L + Gbl_Rect_L;
                    }
                }

            NextMachine:
                ;
            }
            return true;
        }
        private void Plan_On_Sheet()
        {
            try
            {
                long Cut_L, Cut_H, Cut_H_L, Cut_L_H;
                double Bal_L, Bal_H, Final_Bal_L, Final_Bal_H, Waste_In_Percent, Waste;

                for (var i = 0; i <= Gbl_DT_Paper.Rows.Count - 1; i++)
                {
                    Gbl_Paper_ID = Convert.IsDBNull(Gbl_DT_Paper.Rows[i][0]) ? 0 : Convert.ToInt32(Gbl_DT_Paper.Rows[i][0]);
                    if (Gbl_Paper_ID == 0)
                    {
                        Gbl_DT_Paper.Rows[i][10] = Gbl_Sheet_W;
                        Gbl_DT_Paper.Rows[i][11] = Gbl_Sheet_L;
                    }
                    Gbl_Paper_GSM = Gbl_DT_Paper.Rows[i].IsNull(2) ? 0 : Convert.ToDouble(Gbl_DT_Paper.Rows[i][2]);
                    Gbl_Packing = Gbl_DT_Paper.Rows[i].IsNull(4) ? "" : Convert.ToString(Gbl_DT_Paper.Rows[i][4]);
                    Gbl_Unit_Per_Packing = Gbl_DT_Paper.Rows[i].IsNull(5) ? "" : Gbl_DT_Paper.Rows[i][5].ToString();
                    Gbl_Paper_Rate = Gbl_DT_Paper.Rows[i].IsNull(7) ? 0 : Convert.ToDouble(Gbl_DT_Paper.Rows[i][7]);

                    if (Gbl_Paper_TrimmingLR == 0 && Gbl_Paper_TrimmingTB == 0)
                    {
                        Gbl_Paper_TrimmingLR = Gbl_DT_Paper.Rows[i].IsNull(9) ? 0 : Convert.ToDouble(Gbl_DT_Paper.Rows[i][9]);
                        Gbl_Paper_TrimmingTB = Gbl_Paper_TrimmingLR;
                    }

                    Gbl_Paper_H = Gbl_DT_Paper.Rows[i].IsNull(10) ? 0 : Convert.ToDouble(Gbl_DT_Paper.Rows[i][10]);
                    Gbl_Paper_L = Gbl_DT_Paper.Rows[i].IsNull(11) ? 0 : Convert.ToDouble(Gbl_DT_Paper.Rows[i][11]);
                    // Gbl_Is_Standard_Paper = Gbl_DT_Paper.Rows[i].IsNull(13) ? false : Convert.ToBoolean(Gbl_DT_Paper.Rows[i][13]);
                    // Gbl_Is_Balance_Piece = Gbl_DT_Paper.Rows[i].IsNull(15) ? false : Convert.ToBoolean(Gbl_DT_Paper.Rows[i][15]);

                    Gbl_Paper_Rate_Type = Gbl_DT_Paper.Rows[i].IsNull(16) ? "" : Convert.ToString(Gbl_DT_Paper.Rows[i][16]);
                    GblPaperPurchaseRateType = Gbl_DT_Paper.Rows[i].IsNull(20) ? "" : Convert.ToString(Gbl_DT_Paper.Rows[i][20]);
                    Gbl_Paper_Quality = Gbl_DT_Paper.Rows[i].IsNull(1) ? "" : Convert.ToString(Gbl_DT_Paper.Rows[i][1]);
                    GblMainPaperGroup = Gbl_DT_Paper.Rows[i].IsNull(18) ? "" : Convert.ToString(Gbl_DT_Paper.Rows[i][18]);

                    Gbl_Paper_Detail = "Quality=" + Gbl_Paper_Quality.Trim() + " and GSM=" + Gbl_Paper_GSM.ToString().Trim() + " and SizeW=" + Gbl_Paper_H.ToString().Trim() + " And SizeL=" + Gbl_Paper_L.ToString().Trim();

                    if (Gbl_Paper_ID == 0)
                    {
                        Gbl_Paper_L = Math.Round(Gbl_Paper_L + ((Gbl_Paper_TrimmingLR)), 2);
                        Gbl_Paper_H = Math.Round(Gbl_Paper_H + ((Gbl_Paper_TrimmingTB)), 2);
                    }
                    else
                    {
                        Gbl_Paper_L = Math.Round(Gbl_Paper_L - ((Gbl_Paper_TrimmingLR)), 2);
                        Gbl_Paper_H = Math.Round(Gbl_Paper_H - ((Gbl_Paper_TrimmingTB)), 2);
                    }

                    Gbl_Sheet_W = Math.Round(Gbl_Sheet_W, 2);
                    Gbl_Sheet_L = Math.Round(Gbl_Sheet_L, 2);

                    if ((Gbl_Sheet_L <= Gbl_Paper_L & Gbl_Sheet_W <= Gbl_Paper_H))
                    {
                        Cut_L = (int)Math.Floor(Gbl_Paper_L / (double)Gbl_Sheet_L);
                        Cut_H = (int)Math.Floor(Gbl_Paper_H / (double)Gbl_Sheet_W);


                        // Calculating Balance Piece size
                        Bal_L = Gbl_Paper_L - (Gbl_Sheet_L * Cut_L);
                        Bal_H = Gbl_Paper_H - (Gbl_Sheet_W * Cut_H);

                        Cut_H_L = 0;
                        Cut_L_H = 0;
                        // If Gbl_Grain_Direction = "Both" Then
                        if (Gbl_Plan_Grain_Direction == "Both")
                        {
                            if (Bal_L >= Gbl_Sheet_W)
                            {
                                Cut_L_H = (int)Math.Floor(Bal_L / (double)(Gbl_Sheet_W == 0 ? 1 : Gbl_Sheet_W));
                                Cut_H_L = (int)Math.Floor(Gbl_Paper_H / (double)(Gbl_Sheet_L == 0 ? 1 : Gbl_Sheet_L));
                            }

                            if (Bal_H >= Gbl_Sheet_L)
                            {
                                Cut_H_L = (int)Math.Floor(Bal_H / (double)(Gbl_Sheet_L == 0 ? 1 : Gbl_Sheet_L));
                                Cut_L_H = (int)Math.Floor(Gbl_Paper_L / (double)(Gbl_Sheet_W == 0 ? 1 : Gbl_Sheet_W));
                            }


                            Final_Bal_L = Bal_L - (Cut_L_H * Gbl_Sheet_W);
                            Final_Bal_H = Bal_H - (Cut_H_L * Gbl_Sheet_L);

                            if ((Final_Bal_L * Gbl_Paper_H) > (Final_Bal_H * Gbl_Paper_L))
                            {
                                Bal_Piece = Gbl_Paper_H + "x" + Math.Round(Final_Bal_L, 2);
                                Gbl_Bal_Side = "L";
                            }
                            else
                            {
                                Bal_Piece = Math.Round(Final_Bal_H, 2) + "x" + Gbl_Paper_L;
                                Gbl_Bal_Side = "W";
                            }

                            Waste = Math.Round((Gbl_Paper_L * Gbl_Paper_H) - ((Gbl_Sheet_L * Gbl_Sheet_W) * ((Cut_L * Cut_H) + (Cut_L_H * Cut_H_L))), 2);
                            Waste_In_Percent = Math.Round(Waste * 100 / (Gbl_Paper_L * Gbl_Paper_H), 2);
                        }
                        else
                        {
                            if ((Bal_L * Gbl_Paper_H) > (Bal_H * Gbl_Paper_L))
                            {
                                Bal_Piece = Gbl_Paper_H + "x" + Math.Round(Bal_L, 2);
                                Gbl_Bal_Side = "L";
                            }
                            else
                            {
                                Bal_Piece = Math.Round(Bal_H, 2) + "x" + Gbl_Paper_L;
                                Gbl_Bal_Side = "W";
                            }
                            Waste = Math.Round((Gbl_Paper_L * Gbl_Paper_H) - ((Gbl_Sheet_L * Gbl_Sheet_W) * (Cut_L * Cut_H)), 2);
                            Waste_In_Percent = Math.Round(Waste * 100 / (Gbl_Paper_L * Gbl_Paper_H), 2);
                        }
                        if (Convert.ToDouble(GblShowPlanUptoWastagePerc) > 0)
                        {
                            if (Convert.ToDouble(Waste_In_Percent) <= Convert.ToDouble(GblShowPlanUptoWastagePerc))
                            {
                                // Do nothing or continue logic
                            }
                            else
                            {
                                goto nextPaper;
                            }
                        }

                        if (Gbl_Orientation == "BookPages" | Gbl_Orientation == "WiroBookPages" | Gbl_Orientation == "Calendar" | Gbl_Orientation == "WiroLeaves")
                            Add_Shirin_Book(Cut_L, Cut_H, Cut_H_L, Cut_L_H, Bal_Piece, Gbl_Bal_Side, Waste, Waste_In_Percent);
                        else
                            Add_Shirin(Cut_L, Cut_H, Cut_H_L, Cut_L_H, Bal_Piece, Gbl_Bal_Side, Waste, Waste_In_Percent);

                    }
                nextPaper:;
                }
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
            }
        }

        private void Plan_On_Reel()
        {
            try
            {
                int pi;
                double Reel_Width;
                long Cut_L = 0, Cut_H = 0, Cut_H_L = 0, Cut_L_H = 0;
                double Bal_L, Bal_H, Waste_In_Percent, Waste;

                for (pi = 0; pi <= GblDTReel.Rows.Count - 1; pi++)
                {
                    Gbl_Paper_ID = GblDTReel.Rows[pi][0] == DBNull.Value ? 0 : Convert.ToInt32(GblDTReel.Rows[pi][0]);

                    if (Gbl_Paper_ID == 0)
                    {
                        GblDTReel.Rows[pi][10] = Gbl_Sheet_W;
                        GblDTReel.Rows[pi][11] = Gbl_Sheet_L;
                    }

                    Gbl_Paper_GSM = GblDTReel.Rows[pi][2] == DBNull.Value ? 0 : Convert.ToInt32(GblDTReel.Rows[pi][2]);
                    Gbl_Paper_Rate = GblDTReel.Rows[pi][7] == DBNull.Value ? 0 : Convert.ToDouble(GblDTReel.Rows[pi][7]);
                    Reel_Width = GblDTReel.Rows[pi][10] == DBNull.Value ? 0 : Convert.ToDouble(GblDTReel.Rows[pi][10]);


                    // Gbl_Main_Paper_Group = GblDTReel.TextMatrix(pi, 18)

                    if (Reel_Width < Gbl_Sheet_W)
                        //goto NextReel;  //Commented by Abhinav & Vivek on 11-11-2025 

                        if (GblMachineMaxL < Gbl_Sheet_L)
                            goto NextReel;
                    // If Gbl_Machine_Max_Paper_H > Gbl_Sheet_H Then
                    // GoTo NextReel
                    // End If
                    Cut_H = (int)Math.Floor(Reel_Width / Gbl_Sheet_W);
                    Cut_L = 1;
                    Gbl_Paper_H = Reel_Width;

                    if (Gbl_M_Min_H != 0)
                        Gbl_Paper_L = Math.Round(Gbl_Sheet_L, 2); // Gbl_M_Min_H  Variable cutoff setting in line o matic machine
                    else
                        Gbl_Paper_L = GblMachineMaxL;// Gbl_Sheet_L fix web cut off

                    Bal_H = Gbl_Paper_H - (Gbl_Sheet_W * Cut_H);
                    Bal_L = Gbl_Paper_L - (Gbl_Sheet_L * Cut_L);

                    if ((Bal_L * Gbl_Paper_H) > (Bal_H * Gbl_Paper_L))
                    {
                        Bal_Piece = Gbl_Paper_H + "x" + Math.Round(Bal_L, 2);
                        Gbl_Bal_Side = "L";
                    }
                    else
                    {
                        Bal_Piece = Math.Round(Bal_H, 2) + "x" + Gbl_Paper_L;
                        Gbl_Bal_Side = "W";
                    }

                    Gbl_Paper_Detail = "Quality=" + Gbl_Paper_Quality.Trim() + " and GSM=" + Gbl_Paper_GSM.ToString().Trim() + " and SizeW=" + Reel_Width.ToString().Trim() + "";

                    Waste = Math.Round((Gbl_Paper_L * Gbl_Paper_H) - ((Gbl_Sheet_L * Gbl_Sheet_W) * (Cut_L * Cut_H)), 2);
                    Waste_In_Percent = Math.Round(Waste * 100 / (Gbl_Paper_L * Gbl_Paper_H), 2);
                    if (Convert.ToDouble(GblShowPlanUptoWastagePerc) > 0)
                    {
                        if (Convert.ToDouble(Waste_In_Percent) <= Convert.ToDouble(GblShowPlanUptoWastagePerc))
                        {
                            // Do nothing or continue logic
                        }
                        else
                        {
                            goto NextReel;
                        }
                    }

                    if (Gbl_Orientation == "BookPages" | Gbl_Orientation == "WiroBookPages" | Gbl_Orientation == "Calendar" | Gbl_Orientation == "WiroLeaves")
                    {
                        if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection" | Gbl_Printing_Style == "Single Side")
                            Add_Shirin_Book(Cut_L, Cut_H, Cut_H_L, Cut_L_H, Bal_Piece, Gbl_Bal_Side, Waste, Waste_In_Percent);
                    }
                    else if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection" | Gbl_Printing_Style == "Single Side")
                        Add_Shirin(Cut_L, Cut_H, Cut_H_L, Cut_L_H, Bal_Piece, Gbl_Bal_Side, Waste, Waste_In_Percent);

                    NextReel:
                    ;
                }
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
            }
        }
        public string Plan_On_Corrugation_Machine(string width, string length)
        {
            try
            {
                int pi;
                double MinWidth;
                double MaxWidth;
                double MinCutting;
                double MaxCutting;
                long DeckleCuts;
                double ReqDeckle;
                string MachineName;
                long MachineID;

                double width1;
                double length1;

                GblDTCorrugationPlan.Columns.Clear();
                GblDTCorrugationPlan.Rows.Clear();

                GblDTCorrugationPlan.Columns.Add("MachineID");
                GblDTCorrugationPlan.Columns.Add("MachineName");
                GblDTCorrugationPlan.Columns.Add("Deckle");
                GblDTCorrugationPlan.Columns.Add("Cutting");
                GblDTCorrugationPlan.Columns.Add("DeckleCuts");
                GblDTCorrugationPlan.Columns.Add("RequiredDeckle");
                GblDTCorrugationPlan.Columns.Add("RequiredCutting");

                k = "Corrugation_Machine";
                GblDTCorrugationMachine = GetDataTable();

                width1 = Convert.ToDouble(width);
                length1 = Convert.ToDouble(length);

                for (pi = 0; pi <= GblDTCorrugationMachine.Rows.Count - 1; pi++)
                {
                    MaxWidth = Convert.ToDouble(GblDTCorrugationMachine.Rows[pi]["MaxReelSize"]);
                    MinWidth = Convert.ToDouble(GblDTCorrugationMachine.Rows[pi]["MinReelSize"]);
                    MinCutting = Convert.ToDouble(GblDTCorrugationMachine.Rows[pi]["WebCutOffSizeMin"]);
                    MaxCutting = Convert.ToDouble(GblDTCorrugationMachine.Rows[pi]["WebCutOffSize"]);
                    MachineName = GblDTCorrugationMachine.Rows[pi]["MachineName"].ToString();
                    MachineID = Convert.ToInt32(GblDTCorrugationMachine.Rows[pi]["MachineID"]);

                    DeckleCuts = 1;
                    ReqDeckle = width1;
                    // 'START'' By Vivek For Sri Kriscon Dewas  
                    if (width1 < MinWidth)
                    {
                        DeckleCuts = DeckleCuts + 1;
                        ReqDeckle = DeckleCuts * width1;
                    }
                    // 'END'' By Vivek For Sri Kriscon Dewas  

                    while (ReqDeckle <= MaxWidth && ReqDeckle >= MinWidth)
                    {
                        if (length1 <= MaxCutting && length1 >= MinCutting)
                        {
                            DataRow newRow = GblDTCorrugationPlan.NewRow();
                            newRow["MachineID"] = MachineID;
                            newRow["MachineName"] = MachineName;
                            newRow["Deckle"] = width;
                            newRow["Cutting"] = length;
                            newRow["DeckleCuts"] = DeckleCuts;
                            newRow["RequiredDeckle"] = ReqDeckle;
                            newRow["RequiredCutting"] = length;
                            GblDTCorrugationPlan.Rows.Add(newRow);

                            DeckleCuts = DeckleCuts + 1;
                            ReqDeckle = Convert.ToDouble(DeckleCuts) * Convert.ToDouble(width);
                        }
                        else if (length1 < MinCutting)
                        {
                            planErrors = "Cutting size is less than minimum machine size, Please check machine size.";
                            return planErrors;
                        }
                    }
                }
                return DBConnection.ConvertDataTableToJsonString(GblDTCorrugationPlan);
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return planErrors;
            }
        }
        private void Plan_On_Reel_Slitting()
        {
            try
            {
                int pi;
                double Reel_Width;
                long Cut_L = 0, Cut_H = 0, Cut_H_L = 0, Cut_L_H = 0;
                double Bal_L, Bal_H, Waste_In_Percent, Waste;

                for (pi = 0; pi <= GblDTReel.Rows.Count - 1; pi++)
                {

                    Gbl_Paper_ID = Convert.IsDBNull(GblDTReel.Rows[pi][0]) ? 0 : Convert.ToInt32(GblDTReel.Rows[pi][0]);
                    if (Gbl_Paper_ID == 0)
                    {
                        GblDTReel.Rows[pi][10] = Gbl_Sheet_W;
                        GblDTReel.Rows[pi][11] = Gbl_Sheet_L;
                    }
                    Gbl_Paper_GSM = Convert.ToInt32(GblDTReel.Rows[pi][2]);
                    Gbl_Paper_Rate = Convert.IsDBNull(GblDTReel.Rows[pi][7]) ? 0 : Convert.ToDouble(GblDTReel.Rows[pi][7]);
                    Reel_Width = Convert.IsDBNull(GblDTReel.Rows[pi][10]) ? 0 : Convert.ToDouble(GblDTReel.Rows[pi][10]);

                    if (Reel_Width < Gbl_Sheet_W)
                        goto NextReel;
                    if (GblMachineMaxL < Gbl_Sheet_L)
                        goto NextReel;
                    if (GblMachineMaxW < Gbl_Sheet_W)
                    {
                    }

                    Cut_H = (int)Math.Floor(Reel_Width / Gbl_Sheet_W);


                    if (Cut_H <= 0)
                        goto NextReel;

                    Cut_L = 1;
                    Gbl_Paper_H = Reel_Width;
                    // Gbl_Paper_L = Gbl_Sheet_L

                    if (Gbl_M_Min_H != 0)
                        Gbl_Paper_L = Math.Round(Gbl_Sheet_L, 2);  // Gbl_M_Min_H  Variable cutoff setting in line o matic machine
                    else
                        Gbl_Paper_L = GblMachineMaxW;// Gbl_Sheet_L fix web cut off

                    Bal_H = Gbl_Paper_H - (Gbl_Sheet_W * Cut_H);
                    Bal_L = Gbl_Paper_L - (Gbl_Sheet_L * Cut_L);

                    if ((Bal_L * Gbl_Paper_H) > (Bal_H * Gbl_Paper_L))
                    {
                        Bal_Piece = Gbl_Paper_H + "x" + Math.Round(Bal_L, 2);
                        Gbl_Bal_Side = "L";
                    }
                    else
                    {
                        Bal_Piece = Math.Round(Bal_H, 2) + "x" + Gbl_Paper_L;
                        Gbl_Bal_Side = "W";
                    }
                    Waste = Math.Round((Gbl_Paper_L * Gbl_Paper_H) - ((Gbl_Sheet_L * Gbl_Sheet_W) * (Cut_L * Cut_H)), 2);
                    Waste_In_Percent = Math.Round(Waste * 100 / (Gbl_Paper_L * Gbl_Paper_H), 2);
                    if (Convert.ToDouble(GblShowPlanUptoWastagePerc) > 0)
                    {
                        if (Convert.ToDouble(Waste_In_Percent) <= Convert.ToDouble(GblShowPlanUptoWastagePerc))
                        {
                        }
                        else
                        {
                            goto NextReel;
                        }
                    }
                    if (Gbl_Orientation == "BookPages" | Gbl_Orientation == "WiroBookPages" | Gbl_Orientation == "Calendar" | Gbl_Orientation == "WiroLeaves")
                    {
                        if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection" | Gbl_Printing_Style == "Single Side" | Gbl_Printing_Style == "No Printing")
                            Add_Shirin_Book(Cut_L, Cut_H, Cut_H_L, Cut_L_H, Bal_Piece, Gbl_Bal_Side, Waste, Waste_In_Percent);
                    }
                    else if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection" | Gbl_Printing_Style == "Single Side" | Gbl_Printing_Style == "No Printing")
                        Add_Shirin(Cut_L, Cut_H, Cut_H_L, Cut_L_H, Bal_Piece, Gbl_Bal_Side, Waste, Waste_In_Percent);

                    NextReel:
                    ;
                }
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
            }
        }
        /// Add Book planning in datatable
        /// </summary>
        /// <param name="Cut_L"></param>
        /// <param name="Cut_H"></param>
        /// <param name="Cut_H_L"></param>
        /// <param name="Cut_L_H"></param>
        /// <param name="Bal_Piece"></param>
        /// <param name="Bal_Side"></param>
        /// <param name="Waste"></param>
        /// <param name="Waste_In_Percent"></param>
        private void Add_Shirin_Book(long Cut_L, long Cut_H, long Cut_H_L, long Cut_L_H, string Bal_Piece, string Bal_Side, double Waste, double Waste_In_Percent)
        {
            long Make_Ready_Sheet = 0, Make_Ready_Sheets_Total = 0;
            long Plate_Qty = 0;
            double Make_Readies = 0, Make_Ready_Amount = 0;
            double Plate_Rate = 0, Plate_Amount = 0;
            double Full_Sheets = 0, Wastage_Sheets = 0, Process_Wastage_Sheets = 0, Wastage_Percent_Sheets = 0;
            double Final_Quantity = 0, Printing_Impressions = 0, Impression_To_Be_Charged = 0, Printing_Charges = 0;
            long Total_Colors = 0;
            long Total_Colors_Main = 0;
            double Paper_Amount = 0, Printing_Amount = 0;
            double Total_Cut_Sheets = 0, Total_Ups = 0;
            long Actual_Plus_MakeReady_Sheets = 0;
            long Minimum_Sheets = 0;
            long Roundof_Impressions_With = 0;
            long Machine_Colors = 0;
            double Make_Ready_Rate = 0;
            string Printing_Charges_Type = "";
            string Coating_Charges_Type = "";
            double Basic_Printing_Charges = 0;
            double BasicCoatingCharges = 0;
            long Machine_Speed = 0;
            long Make_Ready_Time = 0;
            long Job_Change_Over_Time = 0, Flat_Wastage_Sheets = 0, WastageRMT = 0;
            long No_Of_Sets = 0, Actual_Sheets = 0;
            string Wastage_Type = "";
            string Wastage_Calculation_On = "";
            long No_Of_Forms = 0;
            bool Is_Perfecta_Machine = false;
            DataTable DT_Book = new DataTable();
            double Total_Square_Mtr = 0;
            double Req_Square_Mtr = 0;
            double Total_Running_Mtr = 0;
            double Req_Running_Mtr = 0;
            double TotalContentActualWeight = 0;
            string PlateChargesType = GblPlateChargesType;
            int j = 0;
            bool IsSpecialMachine = false;
            bool is_wastage_added = false; // By Vivek On 05-Nov-2024
            double TempMachineSpeed1 = 0;
            double TempMakeReadyTime1 = 0;
            double TempJobChangeOverTime1 = 0;
            double TempMachineSlabSpeed = 0;
            double TempMakeReadyPerHourCost = 0;
            double TempOrderQuantity = 0;
            double TempTotalPages = 0;

            Process_Wastage_Sheets = 0;
            WastageRMT = 0;

            try
            {
                // CompanyID = Convert.ToString(HttpContext.Current.Session("CompanyID"))
                if (Gbl_Orientation == "PrePlannedSheet")
                    Total_Ups = Gbl_Job_Ups;
                else
                    Total_Ups = Gbl_UPS_L * Gbl_UPS_H;

                // If Gbl_Half_Ups_Logic = True Then
                // Total_Ups = Total_Ups / 2
                // End If

                if (Total_Ups == 8)
                {
                    Console.WriteLine("asd");
                }
                if (Gbl_Orientation == "WiroLeaves")
                    Gbl_Job_Pages = Gbl_Job_Leaves * 2;
                MachinePerHourCost = 0;
                // ''''Check Machine availability or fill respective values of machine 
                Search_In_Machine(Gbl_Machine_ID, ref Minimum_Sheets, ref Make_Ready_Sheet, ref Make_Ready_Rate, ref Machine_Colors, ref Printing_Charges_Type, ref Roundof_Impressions_With, ref Basic_Printing_Charges, ref Machine_Speed, ref Make_Ready_Time, ref Job_Change_Over_Time, ref Wastage_Type, ref Wastage_Calculation_On, Gbl_DT_Search_In_Machine, ref Is_Perfecta_Machine, ref IsSpecialMachine);
                PlateChargesType = GblPlateChargesType;
                if (Gbl_Make_Ready_Rate > 0) // Added by Vivek on 04-JUNE-25
                {
                    Make_Ready_Rate = Gbl_Make_Ready_Rate;
                }
                if (Convert.ToDouble(Gbl_Plan_Make_Ready_Wastage) > 0)
                    Make_Ready_Sheet = Convert.ToInt64(Gbl_Plan_Make_Ready_Wastage);

                if (IsSpecialMachine == true & (Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble"))
                    Gbl_Printing_Style = "Front & Back";

                Calculate_Book_FormsMJ(ref DT_Book, Convert.ToInt64(Total_Ups), Convert.ToInt64(Gbl_Order_Quantity), Gbl_Job_Pages, ref No_Of_Sets, ref No_Of_Forms, ref Actual_Sheets);

                if (Gbl_Printing_Style == "Single Side" | Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble")
                {
                    if (Gbl_Front_Color >= Gbl_Back_Color)
                    {
                        Total_Colors_Main = Gbl_Front_Color;
                        Plate_Qty = (Gbl_Front_Color + Gbl_Special_Front_Color) * No_Of_Sets;
                    }
                    else
                    {
                        Total_Colors_Main = Gbl_Back_Color;
                        Plate_Qty = (Gbl_Back_Color + Gbl_Special_Back_Color) * No_Of_Sets;
                    }
                }
                else if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection")
                {
                    Total_Colors_Main = Gbl_Front_Color + Gbl_Back_Color;
                    if (Gbl_Plan_Type == "Reel Planning")
                        Plate_Qty = Convert.ToInt32(((Gbl_Front_Color + Gbl_Special_Front_Color) * No_Of_Sets + (Gbl_Back_Color + Gbl_Special_Back_Color) * No_Of_Sets) / 2.0);

                    else
                        Plate_Qty = ((Gbl_Front_Color + Gbl_Special_Front_Color) * No_Of_Forms * (ChkBackToBackPastingRequired ? 2 : 1)) + ((Gbl_Back_Color + Gbl_Special_Back_Color) * No_Of_Forms * (ChkBackToBackPastingRequired ? 2 : 1));

                }
                Total_Colors = Total_Colors_Main + Gbl_Special_Front_Color + Gbl_Special_Back_Color;
                if (Machine_Colors == 0)
                    Make_Readies = 0;
                else if (Gbl_Printing_Style == "Single Side")
                    Make_Readies = Math.Ceiling(Total_Colors / (double)Machine_Colors) * No_Of_Sets * (ChkBackToBackPastingRequired ? 2 : 1);
                else if (Gbl_Front_Color >= Gbl_Back_Color)
                    Make_Readies = Math.Ceiling(Gbl_Front_Color / (double)Machine_Colors) * No_Of_Sets * (ChkBackToBackPastingRequired ? 2 : 1);

                Make_Ready_Sheets_Total = (long)Math.Ceiling(Make_Readies * Make_Ready_Sheet);
                Actual_Plus_MakeReady_Sheets = Convert.ToInt32(Actual_Sheets + Make_Ready_Sheets_Total);


                Plate_Qty = 0;

                // ''''''''' By Vivek ON 05-Nov-2024 
                decimal T_Impressions = 0;
                long temp_wastage_percent_sheets = 0;
                long temp_impressions = 0;
                double val1 = 0;
                float temp_val1 = 0;
                long temp_wastage_for_printing_charge_add = 0;
                float fact_vik = 0;

                temp_impressions = 0;
                temp_wastage_percent_sheets = 0;
                // '''''''''''''

                for (var i = 0; i <= DT_Book.Rows.Count - 1; i++)
                {
                    if (IsSpecialMachine && Gbl_Printing_Style == "Front & Back")
                    {
                        if ((Convert.ToDouble(DT_Book.Rows[i][2]) / (Total_Ups * 2)) < 1)
                            DT_Book.Rows[i][4] = Convert.ToDouble(DT_Book.Rows[i][4]) / 2;
                    }
                    temp_wastage_for_printing_charge_add = 0;
                    Printing_Impressions = Convert.ToDouble(DT_Book.Rows[i][4]);
                    if (Printing_Impressions < Roundof_Impressions_With)
                        Printing_Impressions = Roundof_Impressions_With;

                    temp_impressions = Convert.ToInt16(Printing_Impressions);

                    is_wastage_added = false;
                ByVivek_ForWastageAddInPrinting:
                    ;
                    if (Roundof_Impressions_With == 0)
                        Impression_To_Be_Charged = Printing_Impressions;
                    else if (Minimum_Sheets >= Printing_Impressions)
                        Impression_To_Be_Charged = Minimum_Sheets;
                    else
                        Impression_To_Be_Charged = (RoundUP_25(Printing_Impressions / Roundof_Impressions_With) * Roundof_Impressions_With);// * Make_Readies   ' By Vivek On 05-Nov-24   'Rounding sheets like 240 to 1000 sheets

                    if (Minimum_Sheets > Impression_To_Be_Charged)
                        Impression_To_Be_Charged = Minimum_Sheets;

                    if (Impression_To_Be_Charged <= 0)
                        Impression_To_Be_Charged = Printing_Impressions;

                    DT_Book.Rows[i][6] = Impression_To_Be_Charged;

                    // ''''''For Both Machine Slabs
                    if (Search_In_Machine_Slabs(Gbl_Machine_ID, Convert.ToInt64(Impression_To_Be_Charged), ref Wastage_Percent_Sheets, ref Printing_Charges, ref Plate_Rate, ref Coating_Charges, ref Special_Color_Front_Charges, ref Special_Color_Back_Charges, ref Printing_Charges_Type, ref Roundof_Impressions_With, ref Basic_Printing_Charges, ref Actual_Sheets) == false)
                    {
                        if (planErrors.Contains("Check Printing slabs in:"))
                        {
                            if (planErrors.Contains(Gbl_Machine_Name) == false)
                                planErrors = planErrors.Replace("Check Printing slabs in:", "Check Printing slabs in:(" + Gbl_Machine_Name + ",");
                        }
                        else
                            planErrors = planErrors + " Check Printing slabs in: " + Gbl_Machine_Name + ")";
                        return;
                    }

                    Coating_Charges = 0;
                    if (GblOnlineCoating == "None" | GblOnlineCoating == "No" | GblOnlineCoating == "null")
                    {
                    }
                    else if (Search_In_Machine_Online_Coating(Gbl_Machine_ID, GblDTMachineCoatingRates, ref Coating_Charges, ref Coating_Charges_Type, Actual_Sheets, ref BasicCoatingCharges) == false)
                    {
                        if (planErrors.Contains("Check Coating slabs in:"))
                        {
                            if (planErrors.Contains(Gbl_Machine_Name) == false)
                                planErrors = planErrors.Replace("Check Coating slabs in:", "Check Coating slabs in:(" + Gbl_Machine_Name + ",");
                        }
                        else
                            planErrors = planErrors + " Check Coating slabs in: " + Gbl_Machine_Name + ")";
                        return;
                    }

                    // '''Wastage Calculation Form Wise By MJ ON 02-Jul-18
                    fact_vik = 0; // ' Changed By VIVEK ON 20-May-2019 - 03.01 PM -- START

                    if (i == 0)
                        temp_val1 = 1;
                    else if (i == 1)
                        temp_val1 = (float)Convert.ToDecimal(0.5);
                    else if (i == 2)
                        temp_val1 = (float)Convert.ToDecimal(0.25);
                    else if (i == 3)
                        temp_val1 = (float)Convert.ToDecimal(0.125);
                    else if (i == 4)
                        temp_val1 = (float)Convert.ToDecimal(0.0625);

                    if (DT_Book.Rows[i][14] != DBNull.Value && (DT_Book.Rows[i][14].ToString() == "Work & Turn" || DT_Book.Rows[i][14].ToString() == "Work & Tumble"))
                    {
                        val1 = Convert.ToDouble(DT_Book.Rows[i][0]);
                    }
                    else
                    {
                        val1 = Convert.ToDouble(DT_Book.Rows[i][2]) / (Gbl_UPS_H * Gbl_UPS_L * 2);
                    }
                    if (Gbl_Is_Book_Half_Form_Wastage == false)
                        val1 = Math.Ceiling(val1);

                    // ''''''''''''''''''''''''''''''''''''''''
                    // '''''''''START'''BY VIVEK ON 05-Nov-2024 
                    if (is_wastage_added == false)
                    {
                        if (Gbl_Flat_Wastage_Type == "Machine Default")
                        {
                            if (Wastage_Type == "Sheets")
                            {
                                if (Wastage_Calculation_On == "Flat")
                                {
                                    Wastage_Sheets = Wastage_Percent_Sheets;
                                    temp_wastage_percent_sheets += (int)Math.Ceiling(Wastage_Sheets * val1); // val(Myform.VS_Book.TextMatrix(i, 0))
                                    temp_wastage_for_printing_charge_add = (int)Math.Ceiling(Wastage_Sheets * val1);
                                    temp_impressions = (int)Math.Ceiling(Wastage_Sheets * val1);
                                }
                                else
                                {
                                    if (Gbl_Front_Color >= Gbl_Back_Color)
                                        fact_vik = (float)(Wastage_Percent_Sheets * (Gbl_Front_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color));
                                    else
                                        fact_vik = (float)(Wastage_Percent_Sheets * (Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color));

                                    temp_wastage_percent_sheets += (int)Math.Ceiling(fact_vik * val1); // val(Myform.VS_Book.TextMatrix(i, 0))
                                    temp_wastage_for_printing_charge_add = (int)Math.Ceiling(fact_vik * val1);
                                    temp_impressions = (int)Math.Ceiling(fact_vik * val1);
                                }
                            }
                            else if (Wastage_Calculation_On == "Flat")
                            {
                                temp_wastage_percent_sheets += (int)Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Percent_Sheets / 100.0);
                                temp_wastage_for_printing_charge_add = Convert.ToInt64(Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Percent_Sheets / 100.0) / Convert.ToDouble(DT_Book.Rows[i][3]));
                                temp_impressions = Convert.ToInt64(Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Percent_Sheets / 100.0) / Convert.ToDouble(DT_Book.Rows[i][3]));
                                temp_impressions = Convert.ToInt64(RoundUP_25(temp_impressions / Roundof_Impressions_With) * Roundof_Impressions_With);
                            }
                            else
                            {
                                if (Gbl_Front_Color >= Gbl_Back_Color)
                                    fact_vik = (float)(Convert.ToDouble(DT_Book.Rows[i][0]) * (Wastage_Percent_Sheets * (Gbl_Front_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color)));
                                else
                                    fact_vik = (float)(Convert.ToDouble(DT_Book.Rows[i][0]) * (Wastage_Percent_Sheets * (Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color)));

                                temp_wastage_percent_sheets += (int)Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * (double)fact_vik / 100.0);
                                temp_wastage_for_printing_charge_add = (int)Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * (double)fact_vik / 100.0);
                                temp_impressions = (int)Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * (double)fact_vik / 100.0);
                            }
                        }
                        else if (Gbl_Flat_Wastage_Type == "Category & Process Wise Wastage")
                        {
                            CategoryWiseWastage(Gbl_Category_ID, Gbl_Printing_Style, Convert.ToDouble(DT_Book.Rows[i][3]), ref Flat_Wastage_Sheets, ref WastageRMT, (Int16)(Convert.ToDouble(Gbl_Front_Color) + Convert.ToDouble(Gbl_Special_Front_Color)), (Int16)(Convert.ToDouble(Gbl_Back_Color) + Convert.ToDouble(Gbl_Special_Back_Color)));
                            Wastage_Sheets = Flat_Wastage_Sheets;
                            double processFlatWasteQty = 0;
                            double processWastePercent = 0;
                            double processWastePercentQty = 0;
                            Process_Wastage_Sheets = 0;

                            for (j = 0; j < Gbl_DT_Operation.Rows.Count; j++)
                            {
                                // Process Wastage Calculation
                                processFlatWasteQty = Gbl_DT_Operation.Rows[j]["ProcessFlatWastageValue"] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Operation.Rows[j]["ProcessFlatWastageValue"]) : 0;
                                processWastePercent = Gbl_DT_Operation.Rows[j]["ProcessWastagePercentage"] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Operation.Rows[j]["ProcessWastagePercentage"]) : 0;
                                processWastePercentQty = 0;

                                if (processWastePercent > 0)
                                {
                                    processWastePercentQty = Math.Round((Convert.ToDouble(Actual_Sheets) * (processWastePercent / 100)), 0);
                                }

                                Process_Wastage_Sheets += Math.Max(processFlatWasteQty, processWastePercentQty);
                            }

                            temp_wastage_percent_sheets += Convert.ToInt64(Wastage_Sheets * val1 + Process_Wastage_Sheets * val1);
                            temp_wastage_for_printing_charge_add = Convert.ToInt64(Wastage_Sheets * val1 + Process_Wastage_Sheets * val1);
                            temp_impressions = Convert.ToInt64(Wastage_Sheets * val1 + Process_Wastage_Sheets * val1);
                        }
                        else if (Gbl_Flat_Wastage_Type == "Sheets")
                        {
                            Wastage_Sheets = Gbl_Flat_Wastage_Value;
                            temp_wastage_percent_sheets += Convert.ToInt64(Math.Ceiling(Wastage_Sheets * val1)); // *No_Of_Forms ' (No_Of_Sets / 2)  ' BY VIVEK ON 06-JULY-2019
                            temp_wastage_for_printing_charge_add = Convert.ToInt64(Math.Ceiling(Wastage_Sheets * val1));
                            temp_impressions = Convert.ToInt64(Math.Ceiling(Wastage_Sheets * val1));
                        }
                        else if (Gbl_Flat_Wastage_Type == "Percentage")
                        {
                            Wastage_Sheets = Gbl_Flat_Wastage_Value;
                            temp_wastage_percent_sheets += Convert.ToInt64(Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Sheets / 100)); // * val1
                            temp_wastage_for_printing_charge_add = Convert.ToInt64(Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Sheets / 100)); // * val1
                            temp_impressions = Convert.ToInt64(Math.Ceiling((Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Sheets / 100)) / Convert.ToDouble(DT_Book.Rows[i][0])); // * val1  * temp_val1
                            temp_impressions = Convert.ToInt64(RoundUP_25(temp_impressions / Roundof_Impressions_With) * Roundof_Impressions_With); // By Vivek 13-June-2022
                        }

                        else if (Gbl_Flat_Wastage_Type == "Sheets")
                        {
                            Wastage_Sheets = Gbl_Flat_Wastage_Value;
                            temp_wastage_percent_sheets = Convert.ToInt64(temp_wastage_percent_sheets + Math.Ceiling(Wastage_Sheets * val1));   // *No_Of_Forms ' (No_Of_Sets / 2)  ' BY VIVEK ON 06-JULY-2019
                            temp_wastage_for_printing_charge_add = Convert.ToInt64(Math.Ceiling(Wastage_Sheets * val1));
                            temp_impressions = Convert.ToInt64(Math.Ceiling(Wastage_Sheets * val1));
                        }
                        else if (Gbl_Flat_Wastage_Type == "Percentage")
                        {
                            Wastage_Sheets = Gbl_Flat_Wastage_Value;
                            // 'Temp_Wastage_Percent_Sheets = Temp_Wastage_Percent_Sheets + RoundUP(Actual_Sheets * Wastage_Sheets / 100)
                            temp_wastage_percent_sheets += Convert.ToInt64(Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Sheets / 100.0)); // * val1
                            temp_wastage_for_printing_charge_add = Convert.ToInt64(Math.Ceiling(Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Sheets / 100.0)); // * val1
                            temp_impressions = Convert.ToInt64(Math.Ceiling((Convert.ToDouble(DT_Book.Rows[i][3]) * Wastage_Sheets / 100.0)) / Convert.ToDouble(DT_Book.Rows[i][0])); // * val1  * temp_val1
                            temp_impressions = Convert.ToInt64(RoundUP_25(temp_impressions / Roundof_Impressions_With)) * Roundof_Impressions_With; // By Vivek 13-June-2022

                        }
                    }

                    if (Gbl_Is_Wastage_Add_In_Printing_Rates == true & is_wastage_added == false)
                    {
                        if (Gbl_Orientation == "BookPages")
                        {
                            if (Forms_Wastage > 0)
                                temp_impressions = Convert.ToInt64(temp_impressions / (double)Forms_Wastage); // 'bablu 5-9-24
                            else
                                temp_impressions = Convert.ToInt64(temp_impressions / (double)1);// 'bablu 5-9-24
                            Printing_Impressions = Printing_Impressions + temp_impressions;  // Temp_Wastage_For_Printing_Charge_add
                        }
                        else
                            Printing_Impressions = Printing_Impressions + temp_impressions;// Temp_Wastage_For_Printing_Charge_add
                        is_wastage_added = true;
                        goto ByVivek_ForWastageAddInPrinting;
                    }


                    // '''''''''END''''''''''''''''''''''''''''
                    // ''''''''''''''''''''''''''''''''''''''''
                    if (IsSpecialMachine)
                    {
                        DT_Book.Rows[i][1] = Convert.ToDouble(DT_Book.Rows[i][0]) * 2;

                        Printing_Amount = Calculate_Book_Printing_Charges(Convert.ToInt64(Impression_To_Be_Charged), Minimum_Sheets, ref Printing_Charges, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, (long)(DT_Book.Rows[i][1]), Gbl_Front_Color, Gbl_Back_Color, "Front & Back", Is_Perfecta_Machine, Gbl_Machine_ID);
                        Plate_Qty += Convert.ToInt64(DT_Book.Rows[i][0]) * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                    }
                    else if (i == 0 && Convert.ToDouble(DT_Book.Rows[i][1]) > 1)
                    {
                        Printing_Amount = Calculate_Book_Printing_Charges(Convert.ToInt64(Impression_To_Be_Charged), Minimum_Sheets, ref Printing_Charges, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, (long)(DT_Book.Rows[i][1]), Gbl_Front_Color, Gbl_Back_Color, "Front & Back", Is_Perfecta_Machine, Gbl_Machine_ID);
                        if (Gbl_Plan_Type == "Reel Planning")
                        {
                            if (i > 0)
                            {
                                Plate_Qty = Convert.ToInt64(((Convert.ToDouble(DT_Book.Rows[i][1]) * 2) * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color)) / 2.0);
                            }
                            else
                            {
                                Plate_Qty = Convert.ToInt64(DT_Book.Rows[i][0]) * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                            }
                        }
                        else if (DT_Book.Rows[i][14] != DBNull.Value && (DT_Book.Rows[i][14].ToString() == "Work & Turn" || DT_Book.Rows[i][14].ToString() == "Work & Tumble"))
                        {
                            Plate_Qty = Convert.ToInt64(RoundUp((Convert.ToDouble(DT_Book.Rows[i][0]) / 2.0 * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color)), 0));
                        }
                        else
                        {
                            Plate_Qty = Convert.ToInt64(Convert.ToDouble(DT_Book.Rows[i][0]) * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color));
                        }
                    }
                    else if (Gbl_Front_Color >= Gbl_Back_Color)
                    {
                        Printing_Amount = Calculate_Book_Printing_Charges(Convert.ToInt64(Impression_To_Be_Charged), Minimum_Sheets, ref Printing_Charges, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, Convert.ToInt64(DT_Book.Rows[i][1]), Gbl_Front_Color, 0, Gbl_Printing_Style, Is_Perfecta_Machine, Gbl_Machine_ID);
                        if (Gbl_Plan_Type == "Reel Planning")
                            Plate_Qty = Plate_Qty + Gbl_Front_Color + Gbl_Back_Color;
                        else
                            Plate_Qty = Plate_Qty + Gbl_Front_Color;
                    }
                    else
                    {
                        Printing_Amount = Calculate_Book_Printing_Charges(Convert.ToInt64(Impression_To_Be_Charged), Minimum_Sheets, ref Printing_Charges, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, Convert.ToInt64(DT_Book.Rows[i][1]), 0, Gbl_Back_Color, Gbl_Printing_Style, Is_Perfecta_Machine, Gbl_Machine_ID);
                        Plate_Qty = Plate_Qty + Gbl_Back_Color;
                    }

                    if (Gbl_Special_Front_Color > Gbl_Special_Back_Color)
                        Plate_Qty = Plate_Qty + Gbl_Special_Front_Color;
                    else
                        Plate_Qty = Plate_Qty + Gbl_Special_Back_Color;

                    DT_Book.Rows[i][7] = Basic_Printing_Charges;
                    DT_Book.Rows[i][8] = Printing_Charges;
                    DT_Book.Rows[i][9] = Printing_Charges_Type;
                    DT_Book.Rows[i][10] = Printing_Amount;

                    if (DT_Book.Rows[i][14] != DBNull.Value &&
                        (DT_Book.Rows[i][14].ToString() == "Work & Turn" || DT_Book.Rows[i][14].ToString() == "Work & Tumble"))
                    {
                        T_Impressions += Convert.ToInt64(Impression_To_Be_Charged * Convert.ToDouble(DT_Book.Rows[i][0])); // No of Sets
                    }
                    else
                    {
                        T_Impressions += Convert.ToInt64(Impression_To_Be_Charged * Convert.ToDouble(DT_Book.Rows[i][1])); // No of Sets
                    }

                }

                Impression_To_Be_Charged = Convert.ToInt64(T_Impressions);

                Printing_Amount = DT_Book.Compute("SUM(Amount)", "") == DBNull.Value ? 0 : Convert.ToDouble(DT_Book.Compute("SUM(Amount)", ""));

                // ''''''Calculate Wastage 
                Console.WriteLine(No_Of_Forms);
                float tempform;
                // tempform = DT_Book.AsEnumerable().Sum(Function(row) CDbl(row(0)))

                if (Gbl_Is_Book_Half_Form_Wastage == true)
                    tempform = (float)(System.Convert.ToSingle(Gbl_Job_Pages) / (double)((System.Convert.ToSingle(Total_Ups) * 2)));
                else
                    tempform = (float)DT_Book.AsEnumerable().Sum(row => Convert.ToDouble(row[0]));
                // tempform = Gbl_Job_Pages / (Total_Ups * 2)
                if (Gbl_Flat_Wastage_Type == "Machine Default" | Gbl_Flat_Wastage_Type.Contains("Default"))
                {
                    if (Wastage_Type.Contains("Sheet"))
                    {
                        if (Wastage_Calculation_On == "Flat")
                        {
                            Wastage_Sheets = Wastage_Percent_Sheets;
                            // ' Wastage_Sheets = RoundUp(Wastage_Sheets * No_Of_Forms, 0)
                            Wastage_Sheets = RoundUp(Wastage_Sheets * tempform, 0);
                        }
                        else
                        {
                            if (Gbl_Front_Color >= Gbl_Back_Color)
                                Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Front_Color);
                            else
                                Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Back_Color);// Total_Color
                                                                                                   // ' Wastage_Sheets = RoundUp(Wastage_Percent_Sheets * No_Of_Forms, 0)
                            Wastage_Sheets = RoundUp(Wastage_Percent_Sheets * tempform, 0);
                        }
                    }
                    else if (Wastage_Calculation_On == "Flat")
                        Wastage_Sheets = RoundUp(Actual_Plus_MakeReady_Sheets * Wastage_Percent_Sheets / 100, 0);
                    else
                    {
                        if (Gbl_Front_Color >= Gbl_Back_Color)
                            Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Front_Color);
                        else
                            Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Back_Color);// Total_Color
                        Wastage_Sheets = RoundUp(Actual_Plus_MakeReady_Sheets * Wastage_Percent_Sheets / 100, 0);
                    }
                }
                else if (Gbl_Flat_Wastage_Type == "Category & Process Wise Wastage")
                {
                    CategoryWiseWastage(Gbl_Category_ID, Gbl_Printing_Style, Actual_Sheets, ref Flat_Wastage_Sheets, ref WastageRMT, Gbl_Front_Color + Gbl_Special_Front_Color, Gbl_Back_Color + Gbl_Special_Back_Color);
                    Wastage_Sheets = Flat_Wastage_Sheets;

                    double processFlatWasteQty = 0;
                    double processWastePercent = 0;
                    double processWastePercentQty = 0;
                    Process_Wastage_Sheets = 0;

                    for (int i = 0; i < Gbl_DT_Operation.Rows.Count; i++)
                    {
                        processFlatWasteQty = Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]);
                        processWastePercent = Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]);

                        processWastePercentQty = 0;
                        if (processWastePercent > 0)
                        {
                            processWastePercentQty = Math.Round((Convert.ToDouble(Actual_Sheets) * (processWastePercent / 100)), 0);
                        }

                        Process_Wastage_Sheets += Math.Max(processFlatWasteQty, processWastePercentQty);
                    }
                    Wastage_Sheets += Process_Wastage_Sheets;
                }

                else if (Gbl_Flat_Wastage_Type == "Sheets")
                {
                    Flat_Wastage_Sheets = (long)Gbl_Flat_Wastage_Value;
                    Wastage_Sheets = Gbl_Flat_Wastage_Value;
                    Wastage_Sheets = RoundUp(Wastage_Sheets * tempform, 0);
                }
                else if (Gbl_Flat_Wastage_Type == "Percentage")
                {
                    Wastage_Percent_Sheets = Gbl_Flat_Wastage_Value;
                    Wastage_Sheets = RoundUp(Actual_Sheets * Gbl_Flat_Wastage_Value / (double)100, 0);
                }
                Wastage_Sheets = RoundUp(Wastage_Sheets, 0);

                double Total_Paper_In_KG;
                double Used_Paper_In_KG;
                double Wastage_Paper_In_KG;
                double wt_Cut_Sheets;
                double wt_Full_Sheets;

                Total_Cut_Sheets = RoundUp((Actual_Sheets), 0) + RoundUp((Make_Ready_Sheets_Total), 0) + RoundUp((Wastage_Sheets), 0);

                if ((Cut_H_L * Cut_L_H) > 0)
                    Full_Sheets = RoundUp(Total_Cut_Sheets / ((Cut_L * Cut_H) + (Cut_H_L * Cut_L_H)), 0);
                else
                    Full_Sheets = RoundUp(Total_Cut_Sheets / (Cut_L * Cut_H), 0);

                wt_Cut_Sheets = ((Gbl_Paper_GSM * Gbl_Sheet_L * Gbl_Sheet_W) / (double)1000000) / (double)1000;  // wt of Double sheet in kg
                if (Gbl_Paper_ID > 0)
                    wt_Full_Sheets = ((Gbl_Paper_GSM * (Gbl_Paper_L + (Gbl_Paper_TrimmingLR)) * (Gbl_Paper_H + (Gbl_Paper_TrimmingTB))) / (double)1000000000); // wt of Double sheet in kg
                else
                    wt_Full_Sheets = ((Gbl_Paper_GSM * Gbl_Paper_L * Gbl_Paper_H) / (double)1000000000);// wt of Double sheet in kg

                Total_Paper_In_KG = Math.Round(Full_Sheets * wt_Full_Sheets, 3);
                Used_Paper_In_KG = Math.Round(Total_Cut_Sheets * wt_Cut_Sheets, 3);
                TotalContentActualWeight = Math.Round(Actual_Sheets * wt_Cut_Sheets, 3);
                Wastage_Paper_In_KG = Math.Round(Total_Paper_In_KG - Used_Paper_In_KG, 3);

                if (CheckPaperByClient == true)
                    Gbl_Paper_Rate = 0;

                if (Gbl_Paper_Rate_Type.ToUpper().Contains("SHEET"))
                {
                    Paper_Amount = Math.Round(Gbl_Paper_Rate * Full_Sheets, 2);
                }
                else
                {
                    Gbl_Paper_Rate_Type = "Kg";
                    Paper_Amount = Math.Round(Gbl_Paper_Rate * Total_Paper_In_KG, 2);
                }

                Make_Ready_Amount = Math.Round(Make_Readies * Make_Ready_Rate, 2);

                if (Gbl_Machine_Type == "Digital")
                    Plate_Qty = 0;
                Plate_Amount = Math.Round(Plate_Rate * Plate_Qty, 2);
                if (ChkBackToBackPastingRequired == true)
                    Final_Quantity = RoundUp(((Total_Cut_Sheets * Total_Ups) / (Gbl_Job_Pages / (double)2)) / (double)2, 0);
                else
                    Final_Quantity = RoundUp((Total_Cut_Sheets * Total_Ups) / (Gbl_Job_Pages / (double)2), 0);
                long Expected_Execution_Time = 0;
                long Total_Completion_Time = 0;
                // Time in Minutes                            'Make_Ready_Time
                if (Machine_Speed != 0)
                {
                    Expected_Execution_Time = Convert.ToInt64((Make_Ready_Time * Make_Readies) + (Printing_Impressions / Machine_Speed) + Job_Change_Over_Time);
                    Total_Completion_Time = Expected_Execution_Time;
                }

                // ///////////////////////
                // 'Dim ST_Op_Amt As String = ""
                double Op_Amt = 0;
                double Pub_Sheets = 0;
                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double machineCost = 0;

                DataTable DTOPR = new DataTable();
                DTOPR = Gbl_DT_Operation.Copy();
                DTOPR.Clear();

                for (j = 0; j <= GblDTOprFactors.Rows.Count - 1; j++)
                {
                    for (var i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        if (Gbl_DT_Operation.Rows[i][6].ToString() == "Pre")
                            Pub_Sheets = Full_Sheets;
                        else if (Gbl_DT_Operation.Rows[i][5] == DBNull.Value || Gbl_DT_Operation.Rows[i][5].ToString() == "Actual Sheets")
                            Pub_Sheets = Actual_Sheets;
                        else if (Gbl_DT_Operation.Rows[i][5] != DBNull.Value && Gbl_DT_Operation.Rows[i][5].ToString() == "Actual Sheets + Make Ready Sheets")
                            Pub_Sheets = Actual_Sheets + Make_Readies;
                        else if (Gbl_DT_Operation.Rows[i][5] != DBNull.Value && Gbl_DT_Operation.Rows[i][5].ToString() == "Actual Sheets + Wastage Sheets")
                            Pub_Sheets = Actual_Sheets + Wastage_Sheets + Process_Wastage_Sheets;
                        else if (Gbl_DT_Operation.Rows[i][5] != DBNull.Value && Gbl_DT_Operation.Rows[i][5].ToString() == "Actual Sheets + Make Ready Sheets + Wastage Sheets")
                            Pub_Sheets = (Full_Sheets * ((Cut_L * Cut_H) + (Cut_H_L * Cut_L_H)));

                        if (Gbl_DT_Operation.Rows[i][4].ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i][7] = RoundUp(Gbl_Sheet_L / 25.4, 2);
                            Gbl_DT_Operation.Rows[i][8] = RoundUp(Gbl_Sheet_W / 25.4, 2);
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i][7] = 0;
                            Gbl_DT_Operation.Rows[i][8] = 0;
                        }


                        double QTY = 0;
                        string typeofcharge = "";

                        // Check for DBNull and assign value
                        typeofcharge = Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString();

                        if (typeofcharge.Contains("Order Quantity") || typeofcharge.Contains("OrderQuantity"))
                            QTY = Gbl_Order_Quantity;
                        else if (typeofcharge.Contains("Unit"))
                            QTY = Final_Quantity;
                        else if (typeofcharge.Contains("Sheet"))
                            QTY = Pub_Sheets;

                        if (typeofcharge.Contains("Calendar-Inch"))
                            Gbl_DT_Operation.Rows[i][7] = RoundUp(Gbl_Job_L / 25.4, 2);

                        for (int k = 0; k <= GblDTOprSlabs.Rows.Count - 1; k++)
                        {
                            int processID_Op = Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"]);
                            int processID_Slab = GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"]);

                            if (processID_Op == processID_Slab)
                            {
                                double fromQty = GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"]);
                                double toQty = GblDTOprSlabs.Rows[k]["ToQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["ToQty"]);

                                if (fromQty >= 1)
                                {
                                    int processID_Factor = GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"]);

                                    if (processID_Factor == processID_Slab)
                                    {
                                        string rateFactor_Factor = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString().Replace("-", "");
                                        string rateFactor_Slab = GblDTOprSlabs.Rows[k]["RateFactor"] == DBNull.Value ? "" : GblDTOprSlabs.Rows[k]["RateFactor"].ToString().Replace("-", "");

                                        if (QTY >= fromQty && QTY <= toQty && rateFactor_Factor == rateFactor_Slab)
                                        {
                                            Gbl_DT_Operation.Rows[i][1] = GblDTOprSlabs.Rows[k]["Rate"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["Rate"]);
                                            Gbl_DT_Operation.Rows[i][2] = GblDTOprSlabs.Rows[k]["MinimumCharges"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["MinimumCharges"]);
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        var Amt = 0; //Calculate_Operations(Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString(), Gbl_DT_Operation.Rows[i][1] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][1]), Gbl_DT_Operation.Rows[i][2] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][2]), Convert.ToInt64(Final_Quantity), Convert.ToInt64(Final_Quantity), Gbl_DT_Operation.Rows[i][3] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][3]), Convert.ToInt64(Total_Paper_In_KG), Convert.ToInt64(Total_Ups), No_Of_Sets, Gbl_DT_Operation.Rows[i][7] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][7]), Gbl_DT_Operation.Rows[i][8] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][8]), Total_Colors, Pub_Sheets, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, Convert.ToInt64(Gbl_Order_Quantity), Gbl_DT_Operation.Rows[i]["PagesPerSection"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"]), Gbl_DT_Operation.Rows[i]["NoOfForms"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"]));

                        // Assigning values to the DataTable
                        Gbl_DT_Operation.Rows[i][11] = Amt;
                        Gbl_DT_Operation.Rows[i][12] = Gbl_DT_plan.Rows.Count + 1;
                        Gbl_DT_Operation.Rows[i][15] = QTY;
                        Gbl_DT_Operation.Rows[i][16] = Total_Ups;
                        Gbl_DT_Operation.Rows[i][17] = 1;
                        Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;

                        if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                        {
                            Gbl_DT_Operation.Rows[i][19] = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString();
                            Gbl_DT_Operation.Rows[i]["Remarks"] = GblDTOprFactors.Rows[j]["Remarks"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["Remarks"].ToString();
                            Gbl_DT_Operation.Rows[i]["PaperConsumptionRequired"] = GblDTOprFactors.Rows[j]["PaperConsumptionRequired"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["PaperConsumptionRequired"].ToString();

                            if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) > 0)
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]);
                                Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                            }
                        }

                        if (Convert.ToDouble(QTY) > 0)
                        {
                            if (Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineSpeed"]) > 0)
                                opExecutionTime = Math.Round(Convert.ToDouble(QTY) / Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"]));
                            else
                                opExecutionTime = 0;

                            Gbl_DT_Operation.Rows[i]["ExecutionTime"] = Convert.ToDouble(opExecutionTime);
                        }
                        Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = Math.Round(Convert.ToDouble(opExecutionTime) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyTime"]) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]));
                        opTotalExecutionTime = Math.Round(Convert.ToDouble(opExecutionTime) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyTime"]) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]));

                        machineCost = Math.Round(
                            Math.Round(Convert.ToDouble(opTotalExecutionTime) / 60, 2) *
                            Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachinePerHourCost"]), 2
                        );

                        Gbl_DT_Operation.Rows[i]["MachineCost"] = Convert.ToDouble(machineCost);

                        if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) ==
                            (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                        {
                            DTOPR.ImportRow(Gbl_DT_Operation.Rows[i]);
                            Op_Amt += Amt;
                        }
                    }
                }

                double Coating_Amount = 0;
                Coating_Amount = Calculate_Coating_Charges(Convert.ToInt64(Actual_Sheets), Coating_Charges, Coating_Charges_Type, RoundUp(Gbl_Sheet_L / 25.4, 2), RoundUp(Gbl_Sheet_W / 25.4, 2), BasicCoatingCharges);

                Special_Color_Front_Amount = Calculate_Special_Color_Charges(Gbl_Special_Front_Color, Special_Color_Front_Charges, Impression_To_Be_Charged, Printing_Charges_Type, Roundof_Impressions_With, No_Of_Sets);
                Special_Color_Back_Amount = Calculate_Special_Color_Charges(Gbl_Special_Back_Color, Special_Color_Back_Charges, Impression_To_Be_Charged, Printing_Charges_Type, Roundof_Impressions_With, No_Of_Sets);

                Rf_Dt_Opr.Merge(DTOPR); // Gbl_DT_Operation
                GblDTBook.Merge(DT_Book);

                // /////////////
                {
                    var withBlock = Gbl_DT_plan;
                    string Paper_Size, Cut_size, Die_Cut_size;
                    double Total_Amount, F_Total_Amount, Unit_Price;
                    Paper_Size = Gbl_Paper_H + "x" + Gbl_Paper_L;
                    Cut_size = Math.Round(Gbl_Sheet_W, 2) + "x" + Math.Round(Gbl_Sheet_L, 2);
                    Total_Amount = Math.Round(Plate_Amount + Paper_Amount + Printing_Amount + Make_Ready_Amount + Coating_Amount, 2);
                    F_Total_Amount = Op_Amt + Total_Amount;
                    if (Convert.ToDouble(F_Total_Amount) > 0 && Convert.ToDouble(Final_Quantity) > 0)
                    {
                        Unit_Price = Math.Round(Convert.ToDouble(F_Total_Amount) / Convert.ToDouble(Final_Quantity), 2);
                    }
                    else
                        Unit_Price = 0;
                    Die_Cut_size = Gbl_Die_Size_H + "x" + Gbl_Die_Size_L;

                    withBlock.NewRow();
                    withBlock.Rows.Add(Gbl_Machine_ID, Gbl_Machine_Name, Gbl_Machine_Gripper, Gbl_GripperSide, Machine_Colors, Gbl_Paper_ID, Paper_Size, Cut_size, Cut_L, Cut_H, Gbl_UPS_L, Gbl_UPS_H, Total_Ups, Bal_Piece, Bal_Side, Waste, Waste_In_Percent, Wastage_Paper_In_KG, Gbl_Grain_Direction, Plate_Qty, Plate_Rate, Plate_Amount, Make_Ready_Sheets_Total, Actual_Sheets, Wastage_Sheets, Process_Wastage_Sheets, Total_Paper_In_KG, Full_Sheets,
                        Gbl_Paper_Rate, Paper_Amount, (Printing_Impressions * Make_Readies), Impression_To_Be_Charged, Printing_Charges, Printing_Amount, Make_Readies, Make_Ready_Rate, Make_Ready_Amount, Final_Quantity, Gbl_Order_Quantity, Total_Colors, Total_Amount, Cut_L_H, Cut_H_L, Gbl_Printing_Style, Printing_Charges_Type, Expected_Execution_Time, Total_Completion_Time, Gbl_Paper_Detail, Gbl_Plan_Type, Gbl_Paper_Rate_Type, Die_Cut_size, Gbl_InterLock_Style,
                        No_Of_Sets, F_Total_Amount, Unit_Price, Gbl_Packing, string.IsNullOrEmpty(Gbl_Unit_Per_Packing?.ToString()) ? 1 : Convert.ToDouble(Gbl_Unit_Per_Packing), Roundof_Impressions_With, Special_Color_Front_Charges, Special_Color_Back_Charges, Special_Color_Front_Amount, Special_Color_Back_Amount, Op_Amt, withBlock.Rows.Count + 1, Coating_Charges, Coating_Amount, GblMainPaperGroup, Gbl_Machine_Type, 0, "", 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, Machine_Speed, 0, 0, 0, 0, 0, 0, 0, 0, "", "", 0, Paper_Amount, 0, Gbl_windingdirection, Gbl_labeltype, Gbl_finishedformat, 0, Gbl_dietype, Gbl_CoreInnerDia, Gbl_CoreOuterDia, Final_Quantity, Gbl_Estimation_Unit, Gbl_Other_Material_GSM, PlanOtherMaterialGSMSettingJSON, TotalContentActualWeight, Gbl_Orientation, PlanContName, false);
                }
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
            }
        }

        /// <summary>
        /// Add Plan in datatable
        /// </summary>
        /// <param name="Cut_L"></param>
        /// <param name="Cut_H"></param>
        /// <param name="Cut_H_L"></param>
        /// <param name="Cut_L_H"></param>
        /// <param name="Bal_Piece"></param>
        /// <param name="Bal_Side"></param>
        /// <param name="Waste"></param>
        /// <param name="Waste_In_Percent"></param>
        [ScriptMethod(ResponseFormat = ResponseFormat.Json)]
        private void Add_Shirin(long Cut_L, long Cut_H, long Cut_H_L, long Cut_L_H, string Bal_Piece, string Bal_Side, double Waste, double Waste_In_Percent)
        {
            try
            {
                long Make_Ready_Sheet = 0, Make_Ready_Sheets_Total = 0;
                long Plate_Qty = 0;
                long Total_Colors = 0, Total_Colors_Main = 0;
                long Actual_Plus_MakeReady_Sheets = 0;
                long Minimum_Sheets = 0;
                long Roundof_Impressions_With = 0;
                long Machine_Colors = 0;
                long Machine_Speed = 0, Make_Ready_Time = 0, Job_Change_Over_Time = 0;
                long WastageRMT = 0, Flat_Wastage_Sheets = 0;

                double Make_Readies = 0.0, Make_Ready_Amount = 0.0;
                double Plate_Rate = 0.0, Plate_Amount = 0.0;
                long Full_Sheets = 0, Actual_Sheets = 0;
                double Wastage_Sheets = 0.0, Process_Wastage_Sheets = 0.0;
                double Wastage_Percent_Sheets = 0.0;
                double Actual_Full_Sheets = 0.0, Final_Quantity = 0.0;
                double Printing_Impressions = 0.0, Impression_To_Be_Charged = 0.0;
                double Printing_Charges = 0.0, Paper_Amount = 0.0, Printing_Amount = 0.0;
                double Total_Cut_Sheets = 0.0, Total_Ups = 0.0;
                double Make_Ready_Rate = 0.0, Make_Ready_Rate_PerHour = 0.0;
                double Basic_Printing_Charges = 0.0, BasicCoatingCharges = 0.0;
                double Coating_Charges = 0.0, Special_Color_Front_Charges = 0.0, Special_Color_Back_Charges = 0.0;
                double Total_Square_Mtr = 0.0, Req_Square_Mtr = 0.0;
                double Total_Running_Mtr = 0.0, Req_Running_Mtr = 0.0;
                double TempMachineSpeed1 = 0.0, TempMakeReadyTime1 = 0.0, TempMakeReadyPerHourCost = 0.0;
                double TempJobChangeOverTime1 = 0.0, TempMachineSlabSpeed = 0.0;
                double wt_Cut_Sheets = 0.0, FinalQuantityInPcs = 0.0;
                double TotalContentActualWeight = 0.0;
                float TempOrderQuantity = 0f;

                int No_Of_Sets = 0;

                string Printing_Charges_Type = "";
                string Coating_Charges_Type = "";
                string Wastage_Type = "";
                string Wastage_Calculation_On = "";
                string PlateChargesType = GblPlateChargesType;

                bool Is_Perfecta_Machine = false;
                bool IsSpecialMachine = false;
                bool is_wastage_added = false;


                Process_Wastage_Sheets = 0;
                if (Gbl_Orientation == "PrePlannedSheet")
                    Total_Ups = Gbl_Job_Ups;
                else
                    Total_Ups = Gbl_UPS_L * Gbl_UPS_H;

                if (Gbl_Orientation == "WeddingCardSets")
                    Total_Ups = Gbl_Job_Leaves;

                if (Gbl_Half_Ups_Logic == true)
                    Total_Ups = Total_Ups / 2;
                wt_Cut_Sheets = ((Gbl_Paper_GSM * Gbl_Sheet_L * Gbl_Sheet_W) / (double)1000000) / (double)1000;  // wt of Double sheet in kg
                if (Gbl_Estimation_Unit == "KGS")
                {
                    if (Convert.ToDouble(wt_Cut_Sheets) > 0)
                        Actual_Sheets = (long)(RoundUp((Convert.ToDouble(Gbl_Order_Quantity) / Convert.ToDouble(wt_Cut_Sheets)), 0));
                    else
                        Actual_Sheets = 0;
                }
                else if (Gbl_Job_Leaves == 0 || Gbl_Orientation == "WeddingCardSets")
                    Actual_Sheets = (long)(RoundUp(Convert.ToDouble(Gbl_Order_Quantity) / Total_Ups, 0));
                else
                    Actual_Sheets = (long)(RoundUp((Convert.ToDouble(Gbl_Order_Quantity) / Total_Ups) * Gbl_Job_Leaves, 0));

                if (ChkBackToBackPastingRequired == true)
                    Actual_Sheets = Actual_Sheets * 2;
                MachinePerHourCost = 0;
                // ''''Check Machine availability or fill respective values of machine 
                Search_In_Machine(Gbl_Machine_ID, ref Minimum_Sheets, ref Make_Ready_Sheet, ref Make_Ready_Rate, ref Machine_Colors, ref Printing_Charges_Type,
                    ref Roundof_Impressions_With, ref Basic_Printing_Charges, ref Machine_Speed, ref Make_Ready_Time, ref Job_Change_Over_Time, ref Wastage_Type,
                    ref Wastage_Calculation_On, Gbl_DT_Search_In_Machine, ref Is_Perfecta_Machine, ref IsSpecialMachine);
                PlateChargesType = GblPlateChargesType;
                if (Convert.ToDouble(Gbl_Plan_Make_Ready_Wastage) > 0)
                    Make_Ready_Sheet = Convert.ToInt64(Gbl_Plan_Make_Ready_Wastage);

                if (Gbl_Make_Ready_Rate > 0) // Added by Vivek on 04-JUNE-25
                {
                    Make_Ready_Rate = Gbl_Make_Ready_Rate;
                }


                // Special type of machine Mitsubishi Daiya print only F&B ,IsSpecialMachine case is added for this by VB & pKp at Lovely on 15-03-20
                if (IsSpecialMachine == true & (Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble"))
                    Gbl_Printing_Style = "Front & Back";

                if (Gbl_Printing_Style == "Single Side" | Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble")
                {
                    if (Gbl_Front_Color >= Gbl_Back_Color)
                        Total_Colors_Main = Gbl_Front_Color;
                    else
                        Total_Colors_Main = Gbl_Back_Color;

                    // start Added as per desktop version 23-Jun-2025
                    // Added by MB & Vivek on 02-Sep-2024
                    if (Gbl_Special_Front_Color >= Gbl_Special_Back_Color)
                    {
                        Total_Colors = Total_Colors_Main + Gbl_Special_Front_Color;
                    }
                    else
                    {
                        Total_Colors = Total_Colors_Main + Gbl_Special_Back_Color;
                    }
                    // end Added as per desktop version 23-Jun-2025
                }
                else if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection")
                {
                    Total_Colors_Main = Gbl_Front_Color + Gbl_Back_Color;
                    // start Added as per desktop version 23-Jun-2025
                    Total_Colors = Total_Colors_Main + Gbl_Special_Front_Color + Gbl_Special_Back_Color;
                    // end Added as per desktop version 23-Jun-2025
                }
                else
                {
                    Total_Colors_Main = 0;
                    // start Added as per desktop version 23-Jun-2025
                    Total_Colors = Total_Colors_Main + Gbl_Special_Front_Color + Gbl_Special_Back_Color;
                    // end Added as per desktop version 23-Jun-2025
                }

                // start Added as per desktop version 23-Jun-2025
                // Total_Colors = Total_Colors_Main + Gbl_Special_Front_Color + Gbl_Special_Back_Color;
                // end Added as per desktop version 23-Jun-2025

                if (Convert.ToInt64(Machine_Colors) == 0)
                    Make_Readies = 0;
                else if (Gbl_Printing_Style == "Single Side")
                    Make_Readies = RoundUp(Total_Colors / (double)Machine_Colors, 0);
                else if (Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble")
                    Make_Readies = RoundUp(Total_Colors / (double)Machine_Colors, 0);
                else if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection")
                    Make_Readies = Make_Readies = (int)Math.Ceiling((double)Gbl_Front_Color / Machine_Colors) + (int)Math.Ceiling((double)Gbl_Special_Front_Color / Machine_Colors) + (int)Math.Ceiling((double)Gbl_Back_Color / Machine_Colors) + (int)Math.Ceiling((double)Gbl_Special_Back_Color / Machine_Colors);

                Make_Ready_Sheets_Total = Convert.ToInt64(RoundUp(Make_Readies * Make_Ready_Sheet, 0));
                Actual_Plus_MakeReady_Sheets = Convert.ToInt64(Actual_Sheets + Make_Ready_Sheets_Total);

                No_Of_Sets = 1;
                if (Gbl_Printing_Style == "Single Side")
                    Printing_Impressions = Actual_Plus_MakeReady_Sheets;
                else if (Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble")
                    Printing_Impressions = Actual_Plus_MakeReady_Sheets * 2;
                else if (Gbl_Printing_Style == "Front & Back" | Gbl_Printing_Style == "FB-Perfection")
                {
                    No_Of_Sets = 2;
                    Printing_Impressions = Actual_Plus_MakeReady_Sheets;
                }
                //Commented Below As  per desktop version 23-Jun-2025
                //if (Machine_Colors < Total_Colors_Main)
                //{
                //    if (Convert.ToInt64(Machine_Colors) == 0)
                //        Printing_Impressions = Printing_Impressions;
                //    else
                //        Printing_Impressions = Printing_Impressions * RoundUp(Total_Colors_Main / (double)Machine_Colors, 0);
                //}

                //if (Machine_Colors < Total_Colors_Main) ///// Added by Abhinav & vivek on 13-Nov-25
                //{
                //    Printing_Impressions = Printing_Impressions * RoundUp(Total_Colors_Main / (double)Machine_Colors, 0);
                //}

                is_wastage_added = false;
            ByVivek_ForWastageAddInPrinting:
                ;
                if (Roundof_Impressions_With == 0)
                {
                    Impression_To_Be_Charged = Printing_Impressions;
                }
                else
                {
                    // start Added as per desktop version 23-Jun-2025
                    if (Minimum_Sheets >= Printing_Impressions)
                    {
                        Impression_To_Be_Charged = Minimum_Sheets; // * Make_Readies
                    }
                    else
                    {
                        Impression_To_Be_Charged = RoundUP_25(Printing_Impressions / Roundof_Impressions_With) * Roundof_Impressions_With; // * Make_Readies   // Rounding sheets like 240 to 1000 sheets
                    }
                    // end Added as per desktop version 23-Jun-2025 and commented below line
                    // Impression_To_Be_Charged = RoundUP_25(Printing_Impressions / Roundof_Impressions_With) * Roundof_Impressions_With;
                }


                if (Impression_To_Be_Charged <= 0)
                    Impression_To_Be_Charged = Printing_Impressions;

                if (Minimum_Sheets > Impression_To_Be_Charged)
                    Impression_To_Be_Charged = Minimum_Sheets;

                // /////Calculating Wastage
                if (Gbl_Printing_Style != "No Printing")
                {
                    if (!Search_In_Machine_Slabs(Gbl_Machine_ID, (long)Impression_To_Be_Charged, ref Wastage_Percent_Sheets, ref Printing_Charges, ref Plate_Rate, ref Coating_Charges, ref Special_Color_Front_Charges, ref Special_Color_Back_Charges, ref Printing_Charges_Type, ref Roundof_Impressions_With, ref Basic_Printing_Charges, ref Actual_Sheets))
                    {
                        if (planErrors.Contains("Check Printing slabs in:"))
                        {
                            if (!planErrors.Contains(Gbl_Machine_Name))
                            {
                                planErrors = planErrors.Replace("Check Printing slabs in:", "Check Printing slabs in:(" + Gbl_Machine_Name + ",");
                            }
                        }
                        else
                        {
                            planErrors += " Check Printing slabs in: " + Gbl_Machine_Name + ")";
                        }
                        return; // Exit Sub
                    }

                    //if (GblApplyFirstPlanMasterRate)
                    //{
                    //    // Added by Vivek on 04-JUNE-25
                    //    Coating_Charges = GblFirstPlanCoatingRate;
                    //}
                    //if (GblApplyFirstPlanMasterRate)
                    //{
                    //    // Added by Vivek on 04-JUNE-25
                    //    Printing_Charges = GblFirstPlanPrintingRate;
                    //}
                }

                Coating_Charges = 0;
                if (GblOnlineCoating == "None" | GblOnlineCoating == "No" | GblOnlineCoating == "null")
                {
                }
                else
                {
                    if (Search_In_Machine_Online_Coating(Gbl_Machine_ID, GblDTMachineCoatingRates, ref Coating_Charges, ref Coating_Charges_Type, Actual_Sheets, ref BasicCoatingCharges) == false)
                    {
                        if (planErrors.Contains("Check Coating slabs in:"))
                        {
                            if (planErrors.Contains(Gbl_Machine_Name) == false)
                                planErrors = planErrors.Replace("Check Coating slabs in:", "Check Coating slabs in:(" + Gbl_Machine_Name + ",");
                        }
                        else
                            planErrors = planErrors + " Check Coating slabs in: " + Gbl_Machine_Name + ")";
                        return;
                    }
                    //if (GblApplyFirstPlanMasterRate)
                    //{
                    //    // Added by Vivek on 04-JUNE-25
                    //    Coating_Charges = GblFirstPlanCoatingRate;
                    //}
                }

                if (Gbl_Machine_Type == "Digital")
                    Plate_Qty = 0;
                else
                    Plate_Qty = Total_Colors;

                Plate_Amount = Math.Round(Convert.ToDouble(Plate_Rate) * Convert.ToDouble(Plate_Qty), 2);
                Process_Wastage_Sheets = 0;
                // ''''''Calculate Wastage 
                if (Gbl_Flat_Wastage_Type == "Machine Default" | Gbl_Flat_Wastage_Type.Contains("Default"))
                {
                    if (Wastage_Type == "Sheets")
                    {
                        if (Wastage_Calculation_On == "Flat")
                            Wastage_Sheets = Wastage_Percent_Sheets;
                        else
                        {
                            if (Gbl_Front_Color >= Gbl_Back_Color)
                                Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Front_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                            else
                                Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);// Total_Color
                            Wastage_Sheets = Wastage_Percent_Sheets;
                        }
                    }
                    else if (Wastage_Calculation_On == "Flat")
                        Wastage_Sheets = RoundUp(Actual_Plus_MakeReady_Sheets * Wastage_Percent_Sheets / 100, 0);
                    else
                    {
                        if (Gbl_Front_Color >= Gbl_Back_Color)
                            Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Front_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                        else
                            Wastage_Percent_Sheets = Wastage_Percent_Sheets * (Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);// Total_Color
                        Wastage_Sheets = RoundUp(Actual_Plus_MakeReady_Sheets * Wastage_Percent_Sheets / 100, 0);
                    }
                }
                else if (Gbl_Flat_Wastage_Type == "Category & Process Wise Wastage")
                {
                    CategoryWiseWastage(Gbl_Category_ID, Gbl_Printing_Style, Actual_Sheets, ref Flat_Wastage_Sheets, ref WastageRMT, (Gbl_Front_Color + Gbl_Special_Front_Color), (Gbl_Back_Color + Gbl_Special_Back_Color));
                    Wastage_Sheets = Flat_Wastage_Sheets;
                    double processFlatWasteQty = 0;
                    double processWastePercent = 0;
                    double processWastePercentQty = 0;
                    Process_Wastage_Sheets = 0;
                    for (var i = 0; i < Gbl_DT_Operation.Rows.Count; i++)
                    {
                        // Process Wastage Calculation
                        processFlatWasteQty = Convert.IsDBNull(Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]) ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]);
                        processWastePercent = Convert.IsDBNull(Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]) ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]);
                        processWastePercentQty = 0;
                        if (processWastePercent > 0)
                            processWastePercentQty = Math.Round(Actual_Sheets * (processWastePercent / 100), 0);

                        Process_Wastage_Sheets += Math.Max(processFlatWasteQty, processWastePercentQty);
                    }

                    Wastage_Sheets = Convert.ToInt64(Wastage_Sheets) + Convert.ToInt64(Process_Wastage_Sheets);
                }
                else if (Gbl_Flat_Wastage_Type == "Sheets")
                {
                    Flat_Wastage_Sheets = (long)Gbl_Flat_Wastage_Value;
                    Wastage_Sheets = Gbl_Flat_Wastage_Value;
                }
                else if (Gbl_Flat_Wastage_Type == "Percentage")
                {
                    Wastage_Percent_Sheets = Gbl_Flat_Wastage_Value;
                    Wastage_Sheets = RoundUp(Actual_Plus_MakeReady_Sheets * Wastage_Percent_Sheets / 100, 0);
                }
                Wastage_Sheets = RoundUp(Wastage_Sheets, 0);

                // ''''' START '' BY VIVEK ON 05-NOV-2024 for calculate printing charges with Wastage
                if (Gbl_Is_Wastage_Add_In_Printing_Rates == true & is_wastage_added == false)
                {
                    Printing_Impressions = Printing_Impressions + Wastage_Sheets;
                    is_wastage_added = true;
                    goto ByVivek_ForWastageAddInPrinting;
                }
                // ''''' END '' BY VIVEK ON 05-NOV-2024 for calculate printing charges with Wastage
                // /////////Calculating Paper Qty///////////
                double Total_Paper_In_KG;
                double Used_Paper_In_KG;
                double Wastage_Paper_In_KG;
                // Dim wt_Cut_Sheets As Double
                double wt_Full_Sheets;

                Total_Cut_Sheets = RoundUp((Actual_Sheets), 0) + RoundUp((Make_Ready_Sheets_Total), 0) + RoundUp((Wastage_Sheets), 0);

                if ((Cut_H_L * Cut_L_H) > 0)
                {
                    Full_Sheets = (long)(RoundUp(Total_Cut_Sheets / ((Cut_L * Cut_H) + (Cut_H_L * Cut_L_H)), 0));
                    Actual_Full_Sheets = RoundUp(Actual_Sheets / ((Cut_L * Cut_H) + (Cut_H_L * Cut_L_H)), 0);
                }
                else
                {
                    Full_Sheets = (long)(RoundUp(Total_Cut_Sheets / (Cut_L * Cut_H), 0));
                    Actual_Full_Sheets = RoundUp(Actual_Sheets / (Cut_L * Cut_H), 0);
                }

                wt_Cut_Sheets = ((Gbl_Paper_GSM * Gbl_Sheet_L * Gbl_Sheet_W) / 1000000) / 1000;  //wt of Double sheet in kg
                if (Gbl_Paper_ID > 0)
                    wt_Full_Sheets = ((Gbl_Paper_GSM * (Gbl_Paper_L + (Gbl_Paper_TrimmingLR)) * (Gbl_Paper_H + (Gbl_Paper_TrimmingTB))) / (double)1000000000); // wt of Double sheet in kg
                else
                    wt_Full_Sheets = ((Gbl_Paper_GSM * Gbl_Paper_L * Gbl_Paper_H) / (double)1000000000);// wt of Double sheet in kg

                if (Gbl_Plan_Type.Equals("Reel To Sheet Planning", StringComparison.OrdinalIgnoreCase))
                {
                    if (GblPaperPurchaseRateType.Equals("Meter", StringComparison.OrdinalIgnoreCase) || GblPaperPurchaseRateType.Equals("Square Meter", StringComparison.OrdinalIgnoreCase))
                    {
                        Total_Running_Mtr = Math.Round(Full_Sheets * Gbl_Paper_L, 2);
                        Req_Running_Mtr = Math.Round(Actual_Full_Sheets * Gbl_Paper_L, 2);
                    }

                    // Paper weight calculations
                    Total_Paper_In_KG = Math.Round(Full_Sheets * wt_Full_Sheets, 3);
                    Used_Paper_In_KG = Math.Round(Total_Cut_Sheets * wt_Cut_Sheets, 3);
                    TotalContentActualWeight = Math.Round(Actual_Sheets * wt_Cut_Sheets, 3);
                    if (Gbl_Paper_GSM > 0)
                    {
                        Total_Square_Mtr = Math.Round((Total_Paper_In_KG / Gbl_Paper_GSM) * 1000, 3);
                        Req_Square_Mtr = Math.Round((Math.Round(Actual_Full_Sheets * wt_Full_Sheets, 3) / Gbl_Paper_GSM) * 1000, 3);
                    }

                    // Wastage Calculation
                    Wastage_Paper_In_KG = Math.Round(Total_Paper_In_KG - Used_Paper_In_KG, 3);
                    Wastage_Paper_In_KG = Math.Round(Math.Round(Full_Sheets * (Gbl_Paper_H / 1000.0), 3) - Math.Round(Total_Cut_Sheets * (Gbl_Sheet_W / 1000.0), 3), 3);
                }
                else
                {
                    Total_Paper_In_KG = Math.Round(Full_Sheets * wt_Full_Sheets, 3);
                    Used_Paper_In_KG = Math.Round(Total_Cut_Sheets * wt_Cut_Sheets, 3);
                    TotalContentActualWeight = Math.Round(Actual_Sheets * wt_Cut_Sheets, 3);
                    Wastage_Paper_In_KG = Math.Round(Total_Paper_In_KG - Used_Paper_In_KG, 3);

                    Req_Running_Mtr = Math.Round(Actual_Full_Sheets * Gbl_Paper_L, 2);
                    Total_Running_Mtr = Math.Round(Full_Sheets * Gbl_Paper_L, 2);
                    if (Gbl_Paper_GSM > 0)
                    {
                        Total_Square_Mtr = Math.Round((Total_Paper_In_KG / Gbl_Paper_GSM) * 1000, 3);
                        Req_Square_Mtr = Math.Round((Math.Round(Actual_Full_Sheets * wt_Full_Sheets, 3) / Gbl_Paper_GSM) * 1000, 3);
                    }
                }


                if (CheckPaperByClient.ToString() == "True" || Convert.ToBoolean(CheckPaperByClient))
                    Gbl_Paper_Rate = 0;

                switch (Gbl_Paper_Rate_Type.ToUpper())
                {
                    case string s when s.Contains("SHEET"):
                        Paper_Amount = Math.Round(Gbl_Paper_Rate * Full_Sheets, 2);
                        break;

                    case string s when s.Contains("SQUARE METER"):
                        Paper_Amount = Math.Round(Gbl_Paper_Rate * Total_Square_Mtr, 2);
                        break;

                    case string s when s.Contains("METER"):
                        Paper_Amount = Math.Round(Gbl_Paper_Rate * Total_Running_Mtr, 2);
                        break;

                    default:
                        Gbl_Paper_Rate_Type = "Kg";
                        Paper_Amount = Math.Round(Gbl_Paper_Rate * Total_Paper_In_KG, 2);
                        break;
                }
                if (Gbl_Plan_Type.ToUpper() == "REEL TO SHEET PLANNING")
                {
                    DataRow row = GblDTReel.Select($"PaperID = {Gbl_Paper_ID}").FirstOrDefault();
                    if (row != null)
                    {
                        Total_Running_Mtr = Math.Round((Full_Sheets) * (Gbl_Paper_L), 2);

                        string POUnit = row["PurchaseUnit"] == DBNull.Value ? "KG" : row["PurchaseUnit"].ToString();
                        string paperRateType = Gbl_Paper_Rate_Type.ToUpper();  // Store uppercase value once

                        Total_Paper_In_KG = Math.Round(Full_Sheets * wt_Full_Sheets, 3);
                        Used_Paper_In_KG = Math.Round(Total_Cut_Sheets * wt_Cut_Sheets, 3);
                        TotalContentActualWeight = Math.Round(Actual_Sheets * wt_Cut_Sheets, 3);
                        Wastage_Paper_In_KG = Math.Round(
                            Math.Round(Full_Sheets * (Gbl_Paper_H / 1000.0), 3) -
                            Math.Round(Total_Cut_Sheets * (Gbl_Sheet_W / 1000.0), 3), 3);

                        if (Gbl_Paper_GSM > 0)
                        {
                            Total_Square_Mtr = Math.Round((Total_Paper_In_KG / Gbl_Paper_GSM) * 1000, 3);
                            Req_Square_Mtr = Math.Round((Math.Round(Actual_Full_Sheets * wt_Full_Sheets, 3) / Gbl_Paper_GSM) * 1000, 3);
                        }

                        // Calculate Paper_Amount based on Paper Rate Type
                        if (paperRateType.Contains("SQUARE METER"))
                            Paper_Amount = Math.Round(Gbl_Paper_Rate * Total_Square_Mtr, 2);
                        else if (paperRateType.Contains("METER"))
                            Paper_Amount = Math.Round(Gbl_Paper_Rate * Total_Running_Mtr, 2);
                        else
                            Paper_Amount = Math.Round(Gbl_Paper_Rate * Total_Paper_In_KG, 2);
                    }
                }


                // As Discussed with vivek sir on 25-04-2019 for cost getting double due to Ttl imprn of F&B
                double tmpImpression_To_Be_Charged = Impression_To_Be_Charged;
                if (Machine_Colors < Total_Colors_Main)
                    // Printing_Impressions = Printing_Impressions * RoundUp(Total_Colors / Machine_Colors, 0)
                    tmpImpression_To_Be_Charged = Impression_To_Be_Charged / RoundUp(Total_Colors_Main / (double)Machine_Colors, 0);

                Printing_Amount = Calculate_Printing_Charges(Convert.ToInt64(tmpImpression_To_Be_Charged), Minimum_Sheets, ref Printing_Charges, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, No_Of_Sets, Gbl_Front_Color, Gbl_Back_Color, Gbl_Printing_Style, Is_Perfecta_Machine, Gbl_Machine_ID, Machine_Colors);
                Make_Ready_Amount = Math.Round(Make_Readies * Make_Ready_Rate, 2);
                if (ChkBackToBackPastingRequired == false)
                {
                    if (Gbl_Estimation_Unit == "KGS")
                    {
                        Final_Quantity = Gbl_Order_Quantity;
                        if (Gbl_Job_Leaves == 0)
                            FinalQuantityInPcs = RoundUp(Total_Cut_Sheets * Total_Ups, 0);
                        else
                            FinalQuantityInPcs = RoundUp((Total_Cut_Sheets * Total_Ups) / Gbl_Job_Leaves, 0);
                    }
                    else
                    {
                        if (Gbl_Job_Leaves == 0)
                            Final_Quantity = RoundUp(Total_Cut_Sheets * Total_Ups, 0);
                        else
                            Final_Quantity = RoundUp((Total_Cut_Sheets * Total_Ups) / Gbl_Job_Leaves, 0);
                        FinalQuantityInPcs = Final_Quantity;
                    }
                }
                else if (Gbl_Estimation_Unit == "KGS")
                {
                    Final_Quantity = Gbl_Order_Quantity;
                    if (Gbl_Job_Leaves == 0)
                        FinalQuantityInPcs = RoundUp(((Total_Cut_Sheets * Total_Ups) / 2), 0);
                    else
                        FinalQuantityInPcs = RoundUp(((Total_Cut_Sheets * Total_Ups) / Gbl_Job_Leaves) / (double)2, 0);
                }
                else
                {
                    if (Gbl_Job_Leaves == 0)
                        Final_Quantity = RoundUp(((Total_Cut_Sheets * Total_Ups) / 2), 0);
                    else
                        Final_Quantity = RoundUp(((Total_Cut_Sheets * Total_Ups) / Gbl_Job_Leaves) / (double)2, 0);
                    FinalQuantityInPcs = Final_Quantity;
                }

                long Expected_Execution_Time = 0;
                long Total_Completion_Time = 0;
                // Time in Minutes 'Make_Ready_Time
                if (Machine_Speed != 0)
                {
                    Expected_Execution_Time = Convert.ToInt64((Make_Ready_Time * Make_Readies) + (Printing_Impressions / Machine_Speed) + Job_Change_Over_Time);
                    Total_Completion_Time = Expected_Execution_Time;
                }

                double Op_Amt = 0;
                double TotalMachineCost = 0;
                // 'Dim ST_Op_Amt As String = ""
                double Pub_Sheets = 0;
                double Pub_RMT = 0;

                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double makeReadyExecutionCost = 0;
                double ExecutionCost = 0;
                double machineCost = 0;
                double PerHourQty = 0;
                string PerHourCostingParameter = "";
                string MakeReadyTimeMode = "";

                DataTable DTOPR = new DataTable();
                DTOPR = Gbl_DT_Operation.Copy();
                DTOPR.Clear();

                for (var j = 0; j <= GblDTOprFactors.Rows.Count - 1; j++)
                {
                    for (var i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        opExecutionTime = 0;
                        if (Gbl_DT_Operation.Rows[i][6].ToString() == "Pre")
                            Pub_Sheets = Full_Sheets;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "Actual Sheets" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets")
                            Pub_Sheets = Actual_Sheets;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets + Make Ready Sheets")
                            Pub_Sheets = Actual_Sheets + Make_Readies;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets + Wastage Sheets")
                            Pub_Sheets = Actual_Sheets + Wastage_Sheets + Process_Wastage_Sheets;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets + Make Ready Sheets + Wastage Sheets")
                            Pub_Sheets = (Full_Sheets * ((Cut_L * Cut_H) + (Cut_H_L * Cut_L_H)));
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "Actual Running Meter" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter")
                            Pub_RMT = Req_Running_Mtr;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter + Make Ready Running Meter")
                            Pub_RMT = Req_Running_Mtr;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter + Wastage Running Meter")
                            Pub_RMT = Req_Running_Mtr;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter + Make Ready Running Meter + Wastage Running Meter")
                            Pub_RMT = Total_Running_Mtr;

                        if (Gbl_DT_Operation.Rows[i][4].ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i][7] = Math.Round(Gbl_Sheet_L / 25.4, 2);
                            Gbl_DT_Operation.Rows[i][8] = Math.Round(Gbl_Sheet_W / 25.4, 2);
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i][7] = 0;
                            Gbl_DT_Operation.Rows[i][8] = 0;
                        }
                        double QTY = 0;
                        string typeofcharge = "";
                        typeofcharge = Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString();
                        if (typeofcharge.Contains("Order Quantity") | typeofcharge.Contains("OrderQuantity"))
                            QTY = Gbl_Order_Quantity;
                        else if (typeofcharge.Contains("Unit"))
                            QTY = Final_Quantity;
                        else if (typeofcharge.Contains("Sheet"))
                            QTY = Pub_Sheets;
                        else if (typeofcharge.Contains("PCS"))
                            QTY = Final_Quantity;

                        if (typeofcharge.Contains("Calendar-Inch"))
                            Gbl_DT_Operation.Rows[i][7] = RoundUp(Gbl_Job_L / 25.4, 2);

                        if (Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]) == Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["ProcessID"]))
                        {
                            for (int k = 0; k < GblDTOprSlabs.Rows.Count; k++)
                            {
                                int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                int factorProcessID = Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["ProcessID"]);
                                int slabProcessID = Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["ProcessID"]);
                                if (operationProcessID == slabProcessID)
                                {
                                    double fromQty = Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["FromQty"]);
                                    if (fromQty >= 1 && factorProcessID == slabProcessID)
                                    {
                                        double qty = QTY;
                                        double fromQtyVal = Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["FromQty"]);
                                        double toQtyVal = Convert.ToDouble(GblDTOprSlabs.Rows[k]["ToQty"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["ToQty"]);

                                        string rateFactorFactor = (GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString()).Replace("-", "");
                                        string rateFactorSlab = (GblDTOprSlabs.Rows[k]["RateFactor"] == DBNull.Value ? "" : GblDTOprSlabs.Rows[k]["RateFactor"].ToString()).Replace("-", "");

                                        if (qty >= fromQtyVal && qty <= toQtyVal && rateFactorFactor == rateFactorSlab)
                                        {
                                            Gbl_DT_Operation.Rows[i][1] = Convert.ToDouble(GblDTOprSlabs.Rows[k]["Rate"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["Rate"]);
                                            Gbl_DT_Operation.Rows[i][2] = Convert.ToDouble(GblDTOprSlabs.Rows[k]["MinimumCharges"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["MinimumCharges"]);
                                            break; // Exit For
                                        }
                                    }
                                }
                            }
                            double Amt = Calculate_Operations(Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString(), Gbl_DT_Operation.Rows[i][1] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][1]), Gbl_DT_Operation.Rows[i][2] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][2]), Convert.ToInt64(Final_Quantity), Convert.ToInt64(Final_Quantity), Gbl_DT_Operation.Rows[i][3] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][3]), Convert.ToInt64(Total_Paper_In_KG), Convert.ToInt64(Total_Ups), No_Of_Sets, Gbl_DT_Operation.Rows[i][7] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][7]), Gbl_DT_Operation.Rows[i][8] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][8]), Total_Colors, Pub_Sheets, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, Convert.ToInt64(Gbl_Order_Quantity), Gbl_DT_Operation.Rows[i]["PagesPerSection"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"]), Gbl_DT_Operation.Rows[i]["NoOfForms"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"]));

                            // Assign calculated values back to DataTable
                            Gbl_DT_Operation.Rows[i][11] = Math.Round(Amt, 3).ToString();
                            Gbl_DT_Operation.Rows[i][12] = Gbl_DT_plan.Rows.Count + 1;
                            Gbl_DT_Operation.Rows[i][15] = Math.Round(QTY, 3).ToString();
                            Gbl_DT_Operation.Rows[i][16] = Total_Ups;
                            Gbl_DT_Operation.Rows[i][17] = 1;
                            Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;

                            //if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                            //{
                            MachinePerHourCost = 0;
                            PerHourCostingParameter = "";
                            TempMachineSpeed1 = 0;
                            TempMakeReadyTime1 = 0;
                            TempJobChangeOverTime1 = 0;
                            TempMakeReadyPerHourCost = 0;
                            Gbl_DT_Operation.Rows[i][19] = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"];
                            Gbl_DT_Operation.Rows[i]["Remarks"] = GblDTOprFactors.Rows[j]["Remarks"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["Remarks"];
                            Gbl_DT_Operation.Rows[i]["PaperConsumptionRequired"] = GblDTOprFactors.Rows[j]["PaperConsumptionRequired"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["PaperConsumptionRequired"];
                            if ((Gbl_DT_Operation.Rows[i]["DepartmentID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["DepartmentID"]).Equals(100))
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Gbl_Machine_ID;
                                Gbl_DT_Operation.Rows[i]["MachineName"] = Gbl_Machine_Name;
                                if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) > 0 && Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) == Convert.ToDouble(Gbl_Machine_ID))
                                {
                                    for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                    {
                                        int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                        int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                        int allocMachineID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"]);
                                        int operationMachineID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineID"]);

                                        if (allocProcessID == operationProcessID && allocMachineID == operationMachineID)
                                        {
                                            MakeReadyTimeMode = Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"].ToString();
                                            if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]) > 0)
                                            {
                                                TempMachineSpeed1 = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                                            }
                                            else
                                            {
                                                TempMachineSpeed1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"]);
                                            }
                                            if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]) > 0)
                                            {
                                                TempMakeReadyTime1 = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                                            }
                                            else
                                            {
                                                double makeReadyTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"]);
                                                TempMakeReadyTime1 = makeReadyTime1 * ((string.IsNullOrWhiteSpace(MakeReadyTimeMode) || MakeReadyTimeMode.Trim().ToUpper() == "FLAT") ? 1 : Total_Colors);
                                            }
                                            TempJobChangeOverTime1 = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                                            TempMakeReadyPerHourCost = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"]);
                                            MachinePerHourCost = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                        }
                                    }
                                    if (TempMachineSpeed1 > 0)
                                    {
                                        TempMachineSlabSpeed = TempMachineSpeed1;
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSpeed1;
                                    }
                                    else
                                    {
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Machine_Speed;
                                        TempMachineSlabSpeed = Machine_Speed;
                                    }
                                    Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = (TempMakeReadyTime1 > 0) ? TempMakeReadyTime1 : Make_Ready_Time;
                                    Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = (TempJobChangeOverTime1 > 0) ? TempJobChangeOverTime1 : Job_Change_Over_Time;
                                    Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = MachinePerHourCost;
                                    Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = TempMakeReadyPerHourCost;
                                }
                                else
                                {
                                    Gbl_DT_Operation.Rows[i]["MachineID"] = Gbl_Machine_ID;
                                    Gbl_DT_Operation.Rows[i]["MachineName"] = Gbl_Machine_Name;

                                    for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                    {
                                        int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                        int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                        int allocMachineID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"]);
                                        int operationMachineID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineID"]);

                                        if (allocProcessID == operationProcessID && allocMachineID == operationMachineID)
                                        {
                                            MakeReadyTimeMode = Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"].ToString();
                                            TempMachineSpeed1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"]);
                                            double makeReadyTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"]);
                                            TempMakeReadyTime1 = makeReadyTime1 * ((string.IsNullOrWhiteSpace(MakeReadyTimeMode) || MakeReadyTimeMode.Trim().ToUpper() == "FLAT") ? 1 : Total_Colors);
                                            TempJobChangeOverTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"]);
                                            TempMakeReadyPerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"]);
                                            MachinePerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"]);
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                            break;
                                        }
                                    }
                                    if (TempMachineSpeed1 > 0)
                                    {
                                        TempMachineSlabSpeed = TempMachineSpeed1;
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSpeed1;
                                    }
                                    else
                                    {
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Machine_Speed;
                                        TempMachineSlabSpeed = Machine_Speed;
                                    }
                                    Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = (TempMakeReadyTime1 > 0) ? TempMakeReadyTime1 : Make_Ready_Time;
                                    Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = (TempJobChangeOverTime1 > 0) ? TempJobChangeOverTime1 : Job_Change_Over_Time;
                                    Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = MachinePerHourCost;
                                    Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = TempMakeReadyPerHourCost;
                                }
                            }
                            else if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] ?? 0) > 0)
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]);
                                Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                                Gbl_DT_Operation.Rows[i]["PerHourCalculationQuantity"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["PerHourCalculationQuantity"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["PerHourCalculationQuantity"]);
                                Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"]);
                                PerHourCostingParameter = GblDTOprFactors.Rows[j]["PerHourCostingParameter"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["PerHourCostingParameter"].ToString();
                                if (string.IsNullOrWhiteSpace(PerHourCostingParameter))
                                {
                                    for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                    {
                                        int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                        int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                        int allocMachineID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"]);
                                        int operationMachineID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineID"]);

                                        if (allocProcessID == operationProcessID && allocMachineID == operationMachineID)
                                        {
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                            break;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                {
                                    int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                    int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                    if (allocProcessID == operationProcessID)
                                    {
                                        bool isDefaultMachine = Gbl_DT_Operation_Machine_Allocation.Rows[x]["IsDefaultMachine"] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Operation_Machine_Allocation.Rows[x]["IsDefaultMachine"]);
                                        if (isDefaultMachine)
                                        {
                                            TempMachineSpeed1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"]);
                                            TempMakeReadyTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"]);
                                            TempJobChangeOverTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"]);
                                            TempMakeReadyPerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"]);
                                            MachinePerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"]);
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                            goto CalculateMachineCost;
                                        }
                                    }
                                }
                            CalculateMachineCost:
                                if (TempMachineSpeed1 > 0)
                                {
                                    TempMachineSlabSpeed = TempMachineSpeed1;
                                    Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSpeed1;
                                }
                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = TempMakeReadyTime1;
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = TempJobChangeOverTime1;
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = MachinePerHourCost;
                                Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = TempMakeReadyPerHourCost;
                            }

                            if (!string.IsNullOrWhiteSpace(PerHourCostingParameter))
                            {
                                if (PerHourCostingParameter.Trim() == "Actual Sheets")
                                {
                                    PerHourQty = Actual_Sheets;
                                }
                                else if (PerHourCostingParameter.Trim() == "Actual Sheets + Make Ready Sheets")
                                {
                                    PerHourQty = Actual_Sheets + Make_Ready_Sheets_Total;
                                }
                                else if (PerHourCostingParameter.Trim() == "Actual Sheets + Wastage Sheets")
                                {
                                    PerHourQty = Actual_Sheets + Wastage_Sheets;
                                }
                                else if (PerHourCostingParameter.Trim() == "Actual Sheets + Make Ready Sheets + Wastage Sheets")
                                {
                                    PerHourQty = Total_Cut_Sheets;
                                }
                                else if (PerHourCostingParameter.Trim() == "Printing Impresions")
                                {
                                    PerHourQty = (Printing_Impressions * Make_Readies);
                                }
                                else if (PerHourCostingParameter.Trim() == "Order Quantity")
                                {
                                    PerHourQty = Gbl_Order_Quantity;
                                }
                                else if (PerHourCostingParameter.Trim() == "Final Qty")
                                {
                                    PerHourQty = Final_Quantity;
                                }
                                else
                                {
                                    PerHourQty = Total_Cut_Sheets;
                                }
                            }
                            else
                            {
                                PerHourQty = 0;
                            }

                            if (Convert.ToDouble(PerHourQty) > 0)
                            {
                                Gbl_DT_Operation.Rows[i]["PerHourCalculationQuantity"] = Convert.ToDouble(PerHourQty);
                                if (Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineSpeed"]) > 0)
                                {
                                    opExecutionTime = Math.Round(Convert.ToDouble(PerHourQty) / Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineSpeed"]));
                                }
                                else
                                {
                                    opExecutionTime = 0;
                                }

                                Gbl_DT_Operation.Rows[i]["ExecutionTime"] = opExecutionTime;
                            }
                            double makeReadyTime = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyTime"]);
                            double jobChangeOverTime = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]);

                            Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = Math.Round(opExecutionTime + makeReadyTime + jobChangeOverTime);
                            opTotalExecutionTime = Math.Round(opExecutionTime + makeReadyTime + jobChangeOverTime);
                            double machinePerHourCost = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachinePerHourCost"]);
                            ExecutionCost = Math.Round(Math.Round(opExecutionTime / 60, 2) * machinePerHourCost, 2);
                            Gbl_DT_Operation.Rows[i]["ExecutionCost"] = Math.Round(ExecutionCost, 2);
                            double makeReadyPerHourCost = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"]);
                            makeReadyExecutionCost = Math.Round(Math.Round(makeReadyTime / 60, 2) * makeReadyPerHourCost, 2);
                            Gbl_DT_Operation.Rows[i]["MakeReadyMachineCost"] = Math.Round(makeReadyExecutionCost, 2);
                            machineCost = Math.Round(ExecutionCost + makeReadyExecutionCost, 2);
                            if (!Convert.IsDBNull(Gbl_DT_Operation.Rows[i]["IsOnlineProcess"]) && Convert.ToBoolean(Gbl_DT_Operation.Rows[i]["IsOnlineProcess"]))
                            {
                                machineCost = 0;
                            }
                            Gbl_DT_Operation.Rows[i]["MachineCost"] = Convert.ToDouble(machineCost);
                            if ((Convert.IsDBNull(Gbl_DT_Operation.Rows[i]["ProcessID"]) ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (Convert.IsDBNull(GblDTOprFactors.Rows[j]["ProcessID"]) ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                            {
                                DTOPR.ImportRow(Gbl_DT_Operation.Rows[i]);
                            }
                        }
                    }
                }
                double Coating_Amount = Calculate_Coating_Charges(Convert.ToInt64(Actual_Sheets), Coating_Charges, Coating_Charges_Type, Math.Round(Gbl_Sheet_L / 25.4, 2), Math.Round(Gbl_Sheet_W / 25.4, 2), BasicCoatingCharges);
                double Special_Color_Front_Amount = Calculate_Special_Color_Charges(Gbl_Special_Front_Color, Special_Color_Front_Charges, Impression_To_Be_Charged, Printing_Charges_Type, Roundof_Impressions_With, No_Of_Sets);
                double Special_Color_Back_Amount = Calculate_Special_Color_Charges(Gbl_Special_Back_Color, Special_Color_Back_Charges, Impression_To_Be_Charged, Printing_Charges_Type, Roundof_Impressions_With, No_Of_Sets);
                Op_Amt = 0;
                TotalMachineCost = 0;
                foreach (DataRow row in DTOPR.Rows)
                {
                    Op_Amt += Convert.ToDouble(row["Amount"]);
                    TotalMachineCost += Convert.ToDouble(row["MachineCost"]);
                }
                Rf_Dt_Opr.Merge(DTOPR);

                // start Added as per desktop version 23-Jun-2025
                if (Gbl_Printing_Style == "Front & Back" || Gbl_Printing_Style == "FB-Perfection")
                {
                    Printing_Impressions = Printing_Impressions * 2;
                    Impression_To_Be_Charged = Impression_To_Be_Charged * 2;
                }
                int chk_vik;
                if (Machine_Colors < Gbl_Front_Color)
                {
                    chk_vik = (Int32)(RoundUp((double)Gbl_Front_Color / (double)Machine_Colors, 0));
                    // No_Of_Sets = RoundUP(Total_Colors_Main / Machine_Colors)
                    Printing_Impressions = Printing_Impressions * chk_vik; // * RoundUP(Total_Colors_Main / Machine_Colors) // * RoundUP(Total_Colors_Main / Machine_Colors) BY VIVEK ON 14-Mar-2019 FOR 1 col machine 2 col job getting impression problem
                    Impression_To_Be_Charged = Impression_To_Be_Charged * chk_vik;
                }

                // end Added as per desktop version 23-Jun-2025
                {
                    var withBlock = Gbl_DT_plan;
                    string Paper_Size, Cut_size, Die_Cut_size;
                    double Total_Amount, F_Total_Amount, Unit_Price;
                    Paper_Size = Gbl_Paper_H + "x" + Gbl_Paper_L;
                    Cut_size = Math.Round(Gbl_Sheet_W, 2) + "x" + Math.Round(Gbl_Sheet_L, 2);
                    Die_Cut_size = Gbl_Die_Size_H + "x" + Gbl_Die_Size_L;
                    // Total_Amount = Math.Round(Plate_Amount + Paper_Amount + Printing_Amount + Make_Ready_Amount + Coating_Amount, 2)
                    if (Gbl_Half_Ups_Logic == true)
                        Gbl_UPS_L = Gbl_UPS_L / (double)2;
                    if (GblCostEstimationMethodType == "MATERIAL+PROCESS")
                    {
                        Total_Amount = Math.Round(Convert.ToDouble(Plate_Amount) + Convert.ToDouble(Paper_Amount) + Convert.ToDouble(Op_Amt) + Printing_Amount + Make_Ready_Amount + Coating_Amount, 2);
                    }
                    else if (GblCostEstimationMethodType == "MATERIAL+PROCESS+MACHINE")
                    {
                        Total_Amount = Math.Round(Convert.ToDouble(Plate_Amount) + Convert.ToDouble(Paper_Amount) + Convert.ToDouble(Op_Amt) + Convert.ToDouble(TotalMachineCost), 2);
                    }
                    else if (GblCostEstimationMethodType == "PROCESS+MACHINE")
                    {
                        Total_Amount = Math.Round(Convert.ToDouble(Op_Amt) + Convert.ToDouble(TotalMachineCost), 2);
                    }
                    else if (GblCostEstimationMethodType == "MATERIAL+MACHINE")
                    {
                        Total_Amount = Math.Round(Convert.ToDouble(Plate_Amount) + Convert.ToDouble(Paper_Amount) + Convert.ToDouble(TotalMachineCost), 2);
                    }
                    else
                    {
                        Total_Amount = Math.Round(Plate_Amount + Paper_Amount, 2);
                    }
                    F_Total_Amount = Total_Amount;
                    if (Convert.ToDouble(F_Total_Amount) > 0 && Convert.ToDouble(Final_Quantity) > 0)
                    {
                        Unit_Price = Math.Round((Convert.ToDouble(F_Total_Amount) / Convert.ToDouble(Final_Quantity)), 2);
                    }
                    else
                    {
                        Unit_Price = 0;
                    }
                    bool flag_isDieAvailable = false;
                    if (Gbl_DT_DieMaster != null && Gbl_DT_DieMaster.Rows.Count > 0)
                    {
                        foreach (DataRow row in Gbl_DT_DieMaster.Rows)
                        {
                            if (row["TotalUps"] == DBNull.Value || row["UpsL"] == DBNull.Value || row["UpsW"] == DBNull.Value)
                                continue;
                            double totalUps = Convert.ToDouble(row["TotalUps"]);
                            double upsL = Convert.ToDouble(row["UpsL"]);
                            double upsW = Convert.ToDouble(row["UpsW"]);

                            if (totalUps == Total_Ups && upsL == Gbl_UPS_L && upsW == Gbl_UPS_H)
                            {
                                flag_isDieAvailable = true;
                                break; 
                            }
                        }
                    }
                    withBlock.NewRow();
                    withBlock.Rows.Add(Gbl_Machine_ID, Gbl_Machine_Name, Gbl_Machine_Gripper, Gbl_GripperSide, Machine_Colors, Gbl_Paper_ID, Paper_Size, Cut_size, Cut_L, Cut_H, Gbl_UPS_L, Gbl_UPS_H, Total_Ups,
                        Bal_Piece, Bal_Side, Waste, Waste_In_Percent, Wastage_Paper_In_KG, Gbl_Grain_Direction, Plate_Qty, Plate_Rate, Plate_Amount, Make_Ready_Sheets_Total, Actual_Sheets, Wastage_Sheets, Process_Wastage_Sheets,
                        Total_Paper_In_KG, Full_Sheets, Gbl_Paper_Rate, Paper_Amount, (Printing_Impressions), Impression_To_Be_Charged, Printing_Charges, Printing_Amount, Make_Readies, Make_Ready_Rate, Make_Ready_Amount,
                        Final_Quantity, Gbl_Order_Quantity, Total_Colors, Total_Amount, Cut_L_H, Cut_H_L, Gbl_Printing_Style, Printing_Charges_Type, Expected_Execution_Time, Total_Completion_Time, Gbl_Paper_Detail, Gbl_Plan_Type, Gbl_Paper_Rate_Type,
                        Die_Cut_size, Gbl_InterLock_Style, No_Of_Sets, F_Total_Amount, Unit_Price, Gbl_Packing, string.IsNullOrEmpty(Gbl_Unit_Per_Packing?.ToString()) ? 1 : Convert.ToDouble(Gbl_Unit_Per_Packing),
                        Roundof_Impressions_With, Special_Color_Front_Charges, Special_Color_Back_Charges, Special_Color_Front_Amount, Special_Color_Back_Amount, Op_Amt, withBlock.Rows.Count + 1, Coating_Charges,
                        Coating_Amount, GblMainPaperGroup, Gbl_Machine_Type, 0, "", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, Total_Running_Mtr, 0, Total_Square_Mtr, 0, 0, Machine_Speed, 0, 0, 0, 0, 0, 0, 0, 0, "",
                        "", 0, Paper_Amount, 0, Gbl_windingdirection, Gbl_labeltype, Gbl_finishedformat, 0, Gbl_dietype, Gbl_CoreInnerDia, Gbl_CoreOuterDia, FinalQuantityInPcs, Gbl_Estimation_Unit,
                        Gbl_Other_Material_GSM, PlanOtherMaterialGSMSettingJSON, TotalContentActualWeight, Gbl_Orientation, PlanContName, flag_isDieAvailable);
                    Gbl_DT_plan = withBlock;
                }

            }
            catch (Exception ex)
            {
                str = ex.Message;
            }
        }


        public double Calculate_Special_Color_Charges(int Special_Colors, double Special_Color_Charges, double Impression_To_Be_Charged, string Printing_Charges_Type, long Roundof_Impressions_With, long No_Of_Sets)
        {
            double Amount = 0;

            if (Printing_Charges_Type == "Impressions" && Special_Colors > 0)
            {
                // Special Color Condition by Vivek on 12-Oct-2019 1.25PM
                if (Gbl_Printing_Style == "Work & Turn" || Gbl_Printing_Style == "Work & Tumble")
                {
                    Amount = Math.Round(Impression_To_Be_Charged * Special_Color_Charges, 2) / 2;
                }
                else
                {
                    Amount = Math.Round(Impression_To_Be_Charged * Special_Color_Charges, 2);
                }
            }
            else if (Printing_Charges_Type == "Impressions/" + Roundof_Impressions_With)
            {
                if (Roundof_Impressions_With > 0 && Special_Colors > 0)
                {
                    double divisor = (Roundof_Impressions_With == 0 ? 1 : Roundof_Impressions_With);
                    if (Gbl_Printing_Style == "Work & Turn" || Gbl_Printing_Style == "Work & Tumble")
                    {
                        Amount = Math.Round(Impression_To_Be_Charged * (Special_Color_Charges / divisor), 2) / 2;
                    }
                    else
                    {
                        Amount = Math.Round(Impression_To_Be_Charged * (Special_Color_Charges / divisor), 2);
                    }
                }
            }
            else if (Printing_Charges_Type == "Impressions/Color")
            {
                Amount = Math.Round(Impression_To_Be_Charged * Special_Color_Charges * Special_Colors, 2);
            }
            else if (Printing_Charges_Type == "Impressions/" + Roundof_Impressions_With + "/Color")
            {
                if (Roundof_Impressions_With > 0)
                {
                    double divisor = (Roundof_Impressions_With == 0 ? 1 : Roundof_Impressions_With);
                    if (Gbl_Printing_Style == "Work & Turn" || Gbl_Printing_Style == "Work & Tumble")
                    {
                        Amount = Math.Round(Impression_To_Be_Charged * (Special_Color_Charges / divisor) * Special_Colors, 2) / 2;
                    }
                    else
                    {
                        Amount = Math.Round(Impression_To_Be_Charged * (Special_Color_Charges / divisor) * Special_Colors, 2);
                    }
                }
            }

            return Amount;
        }
        private bool Search_In_Machine_Slabs(long Machine_ID, long Printing_Impressions, ref double Wastage_Percent_Sheets, ref double Printing_Charges, ref double Plate_Rate, ref double Coating_Charges, ref double Special_Color_Front_Charges, ref double Special_Color_Back_Charges, ref string Printing_Charges_Type, ref long Roundof_Impressions_With, ref double Basic_Printing_Charges, ref long Actual_Sheets)
        {
            try
            {
                // ---- Search in DT_Client_Printing_Slabs ----
                if (DT_Client_Printing_Slabs != null && DT_Printing_Slabs.Rows.Count > 0)
                {
                    DataRow row = DT_Client_Printing_Slabs.Select("MachineID = " + Machine_ID).FirstOrDefault();
                    if (row != null)
                    {
                        foreach (DataRow dr in DT_Client_Printing_Slabs.Rows)
                        {
                            if (Gbl_LedgerID > 0 && Machine_ID == Convert.ToInt64(dr[0]) && (Printing_Impressions >= Convert.ToDouble(dr[1]) && Printing_Impressions <= Convert.ToDouble(dr[2])))
                            {
                                Wastage_Percent_Sheets = Convert.ToDouble(dr[3]);
                                Printing_Charges = Convert.ToDouble(dr[4]);

                                // Plate Rate logic
                                if (Gbl_Plate_Type == "CTP Plate")
                                    Plate_Rate = Convert.ToDouble(dr[5]);
                                else if (Gbl_Plate_Type == "PS Plate" || Gbl_Plate_Type == "PS Plate+Film")
                                    Plate_Rate = Convert.ToDouble(dr[6]);
                                else if (Gbl_Plate_Type == "CTCP Plate" || Gbl_Plate_Type == "CTcP Plate")
                                    Plate_Rate = Convert.ToDouble(dr[7]);
                                else
                                    Plate_Rate = 0;

                                Coating_Charges = dr.IsNull(8) ? 0 : Convert.ToDouble(dr[8]);
                                Special_Color_Front_Charges = dr.IsNull(9) ? 0 : Convert.ToDouble(dr[9]);
                                Special_Color_Back_Charges = dr.IsNull(10) ? 0 : Convert.ToDouble(dr[10]);

                                Printing_Charges_Type = row.IsNull(15) ? "0" : row[15].ToString();
                                Roundof_Impressions_With = row.IsNull(16) ? 0 : Convert.ToInt64(row[16]);
                                Basic_Printing_Charges = row.IsNull(17) ? 0 : Convert.ToDouble(row[17]);

                                return true;
                            }
                        }
                    }
                }

                // ---- Search in DT_Printing_Slabs ----
                if (DT_Printing_Slabs != null && DT_Printing_Slabs.Rows.Count > 0)
                {
                    DataRow row1 = DT_Printing_Slabs.Select("MachineID = " + Machine_ID).FirstOrDefault();

                    if (row1 != null)
                    {
                        foreach (DataRow dr in DT_Printing_Slabs.Rows)
                        {
                            string slabPaperGroup = dr.IsNull(14) ? "" : dr[14].ToString().Trim();

                            if ((string.Equals(GblMainPaperGroup, slabPaperGroup, StringComparison.OrdinalIgnoreCase) || slabPaperGroup == "-") && Machine_ID == Convert.ToInt64(dr[0]) &&
                                (Printing_Impressions >= Convert.ToDouble(dr[1]) && Printing_Impressions <= Convert.ToDouble(dr[2])))
                            {
                                Printing_Charges = Convert.ToDouble(dr[4]);

                                if (Gbl_Plate_Type == "CTP Plate")
                                    Plate_Rate = Convert.ToDouble(dr[5]);
                                else if (Gbl_Plate_Type == "PS Plate" || Gbl_Plate_Type == "PS Plate+Film")
                                    Plate_Rate = Convert.ToDouble(dr[6]);
                                else if (Gbl_Plate_Type == "CTCP Plate" || Gbl_Plate_Type == "CTcP Plate")
                                    Plate_Rate = Convert.ToDouble(dr[7]);
                                else
                                    Plate_Rate = 0;

                                Coating_Charges = dr.IsNull(8) ? 0 : Convert.ToDouble(dr[8]);
                                Special_Color_Front_Charges = dr.IsNull(9) ? 0 : Convert.ToDouble(dr[9]);
                                Special_Color_Back_Charges = dr.IsNull(10) ? 0 : Convert.ToDouble(dr[10]);

                                // --- Jump to wastage calculation ---
                                goto WastageCalculation;
                            }
                        }
                    }

                    // If not found, take last row values
                    DataRow lastRow = DT_Printing_Slabs.Rows[DT_Printing_Slabs.Rows.Count - 1];
                    Wastage_Percent_Sheets = Convert.ToDouble(lastRow[3]);
                    Printing_Charges = Convert.ToDouble(lastRow[4]);

                    if (Gbl_Plate_Type == "CTP Plate")
                        Plate_Rate = Convert.ToDouble(lastRow[5]);
                    else if (Gbl_Plate_Type == "PS Plate" || Gbl_Plate_Type == "PS Plate+Film")
                        Plate_Rate = Convert.ToDouble(lastRow[6]);
                    else if (Gbl_Plate_Type == "CTCP Plate" || Gbl_Plate_Type == "CTcP Plate")
                        Plate_Rate = Convert.ToDouble(lastRow[7]);
                    else
                        Plate_Rate = 0;

                    goto WastageCalculation;

                WastageCalculation:
                    foreach (DataRow dr in DT_Printing_Slabs.Rows)
                    {
                        string slabPaperGroup = dr.IsNull(14) ? "" : dr[14].ToString().Trim();
                        if ((string.Equals(GblMainPaperGroup, slabPaperGroup, StringComparison.OrdinalIgnoreCase) ||
                             slabPaperGroup == "-") &&
                            Machine_ID == Convert.ToInt64(dr[0]) &&
                            (Actual_Sheets >= Convert.ToDouble(dr[1]) &&
                             Actual_Sheets <= Convert.ToDouble(dr[2])))
                        {
                            Wastage_Percent_Sheets = Convert.ToDouble(dr[3]);
                            return true;
                        }
                    }

                    // fallback
                    Wastage_Percent_Sheets = Convert.ToDouble(DT_Printing_Slabs.Rows[DT_Printing_Slabs.Rows.Count - 1][3]);
                    return true;
                }
                else
                {
                    // Default zeroes
                    Wastage_Percent_Sheets = 0;
                    Printing_Charges = 0;
                    Plate_Rate = 0;
                }

                return false;
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return false;
            }
        }

        private bool Search_In_Machine_Slabs_Flexo(long Machine_ID, double Running_Meter, ref double Wastage_Percent_RMT, ref double Printing_Charges, ref double Plate_Rate, ref double Coating_Charges, ref double Special_Color_Front_Charges, ref double Special_Color_Back_Charges, ref string Printing_Charges_Type, ref long Roundof_Impressions_With, ref double Basic_Printing_Charges, ref double Process_Wastage_Percentage, ref double Slab_Machine_Speed)
        {
            int i;
            try
            {
                var withBlock = DT_Printing_Slabs;
                DataRow row1 = DT_Printing_Slabs.Select("MachineID = " + Machine_ID.ToString()).FirstOrDefault();
                if (row1 != null)
                {
                    for (i = 0; i <= withBlock.Rows.Count - 1; i++)
                    {
                        if (Machine_ID == Convert.ToInt64(withBlock.Rows[i][0]) && (Running_Meter >= Convert.ToDouble(withBlock.Rows[i][18]) && Running_Meter <= Convert.ToDouble(withBlock.Rows[i][19])))
                        {
                            Wastage_Percent_RMT = Wastage_Percent_RMT + Math.Round((Running_Meter * Convert.ToDouble(withBlock.Rows[i][20]) / 100.0), 3);
                            Process_Wastage_Percentage = Convert.ToDouble(withBlock.Rows[i][20]);
                            Slab_Machine_Speed = Convert.ToDouble(withBlock.Rows[i][21]);
                            return true;
                        }
                    }
                }
                if (withBlock.Rows.Count > 0)
                {
                    Wastage_Percent_RMT = Wastage_Percent_RMT + Math.Round((Running_Meter * Convert.ToDouble(withBlock.Rows[withBlock.Rows.Count - 1][20]) / 100.0), 3);
                    Process_Wastage_Percentage = Convert.ToDouble(withBlock.Rows[withBlock.Rows.Count - 1][20]);
                    Slab_Machine_Speed = Convert.ToDouble(withBlock.Rows[withBlock.Rows.Count - 1][21]);
                }
                else
                {
                    Wastage_Percent_RMT = 0;
                    Process_Wastage_Percentage = 0;
                    Slab_Machine_Speed = 0;
                }

                return false;
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return false;
            }
        }

        public double RoundUP_25(double Num)
        {
            if (Num.ToString().Contains("."))
            {
                string decimalPart = Num.ToString().Split('.')[1];
                if (decimalPart.Length > 0 && Convert.ToDouble("0." + decimalPart) >= 0.25)
                {
                    return Math.Ceiling(Num);
                }
                else
                {
                    return Math.Floor(Num);
                }
            }
            else
            {
                return Num;
            }
        }
        public double RoundDown(double Num)
        {
            Num = Math.Round(Num, 5);
            if (Num.ToString().Contains("."))
            {
                return Math.Floor(Num);
            }
            else
            {
                return Num;
            }
        }
        private double RoundUp(double value, int decimals)
        {
            return Math.Ceiling(value * (Math.Pow(10, decimals))) / (Math.Pow(10, decimals));
        }

        private bool Search_In_Machine(long Machine_ID, ref long Minimum_Sheets, ref long Make_Ready_Sheet, ref double Make_Ready_Rate, ref long Machine_Colors,
            ref string Printing_Charges_Type, ref long Roundof_Impressions_With, ref double Basic_Printing_Charges, ref long Machine_Speed, ref long Make_Ready_Time,
            ref long Job_Change_Over_Time, ref string Wastage_Type, ref string Wastage_Calculation_On, DataTable DT_Machine, ref bool Is_Perfecta_Machine, ref bool IsSpecialMachine)
        {
            DataRow row = DT_Machine.Select("MachineID = " + Machine_ID + "").FirstOrDefault();

            if (row != null)
            {
                Minimum_Sheets = Convert.IsDBNull(row[2]) ? 0 : Convert.ToInt64(row[2]);
                Machine_Colors = Convert.IsDBNull(row[3]) ? 0 : Convert.ToInt64(row[3]);
                Make_Ready_Rate = Convert.IsDBNull(row[4]) ? 0 : Convert.ToDouble(row[4]);
                Make_Ready_Sheet = Convert.IsDBNull(row[5]) ? 0 : Convert.ToInt64(row[5]);
                Make_Ready_Time = Convert.IsDBNull(row[7]) ? 0 : Convert.ToInt64(row[7]);
                Machine_Speed = Convert.IsDBNull(row[10]) ? 0 : Convert.ToInt64(row[10]);
                Printing_Charges_Type = Convert.IsDBNull(row[12]) ? "" : row[12].ToString();
                Roundof_Impressions_With = Convert.IsDBNull(row[13]) ? 0 : Convert.ToInt64(row[13]);
                Is_Perfecta_Machine = Convert.IsDBNull(row[14]) ? false : Convert.ToBoolean(row[14]);
                Basic_Printing_Charges = Convert.IsDBNull(row[15]) ? 0 : Convert.ToDouble(row[15]);
                Job_Change_Over_Time = Convert.IsDBNull(row[16]) ? 0 : Convert.ToInt64(row[16]);
                Wastage_Type = Convert.IsDBNull(row[18]) ? "" : row[18].ToString();
                Wastage_Calculation_On = Convert.IsDBNull(row[19]) ? "" : row[19].ToString();
                MachinePerHourCost = Convert.IsDBNull(row[21]) ? 0 : Convert.ToDouble(row[21]);
                IsSpecialMachine = Convert.IsDBNull(row["IsSpecialMachine"]) ? false : Convert.ToBoolean(row["IsSpecialMachine"]);
                GblPlateChargesType = Convert.IsDBNull(row["PlateChargesType"]) ? "Rate/Plate" : row["PlateChargesType"].ToString();

                //Search_In_Machine = true;
                return true;
            }
            //Search_In_Machine = false;
            return false;
        }
        public bool Search_In_Machine_Online_Coating(long Machine_ID, DataTable DTCoatingMachine, ref double Coating_Rate, ref string Coating_Charges_Type, double Actual_Sheets, ref double BasicCoatingCharges)
        {
            try
            {
                DataRow row = DTCoatingMachine.Select("MachineID = " + Machine_ID).FirstOrDefault();

                if (row != null)
                {
                    for (int i = 0; i < DTCoatingMachine.Rows.Count; i++)
                    {
                        long machineId = Convert.IsDBNull(DTCoatingMachine.Rows[i][0]) ? 0 : Convert.ToInt64(DTCoatingMachine.Rows[i][0]);
                        double minSheets = Convert.IsDBNull(DTCoatingMachine.Rows[i][1]) ? 0 : Convert.ToDouble(DTCoatingMachine.Rows[i][1]);
                        double maxSheets = Convert.IsDBNull(DTCoatingMachine.Rows[i][2]) ? 0 : Convert.ToDouble(DTCoatingMachine.Rows[i][2]);

                        if (machineId == Machine_ID && Actual_Sheets >= minSheets && Actual_Sheets <= maxSheets)
                        {
                            Coating_Rate = Convert.IsDBNull(DTCoatingMachine.Rows[i][4]) ? 0 : Convert.ToDouble(DTCoatingMachine.Rows[i][4]);
                            Coating_Charges_Type = Convert.IsDBNull(DTCoatingMachine.Rows[i][5]) ? "Rate/100 Sq.Inch/Sheet" : DTCoatingMachine.Rows[i][5].ToString();
                            BasicCoatingCharges = Convert.IsDBNull(DTCoatingMachine.Rows[i][6]) ? 0 : Convert.ToDouble(DTCoatingMachine.Rows[i][6]);

                            return true;
                        }
                    }
                }
                return false;
            }
            catch (Exception ex)
            {
                return false;
            }
        }

        public void Seperate_Paper_Size(string paperSize, ref double paperL, ref double paperH)
        {
            try
            {
                int xPosition = paperSize.IndexOf("x", StringComparison.OrdinalIgnoreCase);

                if (xPosition > 0)
                {
                    paperH = Convert.ToDouble(paperSize.Substring(0, xPosition));
                    paperL = Convert.ToDouble(paperSize.Substring(xPosition + 1));
                }
                else
                {
                    paperH = 0;
                    paperL = 0;
                }
            }
            catch
            {
                paperH = 0;
                paperL = 0;
            }
        }


        public double Calculate_Printing_Charges(long Impression_To_Be_Charged, long Minimum_Sheets, ref double Printing_Charges, string Printing_Charges_Type, double Basic_Printing_Charges, long Roundof_Impressions_With, long No_Of_sets, long Front_Color, long Back_Color, string Printing_Style, bool Is_Perfecta_Machine, int Machine_ID, long Machine_Colors)
        {
            double Printing_Amount = 0;
            long Total_Colors_Main = 0;

            try
            {
                if (Printing_Style == "Single Side" || Printing_Style == "Work & Turn" || Printing_Style == "Work & Tumble")
                {
                    if (Front_Color >= Back_Color)
                    {
                        Total_Colors_Main = Front_Color;
                    }
                    else
                    {
                        Total_Colors_Main = Back_Color;
                    }
                }
                else if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                {
                    Total_Colors_Main = Front_Color + Back_Color;
                    if (!Is_Perfecta_Machine)
                    {
                        // Impression_To_Be_Charged = Impression_To_Be_Charged / 2;
                        // planErrors += "Impression to be charged is half in case of machine is not perfecta";
                    }

                    // if (No_Of_sets > 1)
                    // {
                    //     if ((Front_Color == 0 ^ Back_Color == 0) && (Machine_Colors <= Front_Color || Machine_Colors <= Back_Color))
                    //     {
                    //         No_Of_sets = 1;
                    //     }
                    // }
                }

                if (Printing_Charges_Type == "Impressions")
                {
                    if (Total_Colors_Main > Machine_Colors)
                    {
                        Impression_To_Be_Charged *= (long)(RoundUp(Total_Colors_Main / Machine_Colors, 0));
                    }

                    if (Basic_Printing_Charges != 0)
                    {
                        Printing_Amount = Math.Round((Impression_To_Be_Charged - Minimum_Sheets) * Printing_Charges + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                    else
                    {
                        Printing_Amount = Math.Round(Impression_To_Be_Charged * Printing_Charges + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                }
                else if (Printing_Charges_Type == $"Impressions/{Roundof_Impressions_With}")
                {
                    if (Basic_Printing_Charges != 0)
                    {
                        Printing_Amount = Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With)) + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                    else
                    {
                        Printing_Amount = Math.Round((Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With)) + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                }
                else if (Printing_Charges_Type == "Impressions/Color")
                {
                    if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                    {
                        if (Basic_Printing_Charges != 0)
                        {
                            Printing_Amount =
                                Math.Round((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges * Front_Color)
                                    + (Front_Color > 0 ? Basic_Printing_Charges : 0), 2) +
                                Math.Round((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges * Back_Color)
                                    + (Back_Color > 0 ? Basic_Printing_Charges : 0), 2);
                        }
                        else
                        {
                            Printing_Amount = Math.Round(Impression_To_Be_Charged * Printing_Charges * Front_Color, 2) +
                                              Math.Round(Impression_To_Be_Charged * Printing_Charges * Back_Color, 2);
                        }
                    }
                    else
                    {
                        if (Basic_Printing_Charges != 0)
                        {
                            Printing_Amount = Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges * Total_Colors_Main) + Basic_Printing_Charges), 2) * No_Of_sets;
                        }
                        else
                        {
                            Printing_Amount = Math.Round(Impression_To_Be_Charged * Printing_Charges * Total_Colors_Main, 2) * No_Of_sets;
                        }
                    }
                }
                else if (Printing_Charges_Type == $"Impressions/{Roundof_Impressions_With}/Color")
                {
                    if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                    {
                        if (Basic_Printing_Charges != 0)
                        {
                            Printing_Amount =
                                Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Front_Color)
                                    + (Front_Color > 0 ? Basic_Printing_Charges : 0), 2) +
                                Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Back_Color)
                                    + (Back_Color > 0 ? Basic_Printing_Charges : 0), 2);
                        }
                        else
                        {
                            Printing_Amount = Math.Round(Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Front_Color, 2) +
                                              Math.Round(Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Back_Color, 2);
                        }
                    }
                    else
                    {
                        if (Basic_Printing_Charges != 0)
                        {
                            Printing_Amount = Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Total_Colors_Main) + Basic_Printing_Charges, 2) * No_Of_sets;
                        }
                        else
                        {
                            Printing_Amount = Math.Round(Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Total_Colors_Main, 2) * No_Of_sets;
                        }
                    }
                }
                if (DT_Printing_Slabs.Rows.Count > 0)
                {
                    // DataRow row1 = DT_Printing_Slabs.Select("MachineID = " + Machine_ID).FirstOrDefault();
                    // DataRow row2 = DT_Printing_Slabs.Select("PaperGroup = '" + GblMainPaperGroup + "'").FirstOrDefault();
                    string tempPaperGroup = (GblMainPaperGroup == "-" || GblMainPaperGroup == "Reel") ? "Paper" : GblMainPaperGroup;
                    string condition = "";

                    if (tempPaperGroup != "-" && tempPaperGroup != "Paper" && tempPaperGroup != "Reel")
                    {
                        condition = "MachineID = " + Machine_ID + " AND (PaperGroup = '" + tempPaperGroup + "')";
                    }
                    else
                    {
                        condition = "MachineID = " + Machine_ID + " AND (PaperGroup = '" + tempPaperGroup + "' OR PaperGroup = 'Paper' OR PaperGroup = '-' OR PaperGroup = 'Reel')";
                    }

                    DataRow row1 = DT_Printing_Slabs.Select(condition).FirstOrDefault();
                    if (row1 != null)
                    {
                        // if (row1 != null && row2 != null)
                        // if (Convert.ToDecimal(row1["SheetRangeTo"] ?? 0) > 0)
                        if (Convert.ToDecimal(row1.IsNull("SheetRangeTo") ? 0 : row1["SheetRangeTo"]) > 0)
                        {
                            double slabPrintingAmount = FnCalGroupWiseRates_(Impression_To_Be_Charged, Minimum_Sheets, Printing_Charges, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, No_Of_sets, Front_Color, Back_Color, Printing_Style, Machine_ID, false);
                            if (Printing_Amount > 0)
                            {
                                Printing_Amount = slabPrintingAmount;
                                Printing_Charges = SlabPrintingChargeN;
                            }
                        }
                    }
                }
                if (Printing_Style == "No Printing")
                {
                    return Printing_Amount = 0;
                }
            }
            catch (Exception ex)
            {
            }
            return Printing_Amount;
        }


        public double Calculate_Book_Printing_Charges(long Impression_To_Be_Charged, long Minimum_Sheets, ref double Printing_Charges, string Printing_Charges_Type, double Basic_Printing_Charges, long Roundof_Impressions_With, long No_Of_sets, long Front_Color, long Back_Color, string Printing_Style, bool Is_Perfecta_Machine, int Machine_ID)
        {
            double Printing_Amount = 0;
            long Total_Colors_Main = 0;

            try
            {
                if (Printing_Style == "Single Side" || Printing_Style == "Work & Turn" || Printing_Style == "Work & Tumble")
                {
                    if (Front_Color >= Back_Color)
                    {
                        Total_Colors_Main = Front_Color;
                    }
                    else
                    {
                        Total_Colors_Main = Back_Color;
                    }
                }
                else if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                {
                    Total_Colors_Main = Front_Color + Back_Color;
                    if (!Is_Perfecta_Machine)
                    {
                        // Impression_To_Be_Charged = Impression_To_Be_Charged / 2;
                        // planErrors += "Impression to be charged is half in case of machine is not perfecta";
                    }
                }

                if (Printing_Charges_Type == "Impressions")
                {
                    if (Basic_Printing_Charges != 0)
                    {
                        Printing_Amount = Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * Printing_Charges) + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                    else
                    {
                        Printing_Amount = Math.Round((Impression_To_Be_Charged * Printing_Charges) + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                }
                else if (Printing_Charges_Type == $"Impressions/{Roundof_Impressions_With}")
                {
                    if (Basic_Printing_Charges != 0)
                    {
                        Printing_Amount = Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With)) + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                    else
                    {
                        Printing_Amount = Math.Round((Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With)) + Basic_Printing_Charges, 2) * No_Of_sets;
                    }
                }
                else if (Printing_Charges_Type == "Impressions/Color")
                {
                    if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                    {
                        if (Basic_Printing_Charges != 0)
                        {
                            Printing_Amount = Math.Round((Printing_Charges * Front_Color) + Basic_Printing_Charges, 2) + Math.Round((Printing_Charges * Back_Color) + Basic_Printing_Charges, 2);
                        }
                        else
                        {
                            Printing_Amount = Math.Round(Printing_Charges * Front_Color, 2) + Math.Round(Printing_Charges * Back_Color, 2);
                        }
                    }
                    else
                    {
                        if (Basic_Printing_Charges != 0)
                        {
                            Printing_Amount = Math.Round((Printing_Charges * Total_Colors_Main) + Basic_Printing_Charges, 2) * No_Of_sets;
                        }
                        else
                        {
                            Printing_Amount = Math.Round(Printing_Charges * Total_Colors_Main, 2) * No_Of_sets;
                        }
                    }
                }
                else if (Printing_Charges_Type == $"Impressions/{Roundof_Impressions_With}/Color")
                {
                    if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                    {
                        if (Back_Color == 0)
                        {
                            if (Basic_Printing_Charges != 0)
                            {
                                Printing_Amount = Math.Round((((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Front_Color) + Basic_Printing_Charges) * No_Of_sets, 2) + Math.Round((((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Back_Color) + Basic_Printing_Charges) * No_Of_sets, 2);
                            }
                            else
                            {
                                Printing_Amount = Math.Round((Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Front_Color) * No_Of_sets, 2) + Math.Round((Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Back_Color) * No_Of_sets, 2);
                            }
                        }
                        else
                        {
                            if (Basic_Printing_Charges != 0)
                            {
                                Printing_Amount = Math.Round((((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Front_Color) + Basic_Printing_Charges) * (No_Of_sets / 2.0), 2) + Math.Round((((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Back_Color) + Basic_Printing_Charges) * (No_Of_sets / 2.0), 2);
                            }
                            else
                            {
                                Printing_Amount = Math.Round((Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Front_Color) * (No_Of_sets / 2.0), 2) + Math.Round((Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Back_Color) * (No_Of_sets / 2.0), 2);
                            }
                        }
                    }
                    else
                    {
                        if (Basic_Printing_Charges != 0)
                        {
                            Printing_Amount = Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (Printing_Charges / Roundof_Impressions_With) * Total_Colors_Main) + Basic_Printing_Charges, 2) * No_Of_sets;
                        }
                        else
                        {
                            Printing_Amount = Math.Round(Impression_To_Be_Charged * (Printing_Charges / Roundof_Impressions_With) * Total_Colors_Main, 2) * No_Of_sets;
                        }
                    }
                }

                if (DT_Printing_Slabs.Rows.Count > 0)
                {
                    // DataRow row1 = DT_Printing_Slabs.Select("MachineID = " + Machine_ID).FirstOrDefault();
                    // DataRow row2 = DT_Printing_Slabs.Select("PaperGroup = '" + GblMainPaperGroup + "'").FirstOrDefault();
                    string tempPaperGroup = (GblMainPaperGroup == "-" || GblMainPaperGroup == "Reel") ? "Paper" : GblMainPaperGroup;
                    string condition = "";
                    if (tempPaperGroup != "-" && tempPaperGroup != "Paper" && tempPaperGroup != "Reel")
                    {
                        condition = "MachineID = " + Machine_ID + " AND (PaperGroup = '" + tempPaperGroup + "')";
                    }
                    else
                    {
                        condition = "MachineID = " + Machine_ID + " AND (PaperGroup = '" + tempPaperGroup + "' OR PaperGroup = 'Paper' OR PaperGroup = '-' OR PaperGroup = 'Reel')";
                    }
                    DataRow row1 = DT_Printing_Slabs.Select(condition).FirstOrDefault();
                    if (row1 != null)
                    {
                        // if (row1 != null && row2 != null)
                        // if (Convert.ToDecimal(row1["SheetRangeTo"] ?? 0) > 0)
                        if (Convert.ToDecimal(row1.IsNull("SheetRangeTo") ? 0 : row1["SheetRangeTo"]) > 0)
                        {
                            double slabPrintingAmount = FnCalGroupWiseRates_(Impression_To_Be_Charged, Minimum_Sheets, Printing_Charges, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, No_Of_sets, Front_Color, Back_Color, Printing_Style, Machine_ID, true);
                            if (slabPrintingAmount > 0)
                            {
                                Printing_Amount = slabPrintingAmount;
                                Printing_Charges = SlabPrintingChargeN;
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in Calculate_Book_Printing_Charges: {ex.Message}");
            }

            return Printing_Amount;
        }


        private double FnCalGroupWiseRates_(long Impression_To_Be_Charged, long Minimum_Sheets, double Printing_Charges, string Printing_Charges_Type, double Basic_Printing_Charges, long Roundof_Impressions_With, long No_Of_Sets, long Front_Color, long Back_Color, string Printing_Style, int Machine_ID, bool IsBookPlan)
        {
            try
            {
                double Min_Charges = 0;
                long Printing_Amount_N = 0;
                SlabPrintingChargeN = 0;
                long Slab_Max_N = 0;
                long Slab_Min_N = 0;
                // long Act_Imp_To_Charge_N;

                long Total_Colors_Main = 0;
                if (Printing_Style == "Single Side" || Printing_Style == "Work & Turn" || Printing_Style == "Work & Tumble")
                {
                    if (Front_Color >= Back_Color)
                    {
                        Total_Colors_Main = Front_Color;
                    }
                    else
                    {
                        Total_Colors_Main = Back_Color;
                    }
                }
                else if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                {
                    Total_Colors_Main = Front_Color + Back_Color;
                }

                DataView dataViewItems = DT_Printing_Slabs.DefaultView;
                DataTable DTSlabs = new DataTable();
                dataViewItems.RowFilter = "MachineID = " + Machine_ID;
                dataViewItems.RowFilter = "PaperGroup = '" + GblMainPaperGroup + "' OR PaperGroup = '-'";
                DTSlabs = DT_Printing_Slabs.Copy();
                DTSlabs.Clear();

                for (int I = 0; I <= dataViewItems.Count - 1; I++)
                {
                    DTSlabs.ImportRow(dataViewItems[I].Row);
                }


                DataRow row1 = DTSlabs.Select("MachineID = " + Machine_ID).FirstOrDefault();
                if (row1 != null)
                {
                    for (int i = 0; i <= DTSlabs.Rows.Count - 1; i++)
                    {
                        if (Machine_ID == Convert.ToInt32(DTSlabs.Rows[i][0]))
                        {
                            if (
                                (Convert.IsDBNull(DTSlabs.Rows[i]["SheetRangeFrom"]) ? 0 : Convert.ToInt32(DTSlabs.Rows[i]["SheetRangeFrom"])) == 1 &&
                                (
                                    GblMainPaperGroup == (Convert.IsDBNull(DTSlabs.Rows[i]["PaperGroup"]) ? "" : DTSlabs.Rows[i]["PaperGroup"].ToString()) ||
                                    (Convert.IsDBNull(DTSlabs.Rows[i]["PaperGroup"]) ? "" : DTSlabs.Rows[i]["PaperGroup"].ToString()) == "-" ||
                                    Convert.IsDBNull(DTSlabs.Rows[i]["PaperGroup"]) ||
                                    DTSlabs.Rows[i]["PaperGroup"].ToString().Trim() == ""
                                ) &&
                                GblMainPaperGroup != ""
                            )
                            {
                                if (
                                    (Gbl_Sheet_L <= (double)((bool)(DTSlabs.Rows[i]["MaxPlanL"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanL"])) &&
                                     Gbl_Sheet_W <= (double)(Convert.IsDBNull(DTSlabs.Rows[i]["MaxPlanW"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanW"]))) ||
                                    (Gbl_Sheet_L <= (double)(Convert.IsDBNull(DTSlabs.Rows[i]["MaxPlanW"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanW"])) &&
                                     Gbl_Sheet_W <= (double)(Convert.IsDBNull(DTSlabs.Rows[i]["MaxPlanL"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanL"])))
                                )
                                {
                                    Min_Charges = Convert.IsDBNull(DTSlabs.Rows[i]["MinCharges"]) ? 0 : Convert.ToDouble(DTSlabs.Rows[i]["MinCharges"]);
                                    Slab_Max_N = Convert.IsDBNull(DTSlabs.Rows[i]["SheetRangeTo"]) ? 0 : Convert.ToInt64(DTSlabs.Rows[i]["SheetRangeTo"]);
                                    Slab_Min_N = Convert.IsDBNull(DTSlabs.Rows[i]["SheetRangeFrom"]) ? 0 : Convert.ToInt64(DTSlabs.Rows[i]["SheetRangeFrom"]);
                                    break;
                                }
                            }
                        }
                    }

                    for (int i = 0; i <= DTSlabs.Rows.Count - 1; i++)
                    {
                        if (Machine_ID == Convert.ToInt32(DTSlabs.Rows[i][0]))
                        {
                            if (
                                (Convert.IsDBNull(DTSlabs.Rows[i]["SheetRangeFrom"]) ? 0 : Convert.ToInt64(DTSlabs.Rows[i]["SheetRangeFrom"])) <= Impression_To_Be_Charged &&
                                (Convert.IsDBNull(DTSlabs.Rows[i]["SheetRangeTo"]) ? 0 : Convert.ToInt64(DTSlabs.Rows[i]["SheetRangeTo"])) >= Impression_To_Be_Charged &&
                                (
                                    GblMainPaperGroup == (Convert.IsDBNull(DTSlabs.Rows[i]["PaperGroup"]) ? "" : DTSlabs.Rows[i]["PaperGroup"].ToString()) ||
                                    (Convert.IsDBNull(DTSlabs.Rows[i]["PaperGroup"]) ? "" : DTSlabs.Rows[i]["PaperGroup"].ToString()) == "-" ||
                                    Convert.IsDBNull(DTSlabs.Rows[i]["PaperGroup"]) ||
                                    DTSlabs.Rows[i]["PaperGroup"].ToString().Trim() == ""
                                ) &&
                                GblMainPaperGroup != ""
                            )
                            {
                                if ((Gbl_Sheet_L <= (double)(Convert.IsDBNull(DTSlabs.Rows[i]["MaxPlanL"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanL"])) &&
                                     Gbl_Sheet_W <= (double)(Convert.IsDBNull(DTSlabs.Rows[i]["MaxPlanW"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanW"]))) ||
                                    (Gbl_Sheet_L <= (double)(Convert.IsDBNull(DTSlabs.Rows[i]["MaxPlanW"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanW"])) &&
                                     Gbl_Sheet_W <= (double)(Convert.IsDBNull(DTSlabs.Rows[i]["MaxPlanL"]) ? 0 : Convert.ToDecimal(DTSlabs.Rows[i]["MaxPlanL"])))
                                )
                                {
                                    SlabPrintingChargeN = Convert.IsDBNull(DTSlabs.Rows[i]["Rate"]) ? 0 : Convert.ToDouble(DTSlabs.Rows[i]["Rate"]);
                                    break;
                                }
                            }
                        }
                    }
                }
                else
                {
                    Min_Charges = 0;
                }
                if (Convert.ToDouble(SlabPrintingChargeN) > 0)
                {
                    if (Convert.ToDouble(Min_Charges) == 0 && Convert.ToDouble(Basic_Printing_Charges) > 0)
                    {
                        Min_Charges = Basic_Printing_Charges;
                    }

                    if (Printing_Charges_Type == "Impressions")
                    {
                        if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                        {
                            Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * SlabPrintingChargeN, 2) * No_Of_Sets);
                        }
                        else
                        {
                            Printing_Amount_N = Convert.ToInt64(Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * SlabPrintingChargeN + Min_Charges), 2) * No_Of_Sets);
                        }
                    }
                    else if (Printing_Charges_Type == $"Impressions/{Roundof_Impressions_With}")
                    {
                        double divisor = Convert.ToDouble(Roundof_Impressions_With) == 0 ? 1 : Convert.ToDouble(Roundof_Impressions_With);
                        if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                        {
                            Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * (SlabPrintingChargeN / divisor), 2) * No_Of_Sets);
                        }
                        else
                        {
                            Printing_Amount_N = Convert.ToInt64(Math.Round(((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) + Min_Charges), 2) * No_Of_Sets);
                        }
                    }
                    else if (Printing_Charges_Type == "Impressions/Color")
                    {
                        if (IsBookPlan)
                        {
                            if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                            {
                                Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * SlabPrintingChargeN * Front_Color, 2) + Math.Round(Impression_To_Be_Charged * SlabPrintingChargeN * Back_Color, 2));
                            }
                            else
                            {
                                double frontPart = ((Impression_To_Be_Charged - Minimum_Sheets) * SlabPrintingChargeN * Front_Color) + (Front_Color > 0 ? Min_Charges : 0);
                                double backPart = ((Impression_To_Be_Charged - Minimum_Sheets) * SlabPrintingChargeN * Back_Color) + (Back_Color > 0 ? Min_Charges : 0);
                                Printing_Amount_N = Convert.ToInt64(Math.Round(frontPart, 2) + Math.Round(backPart, 2));
                            }
                        }
                        else
                        {
                            if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                            {
                                if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                {
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * SlabPrintingChargeN * Front_Color, 2) + Math.Round(Impression_To_Be_Charged * SlabPrintingChargeN * Back_Color, 2));
                                }
                                else
                                {
                                    double frontPart = ((Impression_To_Be_Charged - Minimum_Sheets) * SlabPrintingChargeN * Front_Color) + (Front_Color > 0 ? Min_Charges : 0);
                                    double backPart = ((Impression_To_Be_Charged - Minimum_Sheets) * SlabPrintingChargeN * Back_Color) + (Back_Color > 0 ? Min_Charges : 0);
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(frontPart, 2) + Math.Round(backPart, 2));
                                }
                            }
                            else
                            {
                                if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                {
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * SlabPrintingChargeN * Total_Colors_Main, 2) * No_Of_Sets);
                                }
                                else
                                {
                                    double totalPart = ((Impression_To_Be_Charged - Minimum_Sheets) * SlabPrintingChargeN * Total_Colors_Main) + (Total_Colors_Main > 0 ? Min_Charges : 0);
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(totalPart, 2) * No_Of_Sets);
                                }
                            }
                        }
                    }
                    else if (Printing_Charges_Type == $"Impressions/{Roundof_Impressions_With}/Color")
                    {
                        double divisor = Convert.ToDouble(Roundof_Impressions_With) == 0 ? 1 : Convert.ToDouble(Roundof_Impressions_With);
                        if (IsBookPlan)
                        {
                            if (Back_Color == 0)
                            {
                                if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                {
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Front_Color * No_Of_Sets, 2));
                                }
                                else
                                {
                                    double part = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Front_Color + Min_Charges) * No_Of_Sets;
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(part, 2));
                                }
                            }
                            else
                            {
                                if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                {
                                    double front = Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Front_Color * (No_Of_Sets / 2.0);
                                    double back = Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Back_Color * (No_Of_Sets / 2.0);
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(front, 2) + Math.Round(back, 2));
                                }
                                else
                                {
                                    double front = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Front_Color + (Front_Color > 0 ? Min_Charges : 0)) * (No_Of_Sets / 2.0);
                                    double back = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Back_Color + (Back_Color > 0 ? Min_Charges : 0)) * (No_Of_Sets / 2.0);
                                    Printing_Amount_N = Convert.ToInt64(Math.Round(front, 2) + Math.Round(back, 2));
                                }
                            }
                        }
                        else
                        {
                            if (Printing_Style == "Front & Back" || Printing_Style == "FB-Perfection")
                            {
                                if (Back_Color == 0)
                                {
                                    if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                    {
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Front_Color * No_Of_Sets, 2));
                                    }
                                    else
                                    {
                                        double part = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Front_Color + Min_Charges) * No_Of_Sets;
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(part, 2));
                                    }
                                }
                                else
                                {
                                    if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                    {
                                        double front = Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Front_Color * (No_Of_Sets / 2.0);
                                        double back = Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Back_Color * (No_Of_Sets / 2.0);
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(front, 2) + Math.Round(back, 2));
                                    }
                                    else
                                    {
                                        double front = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Front_Color + (Front_Color > 0 ? Min_Charges : 0)) * (No_Of_Sets / 2.0);
                                        double back = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Back_Color + (Back_Color > 0 ? Min_Charges : 0)) * (No_Of_Sets / 2.0);
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(front, 2) + Math.Round(back, 2));
                                    }
                                }
                            }
                            else
                            {
                                if (Back_Color == 0)
                                {
                                    if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                    {
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Front_Color * No_Of_Sets, 2));
                                    }
                                    else
                                    {
                                        double part = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Front_Color + Min_Charges) * No_Of_Sets;
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(part, 2));
                                    }
                                }
                                else
                                {
                                    if (Min_Charges == 0 && SlabPrintingChargeN > 0)
                                    {
                                        double front = Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Front_Color * (No_Of_Sets / 2.0);
                                        double back = Impression_To_Be_Charged * (SlabPrintingChargeN / divisor) * Back_Color * (No_Of_Sets / 2.0);
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(front, 2) + Math.Round(back, 2));
                                    }
                                    else
                                    {
                                        double front = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Front_Color + (Front_Color > 0 ? Min_Charges : 0)) * (No_Of_Sets / 2.0);
                                        double back = ((Impression_To_Be_Charged - Minimum_Sheets) * (SlabPrintingChargeN / divisor) * Back_Color + (Back_Color > 0 ? Min_Charges : 0)) * (No_Of_Sets / 2.0);
                                        Printing_Amount_N = Convert.ToInt64(Math.Round(front, 2) + Math.Round(back, 2));
                                    }
                                }
                            }
                        }
                    }
                }

                return Printing_Amount_N;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in FnCalGroupWiseRates_: {ex.Message}");
                return 0;
            }
        }

        public DataTable Plate_Calculation(ref DataTable DT)
        {
            if (DT.Rows.Count >= 1)
            {
                for (int i = 0; i < DT.Rows.Count; i++)
                {
                    DT.Rows[i][1] = Convert.ToDouble(DT.Rows[i][5]); // Plate Qty
                    DT.Rows[i][3] = Math.Round(Convert.ToDouble(DT.Rows[i][2]) * Convert.ToDouble(DT.Rows[i][5]), 2); // Plate Amount
                }
            }
            return DT;
        }
        // '''''Calculate Operation
        public double Calculate_Operations(string TypeOfCharges, double Rate, double Minimum_Charges, long Final_Quantity, long Final_Quantity_Pcs, double Setup_Charges, long Total_Paper_KG, long Total_Ups,
        long Sets, double Size_L, double Size_W, long Total_Colors, double Pub_Sheets, double Job_L, double Job_H, double Job_W, long Total_Plates, long Order_Quantity,
        long PagesPerSection, double NoOfForms)
        {
            double Amount = 0;
            long Pages = 0;
            int Stitch = 0;
            int folds = 0;
            double Spine = 0;

            Stitch = 1;
            if (Gbl_Job_Leaves == 0)
            {
                if (Gbl_Job_Pages == 0)
                    Pages = 1;
                else
                    Pages = Gbl_Job_Pages;
            }
            else
                Pages = Gbl_Job_Leaves * 2;

            // Dim spine As Single
            // spine = Val(Paper_Caliper) * (Pages / 2)
            if (Gbl_Order_Quantity == 0)
                Gbl_Order_Quantity = Order_Quantity;
            if (Total_Ups == 4)
                folds = 2;
            else if (Total_Ups == 8)
                folds = 3;
            else if (Total_Ups == 16)
                folds = 4;
            else if (Total_Ups == 32)
                folds = 5;

            switch (TypeOfCharges)
            {
                case "Rate/Total KgOfJob":
                    {
                        Amount = (Total_Paper_KG * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Kg":
                    {
                        Amount = (Total_Paper_KG * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Color":
                    {
                        Amount = (Total_Colors * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Color":
                    {
                        Amount = (Total_Colors * Size_L * Size_W * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Unit":
                    {
                        Amount = (Size_L * Size_W * Rate * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Sheet":
                    {
                        Amount = (Size_L * Size_W * Rate * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch":
                    {
                        Amount = (Size_L * Size_W * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Cm":
                    {
                        Amount = (Size_L * Size_W * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Cm/Unit":
                    {
                        Amount = (Size_L * Size_W * Rate * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/100 Sq.Cm/Sheet":
                    {
                        Amount = ((Size_L * Size_W) * Pub_Sheets * (Rate / 100)) + Setup_Charges;
                        break;
                    }

                case "Rate/100 Sq.Cm/Sheet Both Side":
                    {
                        Amount = ((Size_L * Size_W) * Pub_Sheets * (Rate / 100) * 2) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Cm/Sheet":
                    {
                        Amount = (Size_L * Size_W * Rate * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/100 Sq.Inch/Sheet":
                    {
                        Amount = (((Size_L * Size_W) * Pub_Sheets * (Rate / 100))) + Setup_Charges;
                        break;
                    }

                case "Rate/100 Sq.Inch/Sheet Both Side":
                    {
                        Amount = (((Size_L * Size_W) * Pub_Sheets * (Rate / 100)) * 2) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Sheet Both Side":
                    {
                        Amount = ((Size_L * Size_W) * 2 * Rate * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Unit":
                    {
                        Amount = (Final_Quantity * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/1000 Units":
                    {
                        Amount = (RoundUp(Final_Quantity / (double)1000, 0) * 1000) * (Rate / 1000) + Setup_Charges;
                        break;
                    }

                case "Rate/Sheet":
                    {
                        Amount = (Pub_Sheets * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/1000 Sheets":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = (Pub_Sheets * (Rate / 1000)) + Setup_Charges;
                        break;
                    }

                case "Rate/1000 Sheets Both Side":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = ((Pub_Sheets * (Rate / 1000)) * 2) + Setup_Charges;
                        break;
                    }

                case "Rate/Ups":
                    {
                        Amount = (Total_Ups * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Ups/Sheet":
                    {
                        Amount = (Total_Ups * Pub_Sheets * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Page":
                    {
                        Amount = (Pages * Rate) + Setup_Charges; // Amount = Pages * Rate
                        break;
                    }

                case "Rate/Job":
                    {
                        Amount = (1 * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Set":
                    {
                        Amount = (Sets * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Plate":
                    {
                        Amount = (Total_Plates * Rate) + Setup_Charges;
                        break;
                    }
                //case "Rate/Sq.Inch/Unit":
                //    {
                //        Amount = (Size_L * Size_W * Rate * Final_Quantity) + Setup_Charges;
                //        break;
                //    }

                case "Rate/Total Cuts/1000 Sheets":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = ((Gbl_UPS_L + Gbl_UPS_H) * (Rate / 1000) * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Set/1000 Sheets":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = (Sets * (Rate / 1000) * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Page/Unit":
                    {
                        Amount = (Pages * Final_Quantity * Rate) + Setup_Charges; // Amount = Pages * Rate
                        break;
                    }

                case "Rate/Set/Unit":
                    {
                        Amount = (Sets * Final_Quantity * Rate) + Setup_Charges;
                        break;
                    }

                case "Rate/Total Cuts/Sheet":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = ((Gbl_UPS_L + Gbl_UPS_H) * (Rate) * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Order Quantity":
                    {
                        Amount = (Gbl_Order_Quantity * Rate) + Setup_Charges; // Amount = Pages * Rate
                        break;
                    }

                case "Rate/1000 Order Quantity":
                    {
                        Amount = (Gbl_Order_Quantity * (Rate / 1000)) + Setup_Charges; // Amount = Pages * Rate
                        break;
                    }

                case "Rate/Page/Order Quantity":
                    {
                        Amount = (Pages * Gbl_Order_Quantity * Rate) + Setup_Charges; // Amount = Pages * Rate
                        break;
                    }

                case "Rate/Set/Order Quantity":
                    {
                        Amount = (Sets * Gbl_Order_Quantity * Rate) + Setup_Charges; // Amount = Pages * Rate
                        break;
                    }

                case "Rate/Inch/Unit":
                    {
                        Amount = ((Job_L / 25.4) * Rate * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Inch/Order Quantity":
                    {
                        Amount = ((Job_L / 25.4) * Rate * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Loop/Unit":
                    {
                        Amount = (Stitch * Rate * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Loop/Order Quantity":
                    {
                        Amount = (Stitch * Rate * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Color/1000 Sheets":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = (Total_Colors * (Rate / 1000) * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Color/1000 Sheets Both Side":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = ((Total_Colors * (Rate / 1000) * Pub_Sheets) * 2) + Setup_Charges;
                        break;
                    }

                case "Rate/Ups/1000 Sheets":
                    {
                        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                        Amount = (Total_Ups * Pub_Sheets * (Rate / 1000)) + Setup_Charges;
                        break;
                    }
                //case "Rate/Set/1000 Sheets":
                //    {
                //        Pub_Sheets = RoundUp(Pub_Sheets / 1000, 0) * 1000;
                //        Amount = (Total_Ups * Sets * Pub_Sheets * (Rate / 1000)) + Setup_Charges;
                //        break;
                //    }

                case "Rate/Sq.Inch/Set":
                    {
                        Amount = ((Size_L * Size_W) * Rate * Sets) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Order Quantity":
                    {
                        Amount = (Size_L * Size_W * Rate * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Color/Order Quantity":
                    {
                        Amount = (Total_Colors * Rate * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Color/1000 Order Quantity":
                    {
                        Amount = (Total_Colors * (Rate / 1000) * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Stitch/Unit":
                    {
                        Amount = (Stitch * Rate * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Stitch/Order Quantity":
                    {
                        Amount = (Stitch * Rate * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Color/Set":
                    {
                        Amount = (Rate * (Size_L * Size_W) * Gbl_Front_Color * Sets) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Color/Set/Order Quantity":
                    {
                        Amount = (Rate * (Size_L * Size_W) * Gbl_Front_Color * Sets * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Inch/Color/Set/Unit":
                    {
                        Amount = (Rate * (Size_L * Size_W) * Gbl_Front_Color * Sets * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Mtr/Sheet":
                    {
                        Amount = (Rate * (Size_L * Size_W) * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Meter":
                    {
                        Amount = (Rate * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Mtr/Unit":
                    {
                        Amount = (Rate * (Size_L * Size_W) * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Mtr/Order Quantity":
                    {
                        Amount = (Rate * (Size_L * Size_W) * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Fold/Form/Unit":
                    {
                        if (folds > 0)
                            Amount = (Rate * (folds * RoundUp(Sets / (double)2, 0)) * Final_Quantity) + Setup_Charges;
                        else
                            Amount = (Rate * (Math.Round((Total_Ups / (double)2)) * RoundUp(Sets / (double)2, 0)) * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Fold/Form/Order Quantity":
                    {
                        if (folds > 0)
                            Amount = (Rate * (folds * RoundUp(Sets / (double)2, 0)) * Gbl_Order_Quantity) + Setup_Charges;
                        else
                            Amount = (Rate * (Math.Round((Total_Ups / (double)2)) * RoundUp(Sets / (double)2, 0)) * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Fold/Unit":
                    {
                        if (folds > 0)
                            Amount = (Rate * folds * Final_Quantity) + Setup_Charges;
                        else
                            Amount = (Rate * Math.Round((Total_Ups / (double)2)) * Final_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Fold/Order Quantity":
                    {
                        if (folds > 0)
                            Amount = (Rate * folds * Gbl_Order_Quantity) + Setup_Charges;
                        else
                            Amount = (Rate * Math.Round((Total_Ups / (double)2)) * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/SqureCM(Height*Spine)/Order Quantity":
                    {
                        Spine = (((Gbl_Job_Pages * 1.24 * Gbl_Paper_GSM) / (double)2000) + 1);
                        Amount = (Rate * ((Job_H / 10) * (Spine / 10)) * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Meter":
                    {
                        Amount = (Rate * Pub_Sheets) + Setup_Charges;
                        break;
                    }
                //case "Rate/Meter":
                //    {
                //        Amount = (Rate * Pub_Sheets) + Setup_Charges;
                //        break;
                //    }

                case "Rate/Sq.Meter/Coverage Percentage":
                    {
                        Amount = (Rate * Pub_Sheets) + Setup_Charges;
                        break;
                    }

                case "Rate/Sq.Meter/GSM/Coverage Percentage":
                    {
                        Amount = (Rate * (Pub_Sheets * 3 / 1000)) + Setup_Charges;
                        break;
                    }

                case "Rate/Section/1000 Order Quantity":
                    {
                        // PagesPerSection = IIf(IsDBNull(dt.Rows(i)("PagesPerSection")), 1, dt.Rows(i)("PagesPerSection"))
                        Amount = (Math.Round(Gbl_Job_Pages / (double)PagesPerSection, 2) * (Rate / 1000) * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Form/Order Quantity":
                    {
                        Amount = (Rate * NoOfForms * Gbl_Order_Quantity) + Setup_Charges;
                        break;
                    }

                case "Rate/Zipper Running Meter":
                    {
                        Amount = (Rate * Pub_Sheets) + Setup_Charges;
                        break;
                    }
            }
            return Math.Round((Amount < Minimum_Charges) ? Minimum_Charges : Amount, 2);
        }


        //public double Calculate_Operations(string TypeOfCharges, double Rate, double Minimum_Charges, long Final_Quantity, double Setup_Charges, long Total_Paper_KG, long Total_Ups, long Sets, double Size_L, double Size_W, long Total_Colors, double Pub_Sheets, double Job_L, double Job_H, double Job_W, long Total_Plates, long Order_Quantity)
        //{
        //    double Amount = 0;
        //    long Pages;
        //    int Stitch = 1;
        //    int folds = 0;


        //    if (Gbl_Job_Leaves == 0)
        //    {
        //        if (Gbl_Job_Pages == 0)
        //        {
        //            Pages = 1;
        //        }
        //        else
        //        {
        //            Pages = Gbl_Job_Pages;
        //        }
        //    }
        //    else
        //    {
        //        Pages = Convert.ToInt64(Gbl_Job_Leaves) * 2;
        //    }

        //    if (Gbl_Order_Quantity == 0)
        //    {
        //        Gbl_Order_Quantity = Order_Quantity;
        //    }

        //    switch (Total_Ups)
        //    {
        //        case 4:
        //            folds = 2;
        //            break;
        //        case 8:
        //            folds = 3;
        //            break;
        //        case 16:
        //            folds = 4;
        //            break;
        //        case 32:
        //            folds = 5;
        //            break;
        //    }

        //    double RoundUp(double number, int decimals)
        //    {
        //        double multiplier = Math.Pow(10, decimals);
        //        return Math.Ceiling(number * multiplier) / multiplier;
        //    }

        //    switch (TypeOfCharges)
        //    {
        //        case "Rate/Kg":
        //            Amount = (Total_Paper_KG * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Color":
        //            Amount = (Total_Colors * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Inch/Color":
        //            Amount = (Total_Colors * Size_L * Size_W * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Inch/Unit":
        //            Amount = (Size_L * Size_W * Rate * Final_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Inch/Sheet":
        //            Amount = (Size_L * Size_W * Rate * Pub_Sheets) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Inch":
        //        case "Rate/Sq.Cm":
        //            Amount = (Size_L * Size_W * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Cm/Unit":
        //            Amount = (Size_L * Size_W * Rate * Final_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/100 Sq.Cm/Sheet":
        //            Amount = ((Size_L * Size_W) * Pub_Sheets * (Rate / 100)) + Setup_Charges;
        //            break;
        //        case "Rate/100 Sq.Cm/Sheet Both Side":
        //            Amount = ((Size_L * Size_W) * Pub_Sheets * (Rate / 100) * 2) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Cm/Sheet":
        //            Amount = (Size_L * Size_W * Rate * Pub_Sheets) + Setup_Charges;
        //            break;
        //        case "Rate/100 Sq.Inch/Sheet":
        //            Amount = ((Size_L * Size_W) * Pub_Sheets * (Rate / 100)) + Setup_Charges;
        //            break;
        //        case "Rate/100 Sq.Inch/Sheet Both Side":
        //            Amount = (((Size_L * Size_W) * Pub_Sheets * (Rate / 100)) * 2) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Inch/Sheet Both Side":
        //            Amount = ((Size_L * Size_W) * 2 * Rate * Pub_Sheets) + Setup_Charges;
        //            break;
        //        case "Rate/Unit":
        //            Amount = (Final_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Units":
        //            Amount = (RoundUp(Final_Quantity / 1000.0, 0) * 1000) * (Rate / 1000) + Setup_Charges;
        //            break;
        //        case "Rate/Sheet":
        //            Amount = (Pub_Sheets * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Sheets":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = (Pub_Sheets * (Rate / 1000)) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Sheets Both Side":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = ((Pub_Sheets * (Rate / 1000)) * 2) + Setup_Charges;
        //            break;
        //        case "Rate/Ups":
        //            Amount = (Total_Ups * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Ups/Sheet":
        //            Amount = (Total_Ups * Pub_Sheets * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Page":
        //            Amount = (Pages * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Job":
        //            Amount = Rate + Setup_Charges;
        //            break;
        //        case "Rate/Set":
        //            Amount = (Sets * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Plate":
        //            Amount = (Total_Plates * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Total Cuts/1000 Sheets":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = ((Convert.ToDouble(Gbl_UPS_L) + Convert.ToDouble(Gbl_UPS_H)) * (Rate / 1000) * Pub_Sheets) + Setup_Charges;
        //            break;
        //        case "Rate/Set/1000 Sheets":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = (Sets * (Rate / 1000) * Pub_Sheets) + Setup_Charges;
        //            break;
        //        case "Rate/Page/Unit":
        //            Amount = (Pages * Final_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Set/Unit":
        //            Amount = (Sets * Final_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Total Cuts/Sheet":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = ((Convert.ToDouble(Gbl_UPS_L) + Convert.ToDouble(Gbl_UPS_H)) * Rate * Pub_Sheets) + Setup_Charges;
        //            break;
        //        case "Rate/Order Quantity":
        //            Amount = (Gbl_Order_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Order Quantity":
        //            Amount = (Gbl_Order_Quantity * (Rate / 1000)) + Setup_Charges;
        //            break;
        //        case "Rate/Page/Order Quantity":
        //            Amount = (Pages * Gbl_Order_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Set/Order Quantity":
        //            Amount = (Sets * Gbl_Order_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Inch/Unit":
        //            Amount = ((Job_L / 25.4) * Rate * Final_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Inch/Order Quantity":
        //            Amount = ((Job_L / 25.4) * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Loop/Unit":
        //            Amount = (Stitch * Rate * Final_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Loop/Order Quantity":
        //            Amount = (Stitch * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Color/1000 Sheets":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = (Total_Colors * (Rate / 1000) * Pub_Sheets) + Setup_Charges;
        //            break;
        //        case "Rate/Color/1000 Sheets Both Side":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = ((Total_Colors * (Rate / 1000) * Pub_Sheets) * 2) + Setup_Charges;
        //            break;
        //        case "Rate/Ups/1000 Sheets":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = (Total_Ups * Pub_Sheets * (Rate / 1000)) + Setup_Charges;
        //            break;
        //        case "Rate/Loop/Set/Unit":
        //            Amount = (Stitch * Sets * Rate * Final_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Loop/Set/Order Quantity":
        //            Amount = (Stitch * Sets * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Job/1000 Units":
        //            Amount = (RoundUp(Final_Quantity / 1000.0, 0) * 1000) * (Rate / 1000) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Units/Order Quantity":
        //            Amount = (RoundUp(Gbl_Order_Quantity / 1000.0, 0) * 1000) * (Rate / 1000) + Setup_Charges;
        //            break;
        //        case "Rate/Unit/Order Quantity":
        //            Amount = (Final_Quantity * Gbl_Order_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Cm/Order Quantity":
        //            Amount = (Size_L * Size_W * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Sq.Inch/Order Quantity":
        //            Amount = (Size_L * Size_W * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Page/Order Quantity/Job":
        //            Amount = (Pages * Gbl_Order_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/Sheet/Order Quantity":
        //            Amount = (Pub_Sheets * Gbl_Order_Quantity * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Sheets/Order Quantity":
        //            Amount = (Pub_Sheets * Gbl_Order_Quantity * (Rate / 1000)) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Sheets Both Side/Order Quantity":
        //            Amount = ((Pub_Sheets * Gbl_Order_Quantity * (Rate / 1000)) * 2) + Setup_Charges;
        //            break;
        //        case "Rate/Ups/Order Quantity":
        //            Amount = (Total_Ups * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Ups/Sheet/Order Quantity":
        //            Amount = (Total_Ups * Pub_Sheets * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Plate/Order Quantity":
        //            Amount = (Total_Plates * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Page/Unit/Order Quantity":
        //            Amount = (Pages * Final_Quantity * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Set/Unit/Order Quantity":
        //            Amount = (Sets * Final_Quantity * Rate * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Inch/Unit/Order Quantity":
        //            Amount = ((Job_L / 25.4) * Rate * Final_Quantity * Gbl_Order_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Inch/Order Quantity/Unit":
        //            Amount = ((Job_L / 25.4) * Rate * Gbl_Order_Quantity * Final_Quantity) + Setup_Charges;
        //            break;
        //        case "Rate/Page/Sheet":
        //            Amount = (Pages * Pub_Sheets * Rate) + Setup_Charges;
        //            break;
        //        case "Rate/1000 Page/Sheet":
        //            Pub_Sheets = RoundUp(Pub_Sheets / 1000.0, 0) * 1000;
        //            Amount = (Pages * Pub_Sheets * (Rate / 1000)) + Setup_Charges;
        //            break;
        //        default:
        //            Amount = Setup_Charges;
        //            break;
        //    }

        //    if (Amount < Minimum_Charges)
        //    {
        //        Amount = Minimum_Charges;
        //    }

        //    return Amount;
        //}

        public double Amount_Calculation(object Cal_Amt_Oper)
        {
            string errMsg = "";
            DataTable dt = new DataTable();
            DataTable dT_Search_In_Machine = new DataTable();
            DBConnection.ConvertObjectToDatatable(Cal_Amt_Oper, ref dt, ref errMsg);

            bool Is_Perfecta_Machine = false;
            bool IsSpecialMachine = false;
            double Amount = 0;
            long Minimum_Sheets = 0, Roundof_Impressions_With = 0;
            string Printing_Charges_Type = "";
            double Basic_Printing_Charges = 0;

            try
            {
                if (Convert.ToInt32(dt.Rows[0][0] == DBNull.Value ? 0 : dt.Rows[0][0]) == 0) // Plate Rate
                {
                    Amount = Convert.ToDouble(dt.Rows[0][1]) * Convert.ToDouble(dt.Rows[0][2]);
                }
                else if (Convert.ToInt32(dt.Rows[0][0] == DBNull.Value ? 0 : dt.Rows[0][0]) == 1) // Paper Rate
                {
                    string rateType = dt.Rows[0][1] == DBNull.Value ? "Sheet" : dt.Rows[0][1].ToString();
                    if (rateType == "Sheet")
                    {
                        Amount = Math.Round(Convert.ToDouble(dt.Rows[0][2]) * Convert.ToDouble(dt.Rows[0][3]), 2);
                    }
                    else
                    {
                        Amount = Math.Round(Convert.ToDouble(dt.Rows[0][4]) * Convert.ToDouble(dt.Rows[0][3]), 2);
                    }
                }
                else if (Convert.ToInt32(dt.Rows[0][0] == DBNull.Value ? 0 : dt.Rows[0][0]) == 2) // Printing Amount
                {
                    Gbl_Orientation = dt.Rows[0][8] == DBNull.Value ? "" : dt.Rows[0][8].ToString();

                    Gbl_Machine_ID = Convert.ToInt32(dt.Rows[0][1] == DBNull.Value ? 0 : dt.Rows[0][1]);
                    if (Gbl_Machine_ID != 0)
                    {
                        MachineIDFilter = " And MachineID In (" + Gbl_Machine_ID + ")";
                    }

                    k = "Search_In_Machine_Selection";
                    dT_Search_In_Machine = GetDataTable();

                    long MachineColors = 0;
                    GblMainPaperGroup = dt.Rows[0][9] == DBNull.Value ? "" : dt.Rows[0][9].ToString();

                    double abhi = 0;
                    long abhiL = 0;
                    string abhistr = "";

                    if (Search_In_Machine(Gbl_Machine_ID, ref Minimum_Sheets, ref abhiL, ref abhi, ref MachineColors, ref Printing_Charges_Type, ref Roundof_Impressions_With, ref Basic_Printing_Charges, ref abhiL, ref abhiL, ref abhiL, ref abhistr, ref abhistr, dT_Search_In_Machine, ref Is_Perfecta_Machine, ref IsSpecialMachine))
                    {
                        k = "Printing_Slabs";
                        DT_Printing_Slabs = GetDataTable();

                        for (int i = 0; i < DT_Printing_Slabs.Rows.Count; i++)
                        {
                            DT_Printing_Slabs.Rows[i]["Rate"] = dt.Rows[0][3];
                        }

                        string orientation = Gbl_Orientation;
                        if (orientation == "Books" || orientation == "BookPages" || orientation == "WiroLeaves" || orientation == "WiroBookPages" || orientation == "Calendar")
                        {
                            double a = Convert.ToDouble(dt.Rows[0][3]);
                            Amount = Calculate_Book_Printing_Charges(Convert.ToInt64(dt.Rows[0][2]), Minimum_Sheets, ref a, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, Convert.ToInt32(dt.Rows[0][4]), Convert.ToInt32(dt.Rows[0][5]), (long)dt.Rows[0][6], dt.Rows[0][7].ToString(), Is_Perfecta_Machine, Gbl_Machine_ID);
                            dt.Rows[0][3] = a;
                        }
                        else
                        {
                            double a = Convert.ToDouble(dt.Rows[0][3]);
                            Amount = Calculate_Printing_Charges(Convert.ToInt64(dt.Rows[0][2]), Minimum_Sheets, ref a, Printing_Charges_Type, Basic_Printing_Charges, Roundof_Impressions_With, Convert.ToInt32(dt.Rows[0][4]), Convert.ToInt32(dt.Rows[0][5]), (long)dt.Rows[0][6], dt.Rows[0][7].ToString(), Is_Perfecta_Machine, Gbl_Machine_ID, MachineColors);
                        }
                    }
                    else
                    {
                        Amount = 0;
                    }
                }
                else if (Convert.ToInt32(dt.Rows[0][0] == DBNull.Value ? 0 : dt.Rows[0][0]) == 3) // calculate special colors
                {
                    Gbl_Machine_ID = Convert.ToInt32(dt.Rows[0][5] == DBNull.Value ? 0 : dt.Rows[0][5]);
                    if (Gbl_Machine_ID != 0)
                        MachineIDFilter = " And MachineID In (" + Gbl_Machine_ID + ")";

                    k = "Search_In_Machine_Selection";
                    dT_Search_In_Machine = GetDataTable();
                    double abhi = 0;
                    long abhiL = 0;
                    string abhistr = "";
                    if (Search_In_Machine(Gbl_Machine_ID, ref Minimum_Sheets, ref abhiL, ref abhi, ref abhiL, ref Printing_Charges_Type, ref Roundof_Impressions_With, ref Basic_Printing_Charges, ref abhiL, ref abhiL, ref abhiL, ref abhistr, ref abhistr, dT_Search_In_Machine, ref Is_Perfecta_Machine, ref IsSpecialMachine))
                    {
                        Amount = Calculate_Special_Color_Charges((int)(dt.Rows[0][1]), Convert.ToDouble(dt.Rows[0][2]), Convert.ToDouble(dt.Rows[0][3]), Printing_Charges_Type, Roundof_Impressions_With, (long)dt.Rows[0][4]);
                    }
                }
                else if (Convert.ToInt32(dt.Rows[0][0] == DBNull.Value ? 0 : dt.Rows[0][0]) == 4) // Operation calculations
                {
                    Amount = 0;//Calculate_Operations(dt.Rows[0][1].ToString(),Convert.ToDouble(dt.Rows[0][2] == DBNull.Value ? 0 : dt.Rows[0][2]), Convert.ToDouble(dt.Rows[0][3] == DBNull.Value ? 0 : dt.Rows[0][3]),
                               //(long)(dt.Rows[0][4] == DBNull.Value ? 0 : dt.Rows[0][4]),
                               //(long)(dt.Rows[0][4] == DBNull.Value ? 0 : dt.Rows[0][4]),
                               //Convert.ToDouble(dt.Rows[0][5] == DBNull.Value ? 0 : dt.Rows[0][5]),
                               //(long)(dt.Rows[0][6] == DBNull.Value ? 0 : dt.Rows[0][6]),
                               //(long)(dt.Rows[0][7] == DBNull.Value ? 0 : dt.Rows[0][7]),
                               //(long)(dt.Rows[0][8] == DBNull.Value ? 0 : dt.Rows[0][8]),
                               //Convert.ToDouble(dt.Rows[0][9] == DBNull.Value ? 0 : dt.Rows[0][9]),
                               //Convert.ToDouble(dt.Rows[0][10] == DBNull.Value ? 0 : dt.Rows[0][10]),
                               //(long)(dt.Rows[0][11] == DBNull.Value ? 0 : dt.Rows[0][11]),
                               //Convert.ToDouble(dt.Rows[0][12] == DBNull.Value ? 0 : dt.Rows[0][12]),
                               //Convert.ToDouble(dt.Rows[0][13] == DBNull.Value ? 0 : dt.Rows[0][13]),
                               //Convert.ToDouble(dt.Rows[0][14] == DBNull.Value ? 0 : dt.Rows[0][14]),
                               //Convert.ToDouble(dt.Rows[0][15] == DBNull.Value ? 0 : dt.Rows[0][15]),
                               //(long)(dt.Rows[0][16] == DBNull.Value ? 0 : dt.Rows[0][16]),
                               //(long)(dt.Rows[0][17] == DBNull.Value ? 0 : dt.Rows[0][17]),
                               //Convert.ToInt32(Gbl_DT_Operation.Rows[0]["PagesPerSection"] == DBNull.Value ? 1 : Gbl_DT_Operation.Rows[0]["PagesPerSection"]),
                               //Convert.ToInt32(Gbl_DT_Operation.Rows[0]["NoOfForms"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[0]["NoOfForms"]));
                }
                else if (Convert.ToInt32(dt.Rows[0][0] == DBNull.Value ? 0 : dt.Rows[0][0]) == 5) // Coating
                {
                    Gbl_Machine_ID = Convert.ToInt32(dt.Rows[0][1] == DBNull.Value ? 0 : dt.Rows[0][1]);
                    if (Gbl_Machine_ID != 0)
                        MachineIDFilter = " And MachineID In (" + Gbl_Machine_ID + ")";

                    GblOnlineCoating = dt.Rows[0][6]?.ToString() ?? "0";
                    k = "Machine_Online_Coating_Rates";
                    GblDTMachineCoatingRates = GetDataTable();
                    Coating_Charges = Convert.ToDouble(dt.Rows[0][3] == DBNull.Value ? 0 : dt.Rows[0][3]);

                    if (!(GblOnlineCoating == "None" || GblOnlineCoating == "No" || GblOnlineCoating == "null"))
                    {
                        if (!Search_In_Machine_Online_Coating(Gbl_Machine_ID, GblDTMachineCoatingRates, ref Coating_Charges, ref Printing_Charges_Type, Convert.ToDouble(dt.Rows[0][2] == DBNull.Value ? 0 : dt.Rows[0][2]), ref Basic_Printing_Charges))
                        {

                        }
                        else
                        {
                            Amount = Calculate_Coating_Charges(
                                (long)(dt.Rows[0][2] == DBNull.Value ? 0 : dt.Rows[0][2]),
                                Convert.ToDouble(dt.Rows[0][3] == DBNull.Value ? 0 : dt.Rows[0][3]),
                                Printing_Charges_Type,
                                Convert.ToDouble(dt.Rows[0][4] == DBNull.Value ? 0 : dt.Rows[0][4]),
                                Convert.ToDouble(dt.Rows[0][5] == DBNull.Value ? 0 : dt.Rows[0][5]),
                                Basic_Printing_Charges);
                        }
                    }
                }



            }
            catch (Exception ex)
            {
                // Handle exception
            }
            return Amount;
        }


        public double Calculate_Coating_Charges(long Pub_Sheets, double Coating_Charges, string Coating_Charges_Type, double Size_L, double Size_W, double BasicCoatingCharges)
        {
            double Amount = 0;

            if (Coating_Charges_Type == "Rate/Sq.Inch/Sheet")
                Amount = Math.Round((Size_L * Size_W * Coating_Charges * Pub_Sheets), 2);
            else if (Coating_Charges_Type == "Rate/Sq.Inch/Sheet Both Side")
                Amount = Math.Round((Size_L * Size_W * Coating_Charges * Pub_Sheets), 2) * 2;
            else if (Coating_Charges_Type == "Rate/100 Sq.Inch/Sheet")
                Amount = Math.Round(Size_L * Size_W * Pub_Sheets * (Coating_Charges / 100), 2);
            else if (Coating_Charges_Type == "Rate/100 Sq.Inch/Sheet Both Side")
                Amount = Math.Round(Size_L * Size_W * Pub_Sheets * (Coating_Charges / 100), 2) * 2;
            if (BasicCoatingCharges > Amount)
                Amount = BasicCoatingCharges;
            return Amount;
        }
        private object Calculate_Book_Forms(ref DataTable DT_Book, long Ups, long Quantity, long Pages, ref long No_Of_Set, ref long No_Of_Forms, ref long Actual_Sheets)
        {
            long Pages_Per_Form = 0;
            double Sets = 0;
            double Forms = 0;
            long Remaining_Pages;
            double F_B_Forms = 0;
            double F_B_Sets = 0;
            double F_B_Pages = 0;
            double F_B_Sheets = 0;
            double F_B_Impressions = 0;
            long W_TM_Remaining_Pages = 0;
            double W_TM_Sets = 0;
            int VK_Single_side = 0;

            try
            {

                // ''''''''''''''''''
                if (Gbl_Front_Color > 0 & Gbl_Back_Color > 0)
                    VK_Single_side = 2;
                else
                    VK_Single_side = 1;
                // ''''''''''''''''''
                // '''
                if (ChkBackToBackPastingRequired == true)
                    Pages = Pages * 2;
                {
                    var withBlock = DT_Book;
                    withBlock.Columns.Add("Forms", typeof(double));
                    withBlock.Columns.Add("Sets", typeof(double));
                    withBlock.Columns.Add("Pages", typeof(double));
                    withBlock.Columns.Add("Sheets", typeof(double));
                    withBlock.Columns.Add("ImpressionsPerSet", typeof(double));
                    withBlock.Columns.Add("FormsInPoint", typeof(double));
                    withBlock.Columns.Add("ImprsToChargedPerSet", typeof(double));
                    withBlock.Columns.Add("BasicRate", typeof(double));
                    withBlock.Columns.Add("SlabRate", typeof(double));
                    withBlock.Columns.Add("RateType", typeof(string));
                    withBlock.Columns.Add("Amount", typeof(long));
                    withBlock.Columns.Add("WastagePercentSheet", typeof(double));
                    withBlock.Columns.Add("PlateRate", typeof(double));
                    withBlock.Columns.Add("PlanID", typeof(long));

                    Pages_Per_Form = Ups * 2;
                    Sets = Pages / (double)Ups;
                    Forms = Pages / (double)Pages_Per_Form;
                    Forms_Wastage = (int)Forms; // ' By Vivek on 05-Nov-2024  - Using this variable as global for "Add_Book_Plan"

                    // ' Added By Vivek for web offset machine plate calculation problem 17-Apr-2024
                    if (Gbl_Plan_Type.Trim() == "Reel Planning")
                        Gbl_Printing_Style = "Front & Back";
                    // ''''''''''''''''''

                    MidpointRounding mode;
                    if (Gbl_Printing_Style == "Single Side")
                    {
                        F_B_Forms = (int)Math.Floor(Sets / 2.0);
                        F_B_Sets = F_B_Forms;
                        F_B_Pages = Math.Round(Pages_Per_Form * F_B_Forms, MidpointRounding.AwayFromZero);
                        F_B_Sheets = Quantity * F_B_Forms;
                        F_B_Impressions = F_B_Sheets;
                    }
                    else
                    {
                        F_B_Forms = RoundDown(Sets / 2);
                        F_B_Sets = F_B_Forms * 2;
                        F_B_Pages = Math.Round(Pages_Per_Form * F_B_Forms, MidpointRounding.AwayFromZero);
                        F_B_Sheets = Quantity * F_B_Forms;
                        F_B_Impressions = F_B_Sheets * 2;
                    }

                    var IMPS = F_B_Impressions / F_B_Sets;
                    if (F_B_Sets == 0)
                        IMPS = 0;

                    if (F_B_Forms > 0)
                    {
                        DataRow newRow = withBlock.NewRow();
                        newRow["F_B_Forms"] = F_B_Forms;
                        newRow["F_B_Sets"] = F_B_Sets;
                        newRow["F_B_Pages"] = F_B_Pages;
                        newRow["F_B_Sheets"] = F_B_Sheets;
                        newRow["IMPS"] = IMPS;
                        newRow["F_B_Forms"] = F_B_Forms;

                        withBlock.Rows.Add(newRow);
                        withBlock.Rows[withBlock.Rows.Count - 1]["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                    }


                    double fact;
                    bool flag4 = false;
                    if ((Ups == 4) | (Ups == 8) | (Ups == 16) | (Ups == 32) | (Ups == 64) | (Ups == 128) | (Ups == 256) & Gbl_Orientation == "BookPages")
                        flag4 = true;

                    Remaining_Pages = Convert.ToInt32(Pages - F_B_Pages);
                    W_TM_Sets = Remaining_Pages / (double)Ups;

                    if (Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble")
                        fact = RoundDown(Remaining_Pages / (double)Ups);
                    else
                        fact = 1;

                    // fact = 1

                    double Impperset = 0;
                    if (W_TM_Sets >= fact & fact != 0)
                    {
                        W_TM_Sets = W_TM_Sets - fact;
                        if (Gbl_Printing_Style == "Front & Back" & VK_Single_side == 2)
                            Impperset = 2;
                        else
                            Impperset = (int)Math.Ceiling(fact);

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact) * Impperset;
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2);
                        newRow[4] = Math.Ceiling((Quantity * fact) / 2) * Impperset;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        withBlock.Rows[withBlock.Rows.Count - 1]["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        Remaining_Pages = (int)Math.Ceiling(Remaining_Pages - (fact * Ups));
                    }



                    if (flag4 == true)
                        fact = 0.5;
                    else
                        fact = Remaining_Pages / (double)Ups;


                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) & fact != 0)
                    {
                        W_TM_Sets = W_TM_Sets - fact;

                        if (Gbl_Printing_Style == "Front & Back" & VK_Single_side == 2)
                            Impperset = 2;
                        else
                            Impperset = (int)Math.Ceiling(fact);

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact) * Impperset;
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2);
                        newRow[4] = Math.Ceiling((Quantity * fact) / 2) * Impperset;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        withBlock.Rows[withBlock.Rows.Count - 1]["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        Remaining_Pages -= Convert.ToInt32(fact * Ups);

                    }

                    // Fact = 0.25
                    if (flag4 == true)
                        fact = 0.25;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                            Impperset = Convert.ToInt32(Math.Ceiling((Quantity * fact) / 2.0));
                        else
                            Impperset = Convert.ToInt32(Math.Ceiling((Quantity * fact) / 2.0)) * 2;
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2.0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        withBlock.Rows[withBlock.Rows.Count - 1]["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        Remaining_Pages -= Convert.ToInt32(fact * Ups);
                    }

                    if (flag4 == true)
                        fact = 0.125;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;
                        if (Gbl_Printing_Style == "Single Side")
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0);
                        else
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0) * 2;

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2.0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        withBlock.Rows[withBlock.Rows.Count - 1]["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        Remaining_Pages = Convert.ToInt32(Math.Ceiling(Remaining_Pages - (fact * Ups)));
                    }


                    // Fact = 0.0625
                    if (flag4 == true)
                        fact = 0.0625;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;
                        if (Gbl_Printing_Style == "Single Side")
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0);
                        else
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0) * 2;
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2.0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        withBlock.Rows[withBlock.Rows.Count - 1]["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        fact = Math.Ceiling(Remaining_Pages / (double)Ups);
                    }


                    if (flag4 == true)
                        fact = 0.03125;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)  // Fixed '&' to '&&'
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0);
                        else
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0) * 2;

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2.0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;

                        withBlock.Rows.Add(newRow);
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;

                        fact = Math.Ceiling(Remaining_Pages / (double)Ups);
                    }

                    if (flag4 == true)
                        fact = 0.015625;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0);
                        else
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0) * 2;

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2.0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;

                        fact = Math.Ceiling(Remaining_Pages / (double)Ups);
                    }


                    if (flag4 == true)
                        fact = 0.0078125;
                    else
                        fact = RoundUp(Remaining_Pages / (double)Ups, 0);
                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0);
                        else
                            Impperset = Math.Ceiling((Quantity * fact) / 2.0) * 2;
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = Math.Ceiling(fact);
                        newRow[1] = Math.Ceiling(fact);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = Math.Ceiling((Quantity * fact) / 2.0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;

                        fact = Math.Ceiling(Remaining_Pages / (double)Ups);
                    }

                    int rw;
                    for (rw = 2; rw <= withBlock.Rows.Count - 1; rw++)
                    {
                        if (Gbl_Machine_Type == "Web Offset")
                        {
                            withBlock.Rows[rw][1] = Convert.ToDouble(withBlock.Rows[rw][1]) * 2;
                            withBlock.Rows[rw][4] = Convert.ToDouble(withBlock.Rows[rw][4]) / 2.0;
                        }
                    }

                    No_Of_Forms = DT_Book.Compute("SUM(Forms)", "") is DBNull ? 0 : Convert.ToInt32(DT_Book.Compute("SUM(Forms)", ""));
                    No_Of_Set = DT_Book.Compute("SUM(Sets)", "") is DBNull ? 0 : Convert.ToInt32(DT_Book.Compute("SUM(Sets)", ""));
                    Actual_Sheets = DT_Book.Compute("SUM(Sheets)", "") is DBNull ? 0 : Convert.ToInt32(DT_Book.Compute("SUM(Sheets)", ""));

                    withBlock.Rows[withBlock.Rows.Count - 1][8] = 785657567;
                }
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return planErrors;
            }
            return true;
        }

        private object Calculate_Book_FormsMJ(ref DataTable DT_Book, long Ups, long Quantity, long Pages, ref long No_Of_Set, ref long No_Of_Forms, ref long Actual_Sheets)
        {
            long Pages_Per_Form = 0;
            double Sets = 0;
            double Forms = 0;
            long Remaining_Pages;
            double F_B_Forms = 0;
            double F_B_Sets = 0;
            double F_B_Pages = 0;
            double F_B_Sheets = 0;
            double F_B_Impressions = 0;
            long W_TM_Remaining_Pages = 0;
            double W_TM_Sets = 0;
            int VK_Single_side = 0;
            string FormPlanType = "";
            try
            {

                // ''''''''''''''''''
                if (Gbl_Front_Color > 0 & Gbl_Back_Color > 0)
                    VK_Single_side = 2;
                else
                    VK_Single_side = 1;
                // ''''''''''''''''''
                // '''
                if (ChkBackToBackPastingRequired == true)
                    Pages = Pages * 2;
                {
                    var withBlock = DT_Book;
                    withBlock.Columns.Add("Forms", typeof(double));
                    withBlock.Columns.Add("Sets", typeof(double));
                    withBlock.Columns.Add("Pages", typeof(double));
                    withBlock.Columns.Add("Sheets", typeof(double));
                    withBlock.Columns.Add("ImpressionsPerSet", typeof(double));
                    withBlock.Columns.Add("FormsInPoint", typeof(double));
                    withBlock.Columns.Add("ImprsToChargedPerSet", typeof(double));
                    withBlock.Columns.Add("BasicRate", typeof(double));
                    withBlock.Columns.Add("SlabRate", typeof(double));
                    withBlock.Columns.Add("RateType", typeof(string));
                    withBlock.Columns.Add("Amount", typeof(long));
                    withBlock.Columns.Add("WastagePercentSheet", typeof(double));
                    withBlock.Columns.Add("PlateRate", typeof(double));
                    withBlock.Columns.Add("PlanID", typeof(long));
                    withBlock.Columns.Add("FormPlanType", typeof(string));

                    Pages_Per_Form = Ups * 2;
                    Sets = Pages / (double)Ups;
                    Forms = Pages / (double)Pages_Per_Form;
                    Forms_Wastage = (int)Forms; // ' By Vivek on 05-Nov-2024  - Using this variable as global for "Add_Book_Plan"

                    // ' Added By Vivek for web offset machine plate calculation problem 17-Apr-2024
                    if (Gbl_Plan_Type.Trim() == "Reel Planning")
                        Gbl_Printing_Style = "Front & Back";
                    // ''''''''''''''''''

                    MidpointRounding mode;
                    if (Gbl_Printing_Style == "Single Side")
                    {
                        F_B_Forms = RoundDown(Sets / 2);
                        F_B_Sets = F_B_Forms;
                        F_B_Pages = Math.Round(Pages_Per_Form * F_B_Forms, MidpointRounding.AwayFromZero);
                        F_B_Sheets = Quantity * F_B_Forms;
                        F_B_Impressions = F_B_Sheets;
                        FormPlanType = "Single Side";
                    }
                    else if (Gbl_Required_Printing_Style != "Work & Turn" & Gbl_Required_Printing_Style != "Work & Tumble")
                    {
                        F_B_Forms = RoundDown(Sets / 2);
                        F_B_Sets = F_B_Forms * 2;
                        F_B_Pages = Math.Round(Pages_Per_Form * F_B_Forms, MidpointRounding.AwayFromZero);
                        F_B_Sheets = Quantity * F_B_Forms;
                        F_B_Impressions = F_B_Sheets * 2;
                        FormPlanType = "Front & Back";
                    }
                    double IMPS = 0;
                    if (F_B_Sets == 0)
                        IMPS = 0;
                    else
                        IMPS = F_B_Impressions / F_B_Sets;
                    // Dim IMPS = F_B_Impressions / F_B_Sets
                    if (F_B_Sets == 0)
                        IMPS = 0;

                    if (F_B_Forms > 0)
                    {
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = F_B_Forms;
                        newRow[1] = F_B_Sets;
                        newRow[2] = F_B_Pages;
                        newRow[3] = F_B_Sheets;
                        newRow[4] = IMPS;
                        newRow[5] = F_B_Forms;

                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;
                        withBlock.Rows.Add(newRow);
                    }


                    double fact = 0;
                    bool flag4 = false;
                    if ((Ups == 4) | (Ups == 8) | (Ups == 16) | (Ups == 32) | (Ups == 64) | (Ups == 128) | (Ups == 256) & Gbl_Orientation == "BookPages")
                        flag4 = true;

                    Remaining_Pages = Convert.ToInt32(Pages - F_B_Pages);
                    W_TM_Sets = Remaining_Pages / (double)Ups;

                    if (Gbl_Printing_Style == "Work & Turn" | Gbl_Printing_Style == "Work & Tumble")
                        fact = RoundDown(Remaining_Pages / (double)Ups);
                    else
                        fact = 1;

                    // fact = 1

                    double Impperset;
                    int WT_Fact = 0;
                    if (W_TM_Sets >= fact & fact != 0)
                    {
                        W_TM_Sets = W_TM_Sets - fact;

                        if (Gbl_Required_Printing_Style == "Work & Turn" | Gbl_Required_Printing_Style == "Work & Tumble")
                            Impperset = 1;
                        else
                            Impperset = Math.Ceiling(fact);
                        if (F_B_Forms > 0)
                        {
                            if (Gbl_Printing_Style == "Single Side")
                                FormPlanType = "Single Side";
                            else
                                FormPlanType = "Work & Turn";
                        }
                        else
                            FormPlanType = Gbl_Required_Printing_Style;

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = RoundUp(fact, 0);
                        newRow[1] = RoundUp(fact, 0) * Impperset;
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow[4] = RoundUp(((RoundUp((Quantity * fact) / 2, 0) * VK_Single_side)) / (RoundUp(fact, 0) * Impperset), 0);
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;

                        Remaining_Pages = (Int32)Math.Ceiling(Remaining_Pages - (fact * Ups));
                    }

                    if (flag4 == true)
                        fact = 0.5;
                    else
                        fact = Remaining_Pages / (double)Ups;


                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) & fact != 0)
                    {
                        W_TM_Sets = W_TM_Sets - fact;

                        if (Gbl_Printing_Style == "Front & Back" & VK_Single_side == 2)
                            Impperset = 2;
                        else if (Gbl_Required_Printing_Style == "Work & Turn" | Gbl_Required_Printing_Style == "Work & Tumble")
                            Impperset = 1;
                        else
                            Impperset = RoundUp(fact, 0);
                        if (F_B_Forms > 0)
                        {
                            if (Gbl_Printing_Style == "Single Side")
                                FormPlanType = "Single Side";
                            else
                            {
                                if (Gbl_Plan_Type.Trim() == "Reel Planning") // written by Vivek
                                {
                                    FormPlanType = "Front & Back"; // written by Vivek
                                }
                                else // written by Vivek
                                {
                                    FormPlanType = "Work & Turn"; // This was earlier
                                }
                            }
                        }
                        else
                            FormPlanType = Gbl_Required_Printing_Style;

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = RoundUp(fact, 0);
                        newRow[1] = RoundUp(fact, 0) * Impperset;
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow[4] = RoundUp((Quantity * fact) / 2, 0) * VK_Single_side;
                        newRow[5] = fact;
                        withBlock.Rows.Add(newRow);
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;
                        Remaining_Pages -= (Int32)(fact * Ups);
                    }

                    // Fact = 0.25
                    if (flag4 == true)
                        fact = 0.25;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;
                        if (Gbl_Printing_Style == "Single Side")
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0));
                            FormPlanType = "Single Side";
                        }
                        else
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0)) * 2;
                            FormPlanType = (F_B_Forms > 0) ? "Work & Turn" : Gbl_Required_Printing_Style;
                        }
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = RoundUp(fact, 0);
                        newRow[1] = RoundUp(fact, 0);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;

                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;
                        withBlock.Rows.Add(newRow);
                        Remaining_Pages -= (Int32)(fact * Ups);
                    }

                    if (flag4 == true)
                        fact = 0.125;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0));
                            FormPlanType = "Single Side";
                        }
                        else
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0)) * 2;
                            FormPlanType = (F_B_Forms > 0) ? "Work & Turn" : Gbl_Required_Printing_Style;
                        }
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = RoundUp(fact, 0);
                        newRow[1] = RoundUp(fact, 0);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;
                        withBlock.Rows.Add(newRow);
                        Remaining_Pages = (Int32)Math.Ceiling(Remaining_Pages - (fact * Ups));
                    }


                    // Fact = 0.0625
                    if (flag4 == true)
                        fact = 0.0625;
                    else
                        fact = Remaining_Pages / (double)Ups;
                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0));
                            FormPlanType = "Single Side";
                        }
                        else
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0)) * 2;
                            FormPlanType = (F_B_Forms > 0) ? "Work & Turn" : Gbl_Required_Printing_Style;
                        }

                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = RoundUp(fact, 0);
                        newRow[1] = RoundUp(fact, 0);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;
                        withBlock.Rows.Add(newRow);
                        fact = RoundUp(Remaining_Pages / (double)Ups, 0);
                    }

                    if (flag4 == true)
                        fact = 0.03125;
                    else
                        fact = Remaining_Pages / (double)Ups;
                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0));
                            FormPlanType = "Single Side";
                        }
                        else
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0)) * 2;
                            FormPlanType = (F_B_Forms > 0) ? "Work & Turn" : Gbl_Required_Printing_Style;
                        }

                        DataRow newRow2 = withBlock.NewRow();
                        newRow2[0] = RoundUp(fact, 0);
                        newRow2[1] = RoundUp(fact, 0);
                        newRow2[2] = Math.Round(fact * Ups);
                        newRow2[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow2[4] = Impperset;
                        newRow2[5] = fact;
                        newRow2["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow2["FormPlanType"] = FormPlanType;

                        withBlock.Rows.Add(newRow2);
                        fact = RoundUp(Remaining_Pages / (double)Ups, 0);
                    }

                    if (flag4 == true)
                        fact = 0.015625;
                    else
                        fact = Remaining_Pages / (double)Ups;

                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;
                        if (Gbl_Printing_Style == "Single Side")
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0));
                            FormPlanType = "Single Side";
                        }
                        else
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0)) * 2;
                            FormPlanType = (F_B_Forms > 0) ? "Work & Turn" : Gbl_Required_Printing_Style;
                        }
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = RoundUp(fact, 0);
                        newRow[1] = RoundUp(fact, 0);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;

                        withBlock.Rows.Add(newRow);
                        fact = RoundUp(Remaining_Pages / (double)Ups, 0);
                    }


                    if (flag4 == true)
                        fact = 0.0078125;
                    else
                        fact = RoundUp(Remaining_Pages / (double)Ups, 0);
                    if (Math.Round(W_TM_Sets, 5) >= Math.Round(fact, 5) && fact != 0)
                    {
                        W_TM_Sets -= fact;

                        if (Gbl_Printing_Style == "Single Side")
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0));
                            FormPlanType = "Single Side";
                        }
                        else
                        {
                            Impperset = Convert.ToDouble(RoundUp((Quantity * fact) / 2, 0)) * 2;
                            FormPlanType = (F_B_Forms > 0) ? "Work & Turn" : Gbl_Required_Printing_Style;
                        }
                        DataRow newRow = withBlock.NewRow();
                        newRow[0] = RoundUp(fact, 0);
                        newRow[1] = RoundUp(fact, 0);
                        newRow[2] = Math.Round(fact * Ups);
                        newRow[3] = RoundUp((Quantity * fact) / 2, 0);
                        newRow[4] = Impperset;
                        newRow[5] = fact;
                        newRow["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        newRow["FormPlanType"] = FormPlanType;
                        withBlock.Rows.Add(newRow);
                        fact = RoundUp(Remaining_Pages / (double)Ups, 0);
                    }


                    int rw;
                    for (rw = 2; rw <= withBlock.Rows.Count - 1; rw++)
                    {
                        if (Gbl_Machine_Type == "Web Offset")
                        {
                            withBlock.Rows[rw][1] = Convert.ToDouble(withBlock.Rows[rw][1]) * 2;
                            withBlock.Rows[rw][4] = Convert.ToDouble(withBlock.Rows[rw][4]) / 2;
                        }
                    }

                    No_Of_Forms = DT_Book.Compute("SUM(Forms)", "") is DBNull ? 0 : Convert.ToInt32(DT_Book.Compute("SUM(Forms)", ""));
                    No_Of_Set = DT_Book.Compute("SUM(Sets)", "") is DBNull ? 0 : Convert.ToInt32(DT_Book.Compute("SUM(Sets)", ""));
                    Actual_Sheets = DT_Book.Compute("SUM(Sheets)", "") is DBNull ? 0 : Convert.ToInt32(DT_Book.Compute("SUM(Sheets)", ""));

                    withBlock.Rows[withBlock.Rows.Count - 1][8] = 785657567;
                }
            }
            catch (Exception ex)
            {
                planErrors = ex.Message;
                return planErrors;
            }
            return true;
        }

        public string ShipperPlanning(object ObjJSJson)
        {
            JavaScriptSerializer js = new JavaScriptSerializer();
            js.MaxJsonLength = 2147483647;
            DataTable TblSPlan = new DataTable();

            try
            {
                {
                    var withBlock = TblSPlan;
                    withBlock.Columns.Add("ShipperID", typeof(double));
                    withBlock.Columns.Add("ShipperName", typeof(string));
                    withBlock.Columns.Add("SizeL", typeof(double));
                    withBlock.Columns.Add("SizeW", typeof(double));
                    withBlock.Columns.Add("SizeH", typeof(double));
                    withBlock.Columns.Add("EmptyCartonWt", typeof(double));
                    withBlock.Columns.Add("Capacity", typeof(double));
                    withBlock.Columns.Add("QtyPerShipper", typeof(double));
                    withBlock.Columns.Add("TotalShipperQtyReq", typeof(double));
                    withBlock.Columns.Add("TotalWtOfAllShippers", typeof(double));
                    withBlock.Columns.Add("PackX", typeof(double));
                    withBlock.Columns.Add("PackY", typeof(double));
                    withBlock.Columns.Add("PackZ", typeof(double));
                    withBlock.Columns.Add("ShippingRate", typeof(double));
                    withBlock.Columns.Add("ShippingCost", typeof(double));
                    withBlock.Columns.Add("CBM", typeof(double));
                    withBlock.Columns.Add("CBF", typeof(double));
                    withBlock.Columns.Add("ShipperWeightPerPack", typeof(double));
                    withBlock.Columns.Add("ItemGroupName", typeof(string));
                    withBlock.Columns.Add("ItemGroupID", typeof(int));
                    withBlock.Columns.Add("ShipperRate", typeof(double));
                    withBlock.Columns.Add("ShipperCost", typeof(double));
                }

                CompanyID = Convert.ToInt64(HttpContext.Current.Session["CompanyID"]);
                DBType = DBConnection.DBType;
                DataTable DT = new DataTable(), DTShippers = new DataTable();
                string ShipperPlanType = "";
                double MinJobL = 0, MaxJobL = 0, MinJobW = 0, MinJobH = 0, MaxJob = 0, MaxJobW = 0, MaxJobH = 0;
                double Job_Pack_H, Job_Pack_W, Job_Pack_L, Per_Unit_Wt;
                double Paper_KG;
                double Expected_Qty_In_Box, Qty_In_A_Bundle, Total_Quantity;
                long ShipperID;
                string ShipperName;
                float Shipperlength;
                float ShipperWidth;
                float ShipperHeight;
                float ShipperRate;
                float ShipperWeight;
                float ShipperCapacityWeight;
                string errMsg = "";
                DBConnection.ConvertObjectToDatatable(ObjJSJson, ref DT, ref errMsg);
                Gbl_Job_H = Convert.ToDouble(DT.Rows[0][0]);
                Gbl_Job_L = Convert.ToDouble(DT.Rows[0][1]);
                Gbl_Job_W = Convert.ToDouble(DT.Rows[0][2]);
                Gbl_Job_Open_Flap = Convert.ToDouble(DT.Rows[0][3]);
                Gbl_Job_Bottom_Flap = Convert.ToDouble(DT.Rows[0][4]);
                Gbl_Job_Pages = Convert.ToInt32(DT.Rows[0][5]);
                Gbl_Job_Tongue_Height = Convert.ToDouble(DT.Rows[0][6]);
                Gbl_Job_Overlap_Flap = Convert.ToDouble(DT.Rows[0][7]);
                Gbl_Paper_GSM = Convert.IsDBNull(DT.Rows[0][8]) ? 0 : Convert.ToDouble(DT.Rows[0][8]);
                Gbl_Order_Quantity = Convert.ToInt32(DT.Rows[0][9]);
                Gbl_Orientation = DT.Rows[0][10].ToString().Trim();
                Paper_KG = Convert.ToDouble(DT.Rows[0][11]);
                Qty_In_A_Bundle = Convert.ToDouble(DT.Rows[0][12]);
                Expected_Qty_In_Box = Convert.ToDouble(DT.Rows[0][13]);
                Total_Quantity = Convert.ToDouble(DT.Rows[0][15]);
                ShipperPlanType = DT.Rows[0][21].ToString().Trim();

                Job_Pack_L = Convert.IsDBNull(DT.Rows[0][25]) ? 0 : Convert.ToDouble(DT.Rows[0][25]);
                Job_Pack_W = Convert.IsDBNull(DT.Rows[0][26]) ? 0 : Convert.ToDouble(DT.Rows[0][26]);
                Job_Pack_H = Convert.IsDBNull(DT.Rows[0][27]) ? 0 : Convert.ToDouble(DT.Rows[0][27]);
                Per_Unit_Wt = Convert.IsDBNull(DT.Rows[0][28]) ? 0 : Convert.ToDouble(DT.Rows[0][28]);



                // Sheet_Thichness = Val(DT.Rows(0)(25)) ' Math.Round((Gbl_Paper_GSM * 0.000631312), 3)

                // Select Case Gbl_Orientation
                // Case "Rectangular", "BookCover", "AccordionFold", "DoubleGateFold", "DoubleParallelFold", "GateFold", "FrenchFold", "HalfFold", "HalfThenTriFold", "RollFold", "TriFold", "ZFold"
                // Job_Pack_L = Gbl_Job_L
                // Job_Pack_W = Gbl_Job_H
                // Job_Pack_H = Sheet_Thichness
                // Per_Unit_Wt = Math.Round((Paper_KG * 1000) / Gbl_Order_Quantity, 3)
                // Case "BookPages", "WiroBookPages", "Calendar", "MultipleLeaves", "WiroLeaves", "WrintingPad", "PrePlannedSheet", "FourCornerBox", "RingFlap", "FourCornerHingedLid", "WebbedSelfLockingTray", "TurnOverEndTray", "BodyBeltOuter", "6CornerBox"
                // Job_Pack_L = Gbl_Job_L
                // Job_Pack_W = Gbl_Job_H
                // Job_Pack_H = Sheet_Thichness * Gbl_Job_Pages
                // Per_Unit_Wt = Math.Round((Paper_KG * 1000) / Gbl_Order_Quantity, 3)
                // Case "EnvCenterPasting", "EnvLPasting", "EnvSidePasting", "CatchCover", "ReverseTuckIn", "ReverseTuckAndTongue", "StandardStraightTuckIn", "UniversalCarton", "StandardStraightTuckInNested", "TuckToFrontOpenTop"
                // Job_Pack_L = Sheet_Thichness * 3
                // Job_Pack_W = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2)
                // Job_Pack_H = Gbl_Job_L + Gbl_Job_W
                // Per_Unit_Wt = Math.Round((Paper_KG * 1000) / Gbl_Order_Quantity, 3)
                // Case "CrashLockWithPasting", "CrashLockWithoutPasting", "UniversalOpenCrashLockWithPasting"
                // Job_Pack_L = Sheet_Thichness * 6
                // Job_Pack_W = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2)
                // Job_Pack_H = Gbl_Job_L + Gbl_Job_W
                // Per_Unit_Wt = Math.Round((Paper_KG * 1000) / Gbl_Order_Quantity, 3)
                // Case "CarryBag"
                // Job_Pack_L = Sheet_Thichness * 5
                // Job_Pack_W = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2)
                // Job_Pack_H = Gbl_Job_L + Gbl_Job_W
                // Per_Unit_Wt = Math.Round((Paper_KG * 1000) / Gbl_Order_Quantity, 3)
                // Case "OvelShape", "PolygonShape"
                // Job_Pack_L = Sheet_Thichness
                // Job_Pack_W = Gbl_Job_H + (Gbl_Job_W * 2) + (Gbl_Job_Open_Flap * 2)
                // Job_Pack_H = Gbl_Job_L + Gbl_Job_W
                // Per_Unit_Wt = Math.Round((Paper_KG * 1000) / Gbl_Order_Quantity, 3) 'In gm
                // End Select

                if (Per_Unit_Wt <= 0)
                    return "This will not work with this orientation";

                MinJobL = Math.Max(MinJobL, Job_Pack_L);
                MinJobW = Math.Max(MinJobW, Job_Pack_W);
                MinJobH = Math.Max(MinJobH, Job_Pack_H);


                if (ShipperPlanType.ToUpper() == "OLD")
                {
                    Job_Pack_H = Job_Pack_H + 5; // 5 MM Extra the partition thickness
                    Job_Pack_W = Job_Pack_W + 5; // 5 MM Extra the partition thickness
                    if (DBType == "MYSQL")
                        str = "SELECT Distinct IM.ItemID AS ShipperID,IM.ItemName As ShipperName, IFNULL(IMD.SizeL,0) As ShipperLength, IFNULL(IMD.SizeW,0) As ShipperWidth,IFNULL(IMD.SizeH,0) As ShipperHeight,IMD.EstimationRate As ShipperRate,IFNULL(IMD.EmptyCartonWt,0) As ShipperWeight,IFNULL(IMD.CapacityWeight,0) As CapacityWeight, IGM.ItemGroupName,IM.ItemGroupID,IFNULL(IMD.CBM,0) As CBM,IFNULL(IMD.CBF,0) As CBF " + " From ItemMaster AS IM INNER JOIN ItemGroupMaster AS IGM ON IGM.ItemGroupID=IM.ItemGroupID AND IGM.CompanyID=IM.CompanyID INNER JOIN (select IMD.ItemID,IMD.CompanyID,MAX(CASE WHEN IMD.FieldName='SizeL' THEN IMD.FieldValue END) AS 'SizeL',MAX(CASE WHEN IMD.FieldName='SizeW' THEN IMD.FieldValue END) AS 'SizeW',MAX(CASE WHEN IMD.FieldName='SizeH' THEN IMD.FieldValue END) AS 'SizeH',MAX(CASE WHEN IMD.FieldName='CBF' THEN IMD.FieldValue END) AS 'CBF',MAX(CASE WHEN IMD.FieldName='CBM' THEN IMD.FieldValue END) AS 'CBM',MAX(CASE WHEN IMD.FieldName='EmptyCartonWt' THEN IMD.FieldValue END) AS 'EmptyCartonWt',MAX(CASE WHEN IMD.FieldName='CapacityWeight' THEN IMD.FieldValue END) AS 'CapacityWeight',MAX(CASE WHEN IMD.FieldName='WtPerPacking' THEN IMD.FieldValue END) AS 'WtPerPacking',MAX(CASE WHEN IMD.FieldName='EstimationRate' THEN IMD.FieldValue END) AS 'EstimationRate',MAX(CASE WHEN IMD.FieldName='EstimationUnit' THEN IMD.FieldValue END) AS 'EstimationUnit' " + " From ItemMasterDetails AS IMD  INNER JOIN ItemGroupMaster AS IGM ON IGM.ItemGroupID=IMD.ItemGroupID AND IGM.CompanyID=IMD.CompanyID Where IMD.CompanyID=" + CompanyID + " AND IGM.ItemGroupID=7 And IFNULL(IGM.IsDeletedTransaction,0)<>1 And IFNULL(IMD.IsDeletedTransaction,0)<>1 Group BY IMD.ItemID,IMD.CompanyID) AS IMD on IMD.ItemID=IM.ItemID AND IMD.CompanyID=IM.CompanyID " + " Where IM.CompanyID=" + CompanyID + " AND IFNULL(IM.IsDeletedTransaction,0)<>1 ";
                    else
                        str = "SELECT Distinct ShipperID,ItemName As ShipperName,Isnull(SizeL,0) As ShipperLength, Isnull(SizeW,0) As ShipperWidth,Isnull(SizeH,0) As ShipperHeight,EstimationRate As ShipperRate, Isnull(EmptyCartonWt,0) As ShipperWeight,Isnull(CapacityWeight,0) As CapacityWeight, ItemGroupName,ItemGroupID,Isnull(CBM,0) As CBM,Isnull(CBF,0) As CBF From (Select Distinct [IMD].[ItemID] As ShipperID,ItemName,IMD.ItemGroupID,[IG].[ItemGroupName],IMD.CompanyID,IMD.UserID AS [UserID],Convert(CHAR(30),IMD.ModifiedDate, 106) AS [ModifiedDate],IMD.FYear,[FieldName],[FieldValue] From ItemMasterDetails As IMD Inner Join ItemMaster As IM On IM.ItemID=IMD.ItemID Inner Join ItemGroupMaster AS IG On IG.ItemGroupID=IMD.ItemGroupID And IMD.CompanyID=IG.CompanyID And IMD.ItemGroupID=7 And IMD.CompanyID=" + CompanyID + " And Isnull(IG.IsDeletedTransaction,0)<>1 And Isnull(IMD.IsDeletedTransaction,0)<>1 )x Unpivot (value for name in ([FieldValue])) up pivot (max(value) for FieldName In ([SizeH], [EmptyCartonWt], [CapacityWeight], [WtPerPacking], [EstimationRate],[SizeW], [SizeL], [CBF], [EstimationUnit],[CBM])) P ";
                }
                else
                    str = "SELECT 0 As ShipperID,'X' As ShipperName," + MaxJobL + " As ShipperLength, " + MaxJobW + " As ShipperWidth," + MaxJobH + " As ShipperHeight,10 As ShipperRate, 1 As ShipperWeight,20 As CapacityWeight,'SHIPPER CARTON' As ItemGroupName,7 As ItemGroupID";

                DBConnection.FillDataTable(ref DTShippers, str);

                {
                    var withBlock = DTShippers;
                    if (withBlock.Rows.Count > 0)
                    {
                        int rw;
                        for (rw = 0; rw <= withBlock.Rows.Count - 1; rw++)
                        {
                            ShipperID = Convert.ToInt32(withBlock.Rows[rw]["ShipperID"]);
                            ShipperName = withBlock.Rows[rw]["ShipperName"].ToString().Trim();
                            Shipperlength = Convert.ToInt32(withBlock.Rows[rw]["ShipperLength"]);
                            ShipperWidth = Convert.ToInt32(withBlock.Rows[rw]["ShipperWidth"]);
                            ShipperHeight = Convert.ToInt32(withBlock.Rows[rw]["ShipperHeight"]);
                            ShipperRate = (float)(withBlock.Rows[rw]["ShipperRate"]);
                            ShipperWeight = (float)(withBlock.Rows[rw]["ShipperWeight"]);
                            ShipperCapacityWeight = (float)(withBlock.Rows[rw]["CapacityWeight"]);

                            double Wi, He, Le;
                            long X, Y, Z, X_Inc;

                            X_Inc = Convert.ToInt64(Convert.ToDouble(Qty_In_A_Bundle) * Convert.ToDouble(Job_Pack_L));
                            He = Job_Pack_H;
                            Z = 1;

                            for (double H = Job_Pack_H; H <= 1000; H += Job_Pack_H)
                            {
                                Wi = Job_Pack_W;
                                Y = 1;

                                for (double W = Job_Pack_W; W <= 1000; W += Job_Pack_W)
                                {
                                    Le = X_Inc;
                                    X = Convert.ToInt64(Qty_In_A_Bundle);

                                    for (double L = X_Inc; L <= 1000; L += X_Inc)
                                    {
                                        double WT = (X * Per_Unit_Wt) * Y * Z;

                                        bool flagplan = false;
                                        if (ShipperPlanType.ToUpper() == "OLD")
                                        {
                                            flagplan = WT <= ShipperCapacityWeight;
                                        }
                                        else
                                        {
                                            Shipperlength = (float)Math.Round(Convert.ToDouble(L), 0) + 10;
                                            ShipperWidth = (float)Math.Round(Convert.ToDouble(W), 0) + 10;
                                            ShipperHeight = (float)Math.Round(Convert.ToDouble(H), 0) + 10;
                                            ShipperName = $"{Shipperlength}x{ShipperWidth}x{ShipperHeight}";
                                            ShipperRate = 1;
                                            flagplan = true;
                                        }

                                        if (flagplan)
                                        {
                                            long Qty_In_Shipper = X * Y * Z;
                                            double Filled_Shipper_Wt = ShipperWeight + Math.Round(WT / 1000, 2);
                                            long Total_Shipper_Qty_Req = Convert.ToInt32(RoundUp(Total_Quantity / Qty_In_Shipper, 0));
                                            double Total_Wt_of_All_Shippers = Filled_Shipper_Wt * Total_Shipper_Qty_Req;

                                            if (Qty_In_Shipper == Expected_Qty_In_Box)
                                            {
                                                TblSPlan.NewRow();
                                                TblSPlan.Rows.Add(
                                                    ShipperID, ShipperName,
                                                    Math.Round(Shipperlength, 0), Math.Round(ShipperWidth, 0), Math.Round(ShipperHeight, 0),
                                                    ShipperWeight, Math.Round(Filled_Shipper_Wt, 3),
                                                    Qty_In_Shipper, Total_Shipper_Qty_Req,
                                                    Math.Round(Total_Wt_of_All_Shippers, 3),
                                                    X, Y, Z,
                                                    ShipperRate, ShipperRate * Total_Shipper_Qty_Req,
                                                    Math.Round(((Shipperlength / 10.0) * (ShipperWidth / 10.0) * (ShipperHeight / 10.0)) / 1000000, 4),
                                                    Math.Round(((Shipperlength / 25.4) * (ShipperWidth / 25.4) * (ShipperHeight / 25.4)) / 1728, 4),
                                                    Math.Round(Per_Unit_Wt, 2),
                                                    withBlock.Rows[rw][8].ToString().Trim(),
                                                    Convert.ToDouble(withBlock.Rows[rw][9]),
                                                    ShipperRate, ShipperRate * Total_Shipper_Qty_Req
                                                );

                                                if (TblSPlan.Rows.Count > 15)
                                                {
                                                    break;
                                                }
                                            }
                                        }
                                        X += Convert.ToInt64(Qty_In_A_Bundle);
                                        Le += L;
                                    }

                                    Y += 1;
                                    Wi += W;
                                }

                                He += H;
                                Z += 1;
                            }

                        }
                    }
                }

            x:
                ;

                return DBConnection.ConvertDataTableToJsonString(TblSPlan);
            }
            catch (Exception ex)
            {
                return ex.Message;
            }
        }

        public string ContainerPlanning(object ObjJSJson)
        {
            DataTable TblSPlan = new DataTable(), DTContainers = new DataTable(), DTShpr = new DataTable();

            try
            {
                int CompanyID = Convert.ToInt16(HttpContext.Current.Session["CompanyID"]);

                TblSPlan.Columns.Add("ContainerID", typeof(double));
                TblSPlan.Columns.Add("ContainerName", typeof(string));
                TblSPlan.Columns.Add("LengthMM", typeof(double));
                TblSPlan.Columns.Add("WidthMM", typeof(double));
                TblSPlan.Columns.Add("HeightMM", typeof(double));
                TblSPlan.Columns.Add("LengthFT", typeof(double));
                TblSPlan.Columns.Add("WidthFT", typeof(double));
                TblSPlan.Columns.Add("HeightFT", typeof(double));
                TblSPlan.Columns.Add("CountL", typeof(double));
                TblSPlan.Columns.Add("CountW", typeof(double));
                TblSPlan.Columns.Add("CountH", typeof(double));
                TblSPlan.Columns.Add("TotalCarton", typeof(double));
                TblSPlan.Columns.Add("Direction", typeof(string));
                TblSPlan.Columns.Add("TotalWt", typeof(double));
                TblSPlan.Columns.Add("MaxWeight", typeof(double));
                TblSPlan.Columns.Add("TotalContainers", typeof(double));
                TblSPlan.Columns.Add("CBM", typeof(double));
                TblSPlan.Columns.Add("CBF", typeof(double));

                DBConnection.ConvertObjectToDatatable(ObjJSJson, ref DTShpr, ref str);
                str = "SELECT ContainerID, ContainerName, LengthMM, WidthMM, HeightMM, LengthFT, WidthFT, HeightFT, MaxWeight FROM ContainerMaster WHERE CompanyID=" + CompanyID;
                DBConnection.FillDataTable(ref DTContainers, str);

                int ContL, ContW, ContH;
                double totalWt, TtlContainers, TtlCarton;
                string Directions;

                for (int i = 0; i < DTContainers.Rows.Count; i++)
                {
                    ContH = (int)Math.Floor(DTContainers.Rows[i].Field<double>(4) / DTShpr.Rows[0].Field<double>(0));
                    Directions = "Cont.L-Box L";
                    ContL = (int)Math.Floor(DTContainers.Rows[i].Field<double>(2) / DTShpr.Rows[0].Field<double>(1));
                    ContW = (int)Math.Floor(DTContainers.Rows[i].Field<double>(3) / DTShpr.Rows[0].Field<double>(2));

                    totalWt = Math.Round(DTShpr.Rows[0].Field<double>(3) * ContL * ContH * ContW, 2);
                    if (totalWt <= DTContainers.Rows[i].Field<double>(8))
                    {
                        TtlCarton = ContL * ContW * ContH;
                        TtlContainers = (TtlCarton > 0) ? Convert.ToInt64(Math.Ceiling(DTShpr.Rows[0].Field<double>(4) / TtlCarton)) : 0;

                        TblSPlan.Rows.Add(
                            DTContainers.Rows[i].Field<double>(0), DTContainers.Rows[i].Field<string>(1),
                            DTContainers.Rows[i].Field<double>(2), DTContainers.Rows[i].Field<double>(3), DTContainers.Rows[i].Field<double>(4),
                            DTContainers.Rows[i].Field<double>(5), DTContainers.Rows[i].Field<double>(6), DTContainers.Rows[i].Field<double>(7),
                            ContL, ContW, ContH, TtlCarton, Directions, totalWt, DTContainers.Rows[i].Field<double>(8), TtlContainers,
                            Math.Round(DTShpr.Rows[0].Field<double>(5) * DTShpr.Rows[0].Field<double>(4), 2),
                            Math.Round(DTShpr.Rows[0].Field<double>(6) * DTShpr.Rows[0].Field<double>(4), 2)
                        );
                    }
                }
                return DBConnection.ConvertDataTableToJsonString(TblSPlan);
            }
            catch (Exception ex)
            {
                return JsonConvert.SerializeObject(new { Error = ex.Message });
            }
        }


        private bool Flexo_Label_Planning_Main(string Grain_Direction)
        {
            double Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i, j;
            double Min_Roll_Width, Max_Roll_Width, Min_Cylinder_Circumference_MM, Max_Cylinder_Circumference_MM;
            double Tool_Cylinder_Circumference_MM;
            double Machine_Max_Cut_Off, Machine_Min_Cut_Off;
            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H;
                Gbl_Rect_L = Gbl_Job_W;
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_W;
                Gbl_Rect_L = Gbl_Job_H;
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    if ((Gbl_DT_Machine.Rows[i][14] == DBNull.Value ? false : Convert.ToBoolean(Gbl_DT_Machine.Rows[i][14])) != true || (Convert.ToDouble(Gbl_DT_Machine.Rows[i][10]) < (Gbl_Front_Color + Gbl_Back_Color)) || (Gbl_Front_Color != Gbl_Back_Color))
                    {
                        goto NextMachine;
                    }
                }


                Gbl_Machine_Gripper = 0;
                Gbl_Machine_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1].ToString();
                M_Max_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3]);
                M_Min_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt32(Gbl_DT_Machine.Rows[i][5]);
                Max_Print_L = Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11].ToString();
                Min_Roll_Width = Convert.ToDouble(Gbl_DT_Machine.Rows[i][26]);
                Max_Roll_Width = Convert.ToDouble(Gbl_DT_Machine.Rows[i][27]);
                Gbl_Actual_Around_Gap = 0;

                if (Gbl_DT_Machine.Rows[i][11].ToString().ToUpper() == "FLEXO" || Gbl_DT_Machine.Rows[i][11].ToString().ToUpper() == "LETTERPRESS")
                {
                    Min_Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[i][28] is DBNull ? 0 : Gbl_DT_Machine.Rows[i][28]), 2);
                    Max_Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[i][29] is DBNull ? 0 : Gbl_DT_Machine.Rows[i][29]), 2);
                    Tool_Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[i][42] is DBNull ? 0 : Gbl_DT_Machine.Rows[i][42]), 2);

                    Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L + Gbl_Standard_AR_Gap);
                    Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H + Gbl_Standard_AC_Gap);

                    if (Tool_Cylinder_Circumference_MM >= Min_Cylinder_Circumference_MM &&
                        Tool_Cylinder_Circumference_MM <= Max_Cylinder_Circumference_MM)
                    {
                        if (Gbl_Label_L_With_Around <= Max_Cylinder_Circumference_MM)
                        {
                            if (Gbl_Label_H_With_Across <= Max_Roll_Width &&
                                Tool_Cylinder_Circumference_MM >= Gbl_Label_L_With_Around)
                            {
                                Gbl_UPS_L = Math.Floor(Tool_Cylinder_Circumference_MM / Gbl_Label_L_With_Around);

                                if (Gbl_Standard_AR_Gap == 0)
                                {
                                    Gbl_Around_Waste_Strip = Math.Round((Tool_Cylinder_Circumference_MM - (Gbl_UPS_L * Gbl_Rect_L)), 2);

                                    if (Gbl_Around_Waste_Strip > 1)
                                    {
                                        Gbl_Actual_Around_Gap = Math.Round((Tool_Cylinder_Circumference_MM - (Gbl_UPS_L * Gbl_Rect_L)) / Gbl_UPS_L, 2);
                                        Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L + Gbl_Actual_Around_Gap);
                                    }
                                }
                                else
                                {
                                    Gbl_Actual_Around_Gap = Math.Round((Tool_Cylinder_Circumference_MM - (Gbl_UPS_L * Gbl_Rect_L)) / Gbl_UPS_L, 2);
                                }
                                Plan_On_Roll(i, Gbl_Rect_H, Gbl_Rect_L);
                                if (Check_Plan_In_Special_Size)
                                {
                                    Plan_On_Cylinder(i, Gbl_Rect_H, Gbl_Rect_L);
                                }
                            }
                        }
                    }
                }

                else if (Gbl_DT_Machine.Rows[i][11].ToString().ToUpper() == "DRY WEB OFFSET" || Gbl_DT_Machine.Rows[i][11].ToString().ToUpper() == "DIGITAL")
                {
                    Machine_Max_Cut_Off = Convert.ToDouble(Gbl_DT_Machine.Rows[i][45] is DBNull ? 0 : Gbl_DT_Machine.Rows[i][45]);
                    Machine_Min_Cut_Off = Convert.ToDouble(Gbl_DT_Machine.Rows[i][44] is DBNull ? 0 : Gbl_DT_Machine.Rows[i][44]);

                    Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L + Gbl_Standard_AR_Gap);
                    Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H + Gbl_Standard_AC_Gap);

                    if (Gbl_Label_L_With_Around <= Machine_Max_Cut_Off)
                    {
                        if (Gbl_Label_H_With_Across <= Max_Roll_Width &&
                            Machine_Max_Cut_Off >= Gbl_Label_L_With_Around)
                        {
                            Gbl_UPS_L = Math.Floor(Machine_Max_Cut_Off / Gbl_Label_L_With_Around);  // Minesh Jain on 19-Jan-16

                            if (Gbl_UPS_L > 0)
                            {
                                for (j = (int)Gbl_UPS_L; j >= 1; j--)
                                {
                                    Gbl_Actual_Around_Gap = Gbl_Standard_AR_Gap;
                                    Plan_On_Roll(i, Gbl_Rect_H, Gbl_Rect_L);
                                    Gbl_UPS_L -= 1;
                                }
                            }
                        }
                    }
                }


            NextMachine:
                ;
            }
            return true;
        }

        private bool PrePlannedSheetFlexoLabelPlanning(string Grain_Direction)
        {
            double Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i, j;
            double Min_Roll_Width, Max_Roll_Width, Min_Cylinder_Circumference_MM, Max_Cylinder_Circumference_MM;
            double Tool_Cylinder_Circumference_MM;
            double Machine_Max_Cut_Off, Machine_Min_Cut_Off;
            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H;
                Gbl_Rect_L = Gbl_Job_L;
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_L;
                Gbl_Rect_L = Gbl_Job_H;
            }

            for (i = 0; i <= Gbl_DT_Machine.Rows.Count - 1; i++)
            {
                Gbl_Machine_Gripper = 0;
                Gbl_Machine_ID = Gbl_DT_Machine.Rows[i][0] is DBNull ? 0 : Convert.ToInt32(Gbl_DT_Machine.Rows[i][0]);
                Gbl_Machine_Name = Gbl_DT_Machine.Rows[i][1]?.ToString() ?? string.Empty;
                M_Max_L = Gbl_DT_Machine.Rows[i][2] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][2]);
                GblMachineMaxL = Convert.ToInt32(M_Max_L);
                GblMachineMaxW = Convert.ToInt32(Gbl_DT_Machine.Rows[i][3] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][3]));
                M_Min_L = Gbl_DT_Machine.Rows[i][4] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][4]);
                Gbl_M_Min_H = Convert.ToInt32(Gbl_DT_Machine.Rows[i][5] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][5]));
                Max_Print_L = Gbl_DT_Machine.Rows[i][6] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][6]);
                Max_Print_H = Gbl_DT_Machine.Rows[i][7] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][7]);
                Gbl_Machine_Type = Gbl_DT_Machine.Rows[i][11]?.ToString() ?? string.Empty;
                Min_Roll_Width = Gbl_DT_Machine.Rows[i][26] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][26]);
                Max_Roll_Width = Gbl_DT_Machine.Rows[i][27] is DBNull ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[i][27]);
                Gbl_Actual_Around_Gap = 0;

                if (Gbl_DT_Machine.Rows[i][11]?.ToString().ToUpper() == "FLEXO" || Gbl_DT_Machine.Rows[i][11]?.ToString().ToUpper() == "LETTERPRESS")
                {
                    Min_Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[i][28] ?? 0), 2);
                    Max_Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[i][29] ?? 0), 2);
                    Tool_Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[i][42] ?? 0), 2);

                    Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L);
                    Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H);

                    if (Tool_Cylinder_Circumference_MM >= Min_Cylinder_Circumference_MM &&
                        Tool_Cylinder_Circumference_MM <= Max_Cylinder_Circumference_MM)
                    {
                        if (Gbl_Label_L_With_Around <= Max_Cylinder_Circumference_MM &&
                            Gbl_Label_H_With_Across <= Max_Roll_Width &&
                            Tool_Cylinder_Circumference_MM >= Gbl_Label_L_With_Around)
                        {
                            Gbl_UPS_L = RoundDown(Gbl_Job_Around_Ups);

                            if (Gbl_Standard_AR_Gap == 0)
                            {
                                Gbl_Around_Waste_Strip = Math.Round(Tool_Cylinder_Circumference_MM - Gbl_Rect_L, 2);
                                if (Gbl_Around_Waste_Strip > 1)
                                {
                                    Gbl_Actual_Around_Gap = Math.Round((Tool_Cylinder_Circumference_MM - Gbl_Rect_L) / Gbl_UPS_L, 2);
                                    Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L);
                                }
                            }
                            else
                            {
                                Gbl_Actual_Around_Gap = Math.Round((Tool_Cylinder_Circumference_MM - Gbl_Rect_L) / Gbl_UPS_L, 2);
                            }

                            Plan_On_RollPreplanned(i, Gbl_Rect_H, Gbl_Rect_L);
                            if (Check_Plan_In_Special_Size)
                            {
                                Plan_On_Cylinder(i, Gbl_Rect_H, Gbl_Rect_L);
                            }
                        }
                    }
                }

                else if (Gbl_DT_Machine.Rows[i][11]?.ToString().ToUpper() == "DRY WEB OFFSET" || Gbl_DT_Machine.Rows[i][11]?.ToString().ToUpper() == "DIGITAL")
                {
                    Machine_Max_Cut_Off = Convert.ToDouble(Gbl_DT_Machine.Rows[i][45] ?? 0);
                    Machine_Min_Cut_Off = Convert.ToDouble(Gbl_DT_Machine.Rows[i][44] ?? 0);

                    Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L + Gbl_Standard_AR_Gap);
                    Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H + Gbl_Standard_AC_Gap);

                    if (Gbl_Label_L_With_Around <= Machine_Max_Cut_Off &&
                        Gbl_Label_H_With_Across <= Max_Roll_Width &&
                        Machine_Max_Cut_Off >= Gbl_Label_L_With_Around)
                    {
                        Gbl_UPS_L = RoundDown(Machine_Max_Cut_Off / Gbl_Label_L_With_Around);

                        if (Gbl_UPS_L > 0)
                        {
                            for (j = Convert.ToInt32(Gbl_UPS_L); j >= 1; j--)
                            {
                                Gbl_Actual_Around_Gap = Gbl_Standard_AR_Gap;
                                Plan_On_Roll(i, Gbl_Rect_H, Gbl_Rect_L);
                                Gbl_UPS_L--;
                            }
                        }
                    }
                }
            }
            return true;
        }

        private void Plan_On_Roto_Roll(int mi, double Gbl_Label_H, double Gbl_Label_W)
        {
            float Roll_Width;
            int p;
            for (p = 0; p < GblDTRoll.Rows.Count; p++)
            {
                double rollWidth = Convert.ToDouble(GblDTRoll.Rows[p][10] ?? 0) -
                                   ((Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2) + Gbl_Standard_AC_Gap);

                double rollWidthValue = Convert.ToDouble(GblDTRoll.Rows[p][10] ?? 0);
                double minWidth = Convert.ToDouble(Gbl_DT_Machine.Rows[mi][26] ?? 0);
                double maxWidth = Convert.ToDouble(Gbl_DT_Machine.Rows[mi][27] ?? 0);

                if (rollWidthValue >= minWidth && rollWidthValue <= maxWidth)
                {
                    if (Math.Floor(rollWidthValue / Gbl_Label_H_With_Across) == 1)
                    {
                        if (Gbl_Label_H <= (rollWidth + Gbl_Standard_AC_Gap))
                        {
                            Gbl_UPS_H = Math.Floor((rollWidth + Gbl_Standard_AC_Gap) / Gbl_Label_H);

                            Gbl_Side_Wastage_Strip = Math.Round((rollWidth + Gbl_Standard_AC_Gap) - (Gbl_UPS_H * Gbl_Label_H), 2);

                            Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                            Gbl_Paper_GSM = Convert.ToDouble(GblDTRoll.Rows[p][2] ?? 0);
                            Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();
                            Gbl_Paper_Thickness = Convert.ToDouble(GblDTRoll.Rows[p][5] ?? 0);

                            Gbl_Paper_Detail = " Quality= '" + Gbl_Paper_Quality + "' and Thickness=" + Gbl_Paper_Thickness + " and Width=" + rollWidthValue + " and Manufacturer='" + Gbl_Paper_Mill + "'";

                            Add_Roto_Gravure_Plan(mi, p, Gbl_Label_W, Gbl_Label_H);
                        }
                    }
                    else if (Gbl_Label_H_With_Across <= rollWidth)
                    {
                        Gbl_UPS_H = Math.Floor((rollWidth + Gbl_Standard_AC_Gap) / Gbl_Label_H_With_Across);

                        if (Gbl_UPS_H >= 1)
                        {
                            if ((rollWidth + Gbl_Standard_AC_Gap) >= (((Gbl_UPS_H + 1) * Gbl_Label_H) + Gbl_UPS_H * Gbl_Standard_AC_Gap))
                            {
                                Gbl_UPS_H += 1;
                            }
                        }
                        Gbl_Side_Wastage_Strip = Math.Round((rollWidth + Gbl_Standard_AC_Gap) - ((Gbl_UPS_H * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap), 2);

                        Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                        Gbl_Paper_GSM = Convert.ToDouble(GblDTRoll.Rows[p][2] ?? 0);
                        Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();
                        Gbl_Paper_Thickness = Convert.ToDouble(GblDTRoll.Rows[p][5] ?? 0);

                        Gbl_Paper_Detail = " Quality='" + Gbl_Paper_Quality + "' and Thickness=" + Gbl_Paper_Thickness + " and Width=" + rollWidthValue + " and Manufacturer = '" + Gbl_Paper_Mill + "' ";

                        Add_Roto_Gravure_Plan(mi, p, Gbl_Label_W, Gbl_Label_H);
                    }
                }
            }

            return;
        }

        private void Plan_On_Large_Format_Roll(int mi, double Gbl_Label_H, double Gbl_Label_L)
        {
            double Roll_Width;

            for (int p = 0; p < GblDTRoll.Rows.Count; p++)
            {
                double rollWidthValue = Convert.ToDouble(GblDTRoll.Rows[p][10] ?? 0);
                Roll_Width = rollWidthValue - ((Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2) + Gbl_Standard_AC_Gap);

                double minWidth = Convert.ToDouble(Gbl_DT_Machine.Rows[mi][26] ?? 0);
                double maxWidth = Convert.ToDouble(Gbl_DT_Machine.Rows[mi][27] ?? 0);

                if (rollWidthValue >= minWidth && rollWidthValue <= maxWidth)
                {
                    if (Math.Floor(rollWidthValue / Gbl_Label_H_With_Across) == 1)
                    {
                        if (Gbl_Label_H <= Roll_Width)
                        {
                            Gbl_UPS_H = Math.Floor((Roll_Width + Gbl_Standard_AC_Gap) / Gbl_Label_H);
                            Gbl_Side_Wastage_Strip = Math.Round((Roll_Width + Gbl_Standard_AC_Gap) - (Gbl_UPS_H * Gbl_Label_H), 2);

                            Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                            Gbl_Paper_GSM = Convert.ToDouble(GblDTRoll.Rows[p][2] ?? 0);
                            Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();
                            Gbl_Paper_Thickness = Convert.ToDouble(GblDTRoll.Rows[p][5] ?? 0);

                            Gbl_Paper_Detail = " Quality='" + Gbl_Paper_Quality + "' and Thickness=" + Gbl_Paper_Thickness + " and Width=" + rollWidthValue + " and Manufacturer= '" + Gbl_Paper_Mill + "'";

                            Add_Large_Format_Plan(mi, p, Gbl_Label_L, Gbl_Label_H);
                        }
                    }
                    else if (Gbl_Label_H_With_Across <= Roll_Width)
                    {
                        Gbl_UPS_H = Math.Floor((Roll_Width + Gbl_Standard_AC_Gap) / Gbl_Label_H_With_Across);

                        if (Gbl_UPS_H >= 1)
                        {
                            if ((Roll_Width + Gbl_Standard_AC_Gap) >= (((Gbl_UPS_H + 1) * Gbl_Label_H) + Gbl_UPS_H * Gbl_Standard_AC_Gap))
                            {
                                Gbl_UPS_H++;
                            }
                        }

                        Gbl_Side_Wastage_Strip = Math.Round((Roll_Width + Gbl_Standard_AC_Gap) - ((Gbl_UPS_H * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap), 2);

                        Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                        Gbl_Paper_GSM = Convert.ToDouble(GblDTRoll.Rows[p][2] ?? 0);
                        Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();
                        Gbl_Paper_Thickness = Convert.ToDouble(GblDTRoll.Rows[p][5] ?? 0);

                        Gbl_Paper_Detail = "Quality= '" + Gbl_Paper_Quality + "' and Thickness=" + Gbl_Paper_Thickness + " and Width=" + rollWidthValue + " and Manufacturer='" + Gbl_Paper_Mill + "'";

                        Add_Large_Format_Plan(mi, p, Gbl_Label_L, Gbl_Label_H);
                    }
                }
            }
        }

        private void Plan_On_Roll(int mi, double Gbl_Label_H, double Gbl_Label_W)
        {
            float Roll_Width;

            for (int p = 0; p < GblDTRoll.Rows.Count; p++)
            {
                Roll_Width = (float)(Convert.ToDouble(GblDTRoll.Rows[p][10]) - ((Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2)) - Gbl_Standard_AC_Gap);

                if (Convert.ToDouble(GblDTRoll.Rows[p][10]) >= Convert.ToDouble(Gbl_DT_Machine.Rows[mi][26]) && Convert.ToDouble(GblDTRoll.Rows[p][10]) <= Convert.ToDouble(Gbl_DT_Machine.Rows[mi][27]))
                {
                    if (Math.Floor(Convert.ToDouble(GblDTRoll.Rows[p][10]) / Gbl_Label_H_With_Across) == 1)
                    {
                        if (Gbl_Label_H <= (Roll_Width + Gbl_Standard_AC_Gap))
                        {
                            Gbl_UPS_H = (int)Math.Floor((Roll_Width + Gbl_Standard_AC_Gap) / Gbl_Label_H);

                            Gbl_Side_Wastage_Strip = Math.Round((Roll_Width + Gbl_Standard_AC_Gap) - (Gbl_UPS_H * Gbl_Label_H), 2);

                            Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                            Gbl_Paper_GSM = GblDTRoll.Rows[p][2] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][2]);
                            Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();

                            Gbl_Paper_Detail = "Quality='" + Gbl_Paper_Quality + "' and Face GSM='" + Gbl_Paper_GSM + "' " +
                                               "and Release GSM='" + (GblDTRoll.Rows[p][3] == DBNull.Value ? "" : GblDTRoll.Rows[p][3].ToString()) + "' " +
                                               "and Adhesive GSM='" + (GblDTRoll.Rows[p][4] == DBNull.Value ? "" : GblDTRoll.Rows[p][4].ToString()) + "' " +
                                               "and Width='" + (GblDTRoll.Rows[p][10] == DBNull.Value ? "" : GblDTRoll.Rows[p][10].ToString()) + "' " +
                                               "and Manufacturer='" + Gbl_Paper_Mill + "'";

                            Add_Flexo_Plan(mi, p, Gbl_Label_W, Gbl_Label_H);
                        }
                    }
                    else if (Gbl_Label_H_With_Across <= Roll_Width)
                    {
                        Gbl_UPS_H = (int)Math.Floor((Roll_Width + Gbl_Standard_AC_Gap) / Gbl_Label_H_With_Across);

                        if (Gbl_UPS_H >= 1)
                        {
                            if ((Roll_Width + Gbl_Standard_AC_Gap) >= (((Gbl_UPS_H + 1) * Gbl_Label_H) + Gbl_UPS_H * Gbl_Standard_AC_Gap))
                                Gbl_UPS_H += 1;
                        }

                        Gbl_Side_Wastage_Strip = Math.Round((Roll_Width + Gbl_Standard_AC_Gap) - ((Gbl_UPS_H * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap), 2);

                        Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                        Gbl_Paper_GSM = GblDTRoll.Rows[p][2] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][2]);
                        Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();

                        Gbl_Paper_Detail = "Quality='" + Gbl_Paper_Quality + "' and Face GSM= '" + Gbl_Paper_GSM + "' " +
                                           "and Release GSM='" + (GblDTRoll.Rows[p][3] == DBNull.Value ? "" : GblDTRoll.Rows[p][3].ToString()) + "' " +
                                           "and Adhesive GSM='" + (GblDTRoll.Rows[p][4] == DBNull.Value ? "" : GblDTRoll.Rows[p][4].ToString()) + "' " +
                                           "and Width='" + (GblDTRoll.Rows[p][10] == DBNull.Value ? "" : GblDTRoll.Rows[p][10].ToString()) + "' " +
                                           "and Manufacturer='" + Gbl_Paper_Mill + "'";

                        Add_Flexo_Plan(mi, p, Gbl_Label_W, Gbl_Label_H);
                    }
                }
            }
        }

        private void Plan_On_RollPreplanned(int mi, double Gbl_Label_H, double Gbl_Label_W)
        {
            float Roll_Width;

            for (int p = 0; p < GblDTRoll.Rows.Count; p++)
            {
                Roll_Width = Convert.ToSingle(Convert.ToDouble(GblDTRoll.Rows[p][10]) - ((Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2)) - Gbl_Standard_AC_Gap);

                if (Convert.ToDouble(GblDTRoll.Rows[p][10]) >= Convert.ToDouble(Gbl_DT_Machine.Rows[mi][26]) &&
                    Convert.ToDouble(GblDTRoll.Rows[p][10]) <= Convert.ToDouble(Gbl_DT_Machine.Rows[mi][27]))
                {
                    if (RoundDown(Convert.ToDouble(GblDTRoll.Rows[p][10]) / Gbl_Label_H_With_Across) == 1)
                    {
                        if (Gbl_Label_H <= (Roll_Width + Gbl_Standard_AC_Gap))
                        {
                            Gbl_UPS_H = RoundDown(Gbl_Job_Across_Ups);
                            Gbl_Side_Wastage_Strip = Math.Round((Roll_Width + Gbl_Standard_AC_Gap) - Gbl_Label_H, 2);

                            Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                            Gbl_Paper_GSM = Convert.ToDouble(GblDTRoll.Rows[p][2] == DBNull.Value ? "0" : GblDTRoll.Rows[p][2].ToString());
                            Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();

                            Gbl_Paper_Detail = "Quality='" + Gbl_Paper_Quality + "' and Face GSM= '" + Gbl_Paper_GSM + "' " +
                                               "and Release GSM='" + (GblDTRoll.Rows[p][3] == DBNull.Value ? "" : GblDTRoll.Rows[p][3].ToString()) + "' " +
                                               "and Adhesive GSM='" + (GblDTRoll.Rows[p][4] == DBNull.Value ? "" : GblDTRoll.Rows[p][4].ToString()) + "' " +
                                               "and Width='" + (GblDTRoll.Rows[p][10] == DBNull.Value ? "" : GblDTRoll.Rows[p][10].ToString()) + "' " +
                                               "and Manufacturer='" + Gbl_Paper_Mill + "'";

                            Add_Flexo_Plan(mi, p, Gbl_Label_W, Gbl_Label_H);
                        }
                    }
                    else if (Gbl_Label_H_With_Across <= Roll_Width)
                    {
                        Gbl_UPS_H = RoundDown(Gbl_Job_Across_Ups);
                        Gbl_Side_Wastage_Strip = Math.Round((Roll_Width + Gbl_Standard_AC_Gap) - Gbl_Label_H_With_Across, 2);

                        Gbl_Paper_Quality = GblDTRoll.Rows[p][1] == DBNull.Value ? "" : GblDTRoll.Rows[p][1].ToString();
                        Gbl_Paper_GSM = Convert.ToDouble(GblDTRoll.Rows[p][2] == DBNull.Value ? "0" : GblDTRoll.Rows[p][2].ToString());
                        Gbl_Paper_Mill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();

                        Gbl_Paper_Detail = "Quality='" + Gbl_Paper_Quality + "' and Face GSM= '" + Gbl_Paper_GSM + "' " +
                                           "and Release GSM='" + (GblDTRoll.Rows[p][3] == DBNull.Value ? "" : GblDTRoll.Rows[p][3].ToString()) + "' " +
                                           "and Adhesive GSM='" + (GblDTRoll.Rows[p][4] == DBNull.Value ? "" : GblDTRoll.Rows[p][4].ToString()) + "' " +
                                           "and Width='" + (GblDTRoll.Rows[p][10] == DBNull.Value ? "" : GblDTRoll.Rows[p][10].ToString()) + "' " +
                                           "and Manufacturer='" + Gbl_Paper_Mill + "'";

                        Add_Flexo_Plan(mi, p, Gbl_Label_W, Gbl_Label_H);
                    }
                }
            }
        }


        private void Plan_On_Cylinder(int m, double Gbl_Label_H, double Gbl_Label_W)
        {
            int upsW;
            double Machine_Min_Roll_Width, Machine_Max_Roll_Width;

            Machine_Max_Roll_Width = Convert.ToDouble(Gbl_DT_Machine.Rows[m][27]) - ((Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2));
            Machine_Min_Roll_Width = Convert.ToDouble(Gbl_DT_Machine.Rows[m][26]);

            if (Gbl_Label_H_With_Across <= Machine_Max_Roll_Width)
            {
                Gbl_UPS_H = RoundDown(Machine_Max_Roll_Width / Gbl_Label_H_With_Across);
                Machine_Max_Roll_Width = (Gbl_UPS_H * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap;
                Gbl_Side_Wastage_Strip = Math.Round(Machine_Max_Roll_Width - ((Gbl_UPS_H * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap), 2);
                upsW = (int)Gbl_UPS_H;

                for (int i = 1; i <= upsW; i++)
                {
                    if (((i * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap) >= Machine_Min_Roll_Width)
                    {
                        Gbl_Side_Wastage_Strip = 0;
                        Machine_Max_Roll_Width = (i * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap;
                        Machine_Max_Roll_Width += (Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2);

                        if (GblDTRoll.Rows.Count > 0)
                        {
                            DataRow row = GblDTRoll.Select("SizeW" + Machine_Max_Roll_Width).FirstOrDefault();
                            if (row == null)
                            {
                                Gbl_UPS_H = i;
                                Add_Flexo_Plan_Cyl(Machine_Max_Roll_Width, m, GblDTRoll.Rows.Count - 1, Gbl_Label_W, Gbl_Label_H);
                            }
                        }
                        else
                        {
                            Gbl_UPS_H = i;
                            Add_Flexo_Plan_Cyl(Machine_Max_Roll_Width, m, GblDTRoll.Rows.Count - 1, Gbl_Label_W, Gbl_Label_H);
                        }
                    }
                }
            }
        }


        private bool Roto_Label_Planning_Main(string Grain_Direction)
        {
            double Gbl_Rect_H = 0, Gbl_Rect_L = 0;
            double M_Max_L;
            double M_Min_L, Max_Print_L, Max_Print_H;
            int i, j;
            double Min_Roll_Width, Max_Roll_Width;
            double Machine_Max_Cut_Off, Machine_Min_Cut_Off;
            Gbl_Grain_Direction = Grain_Direction;
            if (Grain_Direction == "With Grain")
            {
                switch (Gbl_Orientation.ToUpper())
                {
                    case "CENTERSEALPOUCH":
                        Gbl_Rect_H = Gbl_Job_H + (Convert.ToDouble(Gbl_Job_Top_Seal) * 2);
                        Gbl_Rect_L = (Gbl_Job_W * 2) + (Convert.ToDouble(Gbl_Job_Center_Seal) * 2);
                        break;

                    case "STANDUPPOUCH":
                        Gbl_Rect_H = Gbl_Job_L + (Convert.ToDouble(Gbl_Job_Bottom_Gusset) * 2);
                        Gbl_Rect_L = (Gbl_Job_W * 2);
                        break;

                    case "FLATBOTTOMPOUCH":
                        Gbl_Rect_H = Gbl_Job_L;
                        Gbl_Rect_L = (Gbl_Job_W * 2) + (Convert.ToDouble(Gbl_Job_Pasting_Flap) * 2);
                        break;

                    case "FOURSIDESEALPOUCH":
                        Gbl_Rect_H = Gbl_Job_H + (Convert.ToDouble(Gbl_Job_Side_Seal) * 2);
                        Gbl_Rect_L = (Gbl_Job_W + (Convert.ToDouble(Gbl_Job_Side_Seal) * 2)) * 2;
                        break;

                    case "THREESIDESEALPOUCH":
                        // no action (intentionally blank as in VB code)
                        break;

                    case "PILLOWPOUCH":
                        Gbl_Rect_H = Gbl_Job_L;
                        Gbl_Rect_L = (Gbl_Job_W * 2) + (Convert.ToDouble(Gbl_Job_Pasting_Flap) * 2);
                        break;

                    case "SPOUTPOUCH":
                    case "ROTOLABEL":
                    case "OPENSIZEPOUCHWITHZIPPER":
                        Gbl_Rect_H = Gbl_Job_L;
                        Gbl_Rect_L = Gbl_Job_W;
                        break;
                }
            }
            else
            {
                switch (Gbl_Orientation.ToUpper())
                {
                    case "CENTERSEALPOUCH":
                        Gbl_Rect_H = (Gbl_Job_W * 2) + (Convert.ToDouble(Gbl_Job_Center_Seal) * 2);
                        Gbl_Rect_L = Gbl_Job_H + (Convert.ToDouble(Gbl_Job_Top_Seal) * 2);
                        break;

                    case "STANDUPPOUCH":
                        Gbl_Rect_H = (Gbl_Job_W * 2);
                        Gbl_Rect_L = Gbl_Job_L + (Convert.ToDouble(Gbl_Job_Bottom_Gusset) * 2);
                        break;

                    case "FLATBOTTOMPOUCH":
                        Gbl_Rect_H = (Gbl_Job_W * 2) + (Convert.ToDouble(Gbl_Job_Pasting_Flap) * 2);
                        Gbl_Rect_L = Gbl_Job_L;
                        break;

                    case "THREESIDESEALPOUCH":
                        Gbl_Rect_H = (Gbl_Job_W * 2);
                        Gbl_Rect_L = Gbl_Job_H + (Convert.ToDouble(Gbl_Job_Side_Seal) * 2);
                        break;

                    case "FOURSIDESEALPOUCH":
                        Gbl_Rect_H = (Gbl_Job_W + (Convert.ToDouble(Gbl_Job_Side_Seal) * 2)) * 2;
                        Gbl_Rect_L = Gbl_Job_H + (Convert.ToDouble(Gbl_Job_Side_Seal) * 2);
                        break;

                    case "PILLOWPOUCH":
                        Gbl_Rect_H = (Gbl_Job_W * 2) + (Convert.ToDouble(Gbl_Job_Pasting_Flap) * 2);
                        Gbl_Rect_L = Gbl_Job_L;
                        break;

                    case "SPOUTPOUCH":
                    case "ROTOLABEL":
                    case "OPENSIZEPOUCHWITHZIPPER":
                        Gbl_Rect_H = Gbl_Job_W;
                        Gbl_Rect_L = Gbl_Job_L;
                        break;
                }
            }

            for (i = 0; i < Gbl_DT_Machine.Rows.Count; i++)
            {
                DataRow machineRow = Gbl_DT_Machine.Rows[i];

                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = machineRow[14] != DBNull.Value && Convert.ToBoolean(machineRow[14]);
                    double machineColorCapacity = Convert.ToDouble(machineRow[10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                    {
                        continue;
                    }
                }
                Gbl_Machine_Gripper = 0;
                Gbl_Machine_ID = (Int16)machineRow[0];
                Gbl_Machine_Name = (string)machineRow[1];
                M_Max_L = Convert.ToDouble(machineRow[2]);
                GblMachineMaxW = (Int64)(machineRow[3]);
                M_Min_L = Convert.ToDouble(machineRow[4]);
                Gbl_M_Min_H = (Int64)(machineRow[5]);
                Max_Print_L = Convert.ToDouble(machineRow[6]);
                Max_Print_H = Convert.ToDouble(machineRow[7]);
                Gbl_Machine_Type = machineRow[11].ToString().ToUpper();
                Min_Roll_Width = Convert.ToDouble(machineRow[26]);
                Max_Roll_Width = Convert.ToDouble(machineRow[27]);

                if (Gbl_Machine_Type == "DRY WEB OFFSET" || Gbl_Machine_Type == "ROTO GRAVURE")
                {
                    double machineMaxCutOff = Convert.ToDouble(machineRow[29]);
                    double machineMinCutOff = Convert.ToDouble(machineRow[28]);
                    Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L + Gbl_Standard_AR_Gap);
                    Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H + Gbl_Standard_AC_Gap);
                    if (Gbl_Label_L_With_Around <= machineMaxCutOff)
                    {
                        if (Gbl_Label_H_With_Across <= Max_Roll_Width && machineMaxCutOff >= Gbl_Label_L_With_Around)
                        {
                            Gbl_UPS_L = (int)RoundDown(machineMaxCutOff / Gbl_Label_L_With_Around);

                            while (Gbl_UPS_L > 0)
                            {
                                if ((Gbl_Label_L_With_Around * Gbl_UPS_L) <= machineMaxCutOff)
                                {
                                    Gbl_Actual_Around_Gap = Gbl_Standard_AR_Gap;
                                    Plan_On_Roto_Roll(i, Gbl_Rect_H, Gbl_Rect_L);
                                }
                                Gbl_UPS_L--;
                            }
                        }
                    }
                }
            }

            return true;
        }

        private void Plan_On_Special_Size_Roll_Roto(int m, double Gbl_Label_H, double Gbl_Label_W)
        {
            int i;
            int upsW;
            double Machine_Min_Roll_Width, Machine_Max_Roll_Width;

            Machine_Max_Roll_Width = Convert.ToDouble(Gbl_DT_Machine.Rows[m][27]) - ((Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2)); // Reduce Color Strip from Roll Width
            Machine_Min_Roll_Width = Convert.ToDouble(Gbl_DT_Machine.Rows[m][26]);

            if (Gbl_Label_H_With_Across <= Machine_Max_Roll_Width)
            {
                Gbl_UPS_H = (int)Math.Floor(Machine_Max_Roll_Width / Gbl_Label_H_With_Across);

                Machine_Max_Roll_Width = ((Gbl_UPS_H * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap);

                Gbl_Side_Wastage_Strip = Math.Round(
                    Machine_Max_Roll_Width - ((Gbl_UPS_H * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap), 2);

                upsW = (Int16)Gbl_UPS_H;

                for (i = 1; i <= upsW; i++)
                {
                    if (((i * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap) >= Machine_Min_Roll_Width)
                    {
                        Gbl_Side_Wastage_Strip = 0;

                        Machine_Max_Roll_Width = ((i * Gbl_Label_H_With_Across) - Gbl_Standard_AC_Gap);
                        Machine_Max_Roll_Width += (Gbl_Plate_Bearer * 2) + (Gbl_ColorStrip * 2);

                        if (GblDTRoll.Rows.Count > 0)
                        {
                            // Look for matching SizeW
                            DataRow row = GblDTRoll.Select("SizeW=" + Machine_Max_Roll_Width).FirstOrDefault();

                            if (row == null)
                            {
                                Gbl_UPS_H = i;
                                Add_Roto_Gravure_Plan_Special_Size(Machine_Max_Roll_Width, m, GblDTRoll.Rows.Count - 1, Gbl_Label_W, Gbl_Label_H);
                            }
                        }
                        else
                        {
                            Gbl_UPS_H = i;
                            Add_Roto_Gravure_Plan_Special_Size(Machine_Max_Roll_Width, m, GblDTRoll.Rows.Count - 1, Gbl_Label_W, Gbl_Label_H);
                        }
                    }
                }
            }
        }


        private bool Large_Format_Planning_Main(string Grain_Direction)
        {
            double Gbl_Rect_H, Gbl_Rect_L;
            double M_Max_L, M_Min_L, Max_Print_L, Max_Print_H;
            double Min_Roll_Width, Max_Roll_Width;
            double Machine_Max_Cut_Off, Machine_Min_Cut_Off;

            Gbl_Grain_Direction = Grain_Direction;

            if (Grain_Direction == "With Grain")
            {
                Gbl_Rect_H = Gbl_Job_H;
                Gbl_Rect_L = Gbl_Job_L;
            }
            else
            {
                Gbl_Rect_H = Gbl_Job_L;
                Gbl_Rect_L = Gbl_Job_H;
            }
            string unit = string.IsNullOrWhiteSpace(ContentSizeInputUnit) ? "MM" : ContentSizeInputUnit.Trim().ToUpper();

            if (unit == "INCH")
            {
                Gbl_Rect_L = Math.Round(Gbl_Rect_L * 2.54, 2); // Convert from inches to cm
                Gbl_Rect_H = Math.Round(Gbl_Rect_H * 2.54, 2);
            }
            else if (unit == "MM")
            {
                Gbl_Rect_L = Math.Round(Gbl_Rect_L / 10.0, 2); // Convert from mm to cm
                Gbl_Rect_H = Math.Round(Gbl_Rect_H / 10.0, 2);
            }
            else if (unit == "MTR")
            {
                Gbl_Rect_L = Math.Round(Gbl_Rect_L * 100, 2); // Convert from meters to cm
                Gbl_Rect_H = Math.Round(Gbl_Rect_H * 100, 2);
            }

            for (int i = 0; i < Gbl_DT_Machine.Rows.Count; i++)
            {
                DataRow machineRow = Gbl_DT_Machine.Rows[i];

                if (Gbl_Printing_Style == "FB-Perfection")
                {
                    bool isMachineValid = machineRow[14] != DBNull.Value && Convert.ToBoolean(machineRow[14]);
                    double machineColorCapacity = Convert.ToDouble(machineRow[10]);

                    if (!isMachineValid || machineColorCapacity < (Gbl_Front_Color + Gbl_Back_Color) || Gbl_Front_Color != Gbl_Back_Color)
                    {
                        continue;
                    }
                }

                Gbl_Machine_Gripper = 0;
                Gbl_Machine_ID = (Int16)machineRow[0];
                Gbl_Machine_Name = (String)machineRow[1];
                M_Max_L = (Int64)(machineRow[2]);
                GblMachineMaxW = (Int64)(machineRow[3]);
                M_Min_L = Convert.ToDouble(machineRow[4]);
                Gbl_M_Min_H = (Int64)(machineRow[5]);
                Max_Print_L = Convert.ToDouble(machineRow[6]);
                Max_Print_H = Convert.ToDouble(machineRow[7]);
                Gbl_Machine_Type = machineRow[11].ToString().ToUpper();
                Min_Roll_Width = Convert.ToDouble(machineRow[26]);
                Max_Roll_Width = Convert.ToDouble(machineRow[27]);

                if (Gbl_DT_Machine.Rows[i][11].ToString().ToUpper() == "LARGE FORMAT")
                {
                    Machine_Max_Cut_Off = Convert.ToDouble(Gbl_DT_Machine.Rows[i][45]);
                    Machine_Min_Cut_Off = Convert.ToDouble(Gbl_DT_Machine.Rows[i][44]);

                    Gbl_Label_L_With_Around = Math.Abs(Gbl_Rect_L);
                    Gbl_Label_H_With_Across = Math.Abs(Gbl_Rect_H);

                    Gbl_UPS_L = 1;

                    Plan_On_Large_Format_Roll(i, Gbl_Rect_H, Gbl_Rect_L);
                }

            }
            return true;
        }
        private void Add_Flexo_Plan(int m, int p, double Rec_L, double Rec_H)
        {
            try
            {
                double Req_Running_Mtr = 0;
                double Total_GSM;
                int Machine_Colors;
                double Wastage_Square_Meters;
                double Total_Square_Mtr;
                double Process_Wastage_Percent;
                double Scrap_Square_Meters;
                double Roll_Change_Wastage = 0;
                long Printing_Impressions = 0;
                double Wastage_Running_Mtr = 0;
                double Process_Wastage_Running_Mtr;
                double Total_Running_Mtr;
                double Req_Square_Mtr = 0;
                long Total_Req_Machine_Time = 0;
                float Feed_Amount = 0;
                float Roll_Width;
                double Total_Ups;
                double Make_Ready_Wastage_Running_meter;
                double Break_Down_Wastage_Running_meter;
                double Paper_Amount = 0;
                long Total_Colors = 0;
                long Expected_Execution_Time = 0;
                long Cylinder_Tool_ID;
                string Cylinder_Code;
                double Cylinder_Circumference_MM, Cylinder_Circumference_Inch, Cylinder_Width;
                int No_Of_Teeth;
                double Machine_Speed;
                string Paper_Size, Cut_size, Die_Cut_size;
                double Total_Amount, F_Total_Amount, Unit_Price;
                double Required_Paper_Weight_Kg;
                double Wastage_Paper_Weight_Kg;
                double Total_Paper_Weight_Kg;
                int Plate_Qty;
                double Plate_Rate = 0;
                string Estimation_Paper_Rate_Type;
                double Paper_Rate = 0;
                double Plate_Amount = 0;
                double Machine_Per_Hour_Cost;
                int FaceGSM, ReleaseGSM, AdhesiveGSM;
                string PaperMill;
                string RollType;
                long FinalQuantityInPcs = 0;
                string Wastage_Type = "";
                string Wastage_Calculation_On = "";
                Process_Wastage_Running_Mtr = 0;
                double PlanningMachineCost = 0;
                int x;
                double TempMachineSpeed1 = 0;
                double TempMakeReadyTime1 = 0;
                double TempJobChangeOverTime1 = 0;
                double AvgRollLength = 0;
                string PlateChargesType = GblPlateChargesType;
                double Make_Ready_Rate_PerHour = 0;
                double TempMakeReadyPerHourCost = 0;
                double TempMachineSlabSpeed = 0;


                Machine_Colors = Convert.ToInt32(Gbl_DT_Machine.Rows[m][10]);
                Gbl_Machine_Colors = Convert.ToDouble(Gbl_DT_Machine.Rows[m][10]);
                Gbl_Paper_ID = Convert.ToInt32(GblDTRoll.Rows[p][0]);
                Roll_Width = (float)(GblDTRoll.Rows[p][10]);
                Paper_Size = Roll_Width.ToString();

                Total_GSM = Convert.ToDouble(GblDTRoll.Rows[p].IsNull(2) ? 0 : GblDTRoll.Rows[p][2]) + Convert.ToDouble(GblDTRoll.Rows[p].IsNull(3) ? 0 : GblDTRoll.Rows[p][3]) + Convert.ToDouble(GblDTRoll.Rows[p].IsNull(4) ? 0 : GblDTRoll.Rows[p][4]);
                AvgRollLength = Convert.ToDouble(GblDTRoll.Rows[p].IsNull(18) ? 0 : GblDTRoll.Rows[p][18]);
                Make_Ready_Wastage_Running_meter = Convert.ToDouble(Gbl_DT_Machine.Rows[m].IsNull(30) ? 0 : Gbl_DT_Machine.Rows[m][30]);
                if (Gbl_Plan_Make_Ready_Wastage > 0)
                    Make_Ready_Wastage_Running_meter = Gbl_Plan_Make_Ready_Wastage;

                Break_Down_Wastage_Running_meter = Convert.ToDouble(Gbl_DT_Machine.Rows[m].IsNull(32) ? 0 : Gbl_DT_Machine.Rows[m][32]);
                Machine_Per_Hour_Cost = Convert.ToDouble(Gbl_DT_Machine.Rows[m].IsNull(25) ? 0 : Gbl_DT_Machine.Rows[m][25]);
                Cylinder_Tool_ID = Convert.ToInt32(Gbl_DT_Machine.Rows[m].IsNull(37) ? 0 : Gbl_DT_Machine.Rows[m][37]);
                Cylinder_Code = Gbl_DT_Machine.Rows[m].IsNull(38) ? "" : Gbl_DT_Machine.Rows[m][38].ToString();
                Cylinder_Width = Convert.ToDouble(Gbl_DT_Machine.Rows[m].IsNull(40) ? 0 : Gbl_DT_Machine.Rows[m][40]);
                No_Of_Teeth = Convert.ToInt32(Gbl_DT_Machine.Rows[m].IsNull(41) ? 0 : Gbl_DT_Machine.Rows[m][41]);
                Wastage_Type = Convert.ToString(Gbl_DT_Machine.Rows[m].IsNull(21) ? 0 : Gbl_DT_Machine.Rows[m][21]);
                Wastage_Calculation_On = Convert.ToString(Gbl_DT_Machine.Rows[m].IsNull(22) ? 0 : Gbl_DT_Machine.Rows[m][22]);
                Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m].IsNull(42) ? 0 : Gbl_DT_Machine.Rows[m][42]), 2);
                Cylinder_Circumference_Inch = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m].IsNull(43) ? 0 : Gbl_DT_Machine.Rows[m][43]), 3);
                Plate_Rate = Convert.ToDouble(Convert.IsDBNull(Gbl_DT_Machine.Rows[m]["PlateCharges"]) ? 0 : Gbl_DT_Machine.Rows[m]["PlateCharges"]);
                PlateChargesType = Convert.IsDBNull(Gbl_DT_Machine.Rows[m]["PlateChargesType"]) ? "Rate/Plate" : Gbl_DT_Machine.Rows[m]["PlateChargesType"].ToString();
                FaceGSM = (Int16)Math.Round(Convert.ToDouble(GblDTRoll.Rows[p].IsNull(2) ? 0 : GblDTRoll.Rows[p][2]), 0);
                ReleaseGSM = (Int16)Math.Round(Convert.ToDouble(GblDTRoll.Rows[p].IsNull(3) ? 0 : GblDTRoll.Rows[p][3]), 0);
                AdhesiveGSM = (Int16)Math.Round(Convert.ToDouble(GblDTRoll.Rows[p].IsNull(4) ? 0 : GblDTRoll.Rows[p][4]), 0);
                PaperMill = GblDTRoll.Rows[p].IsNull(7) ? "" : GblDTRoll.Rows[p][7].ToString();
                RollType = GblDTRoll.Rows[p].IsNull(15) ? "" : GblDTRoll.Rows[p][15].ToString();
                if (Convert.ToDouble(GblDTRoll.Rows[p][2]) <= 0)
                {
                    Total_GSM = Math.Round(
                        Math.Round(Convert.ToDouble(GblDTRoll.Rows[p].IsNull(5) ? 0 : GblDTRoll.Rows[p][5]), 0) *
                        Math.Round(Convert.ToDouble(GblDTRoll.Rows[p].IsNull(6) ? 0 : GblDTRoll.Rows[p][6]), 0), 0);
                }
                Plate_Qty = Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color;
                Estimation_Paper_Rate_Type = GblDTRoll.Rows[p].IsNull(13) ? "" : GblDTRoll.Rows[p][13].ToString();
                Paper_Rate = Convert.ToDouble(GblDTRoll.Rows[p].IsNull(8) ? 0 : GblDTRoll.Rows[p][8]);

                if (Gbl_Orientation == "PrePlannedSheetLabel")
                {
                    Total_Ups = Gbl_Job_Ups;
                    Gbl_Label_L_With_Around = Rec_L;
                }
                else
                {
                    Total_Ups = Gbl_UPS_H * Gbl_UPS_L;
                    Gbl_Label_L_With_Around = Rec_L + Gbl_Actual_Around_Gap;
                }
                if (Gbl_Estimation_Unit == "KGS")
                {
                    if (Total_GSM > 0)
                    {
                        Req_Square_Mtr = Math.Round(((Gbl_Order_Quantity * 1000) / Total_GSM), 2);

                        if (Roll_Width > 0)
                        {
                            Req_Running_Mtr = Math.Ceiling(Req_Square_Mtr / (Roll_Width / 1000.0));

                            if (Gbl_UPS_L > 0 && Gbl_Label_L_With_Around > 0)
                            {
                                if (Cylinder_Circumference_MM > 0)
                                {
                                    Printing_Impressions = (Int64)Math.Round((Req_Running_Mtr * 1000) / Cylinder_Circumference_MM, 0);
                                }
                                else if (Gbl_Orientation == "PrePlannedSheetLabel")
                                {
                                    Printing_Impressions = (Int64)Math.Round((Req_Running_Mtr * 1000) / Math.Round(Gbl_Label_L_With_Around, 2), 0);
                                }
                                else
                                {
                                    Printing_Impressions = (Int64)Math.Round((Req_Running_Mtr * 1000) / Math.Round((Gbl_Label_L_With_Around * Gbl_UPS_L), 2), 0);
                                }
                            }
                            FinalQuantityInPcs = Convert.ToInt32(Printing_Impressions) * Convert.ToInt32(Total_Ups);
                        }
                    }
                    else
                    {
                        Printing_Impressions = (Int64)Math.Round((Gbl_Order_Quantity / Total_Ups), 0);
                        FinalQuantityInPcs = (Int64)Gbl_Order_Quantity;
                    }
                }
                else
                {
                    Printing_Impressions = (Int64)Math.Round((Gbl_Order_Quantity / Total_Ups), 0);
                    FinalQuantityInPcs = (Int64)Gbl_Order_Quantity;
                }
                if (Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "FLEXO" || Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "LETTERPRESS")
                {
                    if (Printing_Impressions > 0 && Cylinder_Circumference_MM > 0)
                    {
                        if (Gbl_Orientation == "PrePlannedSheetLabel")
                        {
                            Req_Running_Mtr = Math.Round(Printing_Impressions * (Cylinder_Circumference_MM / 1000.0), 3);
                        }
                        else
                        {
                            Req_Running_Mtr = Math.Round((Gbl_Label_L_With_Around * (FinalQuantityInPcs / (double)Gbl_UPS_H)) / 1000.0, 3);
                        }
                    }
                    else if (Gbl_Orientation == "PrePlannedSheetLabel")
                    {
                        Req_Running_Mtr = Math.Round((Gbl_Label_L_With_Around * Printing_Impressions) / 1000.0, 3);
                    }
                    else
                    {
                        Req_Running_Mtr = Math.Round((Gbl_Label_L_With_Around * (FinalQuantityInPcs / (double)Gbl_UPS_H)) / 1000.0, 3);
                    }
                    Req_Square_Mtr = Math.Round((Roll_Width / 1000.0) * Req_Running_Mtr, 3);
                }
                else if (Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "DRY WEB OFFSET" || Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "DIGITAL")
                {
                    if (Gbl_Orientation == "PrePlannedSheetLabel")
                    {
                        Feed_Amount = (float)Math.Round(Gbl_Label_L_With_Around, 2);
                    }
                    else
                    {
                        Feed_Amount = (float)Math.Round(Gbl_Label_L_With_Around * Gbl_UPS_L, 2);
                    }
                    Req_Running_Mtr = Math.Round((Printing_Impressions * Feed_Amount) / 1000.0, 3);
                    Req_Square_Mtr = Math.Round((Roll_Width / 1000.0) * Req_Running_Mtr, 3);
                }


                double TempWasteRunningMeter = 0;
                double TempProcessWastePercentage = 0;
                TempMachineSlabSpeed = 0;
                Process_Wastage_Percent = 0;

                if (Gbl_Flat_Wastage_Type == "Machine Default")
                {
                    Process_Wastage_Percent = TempProcessWastePercentage;
                    Wastage_Running_Mtr = TempWasteRunningMeter;
                    Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Make_Ready_Wastage_Running_meter, 3);
                    Gbl_Flat_Wastage_Value = 0;
                    if (Wastage_Type == "Meter")
                    {
                        if (Wastage_Calculation_On == "Flat")
                        {
                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                                Wastage_Running_Mtr = Process_Wastage_Percent;
                            }
                            else
                            {
                                Wastage_Running_Mtr = Process_Wastage_Percent;
                                Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                                Wastage_Running_Mtr += Math.Round(
                                    Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                            }
                        }
                        else
                        {
                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                                Wastage_Running_Mtr = Process_Wastage_Percent *
                                    (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                            }
                            else
                            {
                                Wastage_Running_Mtr = Process_Wastage_Percent *
                                    (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                            }

                            Wastage_Running_Mtr += Math.Round(
                                Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                        }
                    }
                    else
                    {
                        if (Wastage_Calculation_On == "Flat")
                        {
                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Wastage_Running_Mtr = Math.Round(
                                    Req_Running_Mtr * Convert.ToDouble(Gbl_Flat_Wastage_Value) / 100, 3) +
                                    Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][12]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]), 3);

                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                            }
                            else
                            {
                                Wastage_Running_Mtr = Math.Round(
                                    Req_Running_Mtr * Convert.ToDouble(Process_Wastage_Percent) / 100, 3);

                                Wastage_Running_Mtr += Math.Round(
                                    Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);

                                Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                            }
                        }
                        else
                        {
                            double wastePercentage = 0;

                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;

                                wastePercentage = Process_Wastage_Percent *
                                    (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);

                                Wastage_Running_Mtr = Math.Round(
                                    Req_Running_Mtr * Convert.ToDouble(wastePercentage) / 100, 3);
                            }
                            else
                            {
                                wastePercentage = Process_Wastage_Percent *
                                    (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);

                                Wastage_Running_Mtr = Math.Round(
                                    Req_Running_Mtr * Convert.ToDouble(wastePercentage) / 100, 3);

                                Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                            }

                            Wastage_Running_Mtr += Math.Round(
                                Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                        }
                    }


                    double processFlatWasteQty = 0;
                    double processWastePercent = 0;
                    double processWastePercentQty = 0;
                    Process_Wastage_Running_Mtr = 0;
                    for (int i = 0; i < Gbl_DT_Operation.Rows.Count; i++)
                    {
                        processFlatWasteQty = Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]);
                        processWastePercent = Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]);
                        processWastePercentQty = 0;
                        if (processWastePercent > 0)
                        {
                            processWastePercentQty = Math.Round(Req_Running_Mtr * (processWastePercent / 100), 0);
                        }
                        Process_Wastage_Running_Mtr += Math.Max(processFlatWasteQty, processWastePercentQty);
                    }
                    Wastage_Running_Mtr += Process_Wastage_Running_Mtr;

                    if (GblShadeCardCreationRequired == true)
                        Wastage_Running_Mtr = Wastage_Running_Mtr + 400;
                }
                else if (Gbl_Flat_Wastage_Type == "Percentage")
                {
                    Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Gbl_Flat_Wastage_Value) / (double)100, 3);
                    Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                }
                else if (Gbl_Flat_Wastage_Type == "Meter")
                {
                    Wastage_Running_Mtr = Math.Round(Convert.ToDouble(Gbl_Flat_Wastage_Value), 3);
                    Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                }

                double total_mtr;
                total_mtr = Wastage_Running_Mtr + Req_Running_Mtr;

                if (Convert.ToDouble(AvgRollLength) > 0)
                {
                    Roll_Change_Wastage = Math.Round(((Math.Ceiling(total_mtr / Convert.ToDouble(AvgRollLength)) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][34])), 2);
                }
                else if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                {
                    Roll_Change_Wastage = Math.Round(((Math.Ceiling(total_mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][34])), 2);
                }


                Wastage_Running_Mtr = Math.Round((Wastage_Running_Mtr + Roll_Change_Wastage), 3);

                Wastage_Square_Meters = Math.Round((Roll_Width / (double)1000) * Wastage_Running_Mtr, 3);
                Total_Running_Mtr = Math.Round((Wastage_Running_Mtr + Req_Running_Mtr), 3);

                Total_Square_Mtr = Math.Round(((Roll_Width / (double)1000) * Total_Running_Mtr), 3);

                // Scrap_Square_Meters = Total_Square_Mtr - (((Rec_H / 1000) * (Rec_L / 1000)) * Gbl_Order_Quantity)
                Scrap_Square_Meters = Total_Square_Mtr - (((Rec_H / 1000) * (Rec_L / 1000)) * FinalQuantityInPcs);

                Required_Paper_Weight_Kg = Math.Round((Convert.ToDouble(Req_Square_Mtr) * Convert.ToDouble(Total_GSM)) / 1000, 3);
                Wastage_Paper_Weight_Kg = Math.Round((Convert.ToDouble(Wastage_Square_Meters) * Convert.ToDouble(Total_GSM)) / 1000, 3);
                Total_Paper_Weight_Kg = Math.Round((Convert.ToDouble(Total_Square_Mtr) * Convert.ToDouble(Total_GSM)) / 1000, 3);

                if (Estimation_Paper_Rate_Type.ToString().ToUpper() == "SQM" || Estimation_Paper_Rate_Type.ToString().ToUpper() == "SQUARE METER")
                {
                    Paper_Amount = Math.Round(Convert.ToDouble(Total_Square_Mtr) * Convert.ToDouble(Paper_Rate), 2);
                }
                else if (Estimation_Paper_Rate_Type.ToString().ToUpper() == "KG")
                {
                    Paper_Amount = Math.Round(Convert.ToDouble(Total_Paper_Weight_Kg) * Convert.ToDouble(Paper_Rate), 2);
                }

                double Op_Amt = 0;
                // 'Dim ST_Op_Amt As String = ""
                double Pub_RMT = 0;
                double Pub_Sqmtr = 0;
                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double machineCost = 0;
                double TotalMachineCost = 0;
                DataTable DTOPR = new DataTable();
                DTOPR = Gbl_DT_Operation.Copy();
                DTOPR.Clear();

                for (var j = 0; j <= GblDTOprFactors.Rows.Count - 1; j++)
                {
                    for (var i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        if (Gbl_DT_Operation.Rows[i]["PrePress"].ToString() == "Pre")
                        {
                            Pub_RMT = Total_Running_Mtr;
                        }
                        else
                        {
                            string chargeApplyOnSheets = Gbl_DT_Operation.Rows[i]["ChargeApplyOnSheets"] == DBNull.Value ? "Actual Running Meter" : Gbl_DT_Operation.Rows[i]["ChargeApplyOnSheets"].ToString();

                            if (chargeApplyOnSheets == "Actual Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr;
                            }
                            else if (chargeApplyOnSheets == "Actual Running Meter + Make Ready Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr + Make_Ready_Wastage_Running_meter;
                            }
                            else if (chargeApplyOnSheets == "Actual Running Meter + Wastage Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr + Wastage_Running_Mtr;
                            }
                            else if (chargeApplyOnSheets == "Actual Running Meter + Make Ready Running Meter + Wastage Running Meter")
                            {
                                Pub_RMT = Total_Running_Mtr;
                            }
                        }
                        if (Gbl_DT_Operation.Rows[i]["SizeToBeConsidered"].ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i]["SizeL"] = Convert.ToDouble(Cylinder_Circumference_MM);
                            Gbl_DT_Operation.Rows[i]["SizeW"] = Convert.ToDouble(Roll_Width);
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i]["SizeL"] = 0;
                            Gbl_DT_Operation.Rows[i]["SizeW"] = 0;
                        }

                        double QTY = 0;
                        string typeofcharge = Gbl_DT_Operation.Rows[i]["TypeofCharges"] == DBNull.Value ?
                                              "" : Gbl_DT_Operation.Rows[i]["TypeofCharges"].ToString();

                        if (typeofcharge.Contains("Order Quantity") || typeofcharge.Contains("OrderQuantity"))
                        {
                            QTY = Gbl_Order_Quantity;
                        }
                        else if (typeofcharge.Contains("Unit"))
                        {
                            QTY = Gbl_Order_Quantity;
                        }
                        else if (typeofcharge.Contains("Sq.Meter"))
                        {
                            QTY = Math.Round((Pub_RMT * Convert.ToDouble(Roll_Width) / 1000), 3);
                        }
                        else if (typeofcharge.Contains("Meter"))
                        {
                            QTY = Pub_RMT;
                        }
                        else if (typeofcharge.Contains("PCS"))
                        {
                            QTY = FinalQuantityInPcs;
                        }

                        int k = 0;
                        for (k = 0; k <= GblDTOprSlabs.Rows.Count - 1; k++)
                        {
                            if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"])))
                            {
                                if ((GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["FromQty"])) >= 1 && (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])) == (GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"])))
                                {
                                    if (QTY >= (GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["FromQty"])) && QTY <= (GblDTOprSlabs.Rows[k]["ToQty"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["ToQty"])) && (GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString().Replace("-", "")) == (GblDTOprSlabs.Rows[k]["RateFactor"] == DBNull.Value ? "" : GblDTOprSlabs.Rows[k]["RateFactor"].ToString().Replace("-", "")))
                                    {
                                        Gbl_DT_Operation.Rows[i]["Rate"] = GblDTOprSlabs.Rows[k]["Rate"] == DBNull.Value ? 0 : Convert.ToDecimal(GblDTOprSlabs.Rows[k]["Rate"]);
                                        Gbl_DT_Operation.Rows[i]["MinimumCharges"] = GblDTOprSlabs.Rows[k]["MinimumCharges"] == DBNull.Value ? 0 : Convert.ToDecimal(GblDTOprSlabs.Rows[k]["MinimumCharges"]);
                                        break;
                                    }
                                }
                            }
                        }

                        double Amt = Calculate_Operations(Gbl_DT_Operation.Rows[i]["TypeofCharges"] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i]["TypeofCharges"].ToString(), Convert.ToDouble(Gbl_DT_Operation.Rows[i]["Rate"] == DBNull.Value ? 0 : Convert.ToDecimal(Gbl_DT_Operation.Rows[i]["Rate"])), Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MinimumCharges"] == DBNull.Value ? 0 : Convert.ToDecimal(Gbl_DT_Operation.Rows[i]["MinimumCharges"])), Convert.ToInt32(Gbl_Order_Quantity), FinalQuantityInPcs, Convert.ToDouble(Gbl_DT_Operation.Rows[i]["SetupCharges"] == DBNull.Value ? 0 : Convert.ToDecimal(Gbl_DT_Operation.Rows[i]["SetupCharges"])), Convert.ToInt32(Total_Paper_Weight_Kg), Convert.ToInt32(Total_Ups), 0, Convert.ToInt32(Gbl_DT_Operation.Rows[i]["SizeL"] == DBNull.Value ? 0 : Convert.ToDecimal(Gbl_DT_Operation.Rows[i]["SizeL"])), Convert.ToDouble(Gbl_DT_Operation.Rows[i]["SizeW"] == DBNull.Value ? 0 : Convert.ToDecimal(Gbl_DT_Operation.Rows[i]["SizeW"])), Convert.ToInt32(Total_Colors), QTY, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, Convert.ToInt32(Gbl_Order_Quantity), Gbl_DT_Operation.Rows[i]["PagesPerSection"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"]), Gbl_DT_Operation.Rows[i]["NoOfForms"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"]));

                        Gbl_DT_Operation.Rows[i]["Amount"] = Math.Round(Amt, 3).ToString();
                        Gbl_DT_Operation.Rows[i]["PlanID"] = Gbl_DT_plan.Rows.Count + 1;
                        Gbl_DT_Operation.Rows[i]["Quantity"] = Math.Round(QTY, 3).ToString();
                        Gbl_DT_Operation.Rows[i]["Ups"] = Total_Ups;
                        Gbl_DT_Operation.Rows[i]["NoOfPass"] = 1;
                        Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;

                        if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                        {
                            Gbl_DT_Operation.Rows[i]["RateFactor"] = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString();
                            Gbl_DT_Operation.Rows[i]["Remarks"] = GblDTOprFactors.Rows[j]["Remarks"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["Remarks"].ToString();
                            Gbl_DT_Operation.Rows[i]["PaperConsumptionRequired"] = GblDTOprFactors.Rows[j]["PaperConsumptionRequired"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["PaperConsumptionRequired"].ToString();

                            if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) > 0)
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"]);
                                Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                            }
                            else if ((Gbl_DT_Operation.Rows[i]["DepartmentID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["DepartmentID"])) == 100)
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Gbl_DT_Machine.Rows[m][0];

                                for (x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                {
                                    if ((Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"])) == (Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) && (Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"])) == (Gbl_DT_Operation.Rows[i]["MachineID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["MachineID"])))
                                    {
                                        TempMachineSpeed1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"]);
                                        TempMakeReadyTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"]);
                                        TempJobChangeOverTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"]);
                                    }
                                }

                                if (TempMachineSlabSpeed > 0)
                                    Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSlabSpeed;
                                else if (TempMachineSpeed1 > 0)
                                {
                                    TempMachineSlabSpeed = TempMachineSpeed1;
                                    Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSpeed1;
                                }
                                else
                                {
                                    Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]);
                                    TempMachineSlabSpeed = Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]);
                                }

                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = TempMakeReadyTime1 > 0 ? TempMakeReadyTime1 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][19] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][19]);
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = TempJobChangeOverTime1 > 0 ? TempJobChangeOverTime1 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][20] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][20]);
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(Machine_Per_Hour_Cost);
                            }
                        }

                        if (Convert.ToDouble(Pub_RMT) > 0)
                        {
                            double machineSpeed = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineSpeed"]);
                            opExecutionTime = 0;
                            if (machineSpeed > 0)
                                opExecutionTime = Math.Round(Convert.ToDouble(Pub_RMT) / machineSpeed);
                            else
                                opExecutionTime = 0;
                            Gbl_DT_Operation.Rows[i]["ExecutionTime"] = opExecutionTime;
                        }

                        Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = Math.Round(Convert.ToDouble(opExecutionTime) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyTime"]) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]));

                        opTotalExecutionTime = Math.Round(Convert.ToDouble(opExecutionTime) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyTime"]) + Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]));
                        machineCost = Math.Round(Math.Round(opTotalExecutionTime / 60, 2) * Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachinePerHourCost"]), 2);

                        if (Gbl_DT_Operation.Rows[i]["IsOnlineProcess"] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Operation.Rows[i]["IsOnlineProcess"]))
                        {
                            machineCost = 0;
                        }
                        Gbl_DT_Operation.Rows[i]["MachineCost"] = Convert.ToDouble(machineCost);
                        if (Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]) == Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["ProcessID"]))
                        {
                            DTOPR.ImportRow(Gbl_DT_Operation.Rows[i]);
                        }
                    }
                }
                Op_Amt = 0;
                TotalMachineCost = 0;
                for (int i = 0; i < DTOPR.Rows.Count; i++)
                {
                    Op_Amt += Convert.ToDouble(DTOPR.Rows[i]["Amount"] == DBNull.Value ? 0 : DTOPR.Rows[i]["Amount"]);
                    TotalMachineCost += Convert.ToDouble(DTOPR.Rows[i]["MachineCost"] == DBNull.Value ? 0 : DTOPR.Rows[i]["MachineCost"]);
                }
                Rf_Dt_Opr.Merge(DTOPR);
                if (Gbl_DT_Machine.Rows[m][11] != DBNull.Value && Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "FLEXO")
                {
                    Gbl_Big_H = 0;
                }
                if (Gbl_Big_H > 0)
                {
                    if (Gbl_UPS_H % (Gbl_Big_Ups_H == 0 ? 1 : Gbl_Big_Ups_H) != 0)
                    {
                        return;
                    }
                }


                {
                    var withBlock = Gbl_DT_plan;

                    Machine_Speed = Convert.ToDouble(TempMachineSlabSpeed) > 0 ? TempMachineSlabSpeed : Convert.ToDouble(Gbl_DT_Machine.Rows[m][24] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][24]);

                    if (Machine_Speed > 0)
                    {
                        Total_Req_Machine_Time = (long)Math.Round(Total_Running_Mtr / Machine_Speed, 0);
                        Expected_Execution_Time = (long)Math.Round(Req_Running_Mtr / Machine_Speed, 0);
                    }

                    Total_Req_Machine_Time +=
                        (long)((Convert.ToDouble(TempMakeReadyTime1) > 0 ? Convert.ToDouble(TempMakeReadyTime1) : Convert.ToDouble(Gbl_DT_Machine.Rows[m][19] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][19]))
                        + Convert.ToDouble(Gbl_DT_Machine.Rows[m][31] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][31])
                        + (Convert.ToDouble(TempJobChangeOverTime1) > 0 ? Convert.ToDouble(TempJobChangeOverTime1) : Convert.ToDouble(Gbl_DT_Machine.Rows[m][20] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][20])));

                    if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35] == DBNull.Value ? 1 : Gbl_DT_Machine.Rows[m][35]) > 1)
                    {
                        Total_Req_Machine_Time += (long)Math.Round(
                            ((Math.Ceiling(Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][36] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][36])), 2);
                    }

                    Total_Colors = Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color;

                    Paper_Size = Convert.ToString(GblDTRoll.Rows[p][10] == DBNull.Value ? 0 : GblDTRoll.Rows[p][10]);
                    Cut_size = $"{Math.Round(Gbl_Sheet_W, 2)}x{Math.Round(Gbl_Sheet_L, 2)}";
                    Die_Cut_size = $"{Gbl_Die_Size_H}x{Gbl_Die_Size_L}";

                    Total_Amount = 0;
                    double PlateArea = 0;
                    double PlateLength = 0;
                    int unitpricedecimal = 2;
                    int finalCostRoundDecimal = 2;

                    // Read company flags if available
                    if (Gbl_DT_CompanyMaster_Flags.Rows.Count > 0)
                    {
                        var row = Gbl_DT_CompanyMaster_Flags.Rows[0];

                        unitpricedecimal = Convert.IsDBNull(row["EstimationPerUnitCostDecimalPlace"]) ? 2 : Convert.ToInt32(row["EstimationPerUnitCostDecimalPlace"]);
                        finalCostRoundDecimal = Convert.IsDBNull(row["EstimationRoundOffDecimalPlace"]) ? 2 : Convert.ToInt32(row["EstimationRoundOffDecimalPlace"]);

                        if (unitpricedecimal == 0) unitpricedecimal = 2;
                        if (finalCostRoundDecimal == 0) finalCostRoundDecimal = 2;
                    }

                    // Determine PlateLength
                    if (Convert.ToDouble(Cylinder_Circumference_MM) > 0)
                    {
                        PlateLength = Convert.ToDouble(Cylinder_Circumference_MM);
                    }
                    else
                    {
                        PlateLength = Convert.ToDouble(Feed_Amount);
                    }

                    // Calculate PlateArea based on type
                    if (PlateChargesType == "Rate/Plate")
                    {
                        PlateArea = 1;
                    }
                    else if (PlateChargesType == "Rate/Sq.CM")
                    {
                        PlateArea = Math.Round((Convert.ToDouble(Paper_Size) * PlateLength) / 100, 3); // in Sq.CM
                    }
                    else if (PlateChargesType == "Rate/Sq.Inch")
                    {
                        PlateArea = Math.Round((Convert.ToDouble(Paper_Size) * PlateLength) / 645.16, 3); // in Sq.Inch
                    }
                    else if (PlateChargesType == "Rate/Sq.Mtr")
                    {
                        PlateArea = Math.Round((Convert.ToDouble(Paper_Size) * PlateLength) / 1000000, 3); // in Sq.Mtr
                    }

                    // Fallback if PlateArea is still 0
                    if (PlateArea == 0) PlateArea = 1;

                    // Final rounding and cost calculation
                    Op_Amt = Math.Round(Op_Amt, finalCostRoundDecimal);
                    Plate_Amount = Math.Round((Plate_Rate * Plate_Qty * PlateArea), 2);
                    switch (GblCostEstimationMethodType)
                    {
                        case "MATERIAL+PROCESS":
                            Total_Amount = Math.Round(Plate_Amount + Paper_Amount + Op_Amt, 2);
                            break;
                        case "MATERIAL+PROCESS+MACHINE":
                            Total_Amount = Math.Round(Plate_Amount + Paper_Amount + Op_Amt + PlanningMachineCost + TotalMachineCost, 2);
                            break;
                        case "PROCESS+MACHINE":
                            Total_Amount = Math.Round(Op_Amt + PlanningMachineCost + TotalMachineCost, 2);
                            break;
                        case "MATERIAL+MACHINE":
                            Total_Amount = Math.Round(Plate_Amount + Paper_Amount + PlanningMachineCost + TotalMachineCost, 2);
                            break;
                        default:
                            Total_Amount = Math.Round(Plate_Amount + Paper_Amount, 2);
                            break;
                    }

                    F_Total_Amount = Total_Amount;

                    Unit_Price = (F_Total_Amount > 0 && Gbl_Order_Quantity > 0) ? Math.Round(F_Total_Amount / Gbl_Order_Quantity, 2) : 0;

                    var newRow = withBlock.NewRow();

                    newRow.ItemArray = new object[]
                    {
        Gbl_Machine_ID, Gbl_Machine_Name, 0, "", Machine_Colors, Gbl_Paper_ID, Paper_Size, "", 1, 1, Gbl_UPS_H, Gbl_UPS_L, Total_Ups, "", "", 0,
        Process_Wastage_Percent, Wastage_Paper_Weight_Kg, Gbl_Grain_Direction, Plate_Qty, 0, 0, 0, 0, 0, 0, Total_Paper_Weight_Kg, 0,
        Paper_Rate, Paper_Amount, Printing_Impressions, Printing_Impressions, 0, 0, 1, 0, 0, Gbl_Order_Quantity,Gbl_Order_Quantity, Total_Colors, Total_Amount, 0, 0,
        Gbl_Printing_Style, "", Expected_Execution_Time, Total_Req_Machine_Time, Gbl_Paper_Detail, "Flexo Planning", Estimation_Paper_Rate_Type, "", 0, 1,
        F_Total_Amount, Unit_Price, "", 1, 0, Special_Color_Front_Charges, Special_Color_Back_Charges, Special_Color_Front_Amount, Special_Color_Back_Amount,
        Op_Amt, withBlock.Rows.Count + 1, 0, 0, GblMainPaperGroup, Gbl_Machine_Type, Cylinder_Tool_ID, Cylinder_Code, Cylinder_Circumference_Inch,
        Cylinder_Circumference_MM, Cylinder_Width, No_Of_Teeth, Feed_Amount, Gbl_Standard_AC_Gap, Gbl_Actual_Around_Gap, Gbl_Side_Wastage_Strip,
        Req_Running_Mtr, Make_Ready_Wastage_Running_meter, Break_Down_Wastage_Running_meter, Wastage_Running_Mtr, Process_Wastage_Running_Mtr,
        Total_Running_Mtr, Req_Square_Mtr, Total_Square_Mtr, Wastage_Square_Meters, Scrap_Square_Meters, Machine_Speed, Machine_Per_Hour_Cost, Total_GSM,
        Required_Paper_Weight_Kg, Roll_Change_Wastage, 0, FaceGSM, ReleaseGSM, AdhesiveGSM, PaperMill, RollType, Op_Amt, Paper_Amount, TotalMachineCost,
        Gbl_windingdirection, Gbl_labeltype, Gbl_finishedformat, Gbl_LabelPerRoll, Gbl_dietype, Gbl_CoreInnerDia, Gbl_CoreOuterDia, FinalQuantityInPcs,
        Gbl_Estimation_Unit, Gbl_Other_Material_GSM, PlanOtherMaterialGSMSettingJSON, Required_Paper_Weight_Kg, Gbl_Orientation, PlanContName,false
                    };
                    withBlock.Rows.Add(newRow);
                }
            }

            catch (Exception ex)
            {
                str = ex.Message;
            }
        }

        private void Add_Roto_Gravure_Plan(int m, int p, double Rec_L, double Rec_H)
        {
            try
            {
                double Req_Running_Mtr = 0;
                double Total_GSM = 0;
                double Paper_GSM = 0;
                int Machine_Colors = 0;
                double Wastage_Square_Meters = 0;
                double Total_Square_Mtr = 0;
                double Process_Wastage_Percent = 0;
                double Scrap_Square_Meters = 0;
                double Roll_Change_Wastage = 0;
                long Printing_Impressions = 0;
                double Wastage_Running_Mtr = 0;
                double Process_Wastage_Running_Mtr = 0;
                double Total_Running_Mtr = 0;
                double Req_Square_Mtr = 0;
                long Total_Req_Machine_Time = 0;
                float Feed_Amount = 0;
                float Roll_Width = 0;
                double Total_Ups = 0;
                double Make_Ready_Wastage_Running_meter = 0;
                double Break_Down_Wastage_Running_meter = 0;
                double Paper_Amount = 0;
                long Total_Colors = 0;
                long Expected_Execution_Time = 0;
                long Cylinder_Tool_ID = 0;
                string Cylinder_Code = "";
                double Cylinder_Circumference_MM = 0, Cylinder_Circumference_Inch = 0, Cylinder_Width = 0;
                int No_Of_Teeth = 0;
                double Machine_Speed = 0;
                string Paper_Size = "", Cut_size = "", Die_Cut_size = "";
                double Total_Amount = 0, F_Total_Amount = 0, Unit_Price = 0;
                double Required_Paper_Weight_Kg = 0;
                double Wastage_Paper_Weight_Kg = 0;
                double Total_Paper_Weight_Kg = 0;
                int Plate_Qty = 0;
                string Estimation_Paper_Rate_Type = "";
                double Paper_Rate = 0;
                double Plate_Amount = 0;
                double Machine_Per_Hour_Cost = 0;
                double FaceGSM = 0, ReleaseGSM = 0, AdhesiveGSM = 0;
                string PaperMill = "";
                string RollType = "";
                long FinalQuantityInPcs = 0;
                double RequiredQtyKg = 0;
                double AvgRollLength = 0;
                double ZipperRunningMeter = 0;
                double ZipperWeight = 0;
                double perPieceWeight = 0;
                double perPieceZipperWeight = 0;
                double TotalContentActualWeight = 0;
                string PlateChargesType = GblPlateChargesType;


                Machine_Colors = Convert.ToInt32(Gbl_DT_Machine.Rows[m][10]);
                Gbl_Paper_ID = (int)GblDTRoll.Rows[p][0];
                Roll_Width = (int)GblDTRoll.Rows[p][10];
                Paper_Size = Roll_Width.ToString();
                Paper_GSM = (Convert.IsDBNull(GblDTRoll.Rows[p][2]) ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][2])) + (Convert.IsDBNull(GblDTRoll.Rows[p][3]) ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][3])) + (Convert.IsDBNull(GblDTRoll.Rows[p][4]) ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][4]));
                AvgRollLength = Convert.IsDBNull(GblDTRoll.Rows[p][18]) ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][18]);
                Make_Ready_Wastage_Running_meter = Convert.IsDBNull(Gbl_DT_Machine.Rows[m][30]) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]);
                Break_Down_Wastage_Running_meter = Convert.IsDBNull(Gbl_DT_Machine.Rows[m][32]) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]);
                Machine_Per_Hour_Cost = Convert.IsDBNull(Gbl_DT_Machine.Rows[m][25]) ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][25]);
                Cylinder_Tool_ID = 0;
                Cylinder_Code = "";
                Cylinder_Width = 0;
                No_Of_Teeth = 0;
                Cylinder_Circumference_MM = 0;
                Cylinder_Circumference_Inch = 0;
                FaceGSM = Convert.IsDBNull(GblDTRoll.Rows[p][2]) ? 0 : Math.Round(Convert.ToDouble(GblDTRoll.Rows[p][2]), 2);
                ReleaseGSM = 0;
                AdhesiveGSM = 0;

                PaperMill = Convert.IsDBNull(GblDTRoll.Rows[p][7]) ? "" : Convert.ToString(GblDTRoll.Rows[p][7]);
                RollType = "";
                if (Convert.ToDouble(GblDTRoll.Rows[p][2]) <= 0)
                {
                    Paper_GSM = Math.Round(Math.Round(Convert.IsDBNull(GblDTRoll.Rows[p][5]) ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][5]), 0) * Math.Round(Convert.IsDBNull(GblDTRoll.Rows[p][6]) ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][6]), 0), 0
                    );
                }
                else
                {
                    Paper_GSM = FaceGSM;
                }


                Plate_Qty = (Int16)Convert.ToDouble((Gbl_Front_Color) + Convert.ToDouble(Gbl_Back_Color) + Convert.ToDouble(Gbl_Special_Front_Color) + Convert.ToDouble(Gbl_Special_Back_Color));
                Estimation_Paper_Rate_Type = Convert.IsDBNull(GblDTRoll.Rows[p][13]) ? "" : Convert.ToString(GblDTRoll.Rows[p][13]);
                Paper_Rate = Convert.ToDouble(Convert.IsDBNull(GblDTRoll.Rows[p][8]) ? 0 : GblDTRoll.Rows[p][8]);
                Total_Ups = Gbl_UPS_H * Gbl_UPS_L;
                Gbl_Label_L_With_Around = Rec_L + Gbl_Actual_Around_Gap;

                if (Gbl_Estimation_Unit == "KGS")
                {
                    Total_GSM = Convert.ToDouble(Paper_GSM) + Convert.ToDouble(Gbl_Other_Material_GSM);
                    TotalContentActualWeight = Convert.ToDouble(Gbl_Order_Quantity);

                    if (Total_GSM > 0 && Convert.ToDouble(Paper_GSM) > 0)
                    {
                        perPieceWeight = Math.Round(
                            (Math.Round((Convert.ToDouble(Gbl_Label_H_With_Across) * Convert.ToDouble(Gbl_Label_L_With_Around)) / 1000000, 5)
                             * Total_GSM / 1000),
                            6
                        );

                        if (Convert.ToDouble(Gbl_Job_Zipper_Length) > 0 && Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter) > 0)
                        {
                            perPieceZipperWeight = Math.Round(
                                (Convert.ToDouble(Gbl_Job_Zipper_Length) / 1000 * Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter)) / 1000,
                                6
                            );
                        }
                        else if (Convert.ToDouble(Gbl_Job_Zipper_Length) == 0 && Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter) > 0)
                        {
                            perPieceZipperWeight = Math.Round(
                                Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter) / 1000,
                                6
                            );
                        }
                        else
                        {
                            perPieceZipperWeight = 0;
                        }

                        FinalQuantityInPcs = (long)(Math.Round(Convert.ToDouble(Gbl_Order_Quantity) / perPieceWeight, 0));
                        ZipperWeight = Math.Round(FinalQuantityInPcs * perPieceZipperWeight, 2);
                        FinalQuantityInPcs = (long)(Math.Round((Convert.ToDouble(Gbl_Order_Quantity) - ZipperWeight) / perPieceWeight, 0));

                        RequiredQtyKg = Math.Round(
                            (Math.Round(Convert.ToDouble(Gbl_Order_Quantity) - ZipperWeight, 2)
                             * Math.Round((Convert.ToDouble(Paper_GSM) / Total_GSM) * 100, 2)) / 100,
                            2
                        );

                        Req_Square_Mtr = Math.Round((RequiredQtyKg * 1000) / Convert.ToDouble(Paper_GSM), 2);

                        if (Convert.ToDouble(Roll_Width) > 0)
                        {
                            Req_Running_Mtr = RoundUp(
                                Convert.ToDouble(Req_Square_Mtr) / (Convert.ToDouble(Roll_Width) / 1000),
                                0
                            );

                            if (Convert.ToDouble(Gbl_UPS_L) > 0 && Convert.ToDouble(Gbl_Label_L_With_Around) > 0)
                            {
                                Printing_Impressions = (long)(Math.Round((Req_Running_Mtr * 1000) / Math.Round(Convert.ToDouble(Gbl_Label_L_With_Around) * Convert.ToDouble(Gbl_UPS_L), 2), 0));
                            }
                        }
                    }
                }
                else
                {
                    Total_GSM = Convert.ToDouble(Paper_GSM);
                    Printing_Impressions = (long)(Math.Round(Convert.ToDouble(Gbl_Order_Quantity) / Convert.ToDouble(Total_Ups), 0));
                    FinalQuantityInPcs = (long)(Gbl_Order_Quantity);
                }



                if (Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "DRY WEB OFFSET" || Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "DIGITAL" || Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "ROTO GRAVURE")
                {
                    Feed_Amount = (float)(Math.Round((Convert.ToDouble(Gbl_Label_L_With_Around) * Convert.ToDouble(Gbl_UPS_L)), 2));
                    if (Convert.ToDouble(Req_Running_Mtr) == 0)
                    {
                        Req_Running_Mtr = Math.Round(((Printing_Impressions * Feed_Amount) / 1000), 3);
                        Req_Square_Mtr = Math.Round(((Convert.ToDouble(Roll_Width) / 1000) * Req_Running_Mtr), 3);
                    }
                }


                double TempWasteRunningMeter = 0;
                double TempProcessWastePercentage = 0;
                double TempMachineSlabSpeed = 0;

                //if (Search_In_Machine_Slabs_Flexo(Val(Gbl_DT_Machine.Rows(m)(0)), Req_Running_Mtr, ref TempWasteRunningMeter, ref 0, ref 0, ref 0, ref 0, ref 0, ref "", ref 0, ref 0, ref TempProcessWastePercentage, ref TempMachineSlabSpeed) == true)
                //{
                //}
                //else
                //{
                //}

                Process_Wastage_Percent = 0;
                if (Gbl_Flat_Wastage_Type == "Machine Default")
                {
                    Gbl_Flat_Wastage_Value = 0;
                    // Wastage_Running_Mtr = Round((val(Gbl_DT_Machine.TextMatrix(M, 12)) + val(Gbl_DT_Machine.TextMatrix(M, 24))), 3)
                    if (Gbl_Flat_Wastage_Value > 0)
                    {
                        Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Gbl_Flat_Wastage_Value / (double)100), 3) + Math.Round(((double)Gbl_DT_Machine.Rows[m][12] + (double)Gbl_DT_Machine.Rows[m][24]), 3);
                        Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                    }
                    else
                    {
                        Wastage_Running_Mtr = TempWasteRunningMeter;
                        Wastage_Running_Mtr = Wastage_Running_Mtr + Math.Round((Gbl_DT_Machine.Rows[m][32] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) : 0) + (Gbl_DT_Machine.Rows[m][30] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]) : 0), 3);

                        Process_Wastage_Percent = TempProcessWastePercentage;
                        Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                    }
                    if (GblShadeCardCreationRequired == true)
                        Wastage_Running_Mtr = Wastage_Running_Mtr + 400;
                    double processFlatWasteQty = 0;
                    double processWastePercent = 0;
                    double processWastePercentQty = 0;
                    Process_Wastage_Running_Mtr = 0;
                    for (int i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        processFlatWasteQty = (DBNull.Value.Equals(Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]) ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]));
                        processWastePercent = (DBNull.Value.Equals(Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]) ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]));
                        processWastePercentQty = 0;
                        if (processWastePercent > 0)
                        {
                            processWastePercentQty = Math.Round((Req_Running_Mtr * (processWastePercent / 100)), 0);
                        }
                        Process_Wastage_Running_Mtr = Process_Wastage_Running_Mtr + (processFlatWasteQty > processWastePercentQty ? processFlatWasteQty : processWastePercentQty);
                    }
                    Wastage_Running_Mtr = Wastage_Running_Mtr + Process_Wastage_Running_Mtr;

                }
                else if (Gbl_Flat_Wastage_Type == "Percentage")
                {
                    Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Gbl_Flat_Wastage_Value) / (double)100, 3);
                    Wastage_Running_Mtr = Wastage_Running_Mtr + Math.Round((Gbl_DT_Machine.Rows[m][32] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) : 0) + (Gbl_DT_Machine.Rows[m][30] != DBNull.Value ? Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]) : 0), 3);

                    Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                }
                else if (Gbl_Flat_Wastage_Type == "Running Meter")
                {
                    Wastage_Running_Mtr = Math.Round(Gbl_Flat_Wastage_Value, 3);
                    Wastage_Running_Mtr = Wastage_Running_Mtr + Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]));

                }

                double total_mtr;
                total_mtr = Wastage_Running_Mtr + Req_Running_Mtr;
                if (AvgRollLength > 1)
                    Roll_Change_Wastage = Math.Round(((RoundUp((total_mtr / AvgRollLength), 0) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][34])), 2);
                else if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                    Roll_Change_Wastage = Math.Round(((RoundUp((total_mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])), 0) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][34])), 2);
                Wastage_Running_Mtr = Math.Round((Wastage_Running_Mtr + Roll_Change_Wastage), 3);


                Wastage_Square_Meters = Math.Round((Roll_Width / (double)1000) * Wastage_Running_Mtr, 3);
                Total_Running_Mtr = Math.Round((Wastage_Running_Mtr + Req_Running_Mtr), 3);

                Total_Square_Mtr = Math.Round(((Roll_Width / (double)1000) * Total_Running_Mtr), 3);

                Scrap_Square_Meters = Total_Square_Mtr - (((Rec_H / 1000.0) * (Rec_L / 1000.0)) * Gbl_Order_Quantity);

                if (double.TryParse(Gbl_DT_Machine.Rows[m][24]?.ToString(), out double machineValue) && machineValue > 0)
                {
                    Total_Req_Machine_Time = (long)(Math.Round(Total_Running_Mtr / machineValue, 0));
                }

                Total_Req_Machine_Time += (long)(Convert.ToDouble(Gbl_DT_Machine.Rows[m][19] ?? 0) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][31] ?? 0) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][20] ?? 0));

                if (double.TryParse(Gbl_DT_Machine.Rows[m][35]?.ToString(), out double value35) && value35 > 1)
                {
                    if (double.TryParse(Gbl_DT_Machine.Rows[m][36]?.ToString(), out double value36) && value36 > 0)
                    {
                        Total_Req_Machine_Time += (long)(Math.Round((RoundUp((Total_Running_Mtr / value35), 0) - 1) * value36, 2));
                    }
                }
                Required_Paper_Weight_Kg = Math.Round((Req_Square_Mtr * Paper_GSM) / 1000.0, 3);
                Wastage_Paper_Weight_Kg = Math.Round((Wastage_Square_Meters * Paper_GSM) / 1000.0, 3);
                Total_Paper_Weight_Kg = Math.Round((Total_Square_Mtr * Paper_GSM) / 1000.0, 3);

                if (!string.IsNullOrEmpty(Estimation_Paper_Rate_Type))
                {
                    string rateType = Estimation_Paper_Rate_Type.Trim().ToUpper();
                    if (rateType == "SQM" || rateType == "SQUARE METER")
                    {
                        Paper_Amount = Math.Round((Total_Square_Mtr * Paper_Rate), 2);
                    }
                    else if (rateType.Contains("KG"))
                    {
                        Paper_Amount = Math.Round((Total_Paper_Weight_Kg * Paper_Rate), 2);
                    }
                }

                double Op_Amt = 0;
                // 'Dim ST_Op_Amt As String = ""
                double Pub_RMT = 0;
                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double machineCost = 0;
                DataTable DTOPR = new DataTable();
                DTOPR = Gbl_DT_Operation.Copy();
                DTOPR.Clear();

                for (var j = 0; j <= GblDTOprFactors.Rows.Count - 1; j++)
                {
                    for (var i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        if (Gbl_DT_Operation.Rows[i][6]?.ToString() == "Pre")
                        {
                            Pub_RMT = Total_Running_Mtr;
                        }
                        else
                        {
                            string operationValue = Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString();
                            if (operationValue == "Actual Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr;
                            }
                            else if (operationValue == "Actual Running Meter + Make Ready Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr + Make_Ready_Wastage_Running_meter;
                            }
                            else if (operationValue == "Actual Running Meter + Wastage Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr + Wastage_Running_Mtr;
                            }
                            else if (operationValue == "Actual Running Meter + Make Ready Running Meter + Wastage Running Meter")
                            {
                                Pub_RMT = Total_Running_Mtr;
                            }
                        }


                        if (Gbl_DT_Operation.Rows[i][4]?.ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i][7] = Math.Round(Gbl_Sheet_L / 25.4, 2);
                            Gbl_DT_Operation.Rows[i][8] = Math.Round(Gbl_Sheet_W / 25.4, 2);
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i][7] = 0;
                            Gbl_DT_Operation.Rows[i][8] = 0;
                        }
                        double QTY = 0;
                        string typeofcharge = "";
                        typeofcharge = Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString();
                        if (typeofcharge.Contains("Order Quantity") || typeofcharge.Contains("OrderQuantity"))
                            QTY = Gbl_Order_Quantity;
                        else if (typeofcharge.Contains("Unit"))
                            QTY = Gbl_Order_Quantity;  // Final_Quantity
                        else if (typeofcharge.Contains("Meter"))
                            QTY = Pub_RMT;

                        int k = 0;
                        for (k = 0; k < GblDTOprSlabs.Rows.Count; k++)
                        {
                            int processID_Op = Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"]);
                            int processID_Slab = GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"]);
                            if (processID_Op == processID_Slab)
                            {
                                double fromQty = GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"]);
                                int processID_Factor = GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"]);
                                if (fromQty >= 1 && processID_Factor == processID_Slab)
                                {
                                    double toQty = GblDTOprSlabs.Rows[k]["ToQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["ToQty"]);
                                    string rateFactor_Factor = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString();
                                    string rateFactor_Slab = GblDTOprSlabs.Rows[k]["RateFactor"] == DBNull.Value ? "" : GblDTOprSlabs.Rows[k]["RateFactor"].ToString();
                                    if (QTY >= fromQty && QTY <= toQty && rateFactor_Factor.Replace("-", "") == rateFactor_Slab.Replace("-", ""))
                                    {
                                        Gbl_DT_Operation.Rows[i][1] = GblDTOprSlabs.Rows[k]["Rate"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["Rate"]);
                                        Gbl_DT_Operation.Rows[i][2] = GblDTOprSlabs.Rows[k]["MinimumCharges"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["MinimumCharges"]);
                                        break;
                                    }
                                }
                            }
                        }

                        var Amt = 0;//Calculate_Operations(Gbl_DT_Operation.Rows[i][0].ToString(), Gbl_DT_Operation.Rows[i][1] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][1]), Gbl_DT_Operation.Rows[i][2] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][2]), (long)Gbl_Order_Quantity, FinalQuantityInPcs, Gbl_DT_Operation.Rows[i][3] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][3]), (long)Total_Paper_Weight_Kg, (long)Total_Ups, 0, Gbl_DT_Operation.Rows[i][7] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][7]), Gbl_DT_Operation.Rows[i][8] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][8]), Total_Colors, Pub_RMT, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, (long)Gbl_Order_Quantity, Gbl_DT_Operation.Rows[i]["PagesPerSection"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"]), Gbl_DT_Operation.Rows[i]["NoOfForms"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"]));

                        Gbl_DT_Operation.Rows[i][11] = Amt;
                        Gbl_DT_Operation.Rows[i][12] = Gbl_DT_plan.Rows.Count + 1;
                        Gbl_DT_Operation.Rows[i][15] = QTY;
                        Gbl_DT_Operation.Rows[i][16] = Total_Ups;
                        Gbl_DT_Operation.Rows[i][17] = 1;
                        Gbl_DT_Operation.Rows[i][19] = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"];
                        Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;
                        if (GblDTOprFactors.Rows[j]["MachineID"] != DBNull.Value && Convert.ToInt32(GblDTOprFactors.Rows[j]["MachineID"]) > 0)
                        {
                            Gbl_DT_Operation.Rows[i]["MachineID"] = Convert.ToInt32(GblDTOprFactors.Rows[j]["MachineID"]);
                            Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                            Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                            Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                            Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                        }


                        if (QTY > 0)
                        {
                            if ((Int32)Gbl_DT_Operation.Rows[i]["MachineSpeed"] > 0)
                                opExecutionTime = Math.Round((QTY / (double)Gbl_DT_Operation.Rows[i]["MachineSpeed"]));
                            else
                                opExecutionTime = 0;
                            Gbl_DT_Operation.Rows[i]["ExecutionTime"] = opExecutionTime;
                        }
                        Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = Math.Round(opExecutionTime + (double)Gbl_DT_Operation.Rows[i]["MakeReadyTime"] + (double)Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]);
                        opTotalExecutionTime = Math.Round((opExecutionTime + (double)Gbl_DT_Operation.Rows[i]["MakeReadyTime"]) + (double)Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]);
                        machineCost = Math.Round(Math.Round((opTotalExecutionTime / 60), 2) * (double)Gbl_DT_Operation.Rows[i]["MachinePerHourCost"]);
                        Gbl_DT_Operation.Rows[i]["MachineCost"] = machineCost;

                        if (Gbl_DT_Operation.Rows[i]["ProcessID"] == GblDTOprFactors.Rows[j]["ProcessID"])
                        {
                            DTOPR.ImportRow(Gbl_DT_Operation.Rows[i]);
                            Op_Amt = Op_Amt + Amt;
                        }
                    }
                }

                Rf_Dt_Opr.Merge(DTOPR);

                Gbl_Big_H = 0;

                {
                    var withBlock = Gbl_DT_plan;
                    Machine_Speed = Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]);
                    Total_Colors = Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color;



                    Paper_Size = Convert.ToString(GblDTRoll.Rows[p][10]);
                    Cut_size = Math.Round(Gbl_Sheet_W, 2) + "x" + Math.Round(Gbl_Sheet_L, 2);
                    Die_Cut_size = Gbl_Die_Size_H + "x" + Gbl_Die_Size_L;
                    Total_Amount = Math.Round(Plate_Amount + Paper_Amount, 2);
                    if (Gbl_Half_Ups_Logic)
                        Gbl_UPS_L /= 2;
                    F_Total_Amount = Total_Amount;
                    if (F_Total_Amount > 0 && Convert.ToDouble(Gbl_Order_Quantity) > 0)
                        Unit_Price = Math.Round(F_Total_Amount / Convert.ToDouble(Gbl_Order_Quantity), 2);
                    else
                        Unit_Price = 0;

                    withBlock.NewRow();
                    double Operation_Cost = 0;

                    withBlock.Rows.Add(Gbl_Machine_ID, Gbl_Machine_Name, 0, "", Machine_Colors, Gbl_Paper_ID, Paper_Size, "", 1, 1, Gbl_UPS_H, Gbl_UPS_L, Total_Ups, "", "", 0, Process_Wastage_Percent, Wastage_Paper_Weight_Kg, Gbl_Grain_Direction, Plate_Qty, 0, 0, 0, 0, 0, 0, Total_Paper_Weight_Kg, 0, Paper_Rate, Paper_Amount, Printing_Impressions, Printing_Impressions, 0, 0, 1, 0, 0, Gbl_Order_Quantity, Total_Colors, Total_Amount, 0, 0, Gbl_Printing_Style, "", Expected_Execution_Time, Total_Req_Machine_Time, Gbl_Paper_Detail, "Roto Gravure Planning", Estimation_Paper_Rate_Type, "", 0, 1, F_Total_Amount, Unit_Price,
                        "", 1, 0, Special_Color_Front_Charges, Special_Color_Back_Charges, Special_Color_Front_Amount, Special_Color_Back_Amount, Operation_Cost, withBlock.Rows.Count + 1, 0, 0, GblMainPaperGroup, Gbl_Machine_Type, Cylinder_Tool_ID, Cylinder_Code, Cylinder_Circumference_Inch, Cylinder_Circumference_MM, Cylinder_Width, No_Of_Teeth, Feed_Amount, Gbl_Standard_AC_Gap, Gbl_Actual_Around_Gap, Gbl_Side_Wastage_Strip, Req_Running_Mtr, Make_Ready_Wastage_Running_meter, Break_Down_Wastage_Running_meter, Wastage_Running_Mtr, Process_Wastage_Running_Mtr, Total_Running_Mtr, Req_Square_Mtr, Total_Square_Mtr,
                        Wastage_Square_Meters, Scrap_Square_Meters, Machine_Speed, Machine_Per_Hour_Cost, Paper_GSM, Required_Paper_Weight_Kg, Roll_Change_Wastage, 0, FaceGSM, ReleaseGSM, AdhesiveGSM, PaperMill, RollType, 0, Paper_Amount, 0, Gbl_windingdirection, Gbl_labeltype, Gbl_finishedformat, Gbl_LabelPerRoll, Gbl_dietype, Gbl_CoreInnerDia, Gbl_CoreOuterDia, FinalQuantityInPcs, Gbl_Estimation_Unit, Gbl_Other_Material_GSM, PlanOtherMaterialGSMSettingJSON, TotalContentActualWeight, Gbl_Orientation, PlanContName, false);
                }
            }
            catch (Exception ex)
            {
                str = ex.Message;
            }
        }

        private void Add_Roto_Gravure_Plan_Special_Size(double Max_Roll_Width, int m, int p, double Rec_L, double Rec_H)
        {
            try
            {
                double Req_Running_Mtr = 0;
                double Total_GSM = 0;
                double Paper_GSM = 0;
                int Machine_Colors = 0;
                double Wastage_Square_Meters = 0;
                double Total_Square_Mtr = 0;
                double Process_Wastage_Percent = 0;
                double Scrap_Square_Meters = 0;
                double Roll_Change_Wastage = 0;
                long Printing_Impressions = 0;
                double Wastage_Running_Mtr = 0;
                double Process_Wastage_Running_Mtr = 0;
                double Total_Running_Mtr = 0;
                double Req_Square_Mtr = 0;
                long Total_Req_Machine_Time = 0;
                float Feed_Amount = 0;
                float Roll_Width = 0;
                double Total_Ups = 0;
                double Make_Ready_Wastage_Running_meter = 0;
                double Break_Down_Wastage_Running_meter = 0;
                double Paper_Amount = 0;
                long Total_Colors = 0;
                long Expected_Execution_Time = 0;
                long Cylinder_Tool_ID = 0;
                string Cylinder_Code = "";
                double Cylinder_Circumference_MM = 0, Cylinder_Circumference_Inch = 0, Cylinder_Width = 0;
                int No_Of_Teeth = 0;
                double Machine_Speed = 0;
                string Paper_Size = "", Cut_size = "", Die_Cut_size = "";
                double Total_Amount = 0, F_Total_Amount = 0, Unit_Price = 0;
                double Required_Paper_Weight_Kg = 0;
                double Wastage_Paper_Weight_Kg = 0;
                double Total_Paper_Weight_Kg = 0;
                int Plate_Qty = 0;
                string Estimation_Paper_Rate_Type = "";
                double Paper_Rate = 0;
                double Plate_Rate = 0;
                double Plate_Amount = 0;
                double Machine_Per_Hour_Cost = 0;
                double FaceGSM = 0, ReleaseGSM = 0, AdhesiveGSM = 0;
                string PaperMill = "";
                string RollType = "";
                long FinalQuantityInPcs = 0;
                double RequiredQtyKg = 0;
                double AvgRollLength = 0;
                double ZipperRunningMeter = 0;
                double ZipperWeight = 0;
                double perPieceWeight = 0;
                double perPieceZipperWeight = 0;
                double TotalContentActualWeight = 0;
                string PlateChargesType = GblPlateChargesType;

                Machine_Colors = Convert.ToInt32(Gbl_DT_Machine.Rows[m][10]);
                Gbl_Paper_ID = 0;
                Roll_Width = (float)Max_Roll_Width;
                Paper_Size = Roll_Width.ToString();

                // Paper GSM = Face + Release + Adhesive GSM
                Paper_GSM =
                    Convert.ToDouble(GblDTRoll.Rows[p][2] == DBNull.Value ? 0 : GblDTRoll.Rows[p][2]) +
                    Convert.ToDouble(GblDTRoll.Rows[p][3] == DBNull.Value ? 0 : GblDTRoll.Rows[p][3]) +
                    Convert.ToDouble(GblDTRoll.Rows[p][4] == DBNull.Value ? 0 : GblDTRoll.Rows[p][4]);

                AvgRollLength = Convert.ToDouble(GblDTRoll.Rows[p][18] == DBNull.Value ? 0 : GblDTRoll.Rows[p][18]);

                Make_Ready_Wastage_Running_meter = Convert.ToDouble(Gbl_DT_Machine.Rows[m][30] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][30]);

                Plate_Rate = Convert.ToDouble(Gbl_DT_Machine.Rows[m]["PlateCharges"] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m]["PlateCharges"]);

                PlateChargesType = Gbl_DT_Machine.Rows[m]["PlateChargesType"] == DBNull.Value
                    ? "Rate/Plate"
                    : Gbl_DT_Machine.Rows[m]["PlateChargesType"].ToString();

                if (Convert.ToDouble(Gbl_Plan_Make_Ready_Wastage) > 0)
                {
                    Make_Ready_Wastage_Running_meter = Convert.ToDouble(Gbl_Plan_Make_Ready_Wastage);
                }

                Break_Down_Wastage_Running_meter = Convert.ToDouble(Gbl_DT_Machine.Rows[m][32] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][32]);
                Machine_Per_Hour_Cost = Convert.ToDouble(Gbl_DT_Machine.Rows[m][25] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m][25]);

                Cylinder_Tool_ID = 0;
                Cylinder_Code = "";
                Cylinder_Width = 0;
                No_Of_Teeth = 0;
                Cylinder_Circumference_MM = 0;
                Cylinder_Circumference_Inch = 0;

                FaceGSM = Math.Round(Convert.ToDouble(GblDTRoll.Rows[p][2] == DBNull.Value ? 0 : GblDTRoll.Rows[p][2]), 2);
                ReleaseGSM = 0;
                AdhesiveGSM = 0;

                PaperMill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();
                RollType = "";

                if (Convert.ToDouble(GblDTRoll.Rows[p][2]) <= 0)
                {
                    double gsmVal1 = Math.Round(Convert.ToDouble(GblDTRoll.Rows[p][5] == DBNull.Value ? 0 : GblDTRoll.Rows[p][5]), 0);
                    double gsmVal2 = Math.Round(Convert.ToDouble(GblDTRoll.Rows[p][6] == DBNull.Value ? 0 : GblDTRoll.Rows[p][6]), 0);
                    Paper_GSM = Math.Round(gsmVal1 * gsmVal2, 0);
                }
                else
                {
                    Paper_GSM = FaceGSM;
                }
                Gbl_Paper_Detail = "Quality=" + Gbl_Paper_Quality.Trim()
                    + " and Thickness=" + Gbl_Paper_Thickness
                    + " and Width=" + Paper_Size
                    + " and Manufecturer=" + Gbl_Paper_Mill.Trim();

                Plate_Qty = Convert.ToInt32(Gbl_Front_Color) + Convert.ToInt32(Gbl_Back_Color) +
                            Convert.ToInt32(Gbl_Special_Front_Color) + Convert.ToInt32(Gbl_Special_Back_Color);

                Estimation_Paper_Rate_Type = GblDTRoll.Rows[p][13] == DBNull.Value ? "" : GblDTRoll.Rows[p][13].ToString();
                Paper_Rate = Convert.ToDouble(GblDTRoll.Rows[p][8] == DBNull.Value ? 0 : GblDTRoll.Rows[p][8]);

                Total_Ups = Gbl_UPS_H * Gbl_UPS_L;
                Gbl_Label_L_With_Around = Rec_L + Gbl_Actual_Around_Gap;
                if (Gbl_Estimation_Unit == "KGS")
                {
                    TotalContentActualWeight = Convert.ToDouble(Gbl_Order_Quantity);
                    Total_GSM = Convert.ToDouble(Paper_GSM) + Convert.ToDouble(Gbl_Other_Material_GSM);

                    if (Total_GSM > 0 && Convert.ToDouble(Paper_GSM) > 0)
                    {
                        perPieceWeight = Math.Round(
                            (Math.Round((Convert.ToDouble(Gbl_Label_H_With_Across) * Convert.ToDouble(Gbl_Label_L_With_Around)) / 1000000, 5)
                             * Total_GSM / 1000), 6);

                        if (Convert.ToDouble(Gbl_Job_Zipper_Length) > 0 && Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter) > 0)
                        {
                            perPieceZipperWeight = Math.Round(
                                ((Convert.ToDouble(Gbl_Job_Zipper_Length) / 1000) *
                                 Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter)) / 1000, 6);
                        }
                        else if (Convert.ToDouble(Gbl_Job_Zipper_Length) == 0 && Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter) > 0)
                        {
                            perPieceZipperWeight = Math.Round(Convert.ToDouble(Gbl_Job_Zipper_Weight_Per_Meter) / 1000, 6);
                        }
                        else
                        {
                            perPieceZipperWeight = 0;
                        }

                        FinalQuantityInPcs = (long)(Math.Round(Convert.ToDouble(Gbl_Order_Quantity) / perPieceWeight, 0));
                        ZipperWeight = Math.Round(FinalQuantityInPcs * perPieceZipperWeight, 2);
                        FinalQuantityInPcs = (long)(Math.Round((Convert.ToDouble(Gbl_Order_Quantity) - ZipperWeight) / perPieceWeight, 0));

                        RequiredQtyKg = Math.Round(
                            Math.Round((Convert.ToDouble(Gbl_Order_Quantity) - ZipperWeight), 2)
                            * Math.Round((Convert.ToDouble(Paper_GSM) / Total_GSM) * 100, 2) / 100, 2);

                        Req_Square_Mtr = Math.Round((RequiredQtyKg * 1000) / Convert.ToDouble(Paper_GSM), 2);

                        if (Convert.ToDouble(Roll_Width) > 0)
                        {
                            Req_Running_Mtr = RoundUp((Req_Square_Mtr / (Convert.ToDouble(Roll_Width) / 1000)), 0);

                            if (Convert.ToDouble(Gbl_UPS_L) > 0 && Convert.ToDouble(Gbl_Label_L_With_Around) > 0)
                            {
                                Printing_Impressions = (long)(Math.Round((Req_Running_Mtr * 1000) / Math.Round((Convert.ToDouble(Gbl_Label_L_With_Around) * Convert.ToDouble(Gbl_UPS_L)), 2), 0));
                            }
                        }
                    }
                }
                else
                {
                    Total_GSM = Convert.ToDouble(Paper_GSM);
                    Printing_Impressions = (long)(Math.Round(Convert.ToDouble(Gbl_Order_Quantity) / Total_Ups, 0));
                    FinalQuantityInPcs = (long)Gbl_Order_Quantity;
                }

                if (Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "DRY WEB OFFSET" || Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "DIGITAL" || Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "ROTO GRAVURE")
                {
                    Feed_Amount = (float)(Math.Round(Convert.ToDouble(Gbl_Label_L_With_Around) * Convert.ToDouble(Gbl_UPS_L), 2));
                    if (Convert.ToDouble(Req_Running_Mtr) == 0)
                    {
                        Req_Running_Mtr = Math.Round((Printing_Impressions * Feed_Amount) / 1000, 3);
                        Req_Square_Mtr = Math.Round((Convert.ToDouble(Roll_Width) / 1000) * Req_Running_Mtr, 3);
                    }
                }

                double TempWasteRunningMeter = 0;
                double TempProcessWastePercentage = 0;
                double TempMachineSlabSpeed = 0;

                double abhi = 0;
                long abhiL = 0;
                string abhistr = "";
                if (Search_In_Machine_Slabs_Flexo((long)(Gbl_DT_Machine.Rows[m][0]), Req_Running_Mtr, ref TempWasteRunningMeter, ref abhi, ref abhi, ref abhi, ref abhi, ref abhi, ref abhistr, ref abhiL, ref abhi, ref TempProcessWastePercentage, ref TempMachineSlabSpeed))
                {
                    // Uncomment and implement if needed
                    // Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]), 3);
                }
                else
                {
                    // Uncomment and implement if needed
                    // Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]), 3);
                }

                Process_Wastage_Percent = 0;

                if (Gbl_Flat_Wastage_Type == "Machine Default")
                {
                    Gbl_Flat_Wastage_Value = 0;

                    if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                    {
                        Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Convert.ToDouble(Gbl_Flat_Wastage_Value) / 100), 3)
                                             + Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][12]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]), 3);
                        Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                    }
                    else
                    {
                        Wastage_Running_Mtr = TempWasteRunningMeter;
                        Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]), 3);
                        Process_Wastage_Percent = TempProcessWastePercentage;
                        Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                    }

                    if (GblShadeCardCreationRequired)
                    {
                        Wastage_Running_Mtr += 400;
                    }

                    double processFlatWasteQty = 0;
                    double processWastePercent = 0;
                    double processWastePercentQty = 0;
                    Process_Wastage_Running_Mtr = 0;

                    for (int i = 0; i < Gbl_DT_Operation.Rows.Count; i++)
                    {
                        processFlatWasteQty = Convert.ToDouble(
                            Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"] is DBNull ? 0 : Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]
                        );

                        processWastePercent = Convert.ToDouble(
                            Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"] is DBNull ? 0 : Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]
                        );

                        processWastePercentQty = 0;
                        if (processWastePercent > 0)
                        {
                            processWastePercentQty = Math.Round((Req_Running_Mtr * processWastePercent / 100), 0);
                        }

                        Process_Wastage_Running_Mtr += (processFlatWasteQty > processWastePercentQty)
                                                        ? processFlatWasteQty
                                                        : processWastePercentQty;
                    }

                    Wastage_Running_Mtr += Process_Wastage_Running_Mtr;
                }
                else if (Gbl_Flat_Wastage_Type == "Percentage")
                {
                    Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Convert.ToDouble(Gbl_Flat_Wastage_Value)) / 100, 3);
                    Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]), 3);
                    Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                }
                else if (Gbl_Flat_Wastage_Type == "Running Meter")
                {
                    Wastage_Running_Mtr = Math.Round(Convert.ToDouble(Gbl_Flat_Wastage_Value), 3);
                    Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]), 3);
                }
                double total_mtr = Wastage_Running_Mtr + Req_Running_Mtr;

                if (Convert.ToDouble(AvgRollLength) > 1)
                {
                    Roll_Change_Wastage = Math.Round(((RoundUp(total_mtr / Convert.ToDouble(AvgRollLength), 0) - 1) *
                                                       Convert.ToDouble(Gbl_DT_Machine.Rows[m][34])), 2);
                }
                else
                {
                    if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                    {
                        Roll_Change_Wastage = Math.Round(((RoundUp(total_mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]), 0) - 1) *
                                                           Convert.ToDouble(Gbl_DT_Machine.Rows[m][34])), 2);
                    }
                }

                Wastage_Running_Mtr = Math.Round(Wastage_Running_Mtr + Roll_Change_Wastage, 3);

                Wastage_Square_Meters = Math.Round((Roll_Width / 1000) * Wastage_Running_Mtr, 3);
                Total_Running_Mtr = Math.Round(Wastage_Running_Mtr + Req_Running_Mtr, 3);
                Total_Square_Mtr = Math.Round((Roll_Width / 1000) * Total_Running_Mtr, 3);

                Scrap_Square_Meters = Total_Square_Mtr - (((Rec_H / 1000.0) * (Rec_L / 1000.0)) * Gbl_Order_Quantity);

                if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]) > 0)
                {
                    Total_Req_Machine_Time = (long)(Math.Round(Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]), 0));
                }

                Total_Req_Machine_Time += (long)(Convert.ToDouble(Gbl_DT_Machine.Rows[m][19]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][31]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][20]));

                if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                {
                    Total_Req_Machine_Time += (long)(Math.Round(((RoundUp(Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]), 0) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][36])), 2));
                }

                Required_Paper_Weight_Kg = Math.Round((Req_Square_Mtr * Paper_GSM) / 1000, 3);
                Wastage_Paper_Weight_Kg = Math.Round((Wastage_Square_Meters * Paper_GSM) / 1000, 3);
                Total_Paper_Weight_Kg = Math.Round((Total_Square_Mtr * Paper_GSM) / 1000, 3);

                if (TotalContentActualWeight == 0)
                    TotalContentActualWeight = Required_Paper_Weight_Kg;

                if (Estimation_Paper_Rate_Type.ToUpper() == "SQM" || Estimation_Paper_Rate_Type.ToUpper() == "SQUARE METER")
                {
                    Paper_Amount = Math.Round(Total_Square_Mtr * Paper_Rate, 2);
                }
                else if (Estimation_Paper_Rate_Type.ToUpper().Contains("KG"))
                {
                    Paper_Amount = Math.Round(Total_Paper_Weight_Kg * Paper_Rate, 2);
                }

                double opAmt = 0;
                double pubRmt = 0;
                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double machineCost = 0;

                DataTable dtOpr = Gbl_DT_Operation.Copy();
                dtOpr.Clear();

                for (int j = 0; j < GblDTOprFactors.Rows.Count; j++)
                {
                    for (int i = 0; i < Gbl_DT_Operation.Rows.Count; i++)
                    {
                        if (Gbl_DT_Operation.Rows[i][6].ToString() == "Pre")
                            pubRmt = Total_Running_Mtr;
                        else
                        {
                            string rmtType = Convert.IsDBNull(Gbl_DT_Operation.Rows[i][5]) ? "Actual Running Meter" : Gbl_DT_Operation.Rows[i][5].ToString();

                            if (rmtType == "Actual Running Meter")
                                pubRmt = Req_Running_Mtr;
                            else if (rmtType == "Actual Running Meter + Make Ready Running Meter")
                                pubRmt = Req_Running_Mtr + Make_Ready_Wastage_Running_meter;
                            else if (rmtType == "Actual Running Meter + Wastage Running Meter")
                                pubRmt = Req_Running_Mtr + Wastage_Running_Mtr;
                            else if (rmtType == "Actual Running Meter + Make Ready Running Meter + Wastage Running Meter")
                                pubRmt = Total_Running_Mtr;
                        }

                        if (Gbl_DT_Operation.Rows[i][4].ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i][7] = Math.Round(Gbl_Sheet_L / 25.4, 2);
                            Gbl_DT_Operation.Rows[i][8] = Math.Round(Gbl_Sheet_W / 25.4, 2);
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i][7] = 0;
                            Gbl_DT_Operation.Rows[i][8] = 0;
                        }

                        double qty = 0;
                        string typeOfCharge = Convert.IsDBNull(Gbl_DT_Operation.Rows[i][0]) ? "" : Gbl_DT_Operation.Rows[i][0].ToString();
                        if (typeOfCharge.Contains("Order Quantity") || typeOfCharge.Contains("OrderQuantity"))
                            qty = Gbl_Order_Quantity;
                        else if (typeOfCharge.Contains("Unit"))
                            qty = Gbl_Order_Quantity;
                        else if (typeOfCharge.Contains("Meter"))
                            qty = pubRmt;
                        else if (typeOfCharge.Contains("PCS"))
                            qty = FinalQuantityInPcs;

                        for (int k = 0; k < GblDTOprSlabs.Rows.Count; k++)
                        {
                            if (Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] ?? 0) == Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"] ?? 0))
                            {
                                if (Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"] ?? 0) >= 1 && Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"] ?? 0) == Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"] ?? 0))
                                {
                                    string factor1 = (GblDTOprFactors.Rows[j]["RateFactor"] ?? "").ToString().Replace("-", "");
                                    string factor2 = (GblDTOprSlabs.Rows[k]["RateFactor"] ?? "").ToString().Replace("-", "");

                                    if (qty >= Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"]) &&
                                        qty <= Convert.ToDouble(GblDTOprSlabs.Rows[k]["ToQty"]) &&
                                        factor1 == factor2)
                                    {
                                        Gbl_DT_Operation.Rows[i][1] = Convert.ToDouble(GblDTOprSlabs.Rows[k]["Rate"] ?? 0);
                                        Gbl_DT_Operation.Rows[i][2] = Convert.ToDouble(GblDTOprSlabs.Rows[k]["MinimumCharges"] ?? 0);
                                        break;
                                    }
                                }
                            }
                        }

                        double amt = 0;// Calculate_Operations(Gbl_DT_Operation.Rows[i][0]?.ToString() ?? "", Convert.ToDouble(Gbl_DT_Operation.Rows[i][1] ?? 0), Convert.ToDouble(Gbl_DT_Operation.Rows[i][2] ?? 0), (long)Gbl_Order_Quantity, FinalQuantityInPcs, Convert.ToDouble(Gbl_DT_Operation.Rows[i][3] ?? 0), (long)Total_Paper_Weight_Kg, (long)Total_Ups, 0, Convert.ToDouble(Gbl_DT_Operation.Rows[i][7] ?? 0), Convert.ToDouble(Gbl_DT_Operation.Rows[i][8] ?? 0), Total_Colors, pubRmt, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, (long)Gbl_Order_Quantity, Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"] ?? 1), Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"] ?? 1));

                        Gbl_DT_Operation.Rows[i][11] = amt;
                        Gbl_DT_Operation.Rows[i][12] = Gbl_DT_plan.Rows.Count + 1;
                        Gbl_DT_Operation.Rows[i][15] = qty;
                        Gbl_DT_Operation.Rows[i][16] = Total_Ups;
                        Gbl_DT_Operation.Rows[i][17] = 1;
                        Gbl_DT_Operation.Rows[i][19] = GblDTOprFactors.Rows[j]["RateFactor"] ?? "";
                        Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;

                        if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] ?? 0) > 0)
                        {
                            Gbl_DT_Operation.Rows[i]["MachineID"] = GblDTOprFactors.Rows[j]["MachineID"];
                            Gbl_DT_Operation.Rows[i]["MachineSpeed"] = GblDTOprFactors.Rows[j]["MachineSpeed"] ?? 0;
                            Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = GblDTOprFactors.Rows[j]["MakeReadyTime"] ?? 0;
                            Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = GblDTOprFactors.Rows[j]["JobChangeOverTime"] ?? 0;
                            Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = GblDTOprFactors.Rows[j]["MachinePerHourCost"] ?? 0;
                        }

                        if (qty > 0)
                        {
                            if (Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"] ?? 0) > 0)
                                opExecutionTime = Math.Round(qty / Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"]));
                            else
                                opExecutionTime = 0;

                            Gbl_DT_Operation.Rows[i]["ExecutionTime"] = opExecutionTime;
                        }

                        opTotalExecutionTime = Math.Round(opExecutionTime +
                            Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"] ?? 0) +
                            Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] ?? 0));

                        Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = opTotalExecutionTime;

                        machineCost = Math.Round((opTotalExecutionTime / 60.0) * Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] ?? 0), 2);
                        Gbl_DT_Operation.Rows[i]["MachineCost"] = machineCost;

                        if (Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] ?? 0) == Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"] ?? 0))
                        {
                            dtOpr.ImportRow(Gbl_DT_Operation.Rows[i]);
                            opAmt += amt;
                        }
                    }
                }

                Rf_Dt_Opr.Merge(dtOpr);

                int unitpricedecimal = 2;
                int finalCostRoundDecimal = 2;
                if (Gbl_DT_CompanyMaster_Flags.Rows.Count > 0)
                {
                    unitpricedecimal = Convert.ToInt32(string.IsNullOrEmpty(Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationPerUnitCostDecimalPlace"].ToString()) ? "2" : Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationPerUnitCostDecimalPlace"].ToString());
                    finalCostRoundDecimal = Convert.ToInt32(string.IsNullOrEmpty(Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationRoundOffDecimalPlace"].ToString()) ? "2" : Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationRoundOffDecimalPlace"].ToString());

                    if (unitpricedecimal == 0)
                        unitpricedecimal = 2;
                    if (finalCostRoundDecimal == 0)
                        finalCostRoundDecimal = 2;
                }

                opAmt = Math.Round(opAmt, finalCostRoundDecimal);
                Machine_Speed = Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]);
                Total_Colors = Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color;

                Plate_Amount = Convert.ToDouble(Plate_Qty) * Convert.ToDouble(Plate_Rate);
                Cut_size = Math.Round(Gbl_Sheet_W, 2).ToString() + "x" + Math.Round(Gbl_Sheet_L, 2).ToString();
                Die_Cut_size = Gbl_Die_Size_H.ToString() + "x" + Gbl_Die_Size_L.ToString();

                Total_Amount = 0;
                Total_Amount = Math.Round(Plate_Amount + Paper_Amount, finalCostRoundDecimal);
                F_Total_Amount = Total_Amount;

                if (Convert.ToDouble(F_Total_Amount) > 0 && Convert.ToDouble(Gbl_Order_Quantity) > 0)
                {
                    Unit_Price = Math.Round(Convert.ToDouble(F_Total_Amount) / Convert.ToDouble(Gbl_Order_Quantity), unitpricedecimal);
                }
                else
                {
                    Unit_Price = 0;
                }
                DataRow newRow = Gbl_DT_plan.NewRow();
                double Operation_Cost = 0;
                Gbl_DT_plan.Rows.Add(Gbl_Machine_ID, Gbl_Machine_Name, 0, "", Machine_Colors, Gbl_Paper_ID, Paper_Size, "", 1, 1, Gbl_UPS_H, Gbl_UPS_L, Total_Ups, "", "", 0, Process_Wastage_Percent, Wastage_Paper_Weight_Kg, Gbl_Grain_Direction, Plate_Qty, Plate_Rate, Plate_Amount, 0, 0, 0, 0, Total_Paper_Weight_Kg, 0, Paper_Rate, Paper_Amount, Printing_Impressions, Printing_Impressions, 0, 0, 1, 0, 0, Gbl_Order_Quantity, Total_Colors, Total_Amount, 0, 0, Gbl_Printing_Style, "", Expected_Execution_Time, Total_Req_Machine_Time, Gbl_Paper_Detail, "Roto Gravure Planning", Estimation_Paper_Rate_Type, "", 0, 1, F_Total_Amount, Unit_Price, "", 1, 0, Special_Color_Front_Charges, Special_Color_Back_Charges, Special_Color_Front_Amount, Special_Color_Back_Amount, Operation_Cost, Gbl_DT_plan.Rows.Count + 1, 0, 0, GblMainPaperGroup, Gbl_Machine_Type, Cylinder_Tool_ID, Cylinder_Code, Cylinder_Circumference_Inch, Cylinder_Circumference_MM, Cylinder_Width, No_Of_Teeth, Feed_Amount, Gbl_Standard_AC_Gap, Gbl_Actual_Around_Gap, Gbl_Side_Wastage_Strip, Req_Running_Mtr, Make_Ready_Wastage_Running_meter, Break_Down_Wastage_Running_meter, Wastage_Running_Mtr, Process_Wastage_Running_Mtr, Total_Running_Mtr, Req_Square_Mtr, Total_Square_Mtr, Wastage_Square_Meters, Scrap_Square_Meters, Machine_Speed, Machine_Per_Hour_Cost, Paper_GSM, Required_Paper_Weight_Kg, Roll_Change_Wastage, 0, FaceGSM, ReleaseGSM, AdhesiveGSM, PaperMill, RollType, 0, Paper_Amount, 0, Gbl_windingdirection, Gbl_labeltype, Gbl_finishedformat, Gbl_LabelPerRoll, Gbl_dietype, Gbl_CoreInnerDia, Gbl_CoreOuterDia, FinalQuantityInPcs, Gbl_Estimation_Unit, Gbl_Other_Material_GSM, PlanOtherMaterialGSMSettingJSON, TotalContentActualWeight, Gbl_Orientation, PlanContName, false);

            }
            catch (Exception ex)
            {
                str = ex.Message;
            }
        }

        private void Add_Large_Format_Plan(int m, int p, double Rec_L, double Rec_H)
        {
            try
            {
                double Req_Running_Mtr = 0;
                double Total_GSM = 0;
                double Paper_GSM = 0;
                int Machine_Colors = 0;
                double Wastage_Square_Meters = 0;
                double Total_Square_Mtr = 0;
                double Process_Wastage_Percent = 0;
                double Scrap_Square_Meters = 0;
                double Roll_Change_Wastage = 0;
                long Printing_Impressions = 0;
                long Per_Piece_Printing_Impressions = 0;
                double Wastage_Running_Mtr = 0;
                double Process_Wastage_Running_Mtr = 0;
                double Total_Running_Mtr = 0;
                double Req_Square_Mtr = 0;
                long Total_Req_Machine_Time = 0;
                float Feed_Amount = 0;
                float Roll_Width = 0;
                double Total_Ups = 0;
                double Make_Ready_Wastage_Running_meter = 0;
                double Break_Down_Wastage_Running_meter = 0;
                double Paper_Amount = 0;
                long Total_Colors = 0;
                long Expected_Execution_Time = 0;
                long Cylinder_Tool_ID = 0;
                string Cylinder_Code = string.Empty;
                double Cylinder_Circumference_MM = 0;
                double Cylinder_Circumference_Inch = 0;
                double Cylinder_Width = 0;
                int No_Of_Teeth = 0;
                double Machine_Speed = 0;
                string Paper_Size = string.Empty;
                string Cut_size = string.Empty;
                string Die_Cut_size = string.Empty;
                double Total_Amount = 0;
                double F_Total_Amount = 0;
                double Unit_Price = 0;
                double Required_Paper_Weight_Kg = 0;
                double Wastage_Paper_Weight_Kg = 0;
                double Total_Paper_Weight_Kg = 0;
                int Plate_Qty = 0;
                string Estimation_Paper_Rate_Type = string.Empty;
                double Paper_Rate = 0;
                double Plate_Amount = 0;
                double Machine_Per_Hour_Cost = 0;
                int FaceGSM = 0;
                int ReleaseGSM = 0;
                int AdhesiveGSM = 0;
                string PaperMill = string.Empty;
                string RollType = string.Empty;
                long FinalQuantityInPcs = 0;
                double RequiredQtyKg = 0;

                Machine_Colors = (int)(Gbl_DT_Machine.Rows[m][10]);
                Gbl_Paper_ID = (int)(GblDTRoll.Rows[p][0]);
                Roll_Width = (float)(GblDTRoll.Rows[p][10]);
                Paper_Size = Roll_Width.ToString();

                Paper_GSM = (GblDTRoll.Rows[p][2] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][2])) + (GblDTRoll.Rows[p][3] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][3])) + (GblDTRoll.Rows[p][4] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][4]));

                Make_Ready_Wastage_Running_meter = Gbl_DT_Machine.Rows[m][30] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][30]);
                Break_Down_Wastage_Running_meter = Gbl_DT_Machine.Rows[m][32] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]);
                Machine_Per_Hour_Cost = Gbl_DT_Machine.Rows[m][25] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Machine.Rows[m][25]);

                Cylinder_Tool_ID = 0;
                Cylinder_Code = "";
                Cylinder_Width = 0;
                No_Of_Teeth = 0;
                Cylinder_Circumference_MM = 0;
                Cylinder_Circumference_Inch = 0;
                FaceGSM = (int)Math.Round(GblDTRoll.Rows[p][2] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][2]), 0);
                ReleaseGSM = 0;
                AdhesiveGSM = 0;
                PaperMill = GblDTRoll.Rows[p][7] == DBNull.Value ? "" : GblDTRoll.Rows[p][7].ToString();
                RollType = "";

                if (Convert.ToDouble(GblDTRoll.Rows[p][2]) <= 0)
                {
                    Paper_GSM = Math.Round(Math.Round(GblDTRoll.Rows[p][5] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][5]), 0) * Math.Round(GblDTRoll.Rows[p][6] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][6]), 0), 0);
                }
                else
                {
                    Paper_GSM = FaceGSM;
                }

                Plate_Qty = (int)(Convert.ToDouble(Gbl_Front_Color) + Convert.ToDouble(Gbl_Back_Color) + Convert.ToDouble(Gbl_Special_Front_Color) + Convert.ToDouble(Gbl_Special_Back_Color));
                Estimation_Paper_Rate_Type = GblDTRoll.Rows[p][13] == DBNull.Value ? "" : GblDTRoll.Rows[p][13].ToString();
                Paper_Rate = GblDTRoll.Rows[p][8] == DBNull.Value ? 0 : Convert.ToDouble(GblDTRoll.Rows[p][8]);

                Total_Ups = Gbl_UPS_H * Gbl_UPS_L;
                Gbl_Label_L_With_Around = Rec_L + Gbl_Actual_Around_Gap;
                Total_GSM = Paper_GSM;
                if (Total_Ups >= 1)
                {
                    Printing_Impressions = (long)(Math.Ceiling(Gbl_Order_Quantity / Total_Ups));
                }
                else
                {
                    Per_Piece_Printing_Impressions = (long)(Math.Ceiling(1 / Total_Ups));
                    Printing_Impressions = (long)(Math.Ceiling(Gbl_Order_Quantity * Per_Piece_Printing_Impressions));
                }

                FinalQuantityInPcs = (long)Gbl_Order_Quantity;

                // Normalize input unit
                string unit = string.IsNullOrWhiteSpace(ContentSizeInputUnit) ? "MM" : ContentSizeInputUnit.Trim().ToUpper();

                if (unit == "INCH")
                {
                    Gbl_Label_L_With_Around = Math.Round(Gbl_Label_L_With_Around * 2.54, 2);  // INCH to CM
                }
                else if (unit == "MM")
                {
                    Gbl_Label_L_With_Around = Math.Round(Gbl_Label_L_With_Around / 10, 2);    // MM to CM
                }
                else if (unit == "MTR")
                {
                    Gbl_Label_L_With_Around = Math.Round(Gbl_Label_L_With_Around * 100, 2);   // MTR to CM
                }

                if (Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "LARGE FORMAT")
                {
                    Feed_Amount = (float)(Math.Round((Convert.ToDouble(Gbl_Label_L_With_Around) * Convert.ToDouble(Gbl_UPS_L)), 2));

                    if (Req_Running_Mtr == 0)
                    {
                        Req_Running_Mtr = Math.Round((Printing_Impressions * Feed_Amount) / 100, 3);
                        Req_Square_Mtr = Math.Round((Roll_Width / 1000.0) * Req_Running_Mtr, 3);
                    }
                }
                double TempWasteRunningMeter = 0;
                double TempProcessWastePercentage = 0;
                double TempMachineSlabSpeed = 0;

                double abhi = 0;
                long abhiL = 0;
                string abhistr = "";
                if (Search_In_Machine_Slabs_Flexo((long)(Gbl_DT_Machine.Rows[m][0]), Req_Running_Mtr, ref TempWasteRunningMeter, ref abhi, ref abhi, ref abhi, ref abhi, ref abhi, ref abhistr, ref abhiL, ref abhi, ref TempProcessWastePercentage, ref TempMachineSlabSpeed))
                {

                }

                Process_Wastage_Percent = 0;

                if (Gbl_Flat_Wastage_Type == "Machine Default")
                {
                    Gbl_Flat_Wastage_Value = 0;

                    if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                    {
                        Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Convert.ToDouble(Gbl_Flat_Wastage_Value) / 100), 3)
                                             + Math.Round((Convert.ToDouble(Gbl_DT_Machine.Rows[m][12]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][24])), 3);
                        Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                    }
                    else
                    {
                        Wastage_Running_Mtr = TempWasteRunningMeter;
                        Process_Wastage_Percent = TempProcessWastePercentage;
                        Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                        Wastage_Running_Mtr += Math.Round((Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30])), 3);
                    }

                    if (GblShadeCardCreationRequired == true)
                    {
                        Wastage_Running_Mtr += 400;
                    }
                }
                else if (Gbl_Flat_Wastage_Type == "Percentage")
                {
                    Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Convert.ToDouble(Gbl_Flat_Wastage_Value)) / 100, 3);
                    Wastage_Running_Mtr += Math.Round((Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30])), 3);
                }
                else if (Gbl_Flat_Wastage_Type == "Running Meter")
                {
                    Wastage_Running_Mtr = Math.Round(Convert.ToDouble(Gbl_Flat_Wastage_Value), 3);
                    Wastage_Running_Mtr += Math.Round((Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][30])), 3);
                }

                double total_mtr = Wastage_Running_Mtr + Req_Running_Mtr;
                if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                {
                    Roll_Change_Wastage = Math.Round(
                        (Math.Ceiling(total_mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])) - 1)
                        * Convert.ToDouble(Gbl_DT_Machine.Rows[m][34]), 2);
                }

                Wastage_Running_Mtr = Math.Round(Wastage_Running_Mtr + Roll_Change_Wastage, 3);
                Wastage_Square_Meters = Math.Round((Roll_Width / 1000.0) * Wastage_Running_Mtr, 3);
                Total_Running_Mtr = Math.Round(Wastage_Running_Mtr + Req_Running_Mtr, 3);
                Total_Square_Mtr = Math.Round((Roll_Width / 1000.0) * Total_Running_Mtr, 3);

                Scrap_Square_Meters = Total_Square_Mtr - (((Rec_H / 100.0) * (Rec_L / 100.0)) * Gbl_Order_Quantity);

                if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]) > 0)
                {
                    Total_Req_Machine_Time = (long)(Math.Round(Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]), 0));
                }

                Total_Req_Machine_Time += (long)(Convert.ToDouble(Gbl_DT_Machine.Rows[m][19]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][31]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][20]));

                if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                {
                    Total_Req_Machine_Time += (long)(Math.Round((Math.Ceiling(Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][36]), 2));
                }

                Required_Paper_Weight_Kg = Math.Round((Req_Square_Mtr * Paper_GSM) / 1000.0, 3);
                Wastage_Paper_Weight_Kg = Math.Round((Wastage_Square_Meters * Paper_GSM) / 1000.0, 3);
                Total_Paper_Weight_Kg = Math.Round((Total_Square_Mtr * Paper_GSM) / 1000.0, 3);

                if (Estimation_Paper_Rate_Type.ToUpper() == "SQM" || Estimation_Paper_Rate_Type.ToUpper() == "SQUARE METER")
                {
                    Paper_Amount = Math.Round(Total_Square_Mtr * Paper_Rate, 2);
                }
                else if (Estimation_Paper_Rate_Type.ToUpper().Contains("KG"))
                {
                    Paper_Amount = Math.Round(Total_Paper_Weight_Kg * Paper_Rate, 2);
                }

                // --- Operation Amount Calculation Setup ---
                double Op_Amt = 0;
                // string ST_Op_Amt = ""; // Optional
                double Pub_RMT = 0;
                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double machineCost = 0;

                DataTable DTOPR = Gbl_DT_Operation.Clone();
                DTOPR.Clear();
                for (int j = 0; j < GblDTOprFactors.Rows.Count; j++)
                {
                    for (int i = 0; i < Gbl_DT_Operation.Rows.Count; i++)
                    {
                        if (Gbl_DT_Operation.Rows[i][6].ToString() == "Pre")
                        {
                            Pub_RMT = Total_Running_Mtr;
                        }
                        else
                        {
                            string rmtType = Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "Actual Running Meter" : Gbl_DT_Operation.Rows[i][5].ToString();

                            if (rmtType == "Actual Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr;
                            }
                            else if (rmtType == "Actual Running Meter + Make Ready Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr + Make_Ready_Wastage_Running_meter;
                            }
                            else if (rmtType == "Actual Running Meter + Wastage Running Meter")
                            {
                                Pub_RMT = Req_Running_Mtr + Wastage_Running_Mtr;
                            }
                            else if (rmtType == "Actual Running Meter + Make Ready Running Meter + Wastage Running Meter")
                            {
                                Pub_RMT = Total_Running_Mtr;
                            }
                        }

                        if (Gbl_DT_Operation.Rows[i][4].ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i][7] = Math.Ceiling(Gbl_Sheet_L / 25.4 * 100) / 100.0; // RoundUp to 2 decimals
                            Gbl_DT_Operation.Rows[i][8] = Math.Ceiling(Gbl_Sheet_W / 25.4 * 100) / 100.0;
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i][7] = 0;
                            Gbl_DT_Operation.Rows[i][8] = 0;
                        }
                        double QTY = 0;
                        string typeofcharge = Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString();

                        if (typeofcharge.Contains("Order Quantity") || typeofcharge.Contains("OrderQuantity"))
                        {
                            QTY = Gbl_Order_Quantity;
                        }
                        else if (typeofcharge.Contains("Unit"))
                        {
                            QTY = Gbl_Order_Quantity; // Final_Quantity
                        }
                        else if (typeofcharge.Contains("Meter"))
                        {
                            QTY = Pub_RMT;
                        }
                        else if (typeofcharge.Contains("PCS"))
                        {
                            QTY = Gbl_Order_Quantity;
                        }

                        for (int k = 0; k < GblDTOprSlabs.Rows.Count; k++)
                        {
                            var operationProcessID = Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"]);
                            var slabProcessID = GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"]);
                            var factorProcessID = GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"]);

                            if (operationProcessID == slabProcessID)
                            {
                                double fromQty = GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"]);
                                double toQty = GblDTOprSlabs.Rows[k]["ToQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["ToQty"]);
                                string slabRateFactor = GblDTOprSlabs.Rows[k]["RateFactor"] == DBNull.Value ? "" : GblDTOprSlabs.Rows[k]["RateFactor"].ToString().Replace("-", "");
                                string factorRateFactor = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString().Replace("-", "");

                                if (fromQty >= 1 && factorProcessID == slabProcessID)
                                {
                                    if (QTY >= fromQty && QTY <= toQty && factorRateFactor == slabRateFactor)
                                    {
                                        Gbl_DT_Operation.Rows[i][1] = GblDTOprSlabs.Rows[k]["Rate"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["Rate"]);
                                        Gbl_DT_Operation.Rows[i][2] = GblDTOprSlabs.Rows[k]["MinimumCharges"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["MinimumCharges"]);
                                        break;
                                    }
                                }
                            }
                        }

                        double Amt = 0;// Calculate_Operations(typeofcharge, Gbl_DT_Operation.Rows[i][1] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][1]), Gbl_DT_Operation.Rows[i][2] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][2]), (long)Gbl_Order_Quantity, (long)Gbl_Order_Quantity, Gbl_DT_Operation.Rows[i][3] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][3]), (long)Total_Paper_Weight_Kg, (long)Total_Ups, 0, Gbl_DT_Operation.Rows[i][7] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][7]), Gbl_DT_Operation.Rows[i][8] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][8]), Total_Colors, Pub_RMT, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, (long)Gbl_Order_Quantity, Gbl_DT_Operation.Rows[i]["PagesPerSection"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"]), Gbl_DT_Operation.Rows[i]["NoOfForms"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"]));

                        Gbl_DT_Operation.Rows[i][11] = Amt;
                        Gbl_DT_Operation.Rows[i][12] = Gbl_DT_plan.Rows.Count + 1;
                        Gbl_DT_Operation.Rows[i][15] = QTY;
                        Gbl_DT_Operation.Rows[i][16] = Total_Ups;
                        Gbl_DT_Operation.Rows[i][17] = 1;
                        Gbl_DT_Operation.Rows[i][19] = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString();
                        Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;

                        if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) > 0)
                        {
                            Gbl_DT_Operation.Rows[i]["MachineID"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]);
                            Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                            Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                            Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                            Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                        }

                        if (QTY > 0)
                        {
                            double machineSpeed = Gbl_DT_Operation.Rows[i]["MachineSpeed"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"]);
                            if (machineSpeed > 0)
                            {
                                opExecutionTime = Math.Round(QTY / machineSpeed);
                            }
                            else
                            {
                                opExecutionTime = 0;
                            }

                            Gbl_DT_Operation.Rows[i]["ExecutionTime"] = opExecutionTime;
                        }

                        double makeReadyTime = Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"]);
                        double changeOverTime = Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]);

                        Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = Math.Round(opExecutionTime + makeReadyTime + changeOverTime);
                        opTotalExecutionTime = Math.Round(opExecutionTime + makeReadyTime + changeOverTime);

                        double perHourCost = Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachinePerHourCost"]);
                        machineCost = Math.Round(Math.Round(opTotalExecutionTime / 60.0, 2) * perHourCost, 2);

                        Gbl_DT_Operation.Rows[i]["MachineCost"] = machineCost;
                        var operationProcessId = Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"]);
                        var factorProcessId = GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"]);

                        if (operationProcessId == factorProcessId)
                        {
                            DTOPR.ImportRow(Gbl_DT_Operation.Rows[i]);
                            Op_Amt += Amt;
                        }
                    }
                }
                Rf_Dt_Opr.Merge(DTOPR);
                // if (Gbl_Actual_Around_Gap > 0 || Gbl_Around_Waste_Strip > 0)
                Gbl_Big_H = 0;
                int unitpricedecimal = 2;
                int finalCostRoundDecimal = 2;

                if (Gbl_DT_CompanyMaster_Flags.Rows.Count > 0)
                {
                    unitpricedecimal = Convert.ToInt32(Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationPerUnitCostDecimalPlace"] == DBNull.Value ? 2 : Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationPerUnitCostDecimalPlace"]);
                    finalCostRoundDecimal = Convert.ToInt32(Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationRoundOffDecimalPlace"] == DBNull.Value ? 2 : Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationRoundOffDecimalPlace"]);

                    if (unitpricedecimal == 0) unitpricedecimal = 2;
                    if (finalCostRoundDecimal == 0) finalCostRoundDecimal = 2;
                }

                Machine_Speed = Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]);
                Total_Colors = Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color;

                Paper_Size = Convert.ToString(GblDTRoll.Rows[p][10]);
                Cut_size = $"{Math.Round(Gbl_Sheet_W, 2)}x{Math.Round(Gbl_Sheet_L, 2)}";
                Die_Cut_size = $"{Gbl_Die_Size_H}x{Gbl_Die_Size_L}";

                Total_Amount = 0;
                Total_Amount = Math.Round(Plate_Amount + Paper_Amount, finalCostRoundDecimal);

                // if (Gbl_Half_Ups_Logic == true) Gbl_UPS_L /= 2;

                F_Total_Amount = Total_Amount;
                if (F_Total_Amount > 0 && Gbl_Order_Quantity > 0)
                {
                    Unit_Price = Math.Round(F_Total_Amount / Gbl_Order_Quantity, unitpricedecimal);
                }
                else
                {
                    Unit_Price = 0;
                }

                DataRow newRow = Gbl_DT_plan.NewRow();

                double Operation_Cost = 0;

                newRow.ItemArray = new object[]
                {Gbl_Machine_ID, Gbl_Machine_Name, 0, "", Machine_Colors, Gbl_Paper_ID, Paper_Size, "", 1, 1, Gbl_UPS_H, Gbl_UPS_L,Total_Ups, "", "", 0, Process_Wastage_Percent, Wastage_Paper_Weight_Kg, Gbl_Grain_Direction, Plate_Qty,0, 0, 0, 0, 0, 0, Total_Paper_Weight_Kg, 0, Paper_Rate, Paper_Amount,Printing_Impressions, Printing_Impressions, 0, 0, 1, 0, 0, Gbl_Order_Quantity, Total_Colors,Total_Amount, 0, 0, Gbl_Printing_Style, "", Expected_Execution_Time, Total_Req_Machine_Time,Gbl_Paper_Detail, "Large Format Planning", Estimation_Paper_Rate_Type, "", 0, 1, F_Total_Amount,Unit_Price, "", 1, 0, Special_Color_Front_Charges, Special_Color_Back_Charges,Special_Color_Front_Amount, Special_Color_Back_Amount, Operation_Cost, Gbl_DT_plan.Rows.Count + 1,0, 0, GblMainPaperGroup, Gbl_Machine_Type, Cylinder_Tool_ID, Cylinder_Code, Cylinder_Circumference_Inch,Cylinder_Circumference_MM, Cylinder_Width, No_Of_Teeth, Feed_Amount, Gbl_Standard_AC_Gap, Gbl_Actual_Around_Gap,Gbl_Side_Wastage_Strip, Req_Running_Mtr, Make_Ready_Wastage_Running_meter, Break_Down_Wastage_Running_meter,Wastage_Running_Mtr, Process_Wastage_Running_Mtr, Total_Running_Mtr, Req_Square_Mtr, Total_Square_Mtr,Wastage_Square_Meters, Scrap_Square_Meters, Machine_Speed, Machine_Per_Hour_Cost, Paper_GSM,Required_Paper_Weight_Kg, Roll_Change_Wastage, 0, FaceGSM, ReleaseGSM, AdhesiveGSM, PaperMill,RollType, 0, Paper_Amount, 0, Gbl_windingdirection, Gbl_labeltype, Gbl_finishedformat,Gbl_LabelPerRoll, Gbl_dietype, Gbl_CoreInnerDia, Gbl_CoreOuterDia, FinalQuantityInPcs,Gbl_Estimation_Unit, Gbl_Other_Material_GSM, PlanOtherMaterialGSMSettingJSON, Required_Paper_Weight_Kg, Gbl_Orientation, PlanContName,false};

                Gbl_DT_plan.Rows.Add(newRow);
            }
            catch (Exception ex)
            {
                str = ex.Message;
            }
        }

        [ScriptMethod(ResponseFormat = ResponseFormat.Json)]
        private void Add_Flexo_Plan_Cyl(double Max_Roll_Width, int m, int p, double Rec_L, double Rec_H)
        {
            try
            {
                double Req_Running_Mtr = 0;
                double Total_GSM = 0;
                int Machine_Colors = 0;
                double Wastage_Square_Meters = 0;
                double Total_Square_Mtr = 0;
                double Process_Wastage_Percent = 0;
                double Scrap_Square_Meters = 0;
                double Roll_Change_Wastage = 0;
                long Printing_Impressions = 0;
                double Wastage_Running_Mtr = 0;
                double Process_Wastage_Running_Mtr = 0;
                double Total_Running_Mtr = 0;
                double Req_Square_Mtr = 0;
                long Total_Req_Machine_Time = 0;
                float Feed_Amount = 0;
                float Roll_Width = 0;
                double Total_Ups = 0;
                double Make_Ready_Wastage_Running_meter = 0;
                double Break_Down_Wastage_Running_meter = 0;
                double Paper_Amount = 0;
                long Total_Colors = 0;
                long Expected_Execution_Time = 0;
                long Cylinder_Tool_ID = 0;
                string Cylinder_Code = "";
                double Cylinder_Circumference_MM = 0, Cylinder_Circumference_Inch = 0, Cylinder_Width = 0;
                int No_Of_Teeth = 0;
                double Machine_Speed = 0;
                string Paper_Size = "", Cut_size = "", Die_Cut_size = "";
                double Total_Amount = 0, F_Total_Amount = 0, Unit_Price = 0;
                double Required_Paper_Weight_Kg = 0;
                double Wastage_Paper_Weight_Kg = 0;
                double Total_Paper_Weight_Kg = 0;
                int Plate_Qty = 0;
                double Plate_Rate = 0;
                string Estimation_Paper_Rate_Type = "";
                double Paper_Rate = 0;
                double Plate_Amount = 0;
                double Machine_Per_Hour_Cost = 0;
                int FaceGSM = 0, ReleaseGSM = 0, AdhesiveGSM = 0;
                string PaperMill = "";
                string RollType = "";
                string Wastage_Type = "";
                string Wastage_Calculation_On = "";
                double PlanningMachineCost = 0;
                double AvgRollLength = 0;
                string PlateChargesType = GblPlateChargesType;

                Machine_Colors = Convert.ToInt32(Gbl_DT_Machine.Rows[m][10] ?? 0);
                Gbl_Paper_ID = 0;
                Roll_Width = Convert.ToSingle(Max_Roll_Width);
                Paper_Size = Roll_Width.ToString();

                Total_GSM = Convert.ToDouble(GblDTRoll.Rows[p][2] ?? 0) + Convert.ToDouble(GblDTRoll.Rows[p][3] ?? 0) + Convert.ToDouble(GblDTRoll.Rows[p][4] ?? 0);

                AvgRollLength = Convert.ToDouble(GblDTRoll.Rows[p][18] ?? 0);
                Make_Ready_Wastage_Running_meter = Convert.ToDouble(Gbl_DT_Machine.Rows[m][30] ?? 0);
                if (Gbl_Plan_Make_Ready_Wastage > 0) Make_Ready_Wastage_Running_meter = Convert.ToDouble(Gbl_Plan_Make_Ready_Wastage);
                Break_Down_Wastage_Running_meter = Convert.ToDouble(Gbl_DT_Machine.Rows[m][32] ?? 0);
                Machine_Per_Hour_Cost = Convert.ToDouble(Gbl_DT_Machine.Rows[m][25] ?? 0);
                Cylinder_Tool_ID = Convert.ToInt64(Gbl_DT_Machine.Rows[m][37] ?? 0);
                Cylinder_Code = Gbl_DT_Machine.Rows[m][38]?.ToString() ?? "";
                Cylinder_Width = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][40] ?? 0), 2);
                No_Of_Teeth = Convert.ToInt32(Gbl_DT_Machine.Rows[m][41] ?? 0);
                Cylinder_Circumference_MM = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][42] ?? 0), 2);
                Cylinder_Circumference_Inch = Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][43] ?? 0), 3);
                Plate_Rate = Convert.ToDouble(Gbl_DT_Machine.Rows[m]["PlateCharges"] == DBNull.Value ? 0 : Gbl_DT_Machine.Rows[m]["PlateCharges"]);
                PlateChargesType = Gbl_DT_Machine.Rows[m]["PlateChargesType"] == DBNull.Value ? "Rate/Plate" : Gbl_DT_Machine.Rows[m]["PlateChargesType"].ToString();

                FaceGSM = Convert.ToInt32(GblDTRoll.Rows[p][2] ?? 0);
                ReleaseGSM = Convert.ToInt32(GblDTRoll.Rows[p][3] ?? 0);
                AdhesiveGSM = Convert.ToInt32(GblDTRoll.Rows[p][4] ?? 0);
                PaperMill = GblDTRoll.Rows[p][7]?.ToString() ?? "";
                RollType = GblDTRoll.Rows[p][15]?.ToString() ?? "";
                if (Convert.ToDouble(GblDTRoll.Rows[p][2] ?? 0) <= 0)
                {
                    Total_GSM = Math.Round(Convert.ToDouble(GblDTRoll.Rows[p][5] ?? 0) * Convert.ToDouble(GblDTRoll.Rows[p][6] ?? 0), 0);
                }
                Plate_Qty = Convert.ToInt32(Gbl_Front_Color) + Convert.ToInt32(Gbl_Back_Color) + Convert.ToInt32(Gbl_Special_Front_Color) + Convert.ToInt32(Gbl_Special_Back_Color);
                Estimation_Paper_Rate_Type = GblDTRoll.Rows[p][13]?.ToString() ?? "";
                Paper_Rate = Convert.ToDouble(GblDTRoll.Rows[p][8] ?? 0);
                Total_Ups = Gbl_UPS_H * Gbl_UPS_L;
                Gbl_Label_L_With_Around = Rec_L + Gbl_Actual_Around_Gap;
                Printing_Impressions = Convert.ToInt64(Math.Round((Gbl_Order_Quantity / Total_Ups), 0));
                string machineType = Gbl_DT_Machine.Rows[m][11]?.ToString().ToUpper() ?? "";

                if (machineType == "FLEXO" || machineType == "LETTERPRESS")
                {
                    Req_Running_Mtr = Math.Round((Gbl_Label_L_With_Around * (Gbl_Order_Quantity / (double)Gbl_UPS_H)) / 1000, 3);
                    Req_Square_Mtr = Math.Round((Roll_Width / 1000) * Req_Running_Mtr, 3);
                }
                else if (machineType == "DRY WEB OFFSET" || machineType == "DIGITAL")
                {
                    Feed_Amount = (float)Math.Round(Gbl_Label_L_With_Around * Gbl_UPS_L, 2);
                    Req_Running_Mtr = Math.Round((Printing_Impressions * Feed_Amount) / 1000, 3);
                    Req_Square_Mtr = Math.Round((Roll_Width / 1000) * Req_Running_Mtr, 3);
                }


                double TempWasteRunningMeter = 0;
                double TempProcessWastePercentage = 0;
                double TempMachineSlabSpeed = 0;

                double abhi = 0;
                long abhiL = 0;
                string abhistr = "";
                if (Search_In_Machine_Slabs_Flexo((long)(Gbl_DT_Machine.Rows[m][0]), Req_Running_Mtr, ref TempWasteRunningMeter, ref abhi, ref abhi, ref abhi, ref abhi, ref abhi, ref abhistr, ref abhiL, ref abhi, ref TempProcessWastePercentage, ref TempMachineSlabSpeed))
                {

                }

                Process_Wastage_Percent = 0;
                if (Gbl_Flat_Wastage_Type == "Machine Default")
                {
                    Process_Wastage_Percent = TempProcessWastePercentage;
                    Wastage_Running_Mtr = TempWasteRunningMeter;
                    Wastage_Running_Mtr = Wastage_Running_Mtr + Math.Round((Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Make_Ready_Wastage_Running_meter), 3);
                    Gbl_Flat_Wastage_Value = 0;
                    if (Wastage_Type == "Meter")
                    {
                        if (Wastage_Calculation_On == "Flat")
                        {
                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                                Wastage_Running_Mtr = Process_Wastage_Percent;
                            }
                            else
                            {
                                Wastage_Running_Mtr = Process_Wastage_Percent;
                                Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                                Wastage_Running_Mtr += Math.Round(
                                    Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                            }
                        }
                        else
                        {
                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                            }
                            Wastage_Running_Mtr = Process_Wastage_Percent * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                            Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                        }

                    }
                    else
                    {
                        if (Wastage_Calculation_On == "Flat")
                        {
                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Convert.ToDouble(Gbl_Flat_Wastage_Value) / 100), 3) + Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][12]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]), 3);
                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                            }
                            else
                            {
                                Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Convert.ToDouble(Process_Wastage_Percent) / 100), 3);
                                Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);
                                Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                            }

                        }
                        else
                        {
                            double wastePercentage = 0;
                            if (Convert.ToDouble(Gbl_Flat_Wastage_Value) > 0)
                            {
                                Process_Wastage_Percent = Gbl_Flat_Wastage_Value;
                                wastePercentage = Process_Wastage_Percent * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                            }
                            else
                            {
                                wastePercentage = Process_Wastage_Percent * (Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color);
                                Gbl_Flat_Wastage_Value = Process_Wastage_Percent;
                            }
                            Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * (wastePercentage / 100)), 3);
                            Wastage_Running_Mtr += Math.Round(Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter), 3);

                        }
                    }
                    double processFlatWasteQty = 0;
                    double processWastePercent = 0;
                    double processWastePercentQty = 0;
                    Process_Wastage_Running_Mtr = 0;
                    for (var i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        processFlatWasteQty = Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessFlatWastageValue"]);
                        processWastePercent = Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["ProcessWastagePercentage"]);
                        processWastePercentQty = 0;
                        if (processWastePercent > 0)
                            processWastePercentQty = Math.Round((Convert.ToDouble(Req_Running_Mtr) * (processWastePercent / 100)), 0);

                        Process_Wastage_Running_Mtr = Convert.ToDouble(Process_Wastage_Running_Mtr) + Math.Max(processFlatWasteQty, processWastePercentQty);

                    }
                    Wastage_Running_Mtr = Convert.ToDouble(Wastage_Running_Mtr) + Convert.ToDouble(Process_Wastage_Running_Mtr);

                    if (GblShadeCardCreationRequired == true)
                        Wastage_Running_Mtr = Wastage_Running_Mtr + 400;
                }
                else if (Gbl_Flat_Wastage_Type == "Percentage")
                {
                    Wastage_Running_Mtr = Math.Round((Req_Running_Mtr * Convert.ToDouble(Gbl_Flat_Wastage_Value)) / 100.0, 3);
                    Wastage_Running_Mtr += Math.Round((Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter)), 3);

                }
                else if (Gbl_Flat_Wastage_Type == "Meter")
                {
                    Wastage_Running_Mtr = Math.Round(Convert.ToDouble(Gbl_Flat_Wastage_Value), 3);
                    Wastage_Running_Mtr += Math.Round((Convert.ToDouble(Gbl_DT_Machine.Rows[m][32]) + Convert.ToDouble(Make_Ready_Wastage_Running_meter)), 3);
                }

                double total_mtr;
                total_mtr = Wastage_Running_Mtr + Req_Running_Mtr;

                if (Convert.ToDouble(AvgRollLength) > 0)
                {
                    Roll_Change_Wastage = Math.Round((RoundUp((total_mtr / Convert.ToDouble(AvgRollLength)), 0) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][34]), 2);
                }
                else if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                {
                    Roll_Change_Wastage = Math.Round((RoundUp((total_mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])), 0) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][34]), 2);
                }
                Wastage_Running_Mtr = Wastage_Running_Mtr + Roll_Change_Wastage;
                Wastage_Square_Meters = Math.Round((Roll_Width / (double)1000) * Wastage_Running_Mtr, 3);
                Total_Running_Mtr = Wastage_Running_Mtr + Req_Running_Mtr;
                Total_Square_Mtr = Math.Round(((Roll_Width / (double)1000) * Total_Running_Mtr), 3);
                Scrap_Square_Meters = Total_Square_Mtr - (((Rec_H / 1000) * (Rec_L / 1000)) * Gbl_Order_Quantity);
                if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]) > 0)
                {
                    Total_Req_Machine_Time = (long)Math.Round(Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]), 0);
                }
                Total_Req_Machine_Time += (long)(Convert.ToDouble(Gbl_DT_Machine.Rows[m][19]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][31]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][20]));

                if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                {
                    Total_Req_Machine_Time += (long)(Math.Round((RoundUp((Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])), 0) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][36]), 2));
                }
                Required_Paper_Weight_Kg = Math.Round((Convert.ToDouble(Req_Square_Mtr) * Convert.ToDouble(Total_GSM)) / 1000, 3);
                Wastage_Paper_Weight_Kg = Math.Round((Convert.ToDouble(Wastage_Square_Meters) * Convert.ToDouble(Total_GSM)) / 1000, 3);
                Total_Paper_Weight_Kg = Math.Round((Convert.ToDouble(Total_Square_Mtr) * Convert.ToDouble(Total_GSM)) / 1000, 3);

                if (Estimation_Paper_Rate_Type.ToString().ToUpper() == "SQM")
                {
                    Paper_Amount = Math.Round((Convert.ToDouble(Total_Square_Mtr) * Convert.ToDouble(Paper_Rate)), 2);
                }
                else if (Estimation_Paper_Rate_Type.ToString().ToUpper().Contains("KG"))
                {
                    Paper_Amount = Math.Round((Convert.ToDouble(Total_Paper_Weight_Kg) * Convert.ToDouble(Paper_Rate)), 2);
                }
                double Op_Amt = 0;
                double Pub_RMT = 0;
                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double machineCost = 0;
                double TotalMachineCost = 0;

                DataTable DTOPR = new DataTable();
                DTOPR = Gbl_DT_Operation.Copy();
                DTOPR.Clear();

                for (var j = 0; j <= GblDTOprFactors.Rows.Count - 1; j++)
                {
                    for (var i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        if (Gbl_DT_Operation.Rows[i][6]?.ToString() == "Pre")
                        {
                            Pub_RMT = Total_Running_Mtr;
                        }
                        else
                        {
                            string operationType = Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "Actual Running Meter" : Gbl_DT_Operation.Rows[i][5].ToString();

                            if (operationType == "Actual Running Meter")
                                Pub_RMT = Req_Running_Mtr;
                            else if (operationType == "Actual Running Meter + Make Ready Running Meter")
                                Pub_RMT = Req_Running_Mtr + Make_Ready_Wastage_Running_meter;
                            else if (operationType == "Actual Running Meter + Wastage Running Meter")
                                Pub_RMT = Req_Running_Mtr + Wastage_Running_Mtr + Process_Wastage_Running_Mtr;
                            else if (operationType == "Actual Running Meter + Make Ready Running Meter + Wastage Running Meter")
                                Pub_RMT = Total_Running_Mtr;
                        }

                        if (Gbl_DT_Operation.Rows[i][4]?.ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i][7] = RoundUp(Gbl_Sheet_L / 25.4, 2);
                            Gbl_DT_Operation.Rows[i][8] = RoundUp(Gbl_Sheet_W / 25.4, 2);
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i][7] = 0;
                            Gbl_DT_Operation.Rows[i][8] = 0;
                        }

                        double QTY = 0;
                        string typeofcharge = "";
                        typeofcharge = Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString();
                        if (typeofcharge.Contains("Order Quantity") || typeofcharge.Contains("OrderQuantity"))
                        {
                            QTY = Gbl_Order_Quantity;
                        }
                        else if (typeofcharge.Contains("Unit"))
                        {
                            QTY = Gbl_Order_Quantity; // Final_Quantity
                        }
                        else if (typeofcharge.Contains("Sq.Meter"))
                        {
                            QTY = Math.Round((Pub_RMT * Convert.ToDouble(Roll_Width) / 1000), 3);
                        }
                        else if (typeofcharge.Contains("Meter"))
                        {
                            QTY = Pub_RMT;
                        }
                        int k = 0;
                        for (k = 0; k < GblDTOprSlabs.Rows.Count; k++)
                        {
                            var processID_Op = Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"]);
                            var processID_Slab = GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"]);

                            if (processID_Op == processID_Slab)
                            {
                                var fromQty = GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"]);
                                var processID_Factor = GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"]);
                                if (fromQty >= 1 && processID_Factor == processID_Slab)
                                {
                                    var toQty = GblDTOprSlabs.Rows[k]["ToQty"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["ToQty"]);
                                    var rateFactor_Factor = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString().Replace("-", "");
                                    var rateFactor_Slab = GblDTOprSlabs.Rows[k]["RateFactor"] == DBNull.Value ? "" : GblDTOprSlabs.Rows[k]["RateFactor"].ToString().Replace("-", "");

                                    if (QTY >= fromQty && QTY <= toQty && rateFactor_Factor == rateFactor_Slab)
                                    {
                                        Gbl_DT_Operation.Rows[i][1] = GblDTOprSlabs.Rows[k]["Rate"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["Rate"]);
                                        Gbl_DT_Operation.Rows[i][2] = GblDTOprSlabs.Rows[k]["MinimumCharges"] == DBNull.Value ? 0 : Convert.ToDouble(GblDTOprSlabs.Rows[k]["MinimumCharges"]);
                                        break;
                                    }
                                }
                            }
                        }

                        var Amt = 0; // Calculate_Operations(Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString(), Gbl_DT_Operation.Rows[i][1] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][1]), Gbl_DT_Operation.Rows[i][2] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][2]), (long)Gbl_Order_Quantity, (long)Gbl_Order_Quantity, Gbl_DT_Operation.Rows[i][3] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][3]), (long)Total_Paper_Weight_Kg, (long)Total_Ups, 0, Gbl_DT_Operation.Rows[i][7] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][7]), Gbl_DT_Operation.Rows[i][8] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][8]), Total_Colors, Pub_RMT, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, (long)Gbl_Order_Quantity, Gbl_DT_Operation.Rows[i]["PagesPerSection"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"]), Gbl_DT_Operation.Rows[i]["NoOfForms"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"]));

                        Gbl_DT_Operation.Rows[i][11] = Amt;
                        Gbl_DT_Operation.Rows[i][12] = Gbl_DT_plan.Rows.Count + 1;
                        Gbl_DT_Operation.Rows[i][15] = QTY;
                        Gbl_DT_Operation.Rows[i][16] = Total_Ups;
                        Gbl_DT_Operation.Rows[i][17] = 1;
                        Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;

                        if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) ==
                            (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                        {
                            Gbl_DT_Operation.Rows[i][19] = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString();
                            Gbl_DT_Operation.Rows[i]["Remarks"] = GblDTOprFactors.Rows[j]["Remarks"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["Remarks"].ToString();
                            Gbl_DT_Operation.Rows[i]["PaperConsumptionRequired"] = GblDTOprFactors.Rows[j]["PaperConsumptionRequired"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["PaperConsumptionRequired"].ToString();

                            if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) > 0)
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Convert.ToInt32(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]);
                                Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                            }
                        }

                        if (Convert.ToDouble(QTY) > 0)
                        {
                            if (Gbl_DT_Operation.Rows[i]["MachineSpeed"] != DBNull.Value && Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"]) > 0)
                                opExecutionTime = Math.Round(Convert.ToDouble(QTY) / Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"]));
                            else
                                opExecutionTime = 0;

                            Gbl_DT_Operation.Rows[i]["ExecutionTime"] = Convert.ToDouble(opExecutionTime);
                        }
                        double makeReadyTime = Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"]);
                        double jobChangeOverTime = Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]);
                        Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = Math.Round(opExecutionTime + makeReadyTime + jobChangeOverTime);
                        opTotalExecutionTime = Math.Round(opExecutionTime + makeReadyTime + jobChangeOverTime);
                        double machinePerHourCost = Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachinePerHourCost"]);
                        machineCost = Math.Round((Math.Round(opTotalExecutionTime / 60, 2) * machinePerHourCost), 2);
                        bool isOnlineProcess = Gbl_DT_Operation.Rows[i]["IsOnlineProcess"] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Operation.Rows[i]["IsOnlineProcess"]);
                        if (isOnlineProcess)
                            machineCost = 0;

                        Gbl_DT_Operation.Rows[i]["MachineCost"] = Convert.ToDouble(machineCost);
                        TotalMachineCost += Convert.ToDouble(machineCost);
                        if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                        {
                            DTOPR.ImportRow(Gbl_DT_Operation.Rows[i]);
                            Op_Amt += Amt;
                        }

                    }
                }

                Rf_Dt_Opr.Merge(DTOPR);

                if (Gbl_DT_Machine.Rows[m][11].ToString().ToUpper() == "FLEXO")
                    Gbl_Big_H = 0;

                if (Gbl_Big_H > 0)
                {
                    if (Gbl_UPS_H % (Gbl_Big_Ups_H == 0 ? 1 : Gbl_Big_Ups_H) != 0)
                    {
                        return;
                    }
                }
                {
                    DataTable withBlock = Gbl_DT_plan;

                    if (Convert.ToDouble(TempMachineSlabSpeed) > 0)
                        Machine_Speed = TempMachineSlabSpeed;
                    else
                        Machine_Speed = Convert.ToDouble(Gbl_DT_Machine.Rows[m][24]);

                    Total_Req_Machine_Time = 0;
                    Expected_Execution_Time = 0;

                    if (Machine_Speed > 0)
                    {
                        Total_Req_Machine_Time = (long)(Math.Round(Total_Running_Mtr / Machine_Speed, 0));
                        Expected_Execution_Time = (long)(Math.Round(Req_Running_Mtr / Machine_Speed, 0));
                    }

                    Total_Req_Machine_Time += (long)(Convert.ToDouble(Gbl_DT_Machine.Rows[m][19]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][31]) + Convert.ToDouble(Gbl_DT_Machine.Rows[m][20]));

                    if (Convert.ToDouble(Gbl_DT_Machine.Rows[m][35]) > 1)
                    {
                        Total_Req_Machine_Time += (long)(Math.Round((Math.Ceiling(Total_Running_Mtr / Convert.ToDouble(Gbl_DT_Machine.Rows[m][35])) - 1) * Convert.ToDouble(Gbl_DT_Machine.Rows[m][36]), 2));
                    }

                    PlanningMachineCost = 0;
                    if (Machine_Speed > 0)
                        PlanningMachineCost = Math.Round(Math.Round(Total_Req_Machine_Time / 60.0, 2) * Convert.ToDouble(Machine_Per_Hour_Cost), 2);

                    Total_Colors = Gbl_Front_Color + Gbl_Back_Color + Gbl_Special_Front_Color + Gbl_Special_Back_Color;

                    Cut_size = Math.Round(Gbl_Sheet_W, 2) + "x" + Math.Round(Gbl_Sheet_L, 2);
                    Die_Cut_size = Gbl_Die_Size_H + "x" + Gbl_Die_Size_L;
                    Total_Amount = 0;
                    double PlateLength = 0;
                    double PlateArea = 0;
                    int unitpricedecimal = 2;
                    int finalCostRoundDecimal = 2;

                    if (Gbl_DT_CompanyMaster_Flags.Rows.Count > 0)
                    {
                        unitpricedecimal = Convert.ToInt32(Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationPerUnitCostDecimalPlace"] == DBNull.Value
                            ? 2
                            : Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationPerUnitCostDecimalPlace"]);

                        finalCostRoundDecimal = Convert.ToInt32(Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationRoundOffDecimalPlace"] == DBNull.Value
                            ? 2
                            : Gbl_DT_CompanyMaster_Flags.Rows[0]["EstimationRoundOffDecimalPlace"]);

                        if (unitpricedecimal == 0) unitpricedecimal = 2;
                        if (finalCostRoundDecimal == 0) finalCostRoundDecimal = 2;
                    }

                    Op_Amt = Math.Round(Op_Amt, finalCostRoundDecimal);

                    if (Convert.ToDouble(Cylinder_Circumference_MM) > 0)
                    {
                        PlateLength = Cylinder_Circumference_MM;
                    }
                    else
                    {
                        PlateLength = Feed_Amount;
                    }

                    if (PlateChargesType == "Rate/Plate")
                    {
                        PlateArea = 1;
                    }
                    else if (PlateChargesType == "Rate/Sq.CM")
                    {
                        PlateArea = Math.Round((Convert.ToDouble(Paper_Size) * PlateLength) / 100, 3); // in Sq.CM
                    }
                    else if (PlateChargesType == "Rate/Sq.Inch")
                    {
                        PlateArea = Math.Round((Convert.ToDouble(Paper_Size) * PlateLength) / 645.16, 3); // in Sq.Inch
                    }
                    else if (PlateChargesType == "Rate/Sq.Mtr")
                    {
                        PlateArea = Math.Round((Convert.ToDouble(Paper_Size) * PlateLength) / 1000000, 3); // in Sq.Mtr
                    }
                    if (PlateArea == 0) PlateArea = 1;

                    Plate_Amount = Math.Round(Plate_Rate * Plate_Qty * PlateArea, 2);
                    switch (GblCostEstimationMethodType)
                    {
                        case "MATERIAL+PROCESS":
                            Total_Amount = Math.Round(Convert.ToDouble(Plate_Amount) + Convert.ToDouble(Paper_Amount) + Convert.ToDouble(Op_Amt), 2);
                            break;
                        case "MATERIAL+PROCESS+MACHINE":
                            Total_Amount = Math.Round(Convert.ToDouble(Plate_Amount) + Convert.ToDouble(Paper_Amount) + Convert.ToDouble(Op_Amt) + PlanningMachineCost + Convert.ToDouble(TotalMachineCost), 2);
                            break;
                        case "PROCESS+MACHINE":
                            Total_Amount = Math.Round(Convert.ToDouble(Op_Amt) + PlanningMachineCost + Convert.ToDouble(TotalMachineCost), 2);
                            break;
                        case "MATERIAL+MACHINE":
                            Total_Amount = Math.Round(Convert.ToDouble(Plate_Amount) + Convert.ToDouble(Paper_Amount) + PlanningMachineCost + Convert.ToDouble(TotalMachineCost), 2);
                            break;
                        default:
                            Total_Amount = Math.Round(Convert.ToDouble(Plate_Amount) + Convert.ToDouble(Paper_Amount), 2);
                            break;
                    }

                    F_Total_Amount = Total_Amount;
                    Unit_Price = (F_Total_Amount > 0 && Convert.ToDouble(Gbl_Order_Quantity) > 0) ? Math.Round(F_Total_Amount / Convert.ToDouble(Gbl_Order_Quantity), unitpricedecimal) : 0;

                    DataRow newRow = withBlock.NewRow();
                    double Operation_Cost = 0;

                    withBlock.Rows.Add(
                        Gbl_Machine_ID, Gbl_Machine_Name, 0, "", Machine_Colors, Gbl_Paper_ID, Paper_Size, "", 1, 1,
                        Gbl_UPS_H, Gbl_UPS_L, Total_Ups, "", "", 0, Process_Wastage_Percent, Wastage_Paper_Weight_Kg,
                        Gbl_Grain_Direction, Plate_Qty, 0, 0, 0, 0, 0, 0, Total_Paper_Weight_Kg, 0, Paper_Rate, Paper_Amount,
                        Printing_Impressions, Printing_Impressions, 0, 0, 1, 0, 0, Gbl_Order_Quantity, Gbl_Order_Quantity, Total_Colors,
                        Total_Amount, 0, 0, Gbl_Printing_Style, "", Expected_Execution_Time, Total_Req_Machine_Time,
                        Gbl_Paper_Detail, "Flexo Planning", Estimation_Paper_Rate_Type, "", 0, 1, F_Total_Amount,
                        Unit_Price, "", 1, 0, Special_Color_Front_Charges, Special_Color_Back_Charges,
                        Special_Color_Front_Amount, Special_Color_Back_Amount, Operation_Cost, withBlock.Rows.Count + 1,
                        0, 0, GblMainPaperGroup, Gbl_Machine_Type, Cylinder_Tool_ID, Cylinder_Code,
                        Cylinder_Circumference_Inch, Cylinder_Circumference_MM, Cylinder_Width, No_Of_Teeth, Feed_Amount,
                        Gbl_Standard_AC_Gap, Gbl_Actual_Around_Gap, Gbl_Side_Wastage_Strip, Req_Running_Mtr,
                        Make_Ready_Wastage_Running_meter, Break_Down_Wastage_Running_meter, Wastage_Running_Mtr,
                        Process_Wastage_Running_Mtr, Total_Running_Mtr, Req_Square_Mtr, Total_Square_Mtr,
                        Wastage_Square_Meters, Scrap_Square_Meters, Machine_Speed, Machine_Per_Hour_Cost, Total_GSM,
                        Required_Paper_Weight_Kg, Roll_Change_Wastage, 0, FaceGSM, ReleaseGSM, AdhesiveGSM, PaperMill,
                        RollType, Op_Amt, Paper_Amount, PlanningMachineCost, Gbl_windingdirection, Gbl_labeltype,
                        Gbl_finishedformat, Gbl_LabelPerRoll, Gbl_dietype, Gbl_CoreInnerDia, Gbl_CoreOuterDia,
                        Gbl_Order_Quantity, Gbl_Estimation_Unit, Gbl_Other_Material_GSM, PlanOtherMaterialGSMSettingJSON, Required_Paper_Weight_Kg, Gbl_Orientation, PlanContName, false
                    );
                }
            }

            catch (Exception ex)
            {
                str = ex.Message;
            }
        }

        public string ReCalculatePlanningWastage(object ObjGblPlanValues, string WastageType, Double FlatWastageValue, string ContentDomainType, object ObjGblInputValues)
        {
            try
            {
                DataTable DTGblPlanValues = new DataTable();
                DataTable DTGblInputValues = new DataTable();

                // Paper-related variables
                long PaperID = 0;
                string PaperSize = "";
                double TotalGSM = 0;
                string PaperRateType = "";
                double PaperRate = 0;
                double PaperAmount = 0;

                // Machine-related variables
                long MachineID = 0;
                int Machine_Colors = 0;
                double MachineSpeed = 0;
                double MachinePerHourCost = 0;

                // Process info
                double ProcessWastagePercentage = 0;

                // Required values
                double RequiredRunningMeter = 0;
                long RequiredSheets = 0;
                double RequiredSqMeter = 0;
                double RequiredPaperWeight = 0;

                // Wastage values
                double WastageRunningMeter = 0;
                long WastageSheets = 0;
                double WastageSqMeter = 0;
                double WastagePaperWeight = 0;

                // Total values
                double TotalRunningMeter = 0;
                long TotalSheets = 0;
                double TotalSqMeter = 0;
                double TotalPaperWeight = 0;
                double ScrapSquareMeters = 0;
                double RollChangeWastage = 0;
                double AverageRollLength = 0;
                long PrintingImpressions = 0;
                long FinalQuantityInPcs = 0;

                // Imposition / planning
                float FeedValue = 0;
                double TotalUps = 0;
                double MakeReadyWastageRunningMeter = 0;
                double BreakDownWastageRunningMeter = 0;
                long TotalColors = 0;
                long TotalRequiredMachineTime = 0;
                long ExpectedExecutionTime = 0;

                // Cylinder
                long CylinderToolID = 0;
                double CylinderCircumferenceMM = 0;

                // Job/order
                double OrderQty = 0;
                double otherGSM = 0;
                double paperGSM = 0;
                double totalGSMLayers = 0;
                double ZipperWeight = 0;
                double perPieceWeight = 0;
                double perPieceZipperWeight = 0;
                double zipperWtPerMtr = 0;
                double zipperLength = 0;

                // Required material
                double RequiredQtyKg = 0;
                double RequiredQtySQM = 0;
                double RequiredQtyMtr = 0;

                // Job dimensions
                double rollWidth = 0;
                double jobSizeL = 0;
                double jobSizeW = 0;
                double jobSizeH = 0;
                double jobBottomGusset = 0;
                double jobTopSeal = 0;
                double jobCenterSeal = 0;
                double jobSideSeal = 0;
                double jobPastingFlap = 0;
                string jobGrainDirection = "";
                string planContentType = "";
                double openSizeW = 0;
                double openSizeL = 0;
                double estimationQty = 0;

                // Label details
                double labelLengthWithAround = 0;
                double labelHeightWithAcross = 0;
                double acrossGap = 0;
                double aroundGap = 0;
                double aroundUps = 0;
                double acrossUps = 0;
                string errMsg = "";

                // Convert objects to DataTable
                DBConnection.ConvertObjectToDatatable(ObjGblPlanValues, ref DTGblPlanValues, ref errMsg);
                DBConnection.ConvertObjectToDatatable(ObjGblInputValues, ref DTGblInputValues, ref errMsg);

                if (DTGblPlanValues.Rows.Count > 0)
                {
                    PaperID = Convert.ToInt64(DTGblPlanValues.Rows[0]["PaperID"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PaperID"]);
                    PaperSize = DTGblPlanValues.Rows[0]["PaperSize"] == DBNull.Value ? "" : DTGblPlanValues.Rows[0]["PaperSize"].ToString();
                    TotalGSM = Convert.ToDouble(DTGblPlanValues.Rows[0]["PaperTotalGSM"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PaperTotalGSM"]);
                    PaperRateType = DTGblPlanValues.Rows[0]["PaperRateType"] == DBNull.Value ? "KGS" : DTGblPlanValues.Rows[0]["PaperRateType"].ToString();
                    PaperRate = Convert.ToDouble(DTGblPlanValues.Rows[0]["PaperRate"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PaperRate"]);
                    PaperAmount = Convert.ToDouble(DTGblPlanValues.Rows[0]["PaperAmount"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PaperAmount"]);

                    MachineID = Convert.ToInt64(DTGblPlanValues.Rows[0]["MachineID"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["MachineID"]);
                    Machine_Colors = Convert.ToInt32(DTGblPlanValues.Rows[0]["MachineColors"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["MachineColors"]);
                    MachineSpeed = Convert.ToDouble(DTGblPlanValues.Rows[0]["MachineSpeed"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["MachineSpeed"]);

                    RequiredRunningMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["RequiredRunningMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["RequiredRunningMeter"]);
                    RequiredSheets = Convert.ToInt64(DTGblPlanValues.Rows[0]["ActualSheets"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["ActualSheets"]);
                    RequiredSqMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["RequiredSquareMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["RequiredSquareMeter"]);
                    RequiredPaperWeight = Convert.ToDouble(DTGblPlanValues.Rows[0]["RequiredPaperWeightKg"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["RequiredPaperWeightKg"]);
                    WastageRunningMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["WastageRunningMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["WastageRunningMeter"]);
                    WastageSheets = Convert.ToInt64(DTGblPlanValues.Rows[0]["WastageSheets"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["WastageSheets"]);
                    WastageSqMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["WastageSquareMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["WastageSquareMeter"]);
                    WastagePaperWeight = Convert.ToDouble(DTGblPlanValues.Rows[0]["WastageKg"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["WastageKg"]);
                    TotalRunningMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["TotalRequiredRunningMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["TotalRequiredRunningMeter"]);
                    TotalSheets = Convert.ToInt64(DTGblPlanValues.Rows[0]["FullSheets"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["FullSheets"]);
                    TotalSqMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["TotalRequiredSquareMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["TotalRequiredSquareMeter"]);
                    TotalPaperWeight = Convert.ToDouble(DTGblPlanValues.Rows[0]["TotalPaperWeightInKg"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["TotalPaperWeightInKg"]);
                    ScrapSquareMeters = Convert.ToDouble(DTGblPlanValues.Rows[0]["ScrapSquareMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["ScrapSquareMeter"]);
                    RollChangeWastage = Convert.ToDouble(DTGblPlanValues.Rows[0]["RollChangeWastageMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["RollChangeWastageMeter"]);
                    AverageRollLength = Convert.ToDouble(DTGblPlanValues.Rows[0]["AverageRollLength"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["AverageRollLength"]);
                    PrintingImpressions = Convert.ToInt64(DTGblPlanValues.Rows[0]["PrintingImpressions"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PrintingImpressions"]);

                    FeedValue = Convert.ToSingle(DTGblPlanValues.Rows[0]["FeedValue"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["FeedValue"]);
                    TotalUps = Convert.ToDouble(DTGblPlanValues.Rows[0]["TotalUps"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["TotalUps"]);
                    MakeReadyWastageRunningMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["MakeReadyWastageRunningMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["MakeReadyWastageRunningMeter"]);
                    BreakDownWastageRunningMeter = Convert.ToDouble(DTGblPlanValues.Rows[0]["AvgBreakDownRunningMeter"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["AvgBreakDownRunningMeter"]);
                    TotalColors = Convert.ToInt64(DTGblPlanValues.Rows[0]["TotalColors"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["TotalColors"]);
                    TotalRequiredMachineTime = Convert.ToInt64(DTGblPlanValues.Rows[0]["TotalExecutionTime"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["TotalExecutionTime"]);
                    ExpectedExecutionTime = Convert.ToInt64(DTGblPlanValues.Rows[0]["ExpectedExecutionTime"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["ExpectedExecutionTime"]);
                    CylinderToolID = Convert.ToInt64(DTGblPlanValues.Rows[0]["CylinderToolID"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["CylinderToolID"]);
                    CylinderCircumferenceMM = Convert.ToDouble(DTGblPlanValues.Rows[0]["CylinderCircumferenceMM"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["CylinderCircumferenceMM"]);
                    MachinePerHourCost = Convert.ToDouble(DTGblPlanValues.Rows[0]["MachinePerHourRate"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["MachinePerHourRate"]);
                    Gbl_Estimation_Unit = DTGblPlanValues.Rows[0]["EstimationQuantityUnit"] == DBNull.Value ? "" : DTGblPlanValues.Rows[0]["EstimationQuantityUnit"].ToString();
                    OrderQty = Convert.ToDouble(DTGblPlanValues.Rows[0]["PlanContQty"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PlanContQty"]);
                    paperGSM = Convert.ToDouble(DTGblPlanValues.Rows[0]["PaperTotalGSM"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PaperTotalGSM"]);
                    otherGSM = Convert.ToDouble(DTGblPlanValues.Rows[0]["PlanOtherMaterialGSM"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["PlanOtherMaterialGSM"]);

                    zipperWtPerMtr = Convert.ToDouble(DTGblInputValues.Rows[0]["ZipperWeightPerMeter"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["ZipperWeightPerMeter"]);
                    zipperLength = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeZipperLength"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeZipperLength"]);

                    jobSizeL = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeLength"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeLength"]);
                    jobSizeW = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeWidth"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeWidth"]);
                    jobSizeH = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeHeight"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeHeight"]);
                    jobBottomGusset = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeBottomGusset"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeBottomGusset"]);
                    jobTopSeal = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeTopSeal"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeTopSeal"]);
                    jobCenterSeal = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeCenterSeal"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeCenterSeal"]);
                    jobSideSeal = Convert.ToDouble(DTGblInputValues.Rows[0]["SizeSideSeal"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizeSideSeal"]);
                    jobPastingFlap = Convert.ToDouble(DTGblInputValues.Rows[0]["SizePastingflap"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["SizePastingflap"]);

                    jobGrainDirection = DTGblPlanValues.Rows[0]["GrainDirection"] == DBNull.Value ? "" : DTGblPlanValues.Rows[0]["GrainDirection"].ToString();
                    planContentType = DTGblInputValues.Rows[0]["PlanContentType"] == DBNull.Value ? "" : DTGblInputValues.Rows[0]["PlanContentType"].ToString();
                    estimationQty = Convert.ToDouble(DTGblInputValues.Rows[0]["PlanContQty"] == DBNull.Value ? 0 : DTGblInputValues.Rows[0]["PlanContQty"]);

                    acrossGap = Convert.ToDouble(DTGblPlanValues.Rows[0]["AcrossGap"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["AcrossGap"]);
                    aroundGap = Convert.ToDouble(DTGblPlanValues.Rows[0]["AroundGap"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["AroundGap"]);
                    aroundUps = Convert.ToDouble(DTGblPlanValues.Rows[0]["UpsW"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["UpsW"]);
                    acrossUps = Convert.ToDouble(DTGblPlanValues.Rows[0]["UpsL"] == DBNull.Value ? 0 : DTGblPlanValues.Rows[0]["UpsL"]);


                    string k = "Printing_Slabs";
                    DataTable DT_Printing_Slabs = GetDataTable();


                    if (ContentDomainType.ToUpper() == "OFFSET")
                    {
                        return DBConnection.ConvertDataTableToJsonString(DTGblPlanValues);
                    }
                    else if (ContentDomainType.ToUpper() == "FLEXO" | ContentDomainType.ToUpper() == "ROTOGRAVURE" | ContentDomainType.ToUpper() == "LARGEFORMAT")
                    {
                        if (WastageType == "Machine Default")
                        {
                            double TempMachineSlabSpeed = 0;

                            ProcessWastagePercentage = 0;
                            WastageRunningMeter = 0;
                            double tempvalue = 0;
                            long tempvaluelong = 0;
                            string tempvaluestr = "";
                            if (Search_In_Machine_Slabs_Flexo(MachineID, RequiredRunningMeter, ref WastageRunningMeter, ref tempvalue, ref tempvalue, ref tempvalue, ref tempvalue, ref tempvalue, ref tempvaluestr, ref tempvaluelong, ref tempvalue, ref ProcessWastagePercentage, ref TempMachineSlabSpeed))
                            {
                                WastageRunningMeter = Math.Round((WastageRunningMeter + MakeReadyWastageRunningMeter + BreakDownWastageRunningMeter), 3);
                            }
                            else
                            {
                                WastageRunningMeter = Math.Round((MakeReadyWastageRunningMeter + BreakDownWastageRunningMeter), 3);
                            }

                            FlatWastageValue = ProcessWastagePercentage;
                        }
                        else if (WastageType == "Percentage")
                        {
                            WastageRunningMeter = Math.Round(((Int16)RequiredRunningMeter * FlatWastageValue) / 100, 3);
                            WastageRunningMeter = WastageRunningMeter + Math.Round((MakeReadyWastageRunningMeter + BreakDownWastageRunningMeter), 3);
                        }
                        else if (WastageType == "Running Meter")
                        {
                            WastageRunningMeter = Math.Round(FlatWastageValue, 3);
                            WastageRunningMeter = WastageRunningMeter + Math.Round((MakeReadyWastageRunningMeter + BreakDownWastageRunningMeter), 3);
                        }

                        TotalRunningMeter = WastageRunningMeter + RequiredRunningMeter;
                        if (AverageRollLength > 1)
                            RollChangeWastage = Math.Round(((RoundUp((TotalRunningMeter / AverageRollLength), 0) - 1) * 100), 2);
                        WastageRunningMeter = WastageRunningMeter + RollChangeWastage;

                        WastageSqMeter = Math.Round((Convert.ToDouble(PaperSize) / 1000) * WastageRunningMeter, 3);
                        TotalRunningMeter = WastageRunningMeter + RequiredRunningMeter;
                        RequiredSqMeter = Math.Round(((Convert.ToDouble(PaperSize) / 1000) * RequiredRunningMeter), 3);
                        TotalSqMeter = Math.Round(((Convert.ToDouble(PaperSize) / 1000) * TotalRunningMeter), 3);

                        if (MachineSpeed > 0)
                            TotalRequiredMachineTime = (long)Math.Round(TotalRunningMeter / MachineSpeed, 0);

                        if (Gbl_Estimation_Unit == "KGS")
                        {
                            string domain = ContentDomainType.ToUpper();
                            if (domain == "FLEXO" || domain == "LARGEFORMAT")
                            {
                                if (CylinderCircumferenceMM > 0)
                                {
                                    PrintingImpressions = (long)Math.Round((RequiredRunningMeter * 1000) / CylinderCircumferenceMM, 0);
                                }
                                else if (FeedValue > 0)
                                {
                                    PrintingImpressions = (long)Math.Round((RequiredRunningMeter * 1000) / FeedValue, 0);
                                }

                                FinalQuantityInPcs = (long)(PrintingImpressions * TotalUps);
                            }
                            else if (domain == "ROTOGRAVURE")
                            {
                                totalGSMLayers = paperGSM + otherGSM;

                                if (totalGSMLayers > 0 && paperGSM > 0)
                                {
                                    string type = planContentType.ToUpper();
                                    string grain = jobGrainDirection;

                                    if (grain == "With Grain")
                                    {
                                        if (type == "CENTERSEALPOUCH")
                                        {
                                            openSizeW = jobSizeH + (jobTopSeal * 2);
                                            openSizeL = (jobSizeW * 2) + (jobCenterSeal * 2);
                                        }
                                        else if (type == "STANDUPPOUCH")
                                        {
                                            openSizeW = jobSizeL + (jobBottomGusset * 2);
                                            openSizeL = jobSizeW * 2;
                                        }
                                        else if (type == "FLATBOTTOMPOUCH")
                                        {
                                            openSizeW = jobSizeL;
                                            openSizeL = (jobSizeW * 2) + (jobPastingFlap * 2);
                                        }
                                        else if (type == "FOURSIDESEALPOUCH")
                                        {
                                            openSizeW = jobSizeH + (jobSideSeal * 2);
                                            openSizeL = (jobSizeW + jobSideSeal * 2) * 2;
                                        }
                                        else if (type == "PILLOWPOUCH" || type == "THREESIDESEALPOUCH")
                                        {
                                            openSizeW = jobSizeL;
                                            openSizeL = (jobSizeW * 2) + (jobPastingFlap * 2);
                                        }
                                        else if (type == "SPOUTPOUCH" || type == "ROTOLABEL" || type == "OPENSIZEPOUCHWITHZIPPER")
                                        {
                                            openSizeW = jobSizeL;
                                            openSizeL = jobSizeW;
                                        }
                                    }
                                    else // Across grain
                                    {
                                        if (type == "CENTERSEALPOUCH")
                                        {
                                            openSizeW = (jobSizeW * 2) + (jobCenterSeal * 2);
                                            openSizeL = jobSizeH + (jobTopSeal * 2);
                                        }
                                        else if (type == "STANDUPPOUCH")
                                        {
                                            openSizeW = jobSizeW * 2;
                                            openSizeL = jobSizeL + (jobBottomGusset * 2);
                                        }
                                        else if (type == "FLATBOTTOMPOUCH")
                                        {
                                            openSizeW = (jobSizeW * 2) + (jobPastingFlap * 2);
                                            openSizeL = jobSizeL;
                                        }
                                        else if (type == "FOURSIDESEALPOUCH")
                                        {
                                            openSizeW = (jobSizeW + jobSideSeal * 2) * 2;
                                            openSizeL = jobSizeL + (jobSideSeal * 2);
                                        }
                                        else if (type == "PILLOWPOUCH" || type == "THREESIDESEALPOUCH")
                                        {
                                            openSizeW = (jobSizeW * 2) + (jobPastingFlap * 2);
                                            openSizeL = jobSizeL;
                                        }
                                        else if (type == "SPOUTPOUCH" || type == "ROTOLABEL" || type == "OPENSIZEPOUCHWITHZIPPER")
                                        {
                                            openSizeW = jobSizeW;
                                            openSizeL = jobSizeL;
                                        }
                                    }

                                    labelLengthWithAround = Math.Abs(openSizeL + aroundGap);
                                    labelHeightWithAcross = Math.Abs(jobSizeW + acrossGap);

                                    //perPieceWeight = Math.Round(((openSizeW * openSizeL) / 1_000_000.0) * totalGSMLayers / 1000, 6);

                                    if (zipperLength > 0 && zipperWtPerMtr > 0)
                                        perPieceZipperWeight = Math.Round(((zipperLength / 1000) * zipperWtPerMtr) / 1000, 6);
                                    else if (zipperLength == 0 && zipperWtPerMtr > 0)
                                        perPieceZipperWeight = Math.Round(zipperWtPerMtr / 1000, 6);
                                    else
                                        perPieceZipperWeight = 0;

                                    FinalQuantityInPcs = (long)Math.Round(estimationQty / perPieceWeight, 0);
                                    ZipperWeight = Math.Round(FinalQuantityInPcs * perPieceZipperWeight, 2);
                                    FinalQuantityInPcs = (long)Math.Round((estimationQty - ZipperWeight) / perPieceWeight, 0);

                                    RequiredQtyKg = Math.Round((estimationQty - ZipperWeight) * ((paperGSM / totalGSMLayers) * 100) / 100, 2);
                                    RequiredQtySQM = Math.Round((RequiredQtyKg * 1000) / paperGSM, 2);

                                    if (Convert.ToDouble(PaperSize) > 0)
                                    {
                                        RequiredQtyMtr = Math.Ceiling(RequiredQtySQM / (Convert.ToDouble(PaperSize) / 1000.0));
                                        if (aroundUps > 0 && labelLengthWithAround > 0)
                                        {
                                            PrintingImpressions = (long)Math.Round((RequiredQtyMtr * 1000) / (labelLengthWithAround * aroundUps), 0);
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            PrintingImpressions = (long)Math.Round(OrderQty / TotalUps, 0);
                            FinalQuantityInPcs = (long)OrderQty;
                        }

                        RequiredPaperWeight = Math.Round((RequiredSqMeter * TotalGSM) / 1000, 3);
                        WastagePaperWeight = Math.Round((WastageSqMeter * TotalGSM) / 1000, 3);
                        TotalPaperWeight = Math.Round((TotalSqMeter * TotalGSM) / 1000, 3);

                        PaperRateType = PaperRateType.ToString().ToUpper();
                        double paperRateValue = PaperRate;

                        if (PaperRateType == "SQM")
                            PaperAmount = Math.Round(TotalSqMeter * paperRateValue, 2);
                        else if (PaperRateType == "KG")
                            PaperAmount = Math.Round(TotalPaperWeight * paperRateValue, 2);

                        var row = DTGblPlanValues.Rows[0];
                        row["WastageRunningMeter"] = WastageRunningMeter;
                        row["WastageSheets"] = WastageSheets;
                        row["WastageSquareMeter"] = WastageSqMeter;
                        row["WastageKg"] = WastagePaperWeight;
                        row["TotalRequiredRunningMeter"] = TotalRunningMeter;
                        row["FullSheets"] = TotalSheets;
                        row["TotalRequiredSquareMeter"] = TotalSqMeter;
                        row["TotalPaperWeightInKg"] = TotalPaperWeight;
                        row["TotalExecutionTime"] = TotalRequiredMachineTime;
                        row["PaperAmount"] = PaperAmount;
                        row["FinalQuantityInPcs"] = FinalQuantityInPcs;
                        row["PrintingImpressions"] = PrintingImpressions;

                        return DBConnection.ConvertDataTableToJsonString(DTGblPlanValues);
                    }
                    return DBConnection.ConvertDataTableToJsonString(DTGblPlanValues);
                }
                else
                    return "No Data";
            }
            catch (Exception ex)
            {
                str = ex.Message;
                return str;
            }
        }

        private bool CategoryWiseWastage(long Category_ID, string PrintingStyle, double ActualRequiredQty, ref long WastageSheets, ref long WastageRunningMeter, int FrontColors, int BackColors)
        {
            int NoOfColors;
            double FlatWastageQty;
            double PercentageWastageQty = 0;
            double Wastepercent;
            string WastageUnit = "";

            switch (Gbl_Content_Domain_Type.ToUpper())
            {
                case "OFFSET":
                    WastageUnit = "Sheets";
                    break;
                case "FLEXO":
                case "ROTOGRAVURE":
                case "LARGEFORMAT":
                    WastageUnit = "Running Meter";
                    break;
            }

            DataRow row = Gbl_DT_Category_Wastage.Select($"CategoryID = {Category_ID}").FirstOrDefault();
            if (row != null)
            {
                if (FrontColors > 0 && BackColors > 0)
                {
                    if (FrontColors == BackColors)
                    {
                        NoOfColors = FrontColors;
                        DataRow row2 = Gbl_DT_Category_Wastage.Select($"CategoryID = {Category_ID} AND PrintingStyle = 'Both Side' AND Unit = '{WastageUnit}' AND NoOfColor = {NoOfColors}").FirstOrDefault();
                        if (row2 != null)
                        {
                            FlatWastageQty = row2.IsNull(4) ? 0 : Convert.ToDouble(row2[4]);
                            Wastepercent = row2.IsNull(5) ? 0 : Convert.ToDouble(row2[5]);
                            if (Wastepercent > 0)
                                PercentageWastageQty = Math.Round(ActualRequiredQty * (Wastepercent / 100), WastageUnit == "Sheets" ? 0 : 2);
                            WastageSheets = (long)Math.Max(FlatWastageQty, PercentageWastageQty);
                        }
                    }
                    else
                    {
                        NoOfColors = FrontColors;
                        DataRow row1 = Gbl_DT_Category_Wastage.Select($"CategoryID = {Category_ID} AND PrintingStyle = 'Single Side' AND Unit = '{WastageUnit}' AND NoOfColor = {NoOfColors}").FirstOrDefault();
                        if (row1 != null)
                        {
                            FlatWastageQty = row1.IsNull(4) ? 0 : Convert.ToDouble(row1[4]);
                            Wastepercent = row1.IsNull(5) ? 0 : Convert.ToDouble(row1[5]);
                            if (Wastepercent > 0)
                                PercentageWastageQty = Math.Round(ActualRequiredQty * (Wastepercent / 100), WastageUnit == "Sheets" ? 0 : 2);
                            WastageSheets = (long)Math.Max(FlatWastageQty, PercentageWastageQty);
                        }

                        NoOfColors = BackColors;
                        DataRow row2 = Gbl_DT_Category_Wastage.Select($"CategoryID = {Category_ID} AND PrintingStyle = 'Single Side' AND Unit = '{WastageUnit}' AND NoOfColor = {NoOfColors}").FirstOrDefault();
                        if (row2 != null)
                        {
                            FlatWastageQty = row2.IsNull(4) ? 0 : Convert.ToDouble(row2[4]);
                            Wastepercent = row2.IsNull(5) ? 0 : Convert.ToDouble(row2[5]);
                            if (Wastepercent > 0)
                                PercentageWastageQty = Math.Round(ActualRequiredQty * (Wastepercent / 100), WastageUnit == "Sheets" ? 0 : 2);
                            WastageSheets += (long)Math.Max(FlatWastageQty, PercentageWastageQty);
                        }
                    }
                }
                else
                {
                    NoOfColors = FrontColors > 0 ? FrontColors : BackColors;
                    DataRow row1 = Gbl_DT_Category_Wastage.Select($"CategoryID = {Category_ID} AND PrintingStyle = 'Single Side' AND Unit = '{WastageUnit}' AND NoOfColor = {NoOfColors}").FirstOrDefault();
                    if (row1 != null)
                    {
                        FlatWastageQty = row1.IsNull(4) ? 0 : Convert.ToDouble(row1[4]);
                        Wastepercent = row1.IsNull(5) ? 0 : Convert.ToDouble(row1[5]);
                        if (Wastepercent > 0)
                            PercentageWastageQty = Math.Round(ActualRequiredQty * (Wastepercent / 100), WastageUnit == "Sheets" ? 0 : 2);
                        WastageSheets = (long)Math.Max(FlatWastageQty, PercentageWastageQty);
                    }
                }
                return true;
            }
            return false;
        }

        public string calculateoprcost([FromBody] OperationRequest req, bool type, string category, string content)
        {
            try
            {
                string DefaultProcessIds = "";
                DataTable dt = new DataTable();
                string GetProcessIds(string query)
                {
                    DataTable tempDt = new DataTable();
                    DBConnection.FillDataTable(ref tempDt, query);

                    if (tempDt.Rows.Count > 0 &&
                        tempDt.Rows[0][0] != DBNull.Value &&
                        !string.IsNullOrWhiteSpace(tempDt.Rows[0][0].ToString()))
                    {
                        return tempDt.Rows[0][0].ToString();
                    }
                    return string.Empty;
                }
                if (type)
                {
                    string query = $@" SELECT STRING_AGG(CAST(CP.ProcessID AS VARCHAR(10)), ',') AS ProcessID FROM CategoryWiseProcessAllocation AS CP INNER JOIN ContentMaster AS C ON CP.ContentID = C.ContentID AND ISNULL(CP.IsDeletedTransaction, 0) = 0 WHERE CP.CategoryID = {category} AND C.ContentName = '{content}';";
                    DefaultProcessIds = GetProcessIds(query);
                    if (string.IsNullOrWhiteSpace(DefaultProcessIds))
                    {
                        query = $@"SELECT STRING_AGG(CAST(CP.ProcessID AS VARCHAR(10)), ',') AS ProcessID FROM DomainWiseProcessAllocation AS CP INNER JOIN ContentMaster AS C ON CP.DomainType = C.ContentDomainType AND ISNULL(CP.IsDeletedTransaction, 0) = 0 AND ISNULL(C.IsActive, 0) = 1 WHERE C.ContentName = '{content}';";
                        DefaultProcessIds = GetProcessIds(query);
                    }
                }

                double Pub_Sheets = 0;
                double Pub_RMT = 0;
                double opExecutionTime = 0;
                double opTotalExecutionTime = 0;
                double machineCost = 0;
                double makeReadyExecutionCost = 0;
                double ExecutionCost = 0;
                long Machine_Speed = req.Machine_Speed, Make_Ready_Time = req.Make_Ready_Time, Job_Change_Over_Time = req.Job_Change_Over_Time;
                double TempMachineSpeed1 = 0;
                double TempMakeReadyTime1 = 0;
                double TempJobChangeOverTime1 = 0;
                double TempMakeReadyPerHourCost = 0;
                double TempMachineSlabSpeed = 0;
                double MachinePerHourCost = 0;
                string PerHourCostingParameter = "";
                string MakeReadyTimeMode = "";
                long Total_Colors = req.Total_Colors;
                double Actual_Sheets = req.Actual_Sheets;
                double Wastage_Sheets = req.Wastage_Sheets, PerHourQty = 0.0;
                long Make_Readies = 0, Make_Ready_Sheets_Total = req.Make_Ready_Sheets_Total;
                double Final_Quantity = req.Final_Quantity, Printing_Impressions = 0, Total_Cut_Sheets = 0;

                Gbl_Content_Domain_Type = req.Gbl_Content_Domain_Type;
                GblOperId = !string.IsNullOrWhiteSpace(DefaultProcessIds) ? DefaultProcessIds : req.GblOperId;
                double Total_Paper_In_KG = req.Total_Paper_In_KG;
                double Total_Ups = req.Total_Ups;
                long No_Of_Sets = req.No_Of_Sets;
                long Plate_Qty = req.Plate_Qty;
                Gbl_Order_Quantity = req.Gbl_Order_Quantity;
                Gbl_Sheet_L = req.Gbl_Sheet_L;
                Gbl_Sheet_W = req.Gbl_Sheet_W;
                Gbl_Machine_ID = req.Gbl_Machine_ID;

                Total_Cut_Sheets = RoundUp((Actual_Sheets), 0) + RoundUp((Make_Ready_Sheets_Total), 0) + RoundUp((Wastage_Sheets), 0);

                LoadAllGrids();
                DataTable DTOPR = Gbl_DT_Operation.Copy();
                DTOPR.Clear();
                str = "Select PM.ProcessID,PM.Rate,'' as RateFactor,ProcessName,ISNULL(MM.MachineID,0) as MachineID,CASE WHEN ISNULL(PAM.MachineSpeed,0) > 0 THEN ISNULL(PAM.MachineSpeed,0) ELSE MM.MachineSpeed END as MachineSpeed,CASE WHEN ISNULL(PAM.MakeReadyTime,0) > 0 THEN ISNULL(PAM.MakeReadyTime,0) ELSE MM.MakeReadyTime END as MakeReadyTime,CASE WHEN ISNULL(PAM.JobChangeOverTime,0) > 0 THEN ISNULL(PAM.JobChangeOverTime,0) ELSE MM.JobChangeOverTime END as JobChangeOverTime,ISNULL(MM.MakeReadyPerHourCost,0) as MakeReadyPerHourCost,''as Remarks,0 as PaperConsumptionRequired,DM.SequenceNo as DepartmentSequenceNo,ProcessFlatWastageValue,ProcessWastagePercentage,ProcessProductionType,ISNULL(PM.PerHourCostingParameter,'') as PerHourCostingParameter, 0 as PerHourCalculationQuantity,ISNULL(PerHourCost,0) as MachinePerHourCost " +
                      " From ProcessMaster AS PM INNER JOIN DepartmentMaster as DM ON DM.DepartmentID = PM.DepartmentID LEFT join ProcessAllocatedMachineMaster AS PAM ON PM.ProcessID = PAM.ProcessID And ISNULL(IsDefaultMachine,0) = 1 LEFT join MachineMaster as MM  ON PAM.MachineID = MM.MachineID Where ISNULL(PM.IsDeletedTransaction,0) = 0 And PM.ProcessID IN(" + (!string.IsNullOrWhiteSpace(GblOperId) ? GblOperId : "0") + ")";
                DBConnection.FillDataTable(ref GblDTOprFactors, str);


                for (var j = 0; j <= GblDTOprFactors.Rows.Count - 1; j++)
                {
                    for (var i = 0; i <= Gbl_DT_Operation.Rows.Count - 1; i++)
                    {
                        opExecutionTime = 0;
                        if (Gbl_DT_Operation.Rows[i][6].ToString() == "Pre")
                            Pub_Sheets = req.Full_Sheets;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "Actual Sheets" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets")
                            Pub_Sheets = Actual_Sheets;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets + Make Ready Sheets")
                            Pub_Sheets = Actual_Sheets + Make_Readies;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets + Wastage Sheets")
                            Pub_Sheets = Actual_Sheets + Wastage_Sheets + req.Process_Wastage_Sheets;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Sheets + Make Ready Sheets + Wastage Sheets")
                            Pub_Sheets = (req.Full_Sheets * ((req.Cut_L * req.Cut_H) + (req.Cut_H_L * req.Cut_L_H)));
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "Actual Running Meter" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter")
                            Pub_RMT = req.Req_Running_Mtr;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter + Make Ready Running Meter")
                            Pub_RMT = req.Req_Running_Mtr;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter + Wastage Running Meter")
                            Pub_RMT = req.Req_Running_Mtr;
                        else if ((Gbl_DT_Operation.Rows[i][5] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][5].ToString()) == "Actual Running Meter + Make Ready Running Meter + Wastage Running Meter")
                            Pub_RMT = req.Total_Running_Mtr;

                        if (Gbl_DT_Operation.Rows[i][4].ToString().ToUpper() == "PROCESS")
                        {
                            Gbl_DT_Operation.Rows[i][7] = Math.Round(Gbl_Sheet_L / 25.4, 2);
                            Gbl_DT_Operation.Rows[i][8] = Math.Round(Gbl_Sheet_W / 25.4, 2);
                        }
                        else
                        {
                            Gbl_DT_Operation.Rows[i][7] = 0;
                            Gbl_DT_Operation.Rows[i][8] = 0;
                        }
                        double QTY = 0;
                        string typeofcharge = "";
                        typeofcharge = Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString();
                        if (typeofcharge.Contains("Order Quantity") | typeofcharge.Contains("OrderQuantity"))
                            QTY = Gbl_Order_Quantity;
                        else if (typeofcharge.Contains("Unit"))
                            QTY = Final_Quantity;
                        else if (typeofcharge.Contains("Sheet"))
                            QTY = Pub_Sheets;
                        else if (typeofcharge.Contains("PCS"))
                            QTY = Final_Quantity;

                        if (typeofcharge.Contains("Calendar-Inch"))
                            Gbl_DT_Operation.Rows[i][7] = RoundUp(Gbl_Job_L / 25.4, 2);

                        if (Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]) == Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["ProcessID"]))
                        {
                            for (int k = 0; k < GblDTOprSlabs.Rows.Count; k++)
                            {
                                int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                int factorProcessID = Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["ProcessID"]);
                                int slabProcessID = Convert.ToInt32(GblDTOprSlabs.Rows[k]["ProcessID"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["ProcessID"]);
                                if (operationProcessID == slabProcessID)
                                {
                                    double fromQty = Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["FromQty"]);
                                    if (fromQty >= 1 && factorProcessID == slabProcessID)
                                    {
                                        double qty = QTY;
                                        double fromQtyVal = Convert.ToDouble(GblDTOprSlabs.Rows[k]["FromQty"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["FromQty"]);
                                        double toQtyVal = Convert.ToDouble(GblDTOprSlabs.Rows[k]["ToQty"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["ToQty"]);

                                        string rateFactorFactor = (GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"].ToString()).Replace("-", "");
                                        string rateFactorSlab = (GblDTOprSlabs.Rows[k]["RateFactor"] == DBNull.Value ? "" : GblDTOprSlabs.Rows[k]["RateFactor"].ToString()).Replace("-", "");

                                        if (qty >= fromQtyVal && qty <= toQtyVal && rateFactorFactor == rateFactorSlab)
                                        {
                                            Gbl_DT_Operation.Rows[i][1] = Convert.ToDouble(GblDTOprSlabs.Rows[k]["Rate"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["Rate"]);
                                            Gbl_DT_Operation.Rows[i][2] = Convert.ToDouble(GblDTOprSlabs.Rows[k]["MinimumCharges"] == DBNull.Value ? 0 : GblDTOprSlabs.Rows[k]["MinimumCharges"]);
                                            break; // Exit For
                                        }
                                    }
                                }
                            }
                            double Amt = Calculate_Operations(Gbl_DT_Operation.Rows[i][0] == DBNull.Value ? "" : Gbl_DT_Operation.Rows[i][0].ToString(), Gbl_DT_Operation.Rows[i][1] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][1]), Gbl_DT_Operation.Rows[i][2] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][2]),
                                Convert.ToInt64(Final_Quantity), Convert.ToInt64(Final_Quantity), Gbl_DT_Operation.Rows[i][3] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][3]),
                                Convert.ToInt64(Total_Paper_In_KG), Convert.ToInt64(Total_Ups), No_Of_Sets, Gbl_DT_Operation.Rows[i][7] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][7]), Gbl_DT_Operation.Rows[i][8] == DBNull.Value ? 0 : Convert.ToDouble(Gbl_DT_Operation.Rows[i][8]),
                                Total_Colors, Pub_Sheets, Gbl_Job_L, Gbl_Job_H, Gbl_Job_W, Plate_Qty, Convert.ToInt64(Gbl_Order_Quantity), Gbl_DT_Operation.Rows[i]["PagesPerSection"] == DBNull.Value ? 1 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["PagesPerSection"]),
                                Gbl_DT_Operation.Rows[i]["NoOfForms"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["NoOfForms"]));

                            // Assign calculated values back to DataTable
                            Gbl_DT_Operation.Rows[i][11] = Math.Round(Amt, 3).ToString();
                            Gbl_DT_Operation.Rows[i][12] = Gbl_DT_plan.Rows.Count + 1;
                            Gbl_DT_Operation.Rows[i][15] = Math.Round(QTY, 3).ToString();
                            Gbl_DT_Operation.Rows[i][16] = Total_Ups;
                            Gbl_DT_Operation.Rows[i][17] = 1;
                            Gbl_DT_Operation.Rows[i]["NoOfColors"] = Total_Colors;

                            //if ((Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (GblDTOprFactors.Rows[j]["ProcessID"] == DBNull.Value ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                            //{
                            MachinePerHourCost = 0;
                            PerHourCostingParameter = "";
                            TempMachineSpeed1 = 0;
                            TempMakeReadyTime1 = 0;
                            TempJobChangeOverTime1 = 0;
                            TempMakeReadyPerHourCost = 0;
                            Gbl_DT_Operation.Rows[i][19] = GblDTOprFactors.Rows[j]["RateFactor"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["RateFactor"];
                            Gbl_DT_Operation.Rows[i]["Remarks"] = GblDTOprFactors.Rows[j]["Remarks"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["Remarks"];
                            Gbl_DT_Operation.Rows[i]["PaperConsumptionRequired"] = GblDTOprFactors.Rows[j]["PaperConsumptionRequired"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["PaperConsumptionRequired"];
                            if ((Gbl_DT_Operation.Rows[i]["DepartmentID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["DepartmentID"]).Equals(100))
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Gbl_Machine_ID;
                                Gbl_DT_Operation.Rows[i]["MachineName"] = Gbl_Machine_Name;
                                if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) > 0 && Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]) == Convert.ToDouble(Gbl_Machine_ID))
                                {
                                    for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                    {
                                        int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                        int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                        int allocMachineID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"]);
                                        int operationMachineID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineID"]);

                                        if (allocProcessID == operationProcessID && allocMachineID == operationMachineID)
                                        {
                                            MakeReadyTimeMode = Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"].ToString();
                                            if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]) > 0)
                                            {
                                                TempMachineSpeed1 = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                                            }
                                            else
                                            {
                                                TempMachineSpeed1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"]);
                                            }
                                            if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]) > 0)
                                            {
                                                TempMakeReadyTime1 = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                                            }
                                            else
                                            {
                                                double makeReadyTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"]);
                                                TempMakeReadyTime1 = makeReadyTime1 * ((string.IsNullOrWhiteSpace(MakeReadyTimeMode) || MakeReadyTimeMode.Trim().ToUpper() == "FLAT") ? 1 : Total_Colors);
                                            }
                                            TempJobChangeOverTime1 = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                                            TempMakeReadyPerHourCost = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"]);
                                            MachinePerHourCost = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                        }
                                    }
                                    if (TempMachineSpeed1 > 0)
                                    {
                                        TempMachineSlabSpeed = TempMachineSpeed1;
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSpeed1;
                                    }
                                    else
                                    {
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Machine_Speed;
                                        TempMachineSlabSpeed = Machine_Speed;
                                    }
                                    Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = (TempMakeReadyTime1 > 0) ? TempMakeReadyTime1 : Make_Ready_Time;
                                    Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = (TempJobChangeOverTime1 > 0) ? TempJobChangeOverTime1 : Job_Change_Over_Time;
                                    Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = MachinePerHourCost;
                                    Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = TempMakeReadyPerHourCost;
                                }
                                else
                                {
                                    Gbl_DT_Operation.Rows[i]["MachineID"] = Gbl_Machine_ID;
                                    Gbl_DT_Operation.Rows[i]["MachineName"] = Gbl_Machine_Name;

                                    for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                    {
                                        int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                        int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                        int allocMachineID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"]);
                                        int operationMachineID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineID"]);

                                        if (allocProcessID == operationProcessID && allocMachineID == operationMachineID)
                                        {
                                            MakeReadyTimeMode = Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTimeMode"].ToString();
                                            TempMachineSpeed1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"]);
                                            double makeReadyTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"]);
                                            TempMakeReadyTime1 = makeReadyTime1 * ((string.IsNullOrWhiteSpace(MakeReadyTimeMode) || MakeReadyTimeMode.Trim().ToUpper() == "FLAT") ? 1 : Total_Colors);
                                            TempJobChangeOverTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"]);
                                            TempMakeReadyPerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"]);
                                            MachinePerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"]);
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                            break;
                                        }
                                    }
                                    if (TempMachineSpeed1 > 0)
                                    {
                                        TempMachineSlabSpeed = TempMachineSpeed1;
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSpeed1;
                                    }
                                    else
                                    {
                                        Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Machine_Speed;
                                        TempMachineSlabSpeed = Machine_Speed;
                                    }
                                    Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = (TempMakeReadyTime1 > 0) ? TempMakeReadyTime1 : Make_Ready_Time;
                                    Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = (TempJobChangeOverTime1 > 0) ? TempJobChangeOverTime1 : Job_Change_Over_Time;
                                    Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = MachinePerHourCost;
                                    Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = TempMakeReadyPerHourCost;
                                }
                            }
                            else if (Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] ?? 0) > 0)
                            {
                                Gbl_DT_Operation.Rows[i]["MachineID"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineID"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineID"]);
                                Gbl_DT_Operation.Rows[i]["MachineSpeed"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachineSpeed"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachineSpeed"]);
                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyTime"]);
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["JobChangeOverTime"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["JobChangeOverTime"]);
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MachinePerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MachinePerHourCost"]);
                                Gbl_DT_Operation.Rows[i]["PerHourCalculationQuantity"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["PerHourCalculationQuantity"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["PerHourCalculationQuantity"]);
                                Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = Convert.ToDouble(GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : GblDTOprFactors.Rows[j]["MakeReadyPerHourCost"]);
                                PerHourCostingParameter = GblDTOprFactors.Rows[j]["PerHourCostingParameter"] == DBNull.Value ? "" : GblDTOprFactors.Rows[j]["PerHourCostingParameter"].ToString();
                                if (string.IsNullOrWhiteSpace(PerHourCostingParameter))
                                {
                                    for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                    {
                                        int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                        int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                        int allocMachineID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineID"]);
                                        int operationMachineID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["MachineID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineID"]);

                                        if (allocProcessID == operationProcessID && allocMachineID == operationMachineID)
                                        {
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                            break;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                for (int x = 0; x < Gbl_DT_Operation_Machine_Allocation.Rows.Count; x++)
                                {
                                    int allocProcessID = Convert.ToInt32(Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["ProcessID"]);
                                    int operationProcessID = Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["ProcessID"]);
                                    if (allocProcessID == operationProcessID)
                                    {
                                        bool isDefaultMachine = Gbl_DT_Operation_Machine_Allocation.Rows[x]["IsDefaultMachine"] != DBNull.Value && Convert.ToBoolean(Gbl_DT_Operation_Machine_Allocation.Rows[x]["IsDefaultMachine"]);
                                        if (isDefaultMachine)
                                        {
                                            TempMachineSpeed1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachineSpeed"]);
                                            TempMakeReadyTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyTime"]);
                                            TempJobChangeOverTime1 = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["JobChangeOverTime"]);
                                            TempMakeReadyPerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MakeReadyPerHourCost"]);
                                            MachinePerHourCost = Convert.ToDouble(Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation_Machine_Allocation.Rows[x]["MachinePerHourCost"]);
                                            PerHourCostingParameter = Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"] == DBNull.Value ? "" : Gbl_DT_Operation_Machine_Allocation.Rows[x]["PerHourCostingParameter"].ToString();
                                            goto CalculateMachineCost;
                                        }
                                    }
                                }
                            CalculateMachineCost:
                                if (TempMachineSpeed1 > 0)
                                {
                                    TempMachineSlabSpeed = TempMachineSpeed1;
                                    Gbl_DT_Operation.Rows[i]["MachineSpeed"] = TempMachineSpeed1;
                                }
                                Gbl_DT_Operation.Rows[i]["MakeReadyTime"] = TempMakeReadyTime1;
                                Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] = TempJobChangeOverTime1;
                                Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] = MachinePerHourCost;
                                Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] = TempMakeReadyPerHourCost;
                            }
                            if (!string.IsNullOrWhiteSpace(PerHourCostingParameter))
                            {
                                if (PerHourCostingParameter.Trim() == "Actual Sheets")
                                {
                                    PerHourQty = Actual_Sheets;
                                }
                                else if (PerHourCostingParameter.Trim() == "Actual Sheets + Make Ready Sheets")
                                {
                                    PerHourQty = Actual_Sheets + Make_Ready_Sheets_Total;
                                }
                                else if (PerHourCostingParameter.Trim() == "Actual Sheets + Wastage Sheets")
                                {
                                    PerHourQty = Actual_Sheets + Wastage_Sheets;
                                }
                                else if (PerHourCostingParameter.Trim() == "Actual Sheets + Make Ready Sheets + Wastage Sheets")
                                {
                                    PerHourQty = Total_Cut_Sheets;
                                }
                                else if (PerHourCostingParameter.Trim() == "Printing Impresions")
                                {
                                    PerHourQty = (Printing_Impressions * Make_Readies);
                                }
                                else if (PerHourCostingParameter.Trim() == "Order Quantity")
                                {
                                    PerHourQty = Gbl_Order_Quantity;
                                }
                                else if (PerHourCostingParameter.Trim() == "Final Qty")
                                {
                                    PerHourQty = Final_Quantity;
                                }
                                else
                                {
                                    PerHourQty = Total_Cut_Sheets;
                                }
                            }
                            else
                            {
                                PerHourQty = 0;
                            }

                            //}

                            if (Convert.ToDouble(PerHourQty) > 0)
                            {
                                Gbl_DT_Operation.Rows[i]["PerHourCalculationQuantity"] = Convert.ToDouble(PerHourQty);
                                if (Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineSpeed"]) > 0)
                                {
                                    opExecutionTime = Math.Round(Convert.ToDouble(PerHourQty) / Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachineSpeed"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachineSpeed"]));
                                }
                                else
                                {
                                    opExecutionTime = 0;
                                }

                                Gbl_DT_Operation.Rows[i]["ExecutionTime"] = opExecutionTime;
                            }
                            double makeReadyTime = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyTime"]);
                            double jobChangeOverTime = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["JobChangeOverTime"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["JobChangeOverTime"]);

                            Gbl_DT_Operation.Rows[i]["TotalExecutionTime"] = Math.Round(opExecutionTime + makeReadyTime + jobChangeOverTime);
                            opTotalExecutionTime = Math.Round(opExecutionTime + makeReadyTime + jobChangeOverTime);
                            double machinePerHourCost = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MachinePerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MachinePerHourCost"]);
                            ExecutionCost = Math.Round(Math.Round(opExecutionTime / 60, 2) * machinePerHourCost, 2);
                            Gbl_DT_Operation.Rows[i]["ExecutionCost"] = Math.Round(ExecutionCost, 2);
                            double makeReadyPerHourCost = Convert.ToDouble(Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"] == DBNull.Value ? 0 : Gbl_DT_Operation.Rows[i]["MakeReadyPerHourCost"]);
                            makeReadyExecutionCost = Math.Round(Math.Round(makeReadyTime / 60, 2) * makeReadyPerHourCost, 2);
                            Gbl_DT_Operation.Rows[i]["MakeReadyMachineCost"] = Math.Round(makeReadyExecutionCost, 2);
                            machineCost = Math.Round(ExecutionCost + makeReadyExecutionCost, 2);
                            if (!Convert.IsDBNull(Gbl_DT_Operation.Rows[i]["IsOnlineProcess"]) && Convert.ToBoolean(Gbl_DT_Operation.Rows[i]["IsOnlineProcess"]))
                            {
                                machineCost = 0;
                            }
                            Gbl_DT_Operation.Rows[i]["MachineCost"] = Convert.ToDouble(machineCost);
                            if ((Convert.IsDBNull(Gbl_DT_Operation.Rows[i]["ProcessID"]) ? 0 : Convert.ToInt32(Gbl_DT_Operation.Rows[i]["ProcessID"])) == (Convert.IsDBNull(GblDTOprFactors.Rows[j]["ProcessID"]) ? 0 : Convert.ToInt32(GblDTOprFactors.Rows[j]["ProcessID"])))
                            {
                                DTOPR.ImportRow(Gbl_DT_Operation.Rows[i]);
                            }
                        }
                    }
                }
                var sortedRows = DTOPR.AsEnumerable()
        .OrderBy(row => SafeDecimal(row["DepartmentSequenceNo"]));
                decimal SafeDecimal(object value)
                {
                    if (value == null || value == DBNull.Value)
                        return 0;

                    decimal result;
                    return decimal.TryParse(value.ToString(), out result) ? result : 0;
                }
                DataTable sortedTable = sortedRows.Take(5).CopyToDataTable();

                return DBConnection.ConvertDataTableToJsonString(sortedTable);
            }
            catch (Exception ex)
            {
                //return new OperationResponse<DataTable>
                //{
                //    success = false,
                //    message = "Error: " + ex.Message,
                //    result = null
                //};
                return ex.Message;
            }
        }

        //private void ApplyCostingCalculations(ref DataTable planTable, ref DataTable processTable, long categoryID, string plantID, ref DataTable AllocatedMaterials, ref DataTable MaterialParams)
        //{
        //    // ---------- LOCAL SAFE COPY (important for lambdas) ----------
        //    DataTable planTableLocal = planTable;

        //    DataTable DefaultMaterials = new DataTable();
        //    DataTable FinaltMaterials = new DataTable();
        //    DataTable FinalMaterialParamsGrid = new DataTable();
        //    DataTable dataTable = new DataTable();

        //    #region Columns
        //    FinalMaterialParamsGrid.Columns.Add("PlanContQty", typeof(decimal));
        //    FinalMaterialParamsGrid.Columns.Add("PlanContentType", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("PlanContName", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("TransID", typeof(long));
        //    FinalMaterialParamsGrid.Columns.Add("ProcessID", typeof(long));
        //    FinalMaterialParamsGrid.Columns.Add("MachineID", typeof(long));
        //    FinalMaterialParamsGrid.Columns.Add("ItemSubGroupID", typeof(long));
        //    FinalMaterialParamsGrid.Columns.Add("FieldName", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("FieldDescription", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("FieldDisplayName", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("ItemMasterFieldName", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("AppVariableName", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("CalculationFormula", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("DefaultValue", typeof(decimal));
        //    FinalMaterialParamsGrid.Columns.Add("DisplaySequenceNo", typeof(int));
        //    FinalMaterialParamsGrid.Columns.Add("DomainType", typeof(string));
        //    FinalMaterialParamsGrid.Columns.Add("IsDisplayField", typeof(bool));
        //    FinalMaterialParamsGrid.Columns.Add("IsEditableField", typeof(bool));
        //    FinalMaterialParamsGrid.Columns.Add("FieldValue", typeof(string));
        //    #endregion

        //    #region Columns
        //    FinaltMaterials.Columns.Add("PlanContQty", typeof(decimal));
        //    FinaltMaterials.Columns.Add("PlanContentType", typeof(string));
        //    FinaltMaterials.Columns.Add("PlanContName", typeof(string));
        //    FinaltMaterials.Columns.Add("TransID", typeof(long));
        //    FinaltMaterials.Columns.Add("ProcessID", typeof(long));
        //    FinaltMaterials.Columns.Add("MachineID", typeof(long));
        //    FinaltMaterials.Columns.Add("ItemSubGroupID", typeof(long));
        //    FinaltMaterials.Columns.Add("RequiredQuantityInStockUnit", typeof(double));
        //    FinaltMaterials.Columns.Add("BookedQtyInPurchaseUnit", typeof(string));
        //    FinaltMaterials.Columns.Add("RequiredQtyUnit", typeof(string));
        //    FinaltMaterials.Columns.Add("PurchaseUnit", typeof(string));
        //    FinaltMaterials.Columns.Add("EstimatedQuantity", typeof(double));
        //    FinaltMaterials.Columns.Add("EstimationRate", typeof(double));
        //    FinaltMaterials.Columns.Add("EstimationUnit", typeof(string));
        //    FinaltMaterials.Columns.Add("EstimatedAmount", typeof(double));
        //    #endregion


        //    #region AppVariable Mapping
        //    Dictionary<string, string> AppVariableMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        //    {
        //        { "TotalRequiredSquareMeter", "RequiredSquareMeter" },
        //        { "PlanContQty", "FinalQuantity" },
        //        { "TotalPaperWeightWithCorrugation", "TotalPaperWeightInKg" },
        //        { "WastagePercentage", "WastePerc" },
        //        { "PaperSizeL", "PaperSize" },
        //        { "PaperSizeW", "PaperSize" },
        //        { "CutSizeL", "CutSize" },
        //        { "CutSizeW", "CutSize" },
        //        { "ActualSheets", "ActualSheets" },
        //        { "FullSheets", "FullSheets" },
        //        { "TotalUps", "TotalUps" },
        //        { "TotalRequiredRunningMeter", "TotalRequiredRunningMeter" }
        //    };
        //    #endregion

        //    string GBLCompanyID = Convert.ToString(HttpContext.Current.Session["CompanyID"]);
        //    DataRow planRow = (planTableLocal != null && planTableLocal.Rows.Count > 0) ? planTableLocal.Rows[0] : null;

        //    #region Resolver (SAFE, DEFAULT-FIRST)
        //    decimal ResolveVariableValue(string variable, long processID, long machineID, long itemSubGroupID, DataRow paramRow)
        //    {
        //        DataRow[] found = FinalMaterialParamsGrid.Select(
        //            "FieldName = '" + variable.Replace("'", "''") + "' " +
        //            "AND ProcessID=" + processID +
        //            " AND MachineID=" + machineID +
        //            " AND ItemSubGroupID=" + itemSubGroupID,
        //            "DisplaySequenceNo DESC"
        //        );

        //        if (found.Length > 0 && found[0]["FieldValue"] != DBNull.Value)
        //            return Convert.ToDecimal(found[0]["FieldValue"]);

        //        if (planRow != null && AppVariableMap.ContainsKey(variable))
        //        {
        //            string col = AppVariableMap[variable];
        //            if (planTableLocal.Columns.Contains(col) && planRow[col] != DBNull.Value)
        //            {
        //                string raw = Convert.ToString(planRow[col]);

        //                if ((variable.EndsWith("L") || variable.EndsWith("W")) && raw.Contains("x"))
        //                {
        //                    string[] p = raw.Split('x');
        //                    return variable.EndsWith("L") ? Convert.ToDecimal(p[0]) : Convert.ToDecimal(p[1]);
        //                }

        //                return Convert.ToDecimal(planRow[col]);
        //            }
        //        }

        //        if (planRow != null &&
        //            planTableLocal.Columns.Contains(variable) &&
        //            planRow[variable] != DBNull.Value)
        //        {
        //            return Convert.ToDecimal(planRow[variable]);
        //        }

        //        decimal def = Convert.ToDecimal(paramRow["DefaultValue"]);
        //        return def > 0 ? def : 0.0001m;
        //    }
        //    #endregion

        //    #region Universal Formula Evaluator (ROBUST)
        //    object EvaluateFormulaUniversal(
        //        string formula,
        //        Func<string, decimal> resolver)
        //    {
        //        if (string.IsNullOrWhiteSpace(formula))
        //            return 0m;

        //        if (formula.Contains("String.fromCharCode"))
        //        {
        //            var m = System.Text.RegularExpressions.Regex.Match(
        //                formula,
        //                @"String\.fromCharCode\s*\(\s*64\s*\+\s*Number\(e\.(\w+)\)\s*\)"
        //            );

        //            if (m.Success)
        //            {
        //                int v = (int)resolver(m.Groups[1].Value);
        //                return ((char)(64 + v)).ToString();
        //            }
        //        }

        //        bool hasFloor = formula.Contains("| 0");

        //        string expr = formula.TrimStart('=');
        //        expr = System.Text.RegularExpressions.Regex.Replace(expr, @"parseFloat\s*\(", "(");
        //        expr = System.Text.RegularExpressions.Regex.Replace(expr, @"Number\s*\(", "(");
        //        expr = System.Text.RegularExpressions.Regex.Replace(expr, @"\.toFixed\s*\(\s*\d+\s*\)", "");
        //        expr = expr.Replace("| 0", "");
        //        expr = expr.Replace("e.", "");

        //        var exp = new NCalc.Expression(expr, NCalc.EvaluateOptions.IgnoreCase);

        //        // Inject parameters explicitly
        //        var vars = System.Text.RegularExpressions.Regex
        //            .Matches(expr, @"\b[A-Za-z_][A-Za-z0-9_]*\b")
        //            .Cast<System.Text.RegularExpressions.Match>()
        //            .Select(m => m.Value)
        //            .Distinct();

        //        foreach (string v in vars)
        //        {
        //            exp.Parameters[v] = resolver(v);
        //        }

        //        object result = exp.Evaluate();

        //        if (decimal.TryParse(Convert.ToString(result), out decimal num))
        //        {
        //            if (hasFloor) num = Math.Floor(num);

        //            if (formula.Contains("toFixed(4)")) return Math.Round(num, 4);
        //            if (formula.Contains("toFixed(3)")) return Math.Round(num, 3);
        //            if (formula.Contains("toFixed(2)")) return Math.Round(num, 2);
        //            if (formula.Contains("toFixed(0)")) return Math.Round(num, 0);

        //            return num;
        //        }

        //        return result;
        //    }
        //    #endregion

        //    #region MAIN LOOP
        //    for (int i = 0; i < processTable.Rows.Count; i++)
        //    {
        //        long processID = Convert.ToInt64(processTable.Rows[i]["ProcessID"]);
        //        str = " Select  PM.ProcessID,ProcessName,COM.MachineID as MachineID,ISG.ItemSubGroupID,ISGR.Rate from CategoryMaster As CM Inner JOIN CombinationMaster as COM ON COM.CombinationCode = CM.CombinationCode INNER JOIN ProcessMaster as PM On PM.ProcessID =  COM.ProcessID INNER JOIN ItemSubGroupMaster as ISG ON ISG.ItemSubGroupID = COM.ItemSubGroupID INNER JOIN ItemSubGroupRateMaster as ISGR On ISGR.ItemSubGroupID = ISG.ItemSubGroupID " +
        //          " Where ISNULL(CM.IsDeletedTransaction,0) = 0 And CategoryID = " + Gbl_Category_ID + " And PM.ProcessID = " + processID + " And ISGR.ProductionUnitID = " + plantID;
        //        DefaultMaterials.Clear();
        //        DBConnection.FillDataTable(ref DefaultMaterials, str);

        //        for (int j = 0; j < DefaultMaterials.Rows.Count; j++)
        //        {
        //            long machineID = Convert.ToInt64(DefaultMaterials.Rows[j]["MachineID"]);
        //            long itemSubGroupID = Convert.ToInt64(DefaultMaterials.Rows[j]["ItemSubGroupID"]);

        //            DataTable Params = new DataTable();
        //            str = "Select ItemGroupID, S.ItemSubGroupID, TransID, FieldDescription, FieldName, ItemMasterFieldName, AppVariableName, FieldDisplayName, CalculationFormula,CASE WHEN FieldName = 'WastagePercentage' Then '" + ProcessWiseWastagePer + "' WHEN FieldName = 'AnnualQuantity' Then '" + AnnualQuantity + "' When FieldName = 'EstimationRate' THEN ISNULL(IMSR.Rate,0) ELSE DefaultValue End as DefaultValue, DisplaySequenceNo, IsDisplayField,DomainType,Isnull(IsEditableField,0) AS IsEditableField,Isnull(MinimumValue,0) AS MinimumValue,Isnull(MaximumValue,0) AS MaximumValue From MaterialCostEstimationSetting as S INNER JOIN ItemSubGroupMaster AS IMS ON IMS.ItemSubGroupID = S.ItemSubGroupID INNER JOIN ItemSubGroupRateMaster AS IMSR ON IMSR.ItemSubGroupID = IMS.ItemSubGroupID INNER JOIN ProductionUnitMaster As PUM On PUM.ProductionUnitID = IMSR.ProductionUnitID  " +
        //                  " Where S.CompanyID = " + GBLCompanyID + " And Isnull(S.IsDeletedTransaction,0) = 0 And S.ItemSubGroupID = " + itemSubGroupID + " And PUM.ProductionUnitID = " + plantID + " Order By ItemGroupID,ItemSubGroupID,TransID";
        //            DBConnection.FillDataTable(ref Params, str);
        //            for (int k = 0; k < Params.Rows.Count; k++)
        //            {
        //                DataRow paramRow = Params.Rows[k];
        //                string formula = Convert.ToString(paramRow["CalculationFormula"]);
        //                decimal defaultValue = Convert.ToDecimal(paramRow["DefaultValue"]);

        //                object result;

        //                if (defaultValue > 0)
        //                {
        //                    result = defaultValue;
        //                }
        //                else if (!string.IsNullOrEmpty(formula))
        //                {
        //                    result = EvaluateFormulaUniversal(
        //                        formula,
        //                        v => ResolveVariableValue(v, processID, machineID, itemSubGroupID, paramRow)
        //                    );
        //                }
        //                else
        //                {
        //                    result = ResolveVariableValue(Convert.ToString(paramRow["AppVariableName"]), processID, machineID, itemSubGroupID, paramRow);
        //                }

        //                DataRow newRow = FinalMaterialParamsGrid.NewRow();
        //                newRow["PlanContQty"] = planRow != null ? Convert.ToDecimal(planRow["FinalQuantity"]) : 0;
        //                newRow["PlanContentType"] = planRow != null ? Convert.ToString(planRow["PlanContentType"]) : "";
        //                newRow["PlanContName"] = planRow != null ? Convert.ToString(planRow["PlanContName"]) : "";
        //                newRow["TransID"] = paramRow["TransID"];
        //                newRow["ProcessID"] = processID;
        //                newRow["MachineID"] = machineID;
        //                newRow["ItemSubGroupID"] = itemSubGroupID;
        //                newRow["FieldName"] = paramRow["FieldName"];
        //                newRow["FieldDescription"] = paramRow["FieldDescription"];
        //                newRow["FieldDisplayName"] = paramRow["FieldDisplayName"];
        //                newRow["ItemMasterFieldName"] = paramRow["ItemMasterFieldName"];
        //                newRow["AppVariableName"] = paramRow["AppVariableName"];
        //                newRow["CalculationFormula"] = formula;
        //                newRow["DefaultValue"] = defaultValue;
        //                newRow["DisplaySequenceNo"] = paramRow["DisplaySequenceNo"];
        //                newRow["DomainType"] = paramRow["DomainType"];
        //                newRow["IsDisplayField"] = paramRow["IsDisplayField"];
        //                newRow["IsEditableField"] = paramRow["IsEditableField"];
        //                newRow["FieldValue"] = result is string ? result.ToString() : Convert.ToDecimal(result).ToString("0.####");

        //                FinalMaterialParamsGrid.Rows.Add(newRow);
        //            }

        //            DataRow newRow2 = FinaltMaterials.NewRow();
        //            newRow2["PlanContQty"] = planRow != null ? Convert.ToDecimal(planRow["FinalQuantity"]) : 0;
        //            newRow2["PlanContentType"] = planRow != null ? Convert.ToString(planRow["PlanContentType"]) : "";
        //            newRow2["PlanContName"] = planRow != null ? Convert.ToString(planRow["PlanContName"]) : "";
        //            newRow2["TransID"] = j + 1;
        //            newRow2["ProcessID"] = processID;
        //            newRow2["MachineID"] = machineID;
        //            newRow2["ItemSubGroupID"] = itemSubGroupID;
        //            newRow2["RequiredQuantityInStockUnit"] = 0.00;
        //            newRow2["BookedQtyInPurchaseUnit"] = 0.00;
        //            newRow2["RequiredQtyUnit"] = "Kg";
        //            newRow2["PurchaseUnit"] = "Kg";
        //            newRow2["EstimatedQuantity"] = 0.00;
        //            newRow2["EstimationRate"] = 0.00;
        //            newRow2["EstimationUnit"] = "Kg";
        //            newRow2["EstimatedAmount"] = 0.00;
        //            FinaltMaterials.Rows.Add(newRow2);
        //        }

        //        // ---------- Read once ----------
        //        int departmentId = Convert.ToInt32(processTable.Rows[i]["DepartmentID"]);

        //        decimal totalMakeReadies = Convert.ToDecimal(planTable.Rows[0]["TotalMakeReadies"]);
        //        decimal actualSheets = Convert.ToDecimal(processTable.Rows[i]["PerHourCalculationQuantity"]);

        //        decimal machineSpeed = 0;
        //        if (processTable.Rows[i]["MachineSpeed"] != DBNull.Value)
        //        {
        //            machineSpeed = Convert.ToDecimal(processTable.Rows[i]["MachineSpeed"]);
        //        }

        //        // ---------- Fetch Machine Cost ----------
        //        decimal machinePerHourCost = 0;
        //        decimal MakeReadyPerHourCost = 0;
        //        DataTable abhi = new DataTable();

        //        str = @"SELECT PerHourCost,MakeReadyPerHourCost FROM MachineMaster WHERE ISNULL(IsDeletedTransaction,0)=0 AND MachineId = " + processTable.Rows[i]["MachineID"];

        //        DBConnection.FillDataTable(ref abhi, str);

        //        if (abhi.Rows.Count > 0 && abhi.Rows[0][0] != DBNull.Value)
        //        {
        //            machinePerHourCost = Convert.ToDecimal(abhi.Rows[0][0]);
        //            MakeReadyPerHourCost = Convert.ToDecimal(abhi.Rows[0][1]);
        //        }

        //        // ---------- Setup Time & Cost ----------
        //        int setupTime;
        //        decimal setupMultiplier;

        //        if (departmentId == 100)
        //        {
        //            setupTime = 90;
        //            setupMultiplier = 1.5m;
        //        }
        //        else
        //        {
        //            setupTime = 60;
        //            setupMultiplier = 1m;
        //        }

        //        processTable.Rows[i]["SetupTime"] = setupTime;

        //        processTable.Rows[i]["SetupCost"] = Math.Round(MakeReadyPerHourCost * totalMakeReadies * setupMultiplier, 2, MidpointRounding.AwayFromZero);

        //        // ---------- Execution Time (SAFE) ----------
        //        decimal executionTime = 0;
        //        if (machineSpeed > 0 && actualSheets > 0)
        //        {
        //            executionTime = Math.Round((actualSheets / machineSpeed) / 60m, 4, MidpointRounding.AwayFromZero);
        //        }
        //        else
        //        {
        //            executionTime = 0; // fallback – prevents crash
        //        }

        //        processTable.Rows[i]["ExecutionTime"] = executionTime;
        //        // ---------- Execution Cost ----------
        //        processTable.Rows[i]["ExecutionCost"] = Math.Round(executionTime * machinePerHourCost, 3, MidpointRounding.AwayFromZero);
        //    }
        //    #endregion

        //    MaterialParams = FinalMaterialParamsGrid;
        //    AllocatedMaterials = FinaltMaterials;
        //}

        private void ApplyCostingCalculations(ref DataTable planTable, ref DataTable processTable, long categoryID, string plantID, ref DataTable AllocatedMaterials, ref DataTable MaterialParams)
        {
            DataTable planTableLocal = planTable;

            DataTable DefaultMaterials = new DataTable();
            DataTable FinaltMaterials = new DataTable();
            DataTable FinalMaterialParamsGrid = new DataTable();
            DataTable dataTable = new DataTable();

            #region Columns
            FinalMaterialParamsGrid.Columns.Add("PlanContQty", typeof(decimal));
            FinalMaterialParamsGrid.Columns.Add("PlanContentType", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("PlanContName", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("TransID", typeof(long));
            FinalMaterialParamsGrid.Columns.Add("ProcessID", typeof(long));
            FinalMaterialParamsGrid.Columns.Add("MachineID", typeof(long));
            FinalMaterialParamsGrid.Columns.Add("ItemSubGroupID", typeof(long));
            FinalMaterialParamsGrid.Columns.Add("FieldName", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("FieldDescription", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("FieldDisplayName", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("ItemMasterFieldName", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("AppVariableName", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("CalculationFormula", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("DefaultValue", typeof(decimal));
            FinalMaterialParamsGrid.Columns.Add("DisplaySequenceNo", typeof(int));
            FinalMaterialParamsGrid.Columns.Add("DomainType", typeof(string));
            FinalMaterialParamsGrid.Columns.Add("IsDisplayField", typeof(bool));
            FinalMaterialParamsGrid.Columns.Add("IsEditableField", typeof(bool));
            FinalMaterialParamsGrid.Columns.Add("FieldValue", typeof(string));
            #endregion

            #region Columns
            FinaltMaterials.Columns.Add("PlanContQty", typeof(decimal));
            FinaltMaterials.Columns.Add("PlanContentType", typeof(string));
            FinaltMaterials.Columns.Add("PlanContName", typeof(string));
            FinaltMaterials.Columns.Add("TransID", typeof(long));
            FinaltMaterials.Columns.Add("ProcessID", typeof(long));
            FinaltMaterials.Columns.Add("MachineID", typeof(long));
            FinaltMaterials.Columns.Add("ItemSubGroupID", typeof(long));
            FinaltMaterials.Columns.Add("RequiredQuantityInStockUnit", typeof(double));
            FinaltMaterials.Columns.Add("BookedQtyInPurchaseUnit", typeof(string));
            FinaltMaterials.Columns.Add("RequiredQtyUnit", typeof(string));
            FinaltMaterials.Columns.Add("PurchaseUnit", typeof(string));
            FinaltMaterials.Columns.Add("EstimatedQuantity", typeof(double));
            FinaltMaterials.Columns.Add("EstimationRate", typeof(double));
            FinaltMaterials.Columns.Add("EstimationUnit", typeof(string));
            FinaltMaterials.Columns.Add("EstimatedAmount", typeof(double));
            #endregion


            #region AppVariable Mapping
            Dictionary<string, string> AppVariableMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
            {
                { "TotalRequiredSquareMeter", "RequiredSquareMeter" },
                { "PlanContQty", "OrderQuantity" },
                { "TotalPaperWeightWithCorrugation", "TotalPaperWeightInKg" },
                { "WastagePercentage", "WastePerc" },
                { "PaperSizeL", "PaperSize" },
                { "PaperSizeW", "PaperSize" },
                { "CutSizeL", "CutSize" },
                { "CutSizeW", "CutSize" },
                { "ActualSheets", "ActualSheets" },
                { "FullSheets", "FullSheets" },
                { "TotalUps", "TotalUps" },
                { "TotalRequiredRunningMeter", "TotalRequiredRunningMeter" },
                { "MaterialFreightWeight", "MaterialFreightWeight" },
                { "MaterialFreightWeightKg", "MaterialFreightWeight" }
            };
            decimal totalMaterialFreightWeight = 0;
            #endregion

            string GBLCompanyID = Convert.ToString(HttpContext.Current.Session["CompanyID"]);
            DataRow planRow = (planTableLocal != null && planTableLocal.Rows.Count > 0) ? planTableLocal.Rows[0] : null;

            #region Resolver (SAFE, DEFAULT-FIRST)
            decimal ResolveVariableValue(string variable, long processID, long machineID, long itemSubGroupID, DataRow paramRow)
            {
                // Check for MaterialFreightWeight (calculated from Pass 1)
                if (variable.Equals("MaterialFreightWeight", StringComparison.OrdinalIgnoreCase) ||
                    variable.Equals("MaterialFreightWeightKg", StringComparison.OrdinalIgnoreCase))
                {
                    return totalMaterialFreightWeight;
                }

                DataRow[] found = FinalMaterialParamsGrid.Select(
                    "FieldName = '" + variable.Replace("'", "''") + "' " +
                    "AND ProcessID=" + processID +
                    " AND MachineID=" + machineID +
                    " AND ItemSubGroupID=" + itemSubGroupID,
                    "DisplaySequenceNo DESC"
                );

                if (found.Length > 0 && found[0]["FieldValue"] != DBNull.Value)
                    return Convert.ToDecimal(found[0]["FieldValue"]);

                if (found.Length == 0)
                {
                    DataRow[] crossMaterialFound = FinalMaterialParamsGrid.Select(
                        "FieldName = '" + variable.Replace("'", "''") + "'",
                        "DisplaySequenceNo DESC"
                    );

                    if (crossMaterialFound.Length > 0 && crossMaterialFound[0]["FieldValue"] != DBNull.Value)
                        return Convert.ToDecimal(crossMaterialFound[0]["FieldValue"]);
                }

                if (planRow != null && AppVariableMap.ContainsKey(variable))
                {
                    string col = AppVariableMap[variable];
                    if (planTableLocal.Columns.Contains(col) && planRow[col] != DBNull.Value)
                    {
                        string raw = Convert.ToString(planRow[col]);

                        if ((variable.EndsWith("L") || variable.EndsWith("W")) && raw.Contains("x"))
                        {
                            string[] p = raw.Split('x');
                            return variable.EndsWith("L") ? Convert.ToDecimal(p[0]) : Convert.ToDecimal(p[1]);
                        }

                        return Convert.ToDecimal(planRow[col]);
                    }
                }

                if (planRow != null &&
                    planTableLocal.Columns.Contains(variable) &&
                    planRow[variable] != DBNull.Value)
                {
                    return Convert.ToDecimal(planRow[variable]);
                }

                decimal def = Convert.ToDecimal(paramRow["DefaultValue"]);
                return def > 0 ? def : 0.0001m;
            }
            #endregion

            #region Universal Formula Evaluator (ROBUST)
            object EvaluateFormulaUniversal(
                string formula,
                Func<string, decimal> resolver)
            {
                if (string.IsNullOrWhiteSpace(formula))
                    return 0m;

                if (formula.Contains("String.fromCharCode"))
                {
                    var m = System.Text.RegularExpressions.Regex.Match(
                        formula,
                        @"String\.fromCharCode\s*\(\s*64\s*\+\s*Number\(e\.(\w+)\)\s*\)"
                    );

                    if (m.Success)
                    {
                        int v = (int)resolver(m.Groups[1].Value);
                        return ((char)(64 + v)).ToString();
                    }
                }

                bool hasFloor = formula.Contains("| 0");

                string expr = formula.TrimStart('=');
                expr = System.Text.RegularExpressions.Regex.Replace(expr, @"parseFloat\s*\(", "(");
                expr = System.Text.RegularExpressions.Regex.Replace(expr, @"Number\s*\(", "(");
                expr = System.Text.RegularExpressions.Regex.Replace(expr, @"\.toFixed\s*\(\s*\d+\s*\)", "");
                expr = expr.Replace("| 0", "");
                expr = expr.Replace("e.", "");
                var exp = new NCalc.Expression(expr, NCalc.EvaluateOptions.IgnoreCase);
                var vars = System.Text.RegularExpressions.Regex
                    .Matches(expr, @"\b[A-Za-z_][A-Za-z0-9_]*\b")
                    .Cast<System.Text.RegularExpressions.Match>()
                    .Select(m => m.Value)
                    .Distinct();

                foreach (string v in vars)
                {
                    exp.Parameters[v] = resolver(v);
                }

                object result = exp.Evaluate();

                if (decimal.TryParse(Convert.ToString(result), out decimal num))
                {
                    if (hasFloor) num = Math.Floor(num);

                    if (formula.Contains("toFixed(4)")) return Math.Round(num, 4);
                    if (formula.Contains("toFixed(3)")) return Math.Round(num, 3);
                    if (formula.Contains("toFixed(2)")) return Math.Round(num, 2);
                    if (formula.Contains("toFixed(0)")) return Math.Round(num, 0);

                    return num;
                }

                return result;
            }
            #endregion

            #region MAIN LOOP
            for (int i = 0; i < processTable.Rows.Count; i++)
            {
                long processID = Convert.ToInt64(processTable.Rows[i]["ProcessID"]);
                str = " Select  PM.ProcessID,ProcessName,COM.MachineID as MachineID,ISG.ItemSubGroupID,ISGR.Rate from CategoryMaster As CM Inner JOIN CombinationMaster as COM ON COM.CombinationCode = CM.CombinationCode INNER JOIN ProcessMaster as PM On PM.ProcessID =  COM.ProcessID INNER JOIN ItemSubGroupMaster as ISG ON ISG.ItemSubGroupID = COM.ItemSubGroupID INNER JOIN ItemSubGroupRateMaster as ISGR On ISGR.ItemSubGroupID = ISG.ItemSubGroupID " +
                  " Where ISNULL(CM.IsDeletedTransaction,0) = 0 And CategoryID = " + Gbl_Category_ID + " And PM.ProcessID = " + processID + " And ISGR.ProductionUnitID = " + plantID;
                DefaultMaterials.Clear();
                DBConnection.FillDataTable(ref DefaultMaterials, str);

                for (int j = 0; j < DefaultMaterials.Rows.Count; j++)
                {
                    long machineID = Convert.ToInt64(DefaultMaterials.Rows[j]["MachineID"]);
                    long itemSubGroupID = Convert.ToInt64(DefaultMaterials.Rows[j]["ItemSubGroupID"]);

                    DataTable Params = new DataTable();
                    str = "Select ItemGroupID, S.ItemSubGroupID, TransID, FieldDescription, FieldName, ItemMasterFieldName, AppVariableName, FieldDisplayName, CalculationFormula,CASE WHEN FieldName = 'WastagePercentage' Then '" + ProcessWiseWastagePer + "' WHEN FieldName = 'AnnualQuantity' Then '" + AnnualQuantity + "' When FieldName = 'EstimationRate' THEN ISNULL(IMSR.Rate,0) ELSE DefaultValue End as DefaultValue, DisplaySequenceNo, IsDisplayField,DomainType,Isnull(IsEditableField,0) AS IsEditableField,Isnull(MinimumValue,0) AS MinimumValue,Isnull(MaximumValue,0) AS MaximumValue From MaterialCostEstimationSetting as S INNER JOIN ItemSubGroupMaster AS IMS ON IMS.ItemSubGroupID = S.ItemSubGroupID INNER JOIN ItemSubGroupRateMaster AS IMSR ON IMSR.ItemSubGroupID = IMS.ItemSubGroupID INNER JOIN ProductionUnitMaster As PUM On PUM.ProductionUnitID = IMSR.ProductionUnitID  " +
                          " Where S.CompanyID = " + GBLCompanyID + " And Isnull(S.IsDeletedTransaction,0) = 0 And S.ItemSubGroupID = " + itemSubGroupID + " And PUM.ProductionUnitID = " + plantID + " Order By ItemGroupID,ItemSubGroupID,TransID";
                    DBConnection.FillDataTable(ref Params, str);
                    for (int k = 0; k < Params.Rows.Count; k++)
                    {
                        DataRow paramRow = Params.Rows[k];
                        string formula = Convert.ToString(paramRow["CalculationFormula"]);
                        decimal defaultValue = Convert.ToDecimal(paramRow["DefaultValue"]);

                        object result;

                        if (defaultValue > 0)
                        {
                            result = defaultValue;
                        }
                        else if (!string.IsNullOrEmpty(formula))
                        {
                            result = EvaluateFormulaUniversal(
                                formula,
                                v => ResolveVariableValue(v, processID, machineID, itemSubGroupID, paramRow)
                            );
                        }
                        else
                        {
                            result = ResolveVariableValue(Convert.ToString(paramRow["AppVariableName"]), processID, machineID, itemSubGroupID, paramRow);
                        }

                        DataRow newRow = FinalMaterialParamsGrid.NewRow();
                        newRow["PlanContQty"] = planRow != null ? Convert.ToDecimal(planRow["OrderQuantity"]) : 0;
                        newRow["PlanContentType"] = planRow != null ? Convert.ToString(planRow["PlanContentType"]) : "";
                        newRow["PlanContName"] = planRow != null ? Convert.ToString(planRow["PlanContName"]) : "";
                        newRow["TransID"] = paramRow["TransID"];
                        newRow["ProcessID"] = processID;
                        newRow["MachineID"] = machineID;
                        newRow["ItemSubGroupID"] = itemSubGroupID;
                        newRow["FieldName"] = paramRow["FieldName"];
                        newRow["FieldDescription"] = paramRow["FieldDescription"];
                        newRow["FieldDisplayName"] = paramRow["FieldDisplayName"];
                        newRow["ItemMasterFieldName"] = paramRow["ItemMasterFieldName"];
                        newRow["AppVariableName"] = paramRow["AppVariableName"];
                        newRow["CalculationFormula"] = formula;
                        newRow["DefaultValue"] = defaultValue;
                        newRow["DisplaySequenceNo"] = paramRow["DisplaySequenceNo"];
                        newRow["DomainType"] = paramRow["DomainType"];
                        newRow["IsDisplayField"] = paramRow["IsDisplayField"];
                        newRow["IsEditableField"] = paramRow["IsEditableField"];
                        newRow["FieldValue"] = result is string ? result.ToString() : Convert.ToDecimal(result).ToString("0.####");

                        FinalMaterialParamsGrid.Rows.Add(newRow);
                    }

                    DataRow newRow2 = FinaltMaterials.NewRow();
                    newRow2["PlanContQty"] = planRow != null ? Convert.ToDecimal(planRow["OrderQuantity"]) : 0;
                    newRow2["PlanContentType"] = planRow != null ? Convert.ToString(planRow["PlanContentType"]) : "";
                    newRow2["PlanContName"] = planRow != null ? Convert.ToString(planRow["PlanContName"]) : "";
                    newRow2["TransID"] = j + 1;
                    newRow2["ProcessID"] = processID;
                    newRow2["MachineID"] = machineID;
                    newRow2["ItemSubGroupID"] = itemSubGroupID;
                    newRow2["RequiredQuantityInStockUnit"] = 0.00;
                    newRow2["BookedQtyInPurchaseUnit"] = 0.00;
                    newRow2["RequiredQtyUnit"] = "Kg";
                    newRow2["PurchaseUnit"] = "Kg";
                    newRow2["EstimatedQuantity"] = 0.00;
                    newRow2["EstimationRate"] = 0.00;
                    newRow2["EstimationUnit"] = "Kg";
                    newRow2["EstimatedAmount"] = 0.00;
                    FinaltMaterials.Rows.Add(newRow2);
                }
                int departmentId = Convert.ToInt32(processTable.Rows[i]["DepartmentID"]);

                decimal totalMakeReadies = Convert.ToDecimal(planTable.Rows[0]["TotalMakeReadies"]);
                decimal actualSheets = Convert.ToDecimal(processTable.Rows[i]["PerHourCalculationQuantity"]);

                decimal machineSpeed = 0;
                if (processTable.Rows[i]["MachineSpeed"] != DBNull.Value)
                {
                    machineSpeed = Convert.ToDecimal(processTable.Rows[i]["MachineSpeed"]);
                }
                decimal machinePerHourCost = 0;
                decimal MakeReadyPerHourCost = 0;
                DataTable abhi = new DataTable();

                str = @"SELECT PerHourCost,MakeReadyPerHourCost FROM MachineMaster WHERE ISNULL(IsDeletedTransaction,0)=0 AND MachineId = " + processTable.Rows[i]["MachineID"];

                DBConnection.FillDataTable(ref abhi, str);

                if (abhi.Rows.Count > 0 && abhi.Rows[0][0] != DBNull.Value)
                {
                    machinePerHourCost = Convert.ToDecimal(abhi.Rows[0][0]);
                    MakeReadyPerHourCost = Convert.ToDecimal(abhi.Rows[0][1]);
                }
                int setupTime;
                decimal setupMultiplier;

                if (departmentId == 100)
                {
                    setupTime = 90;
                    setupMultiplier = 1.5m;
                }
                else
                {
                    setupTime = 60;
                    setupMultiplier = 1m;
                }

                processTable.Rows[i]["SetupTime"] = setupTime;

                processTable.Rows[i]["SetupCost"] = Math.Round(MakeReadyPerHourCost * totalMakeReadies * setupMultiplier, 2, MidpointRounding.AwayFromZero);

                decimal executionTime = 0;
                if (machineSpeed > 0 && actualSheets > 0)
                {
                    executionTime = Math.Round((actualSheets / machineSpeed) / 60m, 4, MidpointRounding.AwayFromZero);
                }
                else
                {
                    executionTime = 0;
                }

                processTable.Rows[i]["ExecutionTime"] = executionTime;
                processTable.Rows[i]["ExecutionCost"] = Math.Round(executionTime * machinePerHourCost, 3, MidpointRounding.AwayFromZero);
            }
            #endregion

            #region PASS 2 - Calculate MaterialFreightWeight and Re-evaluate dependent formulas
            foreach (DataRow row in FinalMaterialParamsGrid.Rows)
            {
                string fieldName = Convert.ToString(row["FieldName"]).Trim().ToLower();
                string appVarName = Convert.ToString(row["AppVariableName"]).Trim().ToLower();

                bool isFreightWeightKgField =
                    fieldName == "freightweightkg" ||
                    appVarName == "freightweightkg" ||
                    fieldName == "freightweight" ||
                    appVarName == "freightweight";

                bool isMaterialFreightWeight =
                    fieldName == "materialfreightweight" ||
                    appVarName == "materialfreightweight";

                if (isFreightWeightKgField && !isMaterialFreightWeight)
                {
                    if (row["FieldValue"] != DBNull.Value)
                    {
                        decimal freightValue = 0;
                        if (decimal.TryParse(Convert.ToString(row["FieldValue"]), out freightValue))
                        {
                            totalMaterialFreightWeight += freightValue;
                        }
                    }
                }
            }

            totalMaterialFreightWeight = Math.Round(totalMaterialFreightWeight, 4, MidpointRounding.AwayFromZero);

            for (int rowIndex = 0; rowIndex < FinalMaterialParamsGrid.Rows.Count; rowIndex++)
            {
                DataRow paramRow = FinalMaterialParamsGrid.Rows[rowIndex];
                string fieldName = Convert.ToString(paramRow["FieldName"]).Trim().ToLower();
                string appVarName = Convert.ToString(paramRow["AppVariableName"]).Trim().ToLower();
                if (fieldName == "materialfreightweight" || appVarName == "materialfreightweight")
                {
                    paramRow["FieldValue"] = totalMaterialFreightWeight.ToString("0.####");
                }
            }
            for (int rowIndex = 0; rowIndex < FinalMaterialParamsGrid.Rows.Count; rowIndex++)
            {
                DataRow paramRow = FinalMaterialParamsGrid.Rows[rowIndex];
                string formula = Convert.ToString(paramRow["CalculationFormula"]);
                if (!string.IsNullOrEmpty(formula))
                {
                    //string formulaLower = formula.ToLower();
                    //if (formulaLower.Contains("materialfreightweight") ||
                    //    formulaLower.Contains("materialfreightweightkg") ||
                    //    formula.Contains("e.MaterialFreightWeight") ||
                    //    formula.Contains("e.materialFreightWeight") ||
                    //    formulaLower.Contains("requiredquantityinkg") ||
                    //    formulaLower.Contains("e.requiredquantityinkg") ||
                    //    formula.Contains("RequiredQuantityinKg") ||
                    //    formula.Contains("e.RequiredQuantityinKg")
                    //    )
                    //{
                    long processID = Convert.ToInt64(paramRow["ProcessID"]);
                    long machineID = Convert.ToInt64(paramRow["MachineID"]);
                    long itemSubGroupID = Convert.ToInt64(paramRow["ItemSubGroupID"]);

                    object result = EvaluateFormulaUniversal(
                        formula,
                        v => ResolveVariableValue(v, processID, machineID, itemSubGroupID, paramRow)
                    );
                    paramRow["FieldValue"] = result is string ? result.ToString() : Convert.ToDecimal(result).ToString("0.####");
                    //}
                }
            }
            #endregion

            MaterialParams = FinalMaterialParamsGrid;
            AllocatedMaterials = FinaltMaterials;
        }

        public class OperationResponse<T>
        {
            public bool success { get; set; }
            public string message { get; set; }
            public T result { get; set; }
        }
        public class OperationRequest
        {
            public double Full_Sheets { get; set; }
            public double Actual_Sheets { get; set; }
            public long Make_Ready_Sheets_Total { get; set; }
            public double Wastage_Sheets { get; set; }
            public double Process_Wastage_Sheets { get; set; }
            public double Cut_L { get; set; }
            public double Cut_H { get; set; }
            public double Cut_H_L { get; set; }
            public double Cut_L_H { get; set; }
            public double Req_Running_Mtr { get; set; }
            public double Total_Running_Mtr { get; set; }
            public long Total_Paper_In_KG { get; set; }
            public int Total_Ups { get; set; }
            public int No_Of_Sets { get; set; }
            public int Total_Colors { get; set; }
            public int Plate_Qty { get; set; }
            public int Final_Quantity { get; set; }
            public int Gbl_Order_Quantity { get; set; }
            public double Gbl_Job_L { get; set; }
            public double Gbl_Job_H { get; set; }
            public double Gbl_Job_W { get; set; }
            public double Gbl_Sheet_L { get; set; }
            public double Gbl_Sheet_W { get; set; }
            public int Gbl_Machine_ID { get; set; }
            public string Gbl_Machine_Name { get; set; }
            public long Machine_Speed { get; set; }
            public long Make_Ready_Time { get; set; }
            public long Job_Change_Over_Time { get; set; }
            public string Gbl_Content_Domain_Type { get; set; }
            public string GblOperId { get; set; }
        }

    }
}